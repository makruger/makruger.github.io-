<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Working With Solaris IP Filter Rule Sets - System Administration Guide: IP Services</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2007-02-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo"></div>
   <div class="Title">System Administration Guide: IP Services</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="ezecz.html">Previous</a>
             </td>
             <td align="right">
                 <a href="gdwan.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="iptm-1.html">Part&nbsp;I&nbsp;TCP/IP Administration</a></p>
<p class="toc level2"><a href="ipov-1.html">1.&nbsp;&nbsp;Solaris TCPIP Protocol Suite (Overview)</a></p>
<p class="toc level2"><a href="ipplan-1.html">2.&nbsp;&nbsp;Planning an IPv4 Addressing Scheme (Tasks</a></p>
<p class="toc level2"><a href="ipv6-overview-7.html">3.&nbsp;&nbsp;Planning an IPv6 Addressing Scheme (Overview)</a></p>
<p class="toc level2"><a href="ipv6-planning-1.html">4.&nbsp;&nbsp;Planning an IPv6 Network (Tasks)</a></p>
<p class="toc level2"><a href="ipconfig-1.html">5.&nbsp;&nbsp;Configuring TCP/IP Network Services and IPv4 Addressing (Tasks)</a></p>
<p class="toc level2"><a href="fwawf.html">6.&nbsp;&nbsp;Administering Network Interfaces (Tasks)</a></p>
<p class="toc level2"><a href="ipv6-config-tasks-1.html">7.&nbsp;&nbsp;Enabling IPv6 on a Network (Tasks)</a></p>
<p class="toc level2"><a href="ipv6-admintasks-1.html">8.&nbsp;&nbsp;Administering a TCP/IP Network (Tasks)</a></p>
<p class="toc level2"><a href="gegel.html">9.&nbsp;&nbsp;Troubleshooting Network Problems (Tasks)</a></p>
<p class="toc level2"><a href="ipref-8.html">10.&nbsp;&nbsp;TCP/IP and IPv4 in Depth (Reference)</a></p>
<p class="toc level2"><a href="ipv6-ref-76.html">11.&nbsp;&nbsp;IPv6 in Depth (Reference)</a></p>
<p class="toc level1 tocsp"><a href="dhcptm-1.html">Part&nbsp;II&nbsp;DHCP</a></p>
<p class="toc level2"><a href="dhcp-overview-1.html">12.&nbsp;&nbsp;About Solaris DHCP (Overview)</a></p>
<p class="toc level2"><a href="chap2-26.html">13.&nbsp;&nbsp;Planning for DHCP Service (Tasks)</a></p>
<p class="toc level2"><a href="chapter3-20.html">14.&nbsp;&nbsp;Configuring the DHCP Service (Tasks)</a></p>
<p class="toc level2"><a href="dhcp-admin-9.html">15.&nbsp;&nbsp;Administering DHCP (Tasks)</a></p>
<p class="toc level2"><a href="eyatl.html">16.&nbsp;&nbsp;Configuring and Administering  DHCP Clients</a></p>
<p class="toc level2"><a href="dhcp-trouble-1.html">17.&nbsp;&nbsp;Troubleshooting DHCP (Reference)</a></p>
<p class="toc level2"><a href="dhcp-ref-4.html">18.&nbsp;&nbsp;DHCP Commands and Files (Reference)</a></p>
<p class="toc level1 tocsp"><a href="ipsectm-1.html">Part&nbsp;III&nbsp;IP Security</a></p>
<p class="toc level2"><a href="ipsec-ov-1.html">19.&nbsp;&nbsp;IP Security Architecture (Overview)</a></p>
<p class="toc level2"><a href="ipsec-mgtasks-1.html">20.&nbsp;&nbsp;Configuring IPsec (Tasks)</a></p>
<p class="toc level2"><a href="ipsecref-1.html">21.&nbsp;&nbsp;IP Security Architecture (Reference)</a></p>
<p class="toc level2"><a href="ike-1.html">22.&nbsp;&nbsp;Internet Key Exchange (Overview)</a></p>
<p class="toc level2"><a href="ike-task-1.html">23.&nbsp;&nbsp;Configuring IKE (Tasks)</a></p>
<p class="toc level2"><a href="ikeref-1.html">24.&nbsp;&nbsp;Internet Key Exchange (Reference)</a></p>
<p class="toc level2"><a href="eupsq.html">25.&nbsp;&nbsp;Solaris IP Filter (Overview)</a></p>
<p class="toc level3"><a href="fvcbo.html">What's New in Solaris IP Filter</a></p>
<p class="toc level3"><a href="eupss.html">Introduction to Solaris IP Filter</a></p>
<p class="toc level3"><a href="gaufw.html">Solaris IP Filter Packet Processing</a></p>
<p class="toc level3"><a href="ezltg.html">Guidelines for Using Solaris IP Filter</a></p>
<p class="toc level3"><a href="ezecz.html">Using Solaris IP Filter Configuration Files</a></p>
<div class="onpage">
<p class="toc level3"><a href="">Working With Solaris IP Filter Rule Sets</a></p>
</div>
<p class="toc level3"><a href="gdwan.html">Packet Filter Hooks</a></p>
<p class="toc level3"><a href="fxxrb.html">IPv6 for Solaris IP Filter</a></p>
<p class="toc level3"><a href="euqex.html">Solaris IP Filter Man Pages</a></p>
<p class="toc level2 tocsp"><a href="ipfilter-admin-1.html">26.&nbsp;&nbsp;Solaris IP Filter (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="miptm-1.html">Part&nbsp;IV&nbsp;Mobile IP</a></p>
<p class="toc level2"><a href="mipoverview-1.html">27.&nbsp;&nbsp;Mobile IP (Overview)</a></p>
<p class="toc level2"><a href="mipimplementing-1.html">28.&nbsp;&nbsp;Administering Mobile IP (Tasks)</a></p>
<p class="toc level2"><a href="mipmanaging-22.html">29.&nbsp;&nbsp;Mobile IP Files and Commands (Reference)</a></p>
<p class="toc level1 tocsp"><a href="ipmptm-1.html">Part&nbsp;V&nbsp;IPMP</a></p>
<p class="toc level2"><a href="mpoverview.html">30.&nbsp;&nbsp;Introducing IPMP (Overview)</a></p>
<p class="toc level2"><a href="deploynetmult-56.html">31.&nbsp;&nbsp;Administering IPMP (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="ipqostm-1.html">Part&nbsp;VI&nbsp;IP Quality of Service (IPQoS)</a></p>
<p class="toc level2"><a href="ipqos-intro-1.html">32.&nbsp;&nbsp;Introducing IPQoS (Overview)</a></p>
<p class="toc level2"><a href="ipqos-config-planning-1.html">33.&nbsp;&nbsp;Planning for an IPQoS-Enabled Network (Tasks)</a></p>
<p class="toc level2"><a href="ipqos-policy-planning-1.html">34.&nbsp;&nbsp;Creating the IPQoS Configuration File (Tasks)</a></p>
<p class="toc level2"><a href="ipqos-isp-setup-1.html">35.&nbsp;&nbsp;Starting and Maintaining IPQoS (Tasks)</a></p>
<p class="toc level2"><a href="ipqos-accounting-1.html">36.&nbsp;&nbsp;Using Flow Accounting and Statistics Gathering (Tasks)</a></p>
<p class="toc level2"><a href="ipqos-reference-1.html">37.&nbsp;&nbsp;IPQoS in Detail (Reference)</a></p>
<p class="toc level1 tocsp"><a href="glossary-1.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="ezecx"></a><h3>Working With Solaris IP Filter Rule Sets</h3>
<a name="indexterm-2308"></a><a name="indexterm-2309"></a><p>To manage your firewall, you use Solaris IP Filter to specify rule
sets that you use to filter your network traffic. You can create the
following types of rule sets:</p>
<ul><li><p>Packet filtering rule sets</p></li>
<li><p>Network Address Translation (NAT) rule sets</p></li></ul>
<p>Additionally, you can create address pools to reference groups of IP addresses. You
can then use these pools later in a rule set. The address
pools help to speed up rule processing. Address pools also make managing large
groups of addresses easier.</p>

<a name="euqfb"></a><h4>Using Solaris IP Filter's Packet Filtering Feature</h4>
<a name="indexterm-2310"></a><a name="indexterm-2311"></a><a name="indexterm-2312"></a><a name="indexterm-2313"></a><a name="indexterm-2314"></a><p>You set up packet filtering by using packet filtering rule sets. Use the
<tt>ipf</tt> command to work with packet filtering rule sets. For more information on
the <tt>ipf</tt> command, see the <a href="http://docs.sun.com/doc/819-2240/ipf-1m?a=view"><tt>ipf</tt>(1M)</a> command.</p><p>You can create packet filtering rules either at the command line, using the
<tt>ipf</tt> command, or in a packet filtering configuration file. If you want the
packet filtering rules to be loaded at boot time, create a configuration file
called <tt>/etc/ipf/ipf.conf</tt> in which to put packet filtering rules. If you do not
want the packet filtering rules loaded at boot time, put the <tt>ipf.conf</tt> file
in a location of your choice, and manually activate packet filtering by using
the <tt>ipf</tt> command.</p><p>You can maintain two sets of packet filtering rule sets with Solaris IP
Filter, the active rule set and the inactive rule set. In most
cases, you work with the active rule set. However, the <tt>ipf <tt>-I</tt></tt> command enables you
to apply the command action to the inactive rule list. The inactive rule
list is not used by Solaris IP Filter unless you select it.
The inactive rule list provides you with a place to store rules without
affecting active packet filtering.</p><p>Solaris IP Filter processes the rules in the rules list from the
beginning of the configured rules list to the end of the rules list
before passing or blocking a packet. Solaris IP Filter maintains a flag that
determines whether it will or will not pass a packet. It goes through
the entire rule set and determines whether to pass or block the packet
based on the last matching rule.</p><p>There are two exceptions to this process. The first exception is if the
packet matches a rule containing the <tt>quick</tt> keyword. If a rule includes the
<tt>quick</tt> keyword, the action for that rule is taken, and no subsequent rules
are checked. The second exception is if the packet matches a rule containing
the <tt>group</tt> keyword. If a packet matches a group, only rules tagged with
the group are checked.</p>

<a name="euqfk"></a><h5>Configuring Packet Filtering Rules</h5>
<p>Use the following syntax to create packet filtering rules:</p><p><i>action</i> <tt>[in|out]</tt> <i>option</i> <i>keyword, keyword...</i></p>
<ol><li><p>Each rule begins with an action. Solaris IP Filter applies the action to the packet if the packet matches the rule. The following list includes the commonly used actions applied to a packet.</p><dl><dt><tt>block</tt></dt>
<dd><p>Prevents the packet from passing through the filter.</p></dd>
<dt><tt>pass</tt></dt>
<dd><p>Allows the packet through the filter.</p></dd>
<dt><tt>log</tt></dt>
<dd><p>Logs the packet but does not determine if the packet is blocked or passed. Use the <tt>ipmon</tt> command to view the log.</p></dd>
<dt><tt>count</tt></dt>
<dd><p>Includes the packet in the filter statistics. Use the <tt>ipfstat</tt> command to view the statistics.</p></dd>
<dt><tt>skip</tt> <i>number</i></dt>
<dd><p>Makes the filter skip over <i>number</i> filtering rules.</p></dd>
<dt><tt>auth</tt></dt>
<dd><p>Requests that packet authentication be performed by a user program that validates packet information. The program determines whether the packet is passed or blocked.</p></dd>
<dt><tt>preauth</tt></dt>
<dd><p>Requests that the filter look at a pre-authenticated list to determine what to do with the packet.</p></dd>
</dl>
</li>
<li><p>Following the action, the next word must be either <tt>in</tt> or <tt>out</tt>. Your choice determines whether the packet filtering rule is applied to an incoming packet or to an outgoing packet.</p></li>
<li><p>Next, you can choose from a list of options. If you use more than one option, they must be in the order shown here.</p><dl><dt><tt>log</tt></dt>
<dd><p>Logs the packet if the rule is the last matching rule. Use the <tt>ipmon</tt> command to view the log.</p></dd>
<dt><tt>quick</tt></dt>
<dd><p>Executes the rule containing the <tt>quick</tt> option if there is a packet match. All further rule checking stops.</p></dd>
<dt><tt>on</tt> <i>interface-name</i></dt>
<dd><p>Applies the rule only if the packet is moving in or out of the specified interface.</p></dd>
<dt><tt>dup-to</tt> <i>interface-name</i></dt>
<dd><p>Copies the packet and sends the duplicate out on <i>interface-name</i> to an optionally specified IP address.</p></dd>
<dt><tt>to</tt> <i>interface-name</i></dt>
<dd><p>Moves the packet to an outbound queue on <i>interface-name</i>.</p></dd>
</dl>
</li>
<li><p>After specifying the options, you can choose from a variety of keywords that determine whether the packet matches the rule. The following keywords must be used in the order shown here.</p>
<hr><p><b>Note - </b>By default, any packet that does not match any rule in the configuration file is passed through the filter.</p>
<hr>
<dl><dt><tt>tos</tt></dt>
<dd><p>Filters the packet based on the type-of-service value expressed as either a hexadecimal or a decimal integer.</p></dd>
<dt><tt>ttl</tt></dt>
<dd><p>Matches the packet based on its time-to-live value. The time-to-live value stored in a packet indicates the length of time a packet can be on the network before being discarded.</p></dd>
<dt><tt>proto</tt></dt>
<dd><p>Matches a specific protocol. You can use any of the protocol names specified in the <tt>/etc/protocols</tt> file, or use a decimal number to represent the protocol. The keyword <tt>tcp/udp</tt> can be used to match either a TCP or a UDP packet.</p></dd>
<dt><tt>from</tt>/<tt>to</tt>/<tt>all</tt>/<tt>any</tt></dt>
<dd><p>Matches any or all of the following: the source IP address, the destination IP address, and the port number. The <tt>all</tt> keyword is used to accept packets from all sources and to all destinations.</p></dd>
<dt><tt>with</tt></dt>
<dd><p>Matches specified attributes associated with the packet. Insert either the word <tt>not</tt> or the word <tt>no</tt> in front of the keyword in order to match the packet only if the option is not present.</p></dd>
<dt><tt>flags</tt></dt>
<dd><p>Used for TCP to filter based on TCP flags that are set. For more information on the TCP flags, see the <a href="http://docs.sun.com/doc/819-2251/ipf-4?a=view"><tt>ipf</tt>(4)</a> man page.</p></dd>
<dt><tt>icmp-type</tt></dt>
<dd><p>Filters according to ICMP type. This keyword is used only when the <tt>proto</tt> option is set to <tt>icmp</tt> and is not used if the <tt>flags</tt> option is used.</p></dd>
<dt><tt>keep</tt> <i>keep-options</i></dt>
<dd><p>Determines the information that is kept for a packet. The <i>keep-options</i> available include the <tt>state</tt> option and the <tt>frags</tt> option. The <tt>state</tt> option keeps information about the session and can be kept on TCP, UDP, and ICMP packets. The <tt>frags</tt> option keeps information on packet fragments and applies the information to later fragments. The <i>keep-options</i> allow matching packets to pass without going through the access control list.</p></dd>
<dt><tt>head</tt> <i>number</i></dt>
<dd><p>Creates a new group for filtering rules, which is denoted by the number <i>number</i>.</p></dd>
<dt><tt>group</tt> <i>number</i></dt>
<dd><p>Adds the rule to group number <i>number</i> instead of the default group. All filtering rules are placed in group 0 if no other group is specified.</p></dd>
</dl>
</li></ol>
<p>The following example illustrates how to put together the packet filtering rule syntax
to create a rule. To block incoming traffic from the IP address
<tt>192.168.0.0/16</tt>, you would include the following rule in the rule list:</p><pre>block in quick from 192.168.0.0/16 to any</pre><p>For the complete grammar and syntax used to write packet filtering rules, see
the <a href="http://docs.sun.com/doc/819-2251/ipf-4?a=view"><tt>ipf</tt>(4)</a> man page. For tasks associated with packet filtering, see <a href="eubbd.html#ettma">Managing Packet Filtering Rule Sets for Solaris IP Filter</a>. For
an explanation of the IP address scheme (<tt>192.168.0.0/16</tt>) shown in the example, see <a href="ipplan-1.html">Chapter&nbsp;2, Planning an IPv4 Addressing Scheme (Tasks</a>.</p>

<a name="euqfc"></a><h4>Using Solaris IP Filter's NAT Feature</h4>
<a name="indexterm-2315"></a><a name="indexterm-2316"></a><a name="indexterm-2317"></a><a name="indexterm-2318"></a><a name="indexterm-2319"></a><a name="indexterm-2320"></a><a name="indexterm-2321"></a><a name="indexterm-2322"></a><p>NAT sets up mapping rules that translate source and destination IP addresses into
other Internet or intranet addresses. These rules modify the source and destination addresses
of incoming or outgoing IP packets and send the packets on. You can
also use NAT to redirect traffic from one port to another port. NAT
maintains the integrity of the packet during any modification or redirection done on
the packet.</p><p>Use the <tt>ipnat</tt> command to work with NAT rule lists. For more information
on the <tt>ipnat</tt> command, see the <a href="http://docs.sun.com/doc/819-2240/ipnat-1m?a=view"><tt>ipnat</tt>(1M)</a> command.</p><p>You can create NAT rules either at the command line, using the
<tt>ipnat</tt> command, or in a NAT configuration file. NAT configuration rules reside in
the <tt>ipnat.conf</tt> file. If you want the NAT rules to be loaded at
boot time, create a file called <tt>/etc/ipf/ipnat.conf</tt> in which to put NAT rules.
If you do not want the NAT rules loaded at boot time, put
the <tt>ipnat.conf</tt> file in a location of your choice, and manually activate packet
filtering with the <tt>ipnat</tt> command.</p>

<a name="euxbd"></a><h5>Configuring NAT Rules</h5>
<p>Use the following syntax to create NAT rules:</p><p><i>command</i> <i>interface-name</i> <i>parameters</i></p>
<ol><li><p>Each rule begins with one of the following commands:</p><dl><dt><tt>map</tt></dt>
<dd><p>Maps one IP address or network to another IP address or network in an unregulated round-robin process.</p></dd>
<dt><tt>rdr</tt></dt>
<dd><p>Redirects packets from one IP address and port pair to another IP address and port pair.</p></dd>
<dt><tt>bimap</tt></dt>
<dd><p>Establishes a bidirectional NAT between an external IP address and an internal IP address.</p></dd>
<dt><tt>map-block</tt></dt>
<dd><p>Establishes static IP address-based translation. This command is based on an algorithm that forces addresses to be translated into a destination range.</p></dd>
</dl>
</li>
<li><p>Following the command, the next word is the interface name, such as <tt>hme0</tt>.</p></li>
<li><p>Next, you can choose from a variety of parameters, which determine the NAT configuration. Some of the parameters include:</p><dl><dt><tt>ipmask</tt></dt>
<dd><p>Designates the network mask.</p></dd>
<dt><tt>dstipmask</tt></dt>
<dd><p>Designates the address that <tt>ipmask</tt> is translated to.</p></dd>
<dt><tt>mapport</tt></dt>
<dd><p>Designates <tt>tcp</tt>, <tt>udp</tt>, or <tt>tcp/udp</tt> protocols, along with a range of port numbers.</p></dd>
</dl>
</li></ol>
<p>The following example illustrates how to put together the NAT rule syntax together
to create a NAT rule. To rewrite a packet that goes out
on the <tt>de0</tt> device with a source address of <tt>192.168.1.0/24</tt> and to externally
show its source address as <tt>10.1.0.0/16</tt>, you would include the following rule in
the NAT rule set:</p><pre>map de0 192.168.1.0/24 -> 10.1.0.0/16</pre><p>For the complete grammar and syntax used to write NAT rules, see
the <a href="http://docs.sun.com/doc/819-2251/ipnat-4?a=view"><tt>ipnat</tt>(4)</a> man page.</p>

<a name="euqfe"></a><h4>Using Solaris IP Filter's Address Pools Feature</h4>
<a name="indexterm-2323"></a><a name="indexterm-2324"></a><a name="indexterm-2325"></a><a name="indexterm-2326"></a><a name="indexterm-2327"></a><a name="indexterm-2328"></a><p>Address pools establish a single reference that is used to name a
group of address/netmask pairs. Address pools provide processes to reduce the time needed to
match IP addresses with rules.  Address pools also make managing large groups
of addresses easier.</p><p>Address pool configuration rules reside in the <tt>ippool.conf</tt> file. If you want the
address pool rules to be loaded at boot time, create a file called
<tt>/etc/ipf/ippool.conf</tt> in which to put address pool rules. If you do not want
the address pool rules loaded at boot time, put the <tt>ippool.conf</tt> file in
a location of your choice, and manually activate packet filtering with the <tt>ippool</tt>
command.</p>

<a name="euxby"></a><h5>Configuring Address Pools</h5>
<p>Use the following syntax to create an address pool:</p><pre>table role = <i>role-name</i> type = <i>storage-format</i> number = <i>reference-number</i></pre><dl><dt><tt>table</tt></dt>
<dd><p>Defines the reference for the multiple addresses.</p></dd>
<dt><tt>role</tt></dt>
<dd><p>Specifies the role of the pool in Solaris IP Filter. At this time, the only role you can reference is <tt>ipf</tt>.</p></dd>
<dt><tt>type</tt></dt>
<dd><p>Specifies the storage format for the pool.</p></dd>
<dt><tt>number</tt></dt>
<dd><p>Specifies the reference number that is used by the filtering rule.</p></dd>
</dl>
<p>For example, to reference the group of addresses <tt>10.1.1.1 and 10.1.1.2</tt>, and the network
<tt>192.16.1.0</tt> as pool number <tt>13</tt>, you would include the following rule in the address
pool configuration file:</p><pre>table role = ipf type = tree number = 13 
{ 10.1.1.1/32, 10.1.1.2/32, 192.168.1.0/24 };</pre><p>Then, to reference pool number <tt>13</tt> in a filtering rule, you would construct
the rule similar to the following example:</p><pre>pass in from pool/13 to any</pre><p>Note that you must load the pool file before loading the rules
file that contains a reference to the pool. If you do not, the
pool is undefined, as shown in the following output:</p><pre># ipfstat -io
empty list for ipfilter(out)
block in from pool/13(!) to any</pre><p>Even if you add the pool later, the addition of the pool
does not update the kernel rule set. You also need to reload the
rules file that references the pool.</p><p>For the complete grammar and syntax used to write packet filtering rules, see
the <a href="http://docs.sun.com/doc/819-2251/ippool-4?a=view"><tt>ippool</tt>(4)</a> man page.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="ezecz.html">Previous</a>
             </td>
             <td align="right">
                 <a href="gdwan.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

