<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Protecting Traffic With IPsec - System Administration Guide: IP Services</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2007-02-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo"></div>
   <div class="Title">System Administration Guide: IP Services</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="ipsec-mgtasks-2.html">Previous</a>
             </td>
             <td align="right">
                 <a href="ipsec-mgtasks-vpn-2.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="iptm-1.html">Part&nbsp;I&nbsp;TCP/IP Administration</a></p>
<p class="toc level2"><a href="ipov-1.html">1.&nbsp;&nbsp;Solaris TCPIP Protocol Suite (Overview)</a></p>
<p class="toc level2"><a href="ipplan-1.html">2.&nbsp;&nbsp;Planning an IPv4 Addressing Scheme (Tasks</a></p>
<p class="toc level2"><a href="ipv6-overview-7.html">3.&nbsp;&nbsp;Planning an IPv6 Addressing Scheme (Overview)</a></p>
<p class="toc level2"><a href="ipv6-planning-1.html">4.&nbsp;&nbsp;Planning an IPv6 Network (Tasks)</a></p>
<p class="toc level2"><a href="ipconfig-1.html">5.&nbsp;&nbsp;Configuring TCP/IP Network Services and IPv4 Addressing (Tasks)</a></p>
<p class="toc level2"><a href="fwawf.html">6.&nbsp;&nbsp;Administering Network Interfaces (Tasks)</a></p>
<p class="toc level2"><a href="ipv6-config-tasks-1.html">7.&nbsp;&nbsp;Enabling IPv6 on a Network (Tasks)</a></p>
<p class="toc level2"><a href="ipv6-admintasks-1.html">8.&nbsp;&nbsp;Administering a TCP/IP Network (Tasks)</a></p>
<p class="toc level2"><a href="gegel.html">9.&nbsp;&nbsp;Troubleshooting Network Problems (Tasks)</a></p>
<p class="toc level2"><a href="ipref-8.html">10.&nbsp;&nbsp;TCP/IP and IPv4 in Depth (Reference)</a></p>
<p class="toc level2"><a href="ipv6-ref-76.html">11.&nbsp;&nbsp;IPv6 in Depth (Reference)</a></p>
<p class="toc level1 tocsp"><a href="dhcptm-1.html">Part&nbsp;II&nbsp;DHCP</a></p>
<p class="toc level2"><a href="dhcp-overview-1.html">12.&nbsp;&nbsp;About Solaris DHCP (Overview)</a></p>
<p class="toc level2"><a href="chap2-26.html">13.&nbsp;&nbsp;Planning for DHCP Service (Tasks)</a></p>
<p class="toc level2"><a href="chapter3-20.html">14.&nbsp;&nbsp;Configuring the DHCP Service (Tasks)</a></p>
<p class="toc level2"><a href="dhcp-admin-9.html">15.&nbsp;&nbsp;Administering DHCP (Tasks)</a></p>
<p class="toc level2"><a href="eyatl.html">16.&nbsp;&nbsp;Configuring and Administering  DHCP Clients</a></p>
<p class="toc level2"><a href="dhcp-trouble-1.html">17.&nbsp;&nbsp;Troubleshooting DHCP (Reference)</a></p>
<p class="toc level2"><a href="dhcp-ref-4.html">18.&nbsp;&nbsp;DHCP Commands and Files (Reference)</a></p>
<p class="toc level1 tocsp"><a href="ipsectm-1.html">Part&nbsp;III&nbsp;IP Security</a></p>
<p class="toc level2"><a href="ipsec-ov-1.html">19.&nbsp;&nbsp;IP Security Architecture (Overview)</a></p>
<p class="toc level2"><a href="ipsec-mgtasks-1.html">20.&nbsp;&nbsp;Configuring IPsec (Tasks)</a></p>
<p class="toc level3"><a href="ipsec-mgtasks-2.html">Protecting Traffic With IPsec (Task Map)</a></p>
<div class="onpage">
<p class="toc level3"><a href="">Protecting Traffic With IPsec</a></p>
<p class="toc level4"><a href="#ipsec-mgtasks-3">How to Secure Traffic Between Two Systems With IPsec</a></p>
<p class="toc level4"><a href="#ipsec-mgtasks-16">How to Secure a Web Server With IPsec</a></p>
<p class="toc level4"><a href="#ipsec-mgtasks-14">How to Display IPsec Policies</a></p>
<p class="toc level4"><a href="#ipsec-mgtasks-12">How to Generate Random Numbers on a Solaris System</a></p>
<p class="toc level4"><a href="#ipsec-mgtasks-13">How to Manually Create IPsec Security Associations</a></p>
<p class="toc level4"><a href="#ipsec-mgtasks-11">How to Verify That Packets Are Protected With IPsec</a></p>
<p class="toc level4"><a href="#ipsec-mgtasks-18">How to Create a Role for Configuring Network Security</a></p>
</div>
<p class="toc level3 tocsp"><a href="ipsec-mgtasks-vpn-2.html">Protecting a VPN With IPsec (Task Map)</a></p>
<p class="toc level3"><a href="ipsec-mgtasks-vpn-4.html">Protecting a VPN With IPsec</a></p>
<p class="toc level4"><a href="ipsec-mgtasks-vpn-4.html#ipsec-mgtasks-23">How to Protect a VPN With an IPsec Tunnel in Tunnel Mode Over IPv4</a></p>
<p class="toc level4"><a href="ipsec-mgtasks-vpn-4.html#ipsec-mgtasks-15">How to Protect a VPN With an IPsec Tunnel in Tunnel Mode Over IPv6</a></p>
<p class="toc level4"><a href="ipsec-mgtasks-vpn-4.html#ipsec-mgtasks-24">How to Protect a VPN With an IPsec Tunnel in Transport Mode Over IPv4</a></p>
<p class="toc level4"><a href="ipsec-mgtasks-vpn-4.html#ipsec-mgtasks-26">How to Protect a VPN With an IPsec Tunnel  in Transport Mode Over IPv6</a></p>
<p class="toc level2 tocsp"><a href="ipsecref-1.html">21.&nbsp;&nbsp;IP Security Architecture (Reference)</a></p>
<p class="toc level2"><a href="ike-1.html">22.&nbsp;&nbsp;Internet Key Exchange (Overview)</a></p>
<p class="toc level2"><a href="ike-task-1.html">23.&nbsp;&nbsp;Configuring IKE (Tasks)</a></p>
<p class="toc level2"><a href="ikeref-1.html">24.&nbsp;&nbsp;Internet Key Exchange (Reference)</a></p>
<p class="toc level2"><a href="eupsq.html">25.&nbsp;&nbsp;Solaris IP Filter (Overview)</a></p>
<p class="toc level2"><a href="ipfilter-admin-1.html">26.&nbsp;&nbsp;Solaris IP Filter (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="miptm-1.html">Part&nbsp;IV&nbsp;Mobile IP</a></p>
<p class="toc level2"><a href="mipoverview-1.html">27.&nbsp;&nbsp;Mobile IP (Overview)</a></p>
<p class="toc level2"><a href="mipimplementing-1.html">28.&nbsp;&nbsp;Administering Mobile IP (Tasks)</a></p>
<p class="toc level2"><a href="mipmanaging-22.html">29.&nbsp;&nbsp;Mobile IP Files and Commands (Reference)</a></p>
<p class="toc level1 tocsp"><a href="ipmptm-1.html">Part&nbsp;V&nbsp;IPMP</a></p>
<p class="toc level2"><a href="mpoverview.html">30.&nbsp;&nbsp;Introducing IPMP (Overview)</a></p>
<p class="toc level2"><a href="deploynetmult-56.html">31.&nbsp;&nbsp;Administering IPMP (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="ipqostm-1.html">Part&nbsp;VI&nbsp;IP Quality of Service (IPQoS)</a></p>
<p class="toc level2"><a href="ipqos-intro-1.html">32.&nbsp;&nbsp;Introducing IPQoS (Overview)</a></p>
<p class="toc level2"><a href="ipqos-config-planning-1.html">33.&nbsp;&nbsp;Planning for an IPQoS-Enabled Network (Tasks)</a></p>
<p class="toc level2"><a href="ipqos-policy-planning-1.html">34.&nbsp;&nbsp;Creating the IPQoS Configuration File (Tasks)</a></p>
<p class="toc level2"><a href="ipqos-isp-setup-1.html">35.&nbsp;&nbsp;Starting and Maintaining IPQoS (Tasks)</a></p>
<p class="toc level2"><a href="ipqos-accounting-1.html">36.&nbsp;&nbsp;Using Flow Accounting and Statistics Gathering (Tasks)</a></p>
<p class="toc level2"><a href="ipqos-reference-1.html">37.&nbsp;&nbsp;IPQoS in Detail (Reference)</a></p>
<p class="toc level1 tocsp"><a href="glossary-1.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="ipsec-mgtasks-4"></a><h3>Protecting Traffic With IPsec</h3>
<p>This section provides procedures that enable you to secure traffic between two systems,
and to secure a web server. To protect a VPN, see <a href="ipsec-mgtasks-vpn-2.html">Protecting a VPN With IPsec (Task Map)</a>.
Additional procedures provide keying material, provide security associations, and verify that IPsec is
working as configured.</p><p>The following information applies to all IPsec configuration tasks:</p>
<ul><li><p><a name="indexterm-1738"></a><a name="indexterm-1739"></a><a name="indexterm-1740"></a><a name="indexterm-1741"></a><b>IPsec and zones &ndash;</b> To manage IPsec policy and keys for a non-global zone, create the IPsec policy file in the global zone, and run the IPsec configuration commands from the global zone. Use the source address which corresponds to the non-global zone that is being configured. You can also configure IPsec policy and keys in the global zone for the global zone. In the Solaris Express, Developer Edition 2/07 release, you can use IKE to manage keys in a non-global zone.</p></li>
<li><p><a name="indexterm-1742"></a><a name="indexterm-1743"></a><b>IPsec and RBAC &ndash;</b> To use roles to administer IPsec, see <a href="http://docs.sun.com/doc/819-3321/rbactask-1?a=view">Chapter 8, Using Role-Based Access Control (Tasks), in <i>System Administration Guide: Security Services</i></a>. For an example, see <a href="#ipsec-mgtasks-18">How to Create a Role for Configuring Network Security</a>.</p></li>
<li><p><a name="indexterm-1744"></a><a name="indexterm-1745"></a><b>IPsec and SCTP &ndash;</b> IPsec can be used to protect Streams Control Transmission Protocol (SCTP) associations, but caution must be used. For more information, see <a href="ipsec-ov-22.html">IPsec and SCTP</a>.</p></li></ul>


<a name="ipsec-mgtasks-3"></a><h4>How to Secure Traffic Between Two Systems With IPsec</h4>
<hr><p><b>Note - </b><a name="indexterm-1746"></a><a name="indexterm-1747"></a><a name="indexterm-1748"></a><a name="indexterm-1749"></a>You configure IPsec policy in the global zone. </p>
<hr>
<p>This procedure assumes the following setup:</p>
<ul><li><p>The two systems are named <tt>enigma</tt> and <tt>partym</tt>.</p></li>
<li><p>Each system has two addresses, an IPv4 address and an IPv6 address.</p></li>
<li><p>Each system invokes AH protection with the MD5 algorithm, which requires a key of 128 bits.</p></li>
<li><p>Each system invokes ESP protections with the 3DES algorithm, which requires a key of 192 bits.</p></li>
<li><p>Each system uses shared security associations.</p><p>With shared SAs, only one pair of SAs is needed to protect the two systems.</p></li></ul>
<ol>
<li><b>On the system console, assume the Primary Administrator role or become superuser.</b><p>The Primary Administrator role includes the Primary Administrator profile. To create the role
and assign the role to a user, see <a href="http://docs.sun.com/doc/819-2379/smcover-1?a=view">Chapter 2, Working With the Solaris Management Console (Tasks), in <i>System Administration Guide: Basic Administration</i></a>.</p>
<hr><p><b>Note - </b><a name="indexterm-1750"></a>Logging in remotely exposes security-critical traffic to eavesdropping. Even if you somehow protect
the remote login, the security of the system is reduced to the security
of the remote login session.</p>
<hr>
</li>
<li><a name="ipsec-mgtasks-ipnode-1"></a><b><a name="indexterm-1751"></a><a name="indexterm-1752"></a><a name="indexterm-1753"></a><a name="indexterm-1754"></a>On each system, add host entries to the <tt>/etc/inet/hosts</tt> file.</b><ol style="list-style-type: lower-alpha">
				 
<li><b>On a system that is named <tt>partym</tt>, type the following in the <tt>hosts</tt>
file:</b><pre># Secure communication with enigma
192.168.116.16 enigma
2001::aaaa:6666:6666 enigma</pre></li>
<li><b>On a system that is named <tt>enigma</tt>, type the following in the <tt>hosts</tt>
file:</b><pre># Secure communication with partym
192.168.13.213 partym
2001::eeee:3333:3333 partym</pre></li></ol></li>
<li><b><a name="indexterm-1755"></a>On each system, create the IPsec policy file.</b><p>The file name is <tt>/etc/inet/ipsecinit.conf</tt>. For an example, see the <tt>/etc/inet/ipsecinit.sample</tt> file.</p></li>
<li><a name="ipsec-mgtasks-policy-1"></a><b><a name="indexterm-1756"></a>Add an IPsec policy entry to the <tt>ipsecinit.conf</tt> file.</b><ol style="list-style-type: lower-alpha">
				 
<li><b>On the <tt>enigma</tt> system, add the following policy:</b><pre>{laddr enigma raddr partym} ipsec {auth_algs any encr_algs any sa shared}</pre></li>
<li><b>On the <tt>partym</tt> system, add the identical policy:</b><pre>{laddr partym raddr enigma} ipsec {auth_algs any encr_algs any sa shared}</pre><p>For the syntax of IPsec policy entries, see the <a href="http://docs.sun.com/doc/819-2240/ipsecconf-1m?a=view"><tt>ipsecconf</tt>(1M)</a> man page.</p></li></ol></li>
<li><a name="ipsec-mgtasks-sa-3"></a><b><a name="indexterm-1757"></a><a name="indexterm-1758"></a><a name="indexterm-1759"></a><a name="indexterm-1760"></a><a name="indexterm-1761"></a>On each system, add a pair of IPsec SAs between the two
systems.</b><p>You can configure Internet Key Exchange (IKE) to create the SAs automatically. You
can also add the SAs manually.</p>
<hr><p><b>Note - </b>You should use IKE unless you have good reason to generate and maintain
your keys manually. IKE key management is more secure than manual key management.</p>
<hr>

<ul><li><p>Configure IKE by following one of the configuration procedures in <a href="ike-task-7.html">Configuring IKE (Task Map)</a>. For the syntax of the IKE configuration file, see the <a href="http://docs.sun.com/doc/819-2251/ike.config-4?a=view"><tt>ike.config</tt>(4)</a> man page.</p></li>
<li><p>To add the SAs manually, see <a href="#ipsec-mgtasks-13">How to Manually Create IPsec Security Associations</a>. </p></li></ul>
</li>
<li><a name="ipsec-mgtasks-reboot-1"></a><b>Reboot each system.</b><pre># <tt><b>init 6</b></tt></pre></li>
<li><b>Verify that packets are being protected.</b><p>For the procedure, see <a href="#ipsec-mgtasks-11">How to Verify That Packets Are Protected With IPsec</a>.</p></li></ol><a name="ipsec-mgtasks-19"></a>Example&nbsp;20-1 Securing Traffic With IPsec Without Rebooting<p>The following example describes how to implement IPsec in a test environment. In
a production environment, it is more secure to reboot than to run
the <tt>ipsecconf</tt> command. For the security considerations, see the end of this example.</p><p>Instead of rebooting at <a href="#ipsec-mgtasks-reboot-1">Step&nbsp;6</a>, choose one of the following options.</p>
<ul><li><p><a name="indexterm-1762"></a>If you used IKE to create keying material, stop and then restart the <tt>in.iked</tt> daemon.</p><pre># <tt><b>pkill in.iked</b></tt>
# <tt><b>/usr/lib/inet/in.iked</b></tt></pre></li>
<li><p><a name="indexterm-1763"></a><a name="indexterm-1764"></a><a name="indexterm-1765"></a><a name="indexterm-1766"></a><a name="indexterm-1767"></a>If you added keys manually, use the <tt>ipseckey</tt> command to add the SAs to the database.</p><pre># <tt><b>ipseckey -f /etc/inet/secret/ipseckeys</b></tt></pre><p>Then activate the IPsec policy with the <tt>ipsecconf</tt> command.</p><pre># <tt><b>ipsecconf -a /etc/inet/ipsecinit.conf</b></tt></pre></li></ul>
<p><a name="indexterm-1768"></a><a name="indexterm-1769"></a><b>Security Considerations &ndash;</b> Read the warning when you execute the <tt>ipsecconf</tt> command. A socket that is
already latched, that is, a socket that is already in use, provides an
unsecured back door into the system. For more extensive discussion, see <a href="ipsecref-23.html#ipsecref-42">Security Considerations for <tt>ipsecinit.conf</tt> and <tt>ipsecconf</tt></a>.</p>

<a name="ipsec-mgtasks-16"></a><h4>How to Secure a Web Server With IPsec</h4><a name="indexterm-1770"></a><a name="indexterm-1771"></a><a name="indexterm-1772"></a><a name="indexterm-1773"></a><p>A secure web server allows web clients to talk to the web
service. On a secure web server, traffic that is not web traffic <b>must</b>
pass security checks. The following procedure includes bypasses for web traffic. In addition, this
web server can make nonsecured DNS client requests. All other traffic requires ESP
with AES and SHA-1 algorithms.</p>
<hr><p><b>Note - </b>You configure IPsec policy in the global zone. </p>
<hr>
<ol>
<li><b>On the system console, assume the Primary Administrator role or become superuser.</b><p>The Primary Administrator role includes the Primary Administrator profile. To create the role
and assign the role to a user, see <a href="http://docs.sun.com/doc/819-2379/smcover-1?a=view">Chapter 2, Working With the Solaris Management Console (Tasks), in <i>System Administration Guide: Basic Administration</i></a>.</p>
<hr><p><b>Note - </b>Logging in remotely exposes security-critical traffic to eavesdropping. Even if you somehow protect
the remote login, the security of the system is reduced to the security
of the remote login session.</p>
<hr>
</li>
<li><a name="ipsec-mgtasks-bypass-1"></a><b>Determine which services need to bypass security policy checks.</b><p>For a web server, these services include TCP ports 80 (HTTP) and 443
(Secure HTTP). If the web server provides DNS name lookups, the server might
also need to include port 53 for both TCP and UDP.</p></li>
<li><a name="ipsec-mgtasks-webfile-1"></a><b><a name="indexterm-1774"></a>Create a file in the <tt>/etc/inet</tt> directory for the web server policy.</b><p>Give the file a name that indicates its purpose, for example <tt>IPsecWebInitFile</tt>. Type
the following lines in this file:</p><pre># Web traffic that web server should bypass.
{lport  80 ulp tcp dir both} bypass {}
{lport 443 ulp tcp dir both} bypass {}

# Outbound DNS lookups should also be bypassed.
{rport 53 dir both} bypass {}

# Require all other traffic to use ESP with AES and SHA-1.
# Use a unique SA for outbound traffic from the port
{} ipsec {encr_algs aes encr_auth_algs sha1 sa shared}</pre><p>This configuration allows only secure traffic to access the system, with the bypass
exceptions that are described in <a href="#ipsec-mgtasks-bypass-1">Step&nbsp;2</a>.</p></li>
<li><a name="ipsec-mgtasks-init-2"></a><b><a name="indexterm-1775"></a><a name="indexterm-1776"></a>Copy the contents of the file that you created in <a href="#ipsec-mgtasks-webfile-1">Step&nbsp;3</a> into
the <tt>/etc/inet/ipsecinit.conf</tt> file.</b></li>
<li><b>Protect the <tt>IPsecWebInitFile</tt> file with read-only permissions.</b><pre># <tt><b>chmod 400 IPsecWebInitFile</b></tt></pre></li>
<li><b>Secure the web server without rebooting. </b><p>Choose one of the following options.</p>
<ul><li><p>If you are using IKE for key management, stop and restart the <tt>in.iked</tt> daemon.</p><pre># <tt><b>pkill in.iked</b></tt>
# <tt><b>/usr/lib/inet/in.iked</b></tt></pre></li>
<li><p>If you are manually managing keys, use the <tt>ipseckey</tt> and <tt>ipsecconf</tt> commands.</p><p>Use the <tt>IPsecWebInitFile</tt> as the argument to the <tt>ipsecconf</tt> command. If you use the <tt>ipsecinit.conf</tt> file as the argument, the <tt>ipsecconf</tt> command generates errors when policies in the file are already implemented on the system.</p><pre># <tt><b>ipseckey -f /etc/inet/secret/ipseckeys</b></tt> 
# <tt><b>ipsecconf -a /etc/inet/IPsecWebInitFile</b></tt> </pre></li></ul>

<hr><p><b>Caution - </b>Read the warning when you execute the <tt>ipsecconf</tt> command. A socket that is
already latched, that is, a socket that is already in use, provides an
unsecured back door into the system. For more extensive discussion, see <a href="ipsecref-23.html#ipsecref-42">Security Considerations for <tt>ipsecinit.conf</tt> and <tt>ipsecconf</tt></a>. The
same warning applies to restarting the <tt>in.iked</tt> daemon.</p>
<hr>
<p>You can also reboot. Rebooting ensures that the IPsec policy is in
effect on all TCP connections. At reboot, the TCP connections use the policy
in the IPsec policy file.</p></li>
<li>(Optional) <b>Enable a remote system to communicate with the web server for nonweb traffic.</b><p>Type the following policy in a remote system's <tt>ipsecinit.conf</tt> file.</p><pre># Communicate with web server about nonweb stuff
#
{laddr webserver} ipsec {encr_algs aes encr_auth_algs sha1 sa shared}</pre><p>A remote system can communicate securely with the web server for nonweb traffic
only when the systems' IPsec policies match.</p></li></ol>

<a name="ipsec-mgtasks-14"></a><h4>How to Display IPsec Policies</h4><a name="indexterm-1777"></a><a name="indexterm-1778"></a><a name="indexterm-1779"></a><a name="indexterm-1780"></a><p>You can see the policies that are configured in the system when
you issue the <tt>ipsecconf</tt> command without any arguments. The command must be run from
the global zone.</p><ol>
<li><b>Assume a role that includes the Network Security profile, or become superuser.</b><p>To create a role that includes the Network Security profile and assign that
role to a user, see <a href="#ipsec-mgtasks-18">How to Create a Role for Configuring Network Security</a>.</p></li>
<li><b>Display the global IPsec policy entries in the order that the entries
were added.</b><pre>$ <tt><b>ipsecconf</b></tt></pre><p>The command displays each entry with an <b>index</b> followed by a number.</p></li>
<li><b><a name="indexterm-1781"></a>Display the IPsec policy entries in the order in which a match
occurs.</b><pre>$ <tt><b>ipsecconf -l</b></tt></pre></li>
<li><b><a name="indexterm-1782"></a>Display the IPsec policy entries, including per-tunnel entries, in the order in which
a match occurs.</b><pre>$ <tt><b>ipsecconf -L</b></tt></pre></li></ol>

<a name="ipsec-mgtasks-12"></a><h4>How to Generate Random Numbers on a Solaris System</h4><a name="indexterm-1783"></a><a name="indexterm-1784"></a><a name="indexterm-1785"></a><a name="indexterm-1786"></a><p><a name="indexterm-1787"></a>If you are entering keys manually, the keying material should be random. The
format for keying material for a Solaris system is hexadecimal. Other operating systems can
require ASCII keying material. To generate keying material for a Solaris system that
is communicating with an operating system that requires ASCII, see <a href="ike-task-15.html#iketask-key-ex-1">Example&nbsp;23-1</a>.</p><p>If your site has a random number generator, use that generator. Otherwise, you
can use the <tt>od</tt> command with the <tt>/dev/random</tt> Solaris device as input. For
more information, see the <a href="http://docs.sun.com/doc/819-2239/od-1?a=view"><tt>od</tt>(1)</a> man page.</p><ol>
<li><b>Generate random numbers in hexadecimal format.</b><pre>% od -x|-X -A n <i>file</i> | head -<i>n</i></pre><dl><dt><tt>-x</tt></dt>
<dd><p>Displays the octal dump in hexadecimal format. Hexadecimal format is useful for keying material. The hexadecimal is printed in 4-character chunks.</p></dd>
<dt><tt>-X</tt></dt>
<dd><p>Displays the octal dump in hexadecimal format. The hexadecimal is printed in 8-character chunks.</p></dd>
<dt><tt>-A</tt> n</dt>
<dd><p>Removes the input offset base from the display.</p></dd>
<dt><i>file</i></dt>
<dd><p>Serves as a source for random numbers.</p></dd>
<dt><tt>head -</tt><i>n</i></dt>
<dd><p>Restricts the display to the first <i>n</i> lines of output.</p></dd>
</dl>
</li>
<li><b>Combine the output to create a key of the appropriate length.</b><p><a name="indexterm-1788"></a>Remove the spaces between the numbers on one line to create a 32-character
key. A 32-character key is 128 bits. For a security parameter index (SPI),
you should use an 8-character key. The key should use the <tt>0x</tt>
prefix.</p></li></ol><a name="ike-task-33"></a>Example&nbsp;20-2 Generating Key Material for IPsec<p>The following example displays two lines of keys in groups of eight hexadecimal
characters each.</p><pre>% <tt><b>od -X -A n /dev/random | head -2</b></tt>
         d54d1536 4a3e0352 0faf93bd 24fd6cad
         8ecc2670 f3447465 20db0b0c c83f5a4b</pre><p><a name="indexterm-1789"></a><a name="indexterm-1790"></a>By combining the four numbers on the first line, you can create a
32-character key. An 8-character number that is preceded by <tt>0x</tt> provides a suitable
SPI value, for example, <tt>0xf3447465</tt>.</p><p>The following example displays two lines of keys in groups of four
hexadecimal characters each.</p><pre>% <tt><b>od -x -A n /dev/random | head -2</b></tt>
         34ce 56b2 8b1b 3677 9231 42e9 80b0 c673
         2f74 2817 8026 df68 12f4 905a db3d ef27</pre><p>By combining the eight numbers on the first line, you can create
a 32-character key.</p>

<a name="ipsec-mgtasks-13"></a><h4>How to Manually Create IPsec Security Associations</h4><a name="indexterm-1791"></a><a name="indexterm-1792"></a><a name="indexterm-1793"></a><a name="indexterm-1794"></a><a name="indexterm-1795"></a><a name="indexterm-1796"></a><a name="indexterm-1797"></a>
<hr><p><b>Note - </b>You manually manage keying material for a non-global zone from the global zone.</p>
<hr>
<p>The following procedure provides the keying material for the procedure, <a href="#ipsec-mgtasks-3">How to Secure Traffic Between Two Systems With IPsec</a>.</p><ol>
<li><a name="ipsec-mgtasks-keymat-1"></a><b>Generate the keying material for the SAs. </b><p>You need three hexadecimal random numbers for outbound traffic and three hexadecimal random
numbers for inbound traffic.</p><p>Therefore, one system needs to generate the following numbers:</p>
<ul><li><p>Two hexadecimal random numbers as the value for the <tt>spi</tt> keyword. One number is for outbound traffic. One number is for inbound traffic. Each number can be up to eight characters long.</p></li>
<li><p>Two hexadecimal random numbers for the MD5 algorithm for AH. Each number must be 32 characters long. One number is for <tt>dst enigma</tt>. One number is for <tt>dst partym</tt>.</p></li>
<li><p>Two hexadecimal random numbers for the 3DES algorithm for ESP. For a 192-bit key, each number must be 48 characters long. One number is for <tt>dst enigma</tt>. One number is for <tt>dst partym</tt>.</p></li></ul>
<p>If you have a random number generator at your site, use the
generator. You can also use the <tt>od</tt> command. See <a href="#ipsec-mgtasks-12">How to Generate Random Numbers on a Solaris System</a> for the procedure.</p></li>
<li><a name="ipsec-mgtasks-createsa-1"></a><b>On the system console on one of the systems, assume the Primary Administrator
role or become superuser.</b><p>The Primary Administrator role includes the Primary Administrator profile. To create the role
and assign the role to a user, see <a href="http://docs.sun.com/doc/819-2379/smcover-1?a=view">Chapter 2, Working With the Solaris Management Console (Tasks), in <i>System Administration Guide: Basic Administration</i></a>.</p>
<hr><p><b>Note - </b>Logging in remotely exposes security-critical traffic to eavesdropping. Even if you somehow protect
the remote login, the security of the system is reduced to the security
of the remote login session.</p>
<hr>
</li>
<li><b>Enable the <tt>ipseckey</tt> command mode:</b><pre># <tt><b>ipseckey</b></tt>

></pre><p><a name="indexterm-1798"></a><a name="indexterm-1799"></a><a name="indexterm-1800"></a><a name="indexterm-1801"></a>The > prompt indicates that you are in <tt>ipseckey</tt> command mode.</p></li>
<li><b><a name="indexterm-1802"></a><a name="indexterm-1803"></a>If you are replacing existing SAs, flush the current SAs.</b><pre>> <tt><b>flush</b></tt>
> </pre><p><a name="indexterm-1804"></a><a name="indexterm-1805"></a><a name="indexterm-1806"></a><a name="indexterm-1807"></a>To prevent an adversary from having time to break your SAs, you need
to replace the keying material.</p>
<hr><p><b>Note - </b>You must coordinate key replacement on communicating systems. When you replace the SAs
on one system, the SAs must also be replaced on the remote system.</p>
<hr>
</li>
<li><b>To create SAs, type the following command.</b><pre>> <tt><b>add </tt><i>protocol</i><tt> spi </tt><i>random-hex-string</i><tt> \</b></tt>
<tt><b>src </tt><i>addr</i><tt> dst </tt><i>addr2</i><tt> \</b></tt>
<tt><b></tt><i>protocol-prefix</i><tt>_alg </tt><i>protocol-algorithm</i><tt> \</b></tt>
<tt><b></tt><i>protocol-prefix</i><tt>key </tt><i>random-hex-string-of-algorithm-specified-length</i><tt></b></tt></pre><p>You also use this syntax to replace SAs that you have just
flushed.</p><dl><dt><i>protocol</i></dt>
<dd><p>Specifies either <tt>esp</tt> or <tt>ah</tt>.</p></dd>
<dt><i>random-hex-string</i></dt>
<dd><p>Specifies a random number of up to eight characters in hexadecimal format. Precede the characters with <tt>0x</tt>. If you enter more numbers than the security parameter index (SPI) accepts, the system ignores the extra numbers. If you enter fewer numbers than the SPI accepts, the system pads your entry.</p></dd>
<dt><i>addr</i></dt>
<dd><p>Specifies the IP address of one system.</p></dd>
<dt><i>addr2</i></dt>
<dd><p>Specifies the IP address of the peer system of <i>addr</i>.</p></dd>
<dt><i>protocol-prefix</i></dt>
<dd><p>Specifies one of <tt>encr</tt> or <tt>auth</tt>. The <tt>encr</tt> prefix is used with the <tt>esp</tt> protocol. The <tt>auth</tt> prefix is used with the <tt>ah</tt> protocol, and for authenticating the <tt>esp</tt> protocol.</p></dd>
<dt><i>protocol-algorithm</i></dt>
<dd><p>Specifies an algorithm for ESP or AH. Each algorithm requires a key of a specific length.</p><p>Authentication algorithms include MD5 and SHA. Encryption algorithms include 3DES and AES.</p></dd>
<dt><i>random-hex-string-of-algorithm-specified-length</i></dt>
<dd><p><a name="indexterm-1808"></a><a name="indexterm-1809"></a>Specifies a random hexadecimal number of the length that is required by the algorithm. For example, the MD5 algorithm requires a 32-character string for its 128-bit key. The 3DES algorithm requires a 48-character string for its 192-bit key.</p></dd>
</dl>
<ol style="list-style-type: lower-alpha">
				 
<li><b>For example, on the <tt>enigma</tt> system, protect outbound packets.</b><p>Use the random numbers that you generated in <a href="#ipsec-mgtasks-keymat-1">Step&nbsp;1</a>.</p><p>For Solaris 10 1/06:</p><pre>> <tt><b>add esp spi 0x8bcd1407 \</b></tt>
<tt><b>src 192.168.116.16 dst 192.168.13.213 \</b></tt>
<tt><b>encr_alg 3des \</b></tt>
<tt><b>auth_alg md5 \</b></tt>
<tt><b>encrkey d41fb74470271826a8e7a80d343cc5aae9e2a7f05f13730d</b></tt> \
<tt><b>authkey e896f8df7f78d6cab36c94ccf293f031</b></tt>
></pre>
<hr><p><b>Note - </b>The peer system must use the same keying material and the same SPI.</p>
<hr>
</li>
<li><b>Still in <tt>ipseckey</tt> command mode on the <tt>enigma</tt> system, protect inbound packets.</b><p>Type the following commands to protect the packets:</p><pre>> <tt><b>add esp spi 0x122a43e4 \</b></tt>
<tt><b>src 192.168.13.213 dst 192.168.116.16 \</b></tt>
<tt><b>encr_alg 3des \</b></tt>
<tt><b>auth_alg md5 \</b></tt>
<tt><b>encrkey dd325c5c137fb4739a55c9b3a1747baa06359826a5e4358e</b></tt> \
<tt><b>authkey ad9ced7ad5f255c9a8605fba5eb4d2fd</b></tt>
></pre>
<hr><p><b>Note - </b>The keys and SPI can be different for each SA. You <b>should</b>
assign different keys and a different SPI for each SA.</p>
<hr>
</li></ol></li>
<li><b>To exit <tt>ipseckey</tt> command mode, press Control-D or type <tt>quit</tt>.</b></li>
<li><a name="ipsec-mgtasks-createsa-2"></a><b>To ensure that the keying material is available to IPsec at reboot, add
the keying material to the <tt>/etc/inet/secret/ipseckeys</tt> file.</b><p>The  lines  of the <tt>/etc/inet/secret/ipseckeys</tt> file are identical to the
command line language.</p><ol style="list-style-type: lower-alpha">
				 
<li><b>For example, the <tt>/etc/inet/secret/ipseckeys</tt> file on the <tt>enigma</tt> system would appear similar to
the following:</b><pre># ipseckeys - This file takes the file format documented in 
#   ipseckey(1m).
#   Note that naming services might not be available when this file
#   loads, just like ipsecinit.conf.
#
# for outbound packets on enigma
add esp spi 0x8bcd1407 \
   src 192.168.116.16 dst 192.168.13.213  \
   encr_alg 3des \
   auth_alg md5  \
   encrkey  d41fb74470271826a8e7a80d343cc5aae9e2a7f05f13730d \
   authkey  e896f8df7f78d6cab36c94ccf293f031
#
# for inbound packets
add esp spi 0x122a43e4 \
   src 192.168.13.213 dst 192.168.116.16 \
   encr_alg 3des \
   auth_alg md5  \
   encrkey dd325c5c137fb4739a55c9b3a1747baa06359826a5e4358e \
   authkey ad9ced7ad5f255c9a8605fba5eb4d2fd</pre></li>
<li><b><a name="indexterm-1810"></a>Protect the file with read-only permissions.</b><pre># <tt><b>chmod 400 /etc/inet/secret/ipseckeys</b></tt></pre></li></ol></li>
<li><b>Repeat <a href="#ipsec-mgtasks-createsa-1">Step&nbsp;2</a> through <a href="#ipsec-mgtasks-createsa-2">Step&nbsp;7</a> on the <tt>partym</tt> system. </b><p>Use the same keying material that was used on <tt>enigma</tt>.</p><p>The keying material on the two systems <b>must</b> be identical. As shown in
the following example, only the comments in the <tt>ipseckeys</tt> file differ. The
comments differ because <tt>dst enigma</tt> is inbound on the <tt>enigma</tt> system, and outbound on
the <tt>partym</tt> system.</p><pre># partym ipseckeys file
#
<tt><b># for inbound packets</b></tt>
add esp spi 0x8bcd1407 \
   src 192.168.116.16 dst 192.168.13.213  \
   encr_alg 3des \
   auth_alg md5  \
   encrkey  d41fb74470271826a8e7a80d343cc5aae9e2a7f05f13730d \
   authkey  e896f8df7f78d6cab36c94ccf293f031
#
<tt><b># for outbound packets</b></tt>
add esp spi 0x122a43e4 \
   src 192.168.13.213 dst 192.168.116.16 \
   encr_alg 3des \
   auth_alg md5  \
   encrkey dd325c5c137fb4739a55c9b3a1747baa06359826a5e4358e \
   authkey ad9ced7ad5f255c9a8605fba5eb4d2fd</pre></li></ol>

<a name="ipsec-mgtasks-11"></a><h4>How to Verify That Packets Are Protected With IPsec</h4><a name="indexterm-1811"></a><a name="indexterm-1812"></a><a name="indexterm-1813"></a><a name="indexterm-1814"></a><p>To verify that packets are protected, test the connection with the <tt>snoop</tt>
command. The following prefixes can appear in the <tt>snoop</tt> output:</p>
<ul><li><p><tt>AH:</tt> Prefix indicates that AH is protecting the headers. You see <tt>AH:</tt> if you used <tt>auth_alg</tt> to protect the traffic.</p></li>
<li><p><tt>ESP:</tt> Prefix indicates that encrypted data is being sent. You see <tt>ESP:</tt> if you used <tt>encr_auth_alg</tt> or <tt>encr_alg</tt> to protect the traffic.</p></li></ul>
<h6>Before You Begin</h6><p>You must be superuser or have assumed an equivalent role to create
the <tt>snoop</tt> output. You must have access to both systems to test
the connection.</p><ol>
<li><b>On one system, such as <tt>partym</tt>, become superuser.</b><pre>% <tt><b>su -</b></tt>
Password: Type root password
# </pre></li>
<li><b>From the <tt>partym</tt> system, prepare to snoop packets from a remote system.</b><p>In a terminal window on <tt>partym</tt>, snoop the packets from the <tt>enigma</tt> system.</p><pre># <tt><b>snoop -v enigma</b></tt>
Using device /dev/hme (promiscuous mode)</pre></li>
<li><b>Send a packet from the remote system.</b><p>In another terminal window, remotely log in to the <tt>enigma</tt> system. Provide your password.
Then, become superuser and send a packet from the <tt>enigma</tt> system to the
<tt>partym</tt> system. The packet should be captured by the <tt>snoop -v enigma</tt> command.</p><pre>% <tt><b>ssh enigma</b></tt>
Password: Type your password
% <tt><b>su -</b></tt>
Password: Type root password
# <tt><b>ping partym</b></tt></pre></li>
<li><b>Examine the <tt>snoop</tt> output.</b><p>On the <tt>partym</tt> system, you should see output that includes <tt>AH</tt> and <tt>ESP</tt>
information after the initial <tt>IP</tt> header information. <tt>AH</tt> and <tt>ESP</tt> information that resembles
the following shows that packets are being protected:</p><pre>IP:   Time to live = 64 seconds/hops
IP:   Protocol = 51 (AH)
IP:   Header checksum = 4e0e
IP:   Source address = 192.168.116.16, enigma
IP:   Destination address = 192.168.13.213, partym
IP:   No options
IP:
AH:  ----- Authentication Header -----
AH:
AH:  Next header = 50 (ESP)
AH:  AH length = 4 (24 bytes)
AH:  &lt;Reserved field = 0x0>
AH:  SPI = 0xb3a8d714
AH:  Replay = 52
AH:  ICV = c653901433ef5a7d77c76eaa
AH:
ESP:  ----- Encapsulating Security Payload -----
ESP:
ESP:  SPI = 0xd4f40a61
ESP:  Replay = 52
ESP:     ....ENCRYPTED DATA....

ETHER:  ----- Ether Header -----
...</pre></li></ol>

<a name="ipsec-mgtasks-18"></a><h4>How to Create a Role for Configuring Network Security</h4><a name="indexterm-1815"></a><a name="indexterm-1816"></a><a name="indexterm-1817"></a><a name="indexterm-1818"></a><a name="indexterm-1819"></a><p>If you are using role-based access control (RBAC) to administer your systems, you
use this procedure to provide a network management or network security role.</p><ol>
<li><b>Find the Network rights profiles in the local <tt>prof_attr</tt> database.</b><pre>% <tt><b>cd /etc/security</b></tt>
% <tt><b>grep Network prof_attr</b></tt>
Network Management:::Manage the host and network configuration &hellip;
Network Security:::Manage network and host security &hellip;
System Administrator:::&hellip;Network Management&hellip;</pre><p>The Network Management profile is a supplementary profile in the System Administrator profile.
If you have included the System Administrator rights profile in a role, then
that role can execute the commands in the Network Management profile.</p></li>
<li><b><a name="indexterm-1820"></a><a name="indexterm-1821"></a>Determine which commands are in the Network Management rights profile.</b><pre>% <tt><b>grep "Network Management" /etc/security/exec_attr</b></tt>
Network Management:solaris:cmd:::/usr/sbin/ifconfig:privs=sys_net_config
&hellip;
Network Management:suser:cmd:::/usr/sbin/snoop:uid=0</pre><p>The <tt>solaris</tt> policy commands run with privilege (<tt>privs=sys_net_config</tt>). The <tt>suser</tt> policy commands run
as superuser (<tt>uid=0</tt>).</p></li>
<li><b><a name="indexterm-1822"></a><a name="indexterm-1823"></a>Determine which commands are in the Network Security rights profile.</b><pre>% <tt><b>grep "Network Security" /etc/security/exec_attr</b></tt>
&hellip;
Network Security:solaris:cmd:::/usr/sbin/ipsecconf:privs=sys_net_config
&hellip;
Network Security:solaris:cmd:::/usr/sbin/ipseckey:privs=sys_net_config
&hellip;</pre></li>
<li><b>Create a role that includes the Network Security and the Network Management rights
profiles.</b><p>A role with both profiles can execute the <tt>ifconfig</tt>, <tt>snoop</tt>, <tt>ipsecconf</tt>, and <tt>ipseckey</tt> commands,
among others, with appropriate privilege.</p><p>To create the role, assign the role to a user, and register
the changes with the name service, see <a href="http://docs.sun.com/doc/819-3321/rbactask-15?a=view">Configuring RBAC (Task Map) in <i>System Administration Guide: Security Services</i></a>.</p></li></ol>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="ipsec-mgtasks-2.html">Previous</a>
             </td>
             <td align="right">
                 <a href="ipsec-mgtasks-vpn-2.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

