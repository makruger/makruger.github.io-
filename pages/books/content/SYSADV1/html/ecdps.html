<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Troubleshooting the Service Management Facility - System Administration Guide: Basic Administration</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-12-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">System Administration Guide: Basic Administration</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="fahqr.html">Previous</a>
             </td>
             <td align="right">
                 <a href="swmgrpkgsconcepts-52619.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="vol1preface-11.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="saroadmap-1.html">1.&nbsp;&nbsp;Solaris Management Tools (Road Map)</a></p>
<p class="toc level1 tocsp"><a href="smcover-1.html">2.&nbsp;&nbsp;Working With the Solaris Management Console (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="ewpor.html">3.&nbsp;&nbsp;Working With the Sun Java Web Console (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="userconcept-97366.html">4.&nbsp;&nbsp;Managing User Accounts and Groups (Overview)</a></p>
<p class="toc level1 tocsp"><a href="usersetup-92366.html">5.&nbsp;&nbsp;Managing User Accounts and Groups (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="clientconcept-15236.html">6.&nbsp;&nbsp;Managing Client-Server Support (Overview)</a></p>
<p class="toc level1 tocsp"><a href="clientsetup-1.html">7.&nbsp;&nbsp;Managing Diskless Clients (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="hbintro-66644.html">8.&nbsp;&nbsp;Introduction to Shutting Down and Booting a System</a></p>
<p class="toc level1 tocsp"><a href="hboverview-25463.html">9.&nbsp;&nbsp;Shutting Down and Booting a System (Overview)</a></p>
<p class="toc level1 tocsp"><a href="hbsyshalt-84412.html">10.&nbsp;&nbsp;Shutting Down a System (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="grubtasks-1.html">11.&nbsp;&nbsp;Modifying Solaris Boot Behavior (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="hbsparcboot-79782.html">12.&nbsp;&nbsp;Booting a Solaris System (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="hbtsboot-1.html">13.&nbsp;&nbsp;Troubleshooting Booting a Solaris System (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="archive-123.html">14.&nbsp;&nbsp;Managing the Solaris Boot Archives (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="hbsysboot-76719.html">15.&nbsp;&nbsp;x86: GRUB Based Booting (Reference)</a></p>
<p class="toc level1 tocsp"><a href="hbrunlevels-25516.html">16.&nbsp;&nbsp;Managing Services (Overview)</a></p>
<p class="toc level1 tocsp"><a href="faauf.html">17.&nbsp;&nbsp;Managing Services (Tasks)</a></p>
<p class="toc level2"><a href="eqbrp.html">Managing Services (Task Map)</a></p>
<p class="toc level2"><a href="dzhaq.html">Monitoring SMF Services</a></p>
<p class="toc level2"><a href="gdqyb.html">Managing SMF Services (Task Map)</a></p>
<p class="toc level2"><a href="eqbrs.html">Managing SMF Services</a></p>
<p class="toc level2"><a href="eqbwh.html">Configuring SMF Services</a></p>
<p class="toc level2"><a href="etesg.html">Using Run Control Scripts (Task Map)</a></p>
<p class="toc level2"><a href="fahqr.html">Using Run Control Scripts</a></p>
<div class="onpage">
<p class="toc level2"><a href="">Troubleshooting the Service Management Facility</a></p>
</div>
<p class="toc level1 tocsp"><a href="swmgrpkgsconcepts-52619.html">18.&nbsp;&nbsp;Managing Software (Overview)</a></p>
<p class="toc level1 tocsp"><a href="swmgrpkgsgui-1.html">19.&nbsp;&nbsp;Managing Software With Solaris System Administration Tools (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="swmgrpkgscli-1.html">20.&nbsp;&nbsp;Managing Software by Using Package Commands (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="swmgrpatchtasks-1.html">21.&nbsp;&nbsp;Managing Solaris Patches by Using the <tt>patchadd</tt> Command (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="fddwm.html">A.&nbsp;&nbsp;SMF Services</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="ecdps"></a><h3>Troubleshooting the Service Management Facility</h3>


<a name="ecdwg"></a><h4>Debugging a Service That Is Not Starting</h4><p>In this procedure, the print service is disabled.</p><ol>
<li><b>Become superuser or assume a role that includes the <tt>Service Management</tt> rights profile.</b><p>Roles contain authorizations and privileged commands. For more information about roles, see <a href="http://docs.sun.com/doc/819-3321/rbactask-30?a=view">Configuring RBAC in <i>System Administration Guide: Security Services</i></a>.</p></li>
<li><b>Request information about the hung service.</b><pre># <tt><b>svcs -xv</b></tt>
svc:/application/print/server:default (LP Print Service)
 State: disabled since Wed 13 Oct 2004 02:20:37 PM PDT
Reason: Disabled by an administrator.
   See: http://sun.com/msg/SMF-8000-05
   See: man -M /usr/share/man -s 1M lpsched
Impact: 2 services are not running:
        svc:/application/print/rfc1179:default
        svc:/application/print/ipp-listener:default</pre><p>The <tt>-x</tt> option provides additional information about the service instances that are impacted.</p></li>
<li><b>Enable the service.</b><pre># <tt><b>svcadm enable application/print/server</b></tt></pre></li></ol>

<a name="ecduh"></a><h4>How to Repair a Corrupt Repository</h4><p>This procedure shows how to replace a corrupt repository with a default copy
of the repository. When the repository daemon, <tt>svc.configd</tt>, is started, it does an
integrity check of the configuration repository. This repository is stored in <tt>/etc/svc/repository.db</tt>. The
repository can become corrupted due to one of the following reasons:</p>
<ul><li><p>Disk failure</p></li>
<li><p>Hardware bug</p></li>
<li><p>Software bug</p></li>
<li><p>Accidental overwrite of the file</p></li></ul>
<p>If the integrity check fails, the <tt>svc.configd</tt> daemon writes a message to the
console similar to the following:</p><pre>svc.configd: smf(5) database integrity check of:

    /etc/svc/repository.db

  failed.  The database might be damaged or a media error might have
  prevented it from being verified.  Additional information useful to
  your service provider is in:

    /etc/svc/volatile/db_errors

  The system will not be able to boot until you have restored a working
  database.  svc.startd(1M) will provide a sulogin(1M) prompt for recovery
  purposes.  The command:

    /lib/svc/bin/restore_repository

  can be run to restore a backup version of your repository. See
  http://sun.com/msg/SMF-8000-MY for more information.</pre><p>The <tt>svc.startd</tt> daemon then exits and starts <tt>sulogin</tt> to enable you to
perform maintenance.</p><ol>
<li><b>Enter the <tt>root</tt> password at the <tt>sulogin</tt> prompt. <tt>sulogin</tt> enables the <tt>root</tt>
user to enter system maintenance mode to repair the system.</b></li>
<li><b>Run the following command:</b><pre># <tt><b>/lib/svc/bin/restore_repository</b></tt></pre><p>Running this command takes you through the necessary steps to restore a non-corrupt
backup. SMF automatically takes backups of the repository at key system moments. For
more information see <a href="dzhid.html#frjjz">SMF Repository Backups</a>.</p><p>When started, the <tt>/lib/svc/bin/restore_repository</tt> command displays a message similar to the following:</p><pre>Repository Restore utility
See http://sun.com/msg/SMF-8000-MY for more information on the use of
this script to restore backup copies of the smf(5) repository.

If there are any problems which need human intervention, this script
will give instructions and then exit back to your shell.

Note that upon full completion of this script, the system will be
rebooted using reboot(1M), which will interrupt any active services.</pre><p>If the system that you are recovering is not a local zone,
the script explains how to remount the <tt>/</tt> and <tt>/usr</tt> file systems with read
and write permissions to recover the databases. The script exits after printing these
instructions. Follow the instructions, paying special attention to any errors that might occur.</p><p>After the <tt>root</tt> (<tt>/</tt>) file system is mounted with write permissions, or
if the system is a local zone, you are prompted to select the
repository backup to restore:</p><pre>The following backups of /etc/svc/repository.db exists, from
oldest to newest:

... <i>list of backups</i> ...</pre><p>Backups are given names, based on type and the time the backup
was taken. Backups beginning with <tt>boot</tt> are completed before the first change is made
to the repository after system boot.  Backups beginning with <tt>manifest_import</tt> are
completed after <tt>svc:/system/manifest-import:default</tt> finishes its process. The time of the backup is
given in <i>YYYYMMDD_HHMMSS</i> format.</p></li>
<li><b>Enter the appropriate response.</b><p>Typically, the most recent backup option is selected.</p><pre>Please enter one of:
        1) boot, for the most recent post-boot backup
        2) manifest_import, for the most recent manifest_import backup.
        3) a specific backup repository from the above list
        4) -seed-, the initial starting repository. (All customizations
           will be lost.)
        5) -quit-, to cancel.

Enter response [boot]:</pre><p>If you press Enter without specifying a backup to restore, the default response,
enclosed in <tt>[]</tt>  is selected. Selecting <tt>-quit-</tt> exits the <tt>restore_repository</tt> script,
returning  you to your shell prompt.</p>
<hr><p><b>Note - </b>Selecting <tt>-seed-</tt> restores the <tt>seed</tt> repository. This repository is designed for use during
initial installation and upgrades. Using the <tt>seed</tt> repository for recovery purposes should be a
last resort.</p>
<hr>
<p>After the backup to restore has been selected, it is validated and
its integrity is checked. If there are any problems, the <tt>restore_repository</tt> command prints error
messages and prompts you for another selection. Once a valid backup is selected,
the following information is printed, and you are prompted for final confirmation.</p><pre>After confirmation, the following steps will be taken:

svc.startd(1M) and svc.configd(1M) will be quiesced, if running.
/etc/svc/repository.db
    -- renamed --&gt; /etc/svc/repository.db_old_YYYYMMDD_HHMMSS
/etc/svc/volatile/db_errors
    -- copied --&gt; /etc/svc/repository.db_old_YYYYMMDD_HHMMSS_errors
repository_to_restore
    -- copied --&gt; /etc/svc/repository.db
and the system will be rebooted with reboot(1M).

Proceed [yes/no]?</pre></li>
<li><b>Type <tt>yes</tt> to remedy the fault.</b><p>The system reboots after the <tt>restore_repository</tt> command executes all of the listed actions.</p></li></ol>

<a name="ecdwu"></a><h4>How to Boot Without Starting Any Services</h4><p>If problems with starting services occur, sometimes a system will hang during the
boot. This procedure shows how to troubleshoot this problem.</p><ol>
<li><b>Boot without starting any services.</b><p>This command instructs the <tt>svc.startd</tt> daemon to temporarily disable all services and start <tt>sulogin</tt>
on the console.</p><pre>ok <tt><b>boot -m milestone=none</b></tt></pre></li>
<li><b>Log in to the system as <tt>root</tt>.</b></li>
<li><b>Enable all services.</b><pre># <tt><b>svcadm milestone all</b></tt></pre></li>
<li><b>Determine where the boot process is hanging.</b><p>When the boot process hangs, determine which services are not running by running
<tt>svcs</tt> <tt>-a</tt>. Look for error messages in the log files in <tt>/var/svc/log</tt>.</p></li>
<li><b>After fixing the problems, verify that all services have started.</b><ol style="list-style-type: lower-alpha">
				 
<li><b>Verify that all needed services are online.</b><pre># <tt><b>svcs -x</b></tt></pre></li>
<li><b>Verify that the <tt>console-login</tt> service dependencies are satisfied.</b><p>This command verifies that the <tt>login</tt> process on the console will run.</p><pre># <tt><b>svcs -l system/console-login:default</b></tt></pre></li></ol></li>
<li><b>Continue the normal booting process.</b></li></ol>

<a name="gcvri"></a><h4>How to Force a <tt>sulogin</tt> Prompt If the <tt>system/filesystem/local:default</tt> Service Fails During Boot</h4><p>Local file systems that are not required to boot the Solaris OS
are mounted by the <tt>svc:/system/filesystem/local:default</tt> service. When any of those file systems are unable
to be mounted, the service enters a maintenance state. System startup continues, and
any services which do not depend on <tt>filesystem/local</tt> are started. Services which require <tt>filesystem/local</tt>
to be online before starting through dependencies are not started.</p><p>To change the configuration of the system so that a <tt>sulogin</tt> prompt appears
immediately after the service fails instead of allowing system startup to continue, follow
the procedure below.</p><ol>
<li><b>Modify the <tt>system/console-login</tt> service.</b><pre># <tt><b>svccfg -s svc:/system/console-login</b></tt>
svc:/system/console-login&gt; <tt><b>addpg site,filesystem-local dependency</b></tt>
svc:/system/console-login&gt; <tt><b>setprop site,filesystem-local/entities = fmri: svc:/system/filesystem/local</b></tt>
svc:/system/console-login&gt; <tt><b>setprop site,filesystem-local/grouping = astring: require_all</b></tt>
svc:/system/console-login&gt; <tt><b>setprop site,filesystem-local/restart_on = astring: none</b></tt>
svc:/system/console-login&gt; <tt><b>setprop site,filesystem-local/type = astring: service</b></tt>
svc:/system/console-login&gt; <tt><b>end</b></tt></pre></li>
<li><b>Refresh the service.</b><pre># <tt><b>svcadm refresh console-login</b></tt></pre></li></ol><a name="gcvxr"></a><h6>Example&nbsp;17-18 Forcing an <tt>sulogin</tt> Prompt Using Jumpstart</h6><p>Save the following commands into a script and save it as <tt>/etc/rcS.d/S01site-customfs</tt>.</p><pre>#!/bin/sh
#
# This script adds a dependency from console-login -&gt; filesystem/local
# This forces the system to stop the boot process and drop to an sulogin prompt
# if any file system in filesystem/local fails to mount.

PATH=/usr/sbin:/usr/bin
export PATH

    svccfg -s svc:/system/console-login &lt;&lt; EOF
addpg site,filesystem-local dependency
setprop site,filesystem-local/entities = fmri: svc:/system/filesystem/local
setprop site,filesystem-local/grouping = astring: require_all
setprop site,filesystem-local/restart_on = astring: none
setprop site,filesystem-local/type = astring: service
EOF

svcadm refresh svc:/system/console-login

[ -f /etc/rcS.d/S01site-customfs ] &amp;&amp;
    rm -f /etc/rcS.d/S01site-customfs</pre><h6>Troubleshooting</h6><p>When a failure occurs with the <tt>system/filesystem/local:default</tt> service, the <tt>svcs</tt> <tt>-vx</tt> command should
be used to identify the failure. After the failure has been fixed, the
following command clears the error state and allows the system boot to continue:
<tt>svcadm</tt> <tt>clear filesystem/local</tt>.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="fahqr.html">Previous</a>
             </td>
             <td align="right">
                 <a href="swmgrpkgsconcepts-52619.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

