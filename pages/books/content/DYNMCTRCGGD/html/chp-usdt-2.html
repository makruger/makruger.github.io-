<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Adding Probes to an Application - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-11-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Solaris Dynamic Tracing Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-usdt-1.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-sec.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="chp-intro.html">1.&nbsp;&nbsp;Introduction</a></p>
<p class="toc level1 tocsp"><a href="chp-typeopexpr.html">2.&nbsp;&nbsp;Types, Operators, and Expressions</a></p>
<p class="toc level1 tocsp"><a href="chp-variables.html">3.&nbsp;&nbsp;Variables</a></p>
<p class="toc level1 tocsp"><a href="chp-prog.html">4.&nbsp;&nbsp;D Program Structure</a></p>
<p class="toc level1 tocsp"><a href="chp-pointers.html">5.&nbsp;&nbsp;Pointers and Arrays</a></p>
<p class="toc level1 tocsp"><a href="chp-strings.html">6.&nbsp;&nbsp;Strings</a></p>
<p class="toc level1 tocsp"><a href="chp-structs.html">7.&nbsp;&nbsp;Structs and Unions</a></p>
<p class="toc level1 tocsp"><a href="chp-types.html">8.&nbsp;&nbsp;Type and Constant Definitions</a></p>
<p class="toc level1 tocsp"><a href="chp-aggs.html">9.&nbsp;&nbsp;Aggregations</a></p>
<p class="toc level1 tocsp"><a href="chp-actsub.html">10.&nbsp;&nbsp;Actions and Subroutines</a></p>
<p class="toc level1 tocsp"><a href="chp-buf.html">11.&nbsp;&nbsp;Buffers and Buffering</a></p>
<p class="toc level1 tocsp"><a href="chp-fmt.html">12.&nbsp;&nbsp;Output Formatting</a></p>
<p class="toc level1 tocsp"><a href="chp-spec.html">13.&nbsp;&nbsp;Speculative Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace1m.html">14.&nbsp;&nbsp;<tt>dtrace</tt>(1M) Utility</a></p>
<p class="toc level1 tocsp"><a href="chp-script.html">15.&nbsp;&nbsp;Scripting</a></p>
<p class="toc level1 tocsp"><a href="chp-opt.html">16.&nbsp;&nbsp;Options and Tunables</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace.html">17.&nbsp;&nbsp;<tt>dtrace</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-lockstat.html">18.&nbsp;&nbsp;<tt>lockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-profile.html">19.&nbsp;&nbsp;<tt>profile</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fbt.html">20.&nbsp;&nbsp;<tt>fbt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-syscall.html">21.&nbsp;&nbsp;<tt>syscall</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sdt.html">22.&nbsp;&nbsp;<tt>sdt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sysinfo.html">23.&nbsp;&nbsp;<tt>sysinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-vminfo.html">24.&nbsp;&nbsp;<tt>vminfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-proc.html">25.&nbsp;&nbsp;<tt>proc</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sched.html">26.&nbsp;&nbsp;<tt>sched</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-io.html">27.&nbsp;&nbsp;<tt>io</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-mib.html">28.&nbsp;&nbsp;<tt>mib</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fpuinfo.html">29.&nbsp;&nbsp;<tt>fpuinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-pid.html">30.&nbsp;&nbsp;<tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-plockstat.html">31.&nbsp;&nbsp;<tt>plockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fasttrap.html">32.&nbsp;&nbsp;<tt>fasttrap</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-user.html">33.&nbsp;&nbsp;User Process Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-usdt.html">34.&nbsp;&nbsp;Statically Defined Tracing for User Applications</a></p>
<p class="toc level2"><a href="chp-usdt-1.html">Choosing the Probe Points</a></p>
<div class="onpage">
<p class="toc level2"><a href="">Adding Probes to an Application</a></p>
</div>
<p class="toc level1 tocsp"><a href="chp-sec.html">35.&nbsp;&nbsp;Security</a></p>
<p class="toc level1 tocsp"><a href="chp-anon.html">36.&nbsp;&nbsp;Anonymous Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-post.html">37.&nbsp;&nbsp;Postmortem Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-perf.html">38.&nbsp;&nbsp;Performance Considerations</a></p>
<p class="toc level1 tocsp"><a href="chp-stab.html">39.&nbsp;&nbsp;Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-xlate.html">40.&nbsp;&nbsp;Translators</a></p>
<p class="toc level1 tocsp"><a href="chp-vers.html">41.&nbsp;&nbsp;Versioning</a></p>
<p class="toc level1 tocsp"><a href="gloss01.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="chp-usdt-2"></a><h3>Adding Probes to an Application</h3>
<p><a name="indexterm-472"></a><a name="indexterm-473"></a>DTrace probes for libraries and executables are defined in an ELF section in
the corresponding application binary. This section describes how to define your probes, add them
to your application source code, and augment your application's build process to include
the DTrace probe definitions.</p>

<a name="chp-usdt-3"></a><h4>Defining Providers and Probes</h4>
<p>You define DTrace probes in a <tt>.d</tt> source file which is then used
when compiling and linking your application. First, select an appropriate name for your
user application provider. The provider name you choose will be appended with the
process identifier for each process that is executing your application code. For example,
if you chose the provider name <tt>myserv</tt> for a web server that was
executing as process ID 1203, the DTrace provider name corresponding to this process
would be <tt>myserv1203</tt>. In your <tt>.d</tt> source file, add a provider definition similar
to the following example:</p><pre>provider myserv {
    ...
};            </pre><p>Next, add a definition for each probe and the corresponding arguments. The following
example defines the two probes discussed in <a href="chp-usdt-1.html">Choosing the Probe Points</a>. The first probe has two
arguments, both of type <tt>string</tt>, and the second probe has no arguments. The
D compiler converts two consecutive underscores (<tt>__</tt>) in any probe name to a
hyphen (<tt>-</tt>).</p><pre>provider myserv {
    probe query__receive(string, string);
    probe query__respond();
};</pre><p>You should add stability attributes to your provider definition so that consumers of
your probes understand the likelihood of change in future versions of your application.
See <a href="chp-stab.html">Chapter&nbsp;39, Stability</a> for more information on the DTrace stability attributes. Stability attributes are defined
as shown in the following example:</p><a name="ex-myserv.d"></a><h6>Example&nbsp;34-1 <tt>myserv.d</tt>: Statically Defined Application Probes</h6><pre>#pragma D attributes Evolving/Evolving/Common provider myserv provider
#pragma D attributes Private/Private/Unknown provider myserv module
#pragma D attributes Private/Private/Unknown provider myserv function
#pragma D attributes Evolving/Evolving/Common provider myserv name
#pragma D attributes Evolving/Evolving/Common provider myserv args

provider myserv {
    probe query__receive(string, string);
    probe query__respond();
};</pre>
<hr><p><b>Note - </b>D scripts that use non-integer arguments from user added probes must use the
<tt>copyin()</tt> and <tt>copyinstr()</tt> functions to retrieve those arguments. Please see <a href="chp-user.html">Chapter&nbsp;33, User Process Tracing</a> for more
information.</p>
<hr>


<a name="chp-usdt-4"></a><h4>Adding Probes to Application Code</h4>
<p>Now that you have defined your probes in a <tt>.d</tt> file, you need
to augment your source code to indicate the locations that should trigger your
probes. Consider the following example C application source code:</p><pre>void
main_look(void)
{
    ...
    query = wait_for_new_query();
    process_query(query)
    ...
}</pre><p>To add a probe site, add a reference to the <tt>DTRACE_PROBE()</tt> macro defined
in <tt>&lt;sys/sdt.h&gt;</tt> as shown in the following example:</p><pre>#include &lt;sys/sdt.h&gt;
...

void
main_look(void)
{
    ...
    query = wait_for_new_query();
    DTRACE_PROBE2(myserv, query__receive, query-&gt;clientname, query-&gt;msg);
    process_query(query)
    ...
}</pre><p>The suffix <tt>2</tt> in the macro name <tt>DTRACE_PROBE2</tt> refers the number of arguments
that are passed to the probe. The first two arguments to the probe
macro are the provider name and probe name and must correspond to your
D provider and probe definitions. The remaining macro arguments are the arguments assigned
to the DTrace <tt>arg0..9</tt> variables when the probes fires. Your application source code
can contain multiple references to the same provider and probe name. If multiple
references to the same probe are present in your source code, any of
the macro references will cause the probe to fire.</p>

<a name="chp-usdt-5"></a><h4>Building Applications with Probes</h4>
<p>You must augment the build process for your application to include the DTrace
provider and probe definitions. A typical build process takes each source file and
compiles it to create a corresponding object file. The compiled object files are
then linked together to create the finished application binary, as shown in the
following example:</p><pre>cc -c src1.c
cc -c src2.c
...
cc -o myserv src1.o src2.o ...</pre><p>To include DTrace probe definitions in your application, add appropriate Makefile rules to
your build process to execute the <tt>dtrace</tt> command as shown in the following
example:</p><pre>cc -c src1.c
cc -c src2.c
...
dtrace -G -32 -s myserv.d src1.o src2.o ...
cc -o myserv myserv.o src1.o src2.o ...</pre><p>The <tt>dtrace</tt> command shown above post-processes the object files generated by the preceding
compiler commands and generates the object file <tt>myserv.o</tt> from <tt>myserv.d</tt> and the other object
files. The <tt>dtrace</tt> <tt>-G</tt> option is used to link provider and probe definitions
with a user application. The <tt>-32</tt> option is used to build 32&ndash;bit
application binaries. The <tt>-64</tt> option is used to build 64&ndash;bit application binaries.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-usdt-1.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-sec.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

