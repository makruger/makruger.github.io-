<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Translator Declarations - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-11-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Solaris Dynamic Tracing Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-xlate.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-xlate-2.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="chp-intro.html">1.&nbsp;&nbsp;Introduction</a></p>
<p class="toc level1 tocsp"><a href="chp-typeopexpr.html">2.&nbsp;&nbsp;Types, Operators, and Expressions</a></p>
<p class="toc level1 tocsp"><a href="chp-variables.html">3.&nbsp;&nbsp;Variables</a></p>
<p class="toc level1 tocsp"><a href="chp-prog.html">4.&nbsp;&nbsp;D Program Structure</a></p>
<p class="toc level1 tocsp"><a href="chp-pointers.html">5.&nbsp;&nbsp;Pointers and Arrays</a></p>
<p class="toc level1 tocsp"><a href="chp-strings.html">6.&nbsp;&nbsp;Strings</a></p>
<p class="toc level1 tocsp"><a href="chp-structs.html">7.&nbsp;&nbsp;Structs and Unions</a></p>
<p class="toc level1 tocsp"><a href="chp-types.html">8.&nbsp;&nbsp;Type and Constant Definitions</a></p>
<p class="toc level1 tocsp"><a href="chp-aggs.html">9.&nbsp;&nbsp;Aggregations</a></p>
<p class="toc level1 tocsp"><a href="chp-actsub.html">10.&nbsp;&nbsp;Actions and Subroutines</a></p>
<p class="toc level1 tocsp"><a href="chp-buf.html">11.&nbsp;&nbsp;Buffers and Buffering</a></p>
<p class="toc level1 tocsp"><a href="chp-fmt.html">12.&nbsp;&nbsp;Output Formatting</a></p>
<p class="toc level1 tocsp"><a href="chp-spec.html">13.&nbsp;&nbsp;Speculative Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace1m.html">14.&nbsp;&nbsp;<tt>dtrace</tt>(1M) Utility</a></p>
<p class="toc level1 tocsp"><a href="chp-script.html">15.&nbsp;&nbsp;Scripting</a></p>
<p class="toc level1 tocsp"><a href="chp-opt.html">16.&nbsp;&nbsp;Options and Tunables</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace.html">17.&nbsp;&nbsp;<tt>dtrace</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-lockstat.html">18.&nbsp;&nbsp;<tt>lockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-profile.html">19.&nbsp;&nbsp;<tt>profile</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fbt.html">20.&nbsp;&nbsp;<tt>fbt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-syscall.html">21.&nbsp;&nbsp;<tt>syscall</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sdt.html">22.&nbsp;&nbsp;<tt>sdt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sysinfo.html">23.&nbsp;&nbsp;<tt>sysinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-vminfo.html">24.&nbsp;&nbsp;<tt>vminfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-proc.html">25.&nbsp;&nbsp;<tt>proc</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sched.html">26.&nbsp;&nbsp;<tt>sched</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-io.html">27.&nbsp;&nbsp;<tt>io</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-mib.html">28.&nbsp;&nbsp;<tt>mib</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fpuinfo.html">29.&nbsp;&nbsp;<tt>fpuinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-pid.html">30.&nbsp;&nbsp;<tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-plockstat.html">31.&nbsp;&nbsp;<tt>plockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fasttrap.html">32.&nbsp;&nbsp;<tt>fasttrap</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-user.html">33.&nbsp;&nbsp;User Process Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-usdt.html">34.&nbsp;&nbsp;Statically Defined Tracing for User Applications</a></p>
<p class="toc level1 tocsp"><a href="chp-sec.html">35.&nbsp;&nbsp;Security</a></p>
<p class="toc level1 tocsp"><a href="chp-anon.html">36.&nbsp;&nbsp;Anonymous Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-post.html">37.&nbsp;&nbsp;Postmortem Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-perf.html">38.&nbsp;&nbsp;Performance Considerations</a></p>
<p class="toc level1 tocsp"><a href="chp-stab.html">39.&nbsp;&nbsp;Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-xlate.html">40.&nbsp;&nbsp;Translators</a></p>
<div class="onpage">
<p class="toc level2"><a href="">Translator Declarations</a></p>
</div>
<p class="toc level2"><a href="chp-xlate-2.html">Translate Operator</a></p>
<p class="toc level2"><a href="chp-xlate-3.html">Process Model Translators</a></p>
<p class="toc level2"><a href="chp-xlate-4.html">Stable Translations</a></p>
<p class="toc level1 tocsp"><a href="chp-vers.html">41.&nbsp;&nbsp;Versioning</a></p>
<p class="toc level1 tocsp"><a href="gloss01.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="chp-xlate-1"></a><h3>Translator Declarations</h3>
<p>A <b>translator</b> is a collection of D assignment statements provided by the
supplier of an interface that can be used to translate an input
expression into an object of struct type. To understand the need for
and use of translators, we'll consider as an example the ANSI-C standard
library routines defined in <tt>stdio.h</tt>. These routines operate on a data structure
named <tt>FILE</tt> whose implementation artifacts are abstracted away from C programmers. A
standard technique for creating a data structure abstraction is to provide only
a forward declaration of a data structure in public header files, while
keeping the corresponding struct definition in a separate private header file.</p><p>If you are writing a C program and wish to know the
file descriptor corresponding to a <tt>FILE</tt> struct, you can use the <a href="http://docs.sun.com/doc/819-2243/fileno-3c?a=view"><tt>fileno</tt>(3C)</a>
function to obtain the descriptor rather than dereferencing a member of the
FILE struct directly. The Solaris header files enforce this rule by defining
FILE as an opaque forward declaration tag so it cannot be dereferenced
directly by C programs that include <tt>&lt;stdio.h&gt;</tt>. Inside the <tt>libc.so.1</tt> library, you
can imagine that <tt>fileno()</tt> is implemented in C something like this:</p><pre>int
fileno(FILE *fp)
{
    struct file_impl *ip = (struct file_impl *)fp;

    return (ip-&gt;fd);
}</pre><p>Our hypothetical <tt>fileno()</tt> takes a <tt>FILE</tt> pointer as an argument and casts
it to a pointer to a corresponding internal <tt>libc</tt> structure, <tt>struct file_impl</tt>, and
then returns the value of the <tt>fd</tt> member of the implementation structure.
Why does Solaris implement interfaces like this? By abstracting the details of
the current <tt>libc</tt> implementation away from client programs, Sun is able to
maintain a commitment to strong binary compatibility while continuing to evolve and
change the internal implementation details of <tt>libc</tt>. In our example, the <tt>fd</tt>
member could change size or position within <tt>struct file_impl</tt>, even in a patch,
and existing binaries calling <a href="http://docs.sun.com/doc/819-2243/fileno-3c?a=view"><tt>fileno</tt>(3C)</a> would not be affected by this change
because they do not depend on these artifacts.</p><p>Unfortunately, observability software such as DTrace has the need to peer inside
the implementation in order to provide useful results, and does not have
the luxury of calling arbitrary C functions defined in Solaris libraries or
in the kernel. You could declare a copy of <tt>struct file_impl</tt> in your
D program in order to instrument the routines declared in <tt>stdio.h</tt>, but
then your D program would rely on Private implementation artifacts of the
library that might break in a future micro or minor release, or
even in a patch. Ideally, we want to provide a construct for
use in D programs that is bound to the implementation of the
library and is updated accordingly, but still provides an additional layer of
abstraction associated with greater stability.</p><p>A new translator is created using a declaration of the form:</p><pre>translator <i>output-type</i> &lt; <i>input-type</i> <i>input-identifier</i> &gt; {
    <i>member-name</i> = <i>expression</i> ;
    <i>member-name</i> = <i>expression</i> ;
    ...
};    </pre><p>The <i>output-type</i> names a struct that will be the result type for
the translation. The <i>input-type</i> specifies the type of the input expression, and
is surrounded in angle brackets <tt>&lt; &gt;</tt> and followed by an <i>input-identifier</i> that
can be used in the translator expressions as an alias for the
input expression. The body of the translator is surrounded in braces <tt>{ }</tt>
and terminated with a semicolon (<tt>;</tt>), and consists of a list of
<i>member-name</i> and identifiers corresponding translation expressions. Each member declaration must name a
unique member of the <i>output-type</i> and must be assigned an expression of
a type compatible with the member type, according to the rules for
the D assignment (<tt>=</tt>) operator.</p><p>For example, we could define a struct of stable information about <tt>stdio</tt>
files based on some of the available <tt>libc</tt> interfaces:</p><pre>struct file_info {
    int file_fd;   /* file descriptor from fileno(3C) */
    int file_eof;  /* eof flag from feof(3C) */
};</pre><p>A hypothetical D translator from <tt>FILE</tt> to <tt>file_info</tt> could then be declared
in D as follows:</p><pre>translator struct file_info &lt; FILE *F &gt; {
    file_fd = ((struct file_impl *)F)-&gt;fd;
    file_eof = ((struct file_impl *)F)-&gt;eof;
};</pre><p>In our hypothetical translator, the input expression is of type <tt>FILE *</tt> and
is assigned the <i>input-identifier</i> <tt>F</tt>. The identifier <tt>F</tt> can then be used
in the translator member expressions as a variable of type <tt>FILE *</tt> that
is only visible within the body of the translator declaration. To determine
the value of the output <tt>file_fd</tt> member, the translator performs a cast
and dereference similar to the hypothetical implementation of <a href="http://docs.sun.com/doc/819-2243/fileno-3c?a=view"><tt>fileno</tt>(3C)</a> shown above. A
similar translation is performed to obtain the value of the EOF indicator.</p><p>Sun provides a set of translators for use with Solaris interfaces that
you can invoke from your D programs, and promises to maintain these
translators according to the rules for interface stability defined earlier as the
implementation of the corresponding interface changes. We'll learn about these translators later
in the chapter, after we learn how to invoke translators from D.
The translator facility itself is also provided for use by application and
library developers who wish to offer their own translators that D programmers
can use to observe the state of their software packages.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-xlate.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-xlate-2.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

