<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>copyin() and copyinstr() Subroutines - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-11-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Solaris Dynamic Tracing Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-user.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-user-2.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="chp-intro.html">1.&nbsp;&nbsp;Introduction</a></p>
<p class="toc level1 tocsp"><a href="chp-typeopexpr.html">2.&nbsp;&nbsp;Types, Operators, and Expressions</a></p>
<p class="toc level1 tocsp"><a href="chp-variables.html">3.&nbsp;&nbsp;Variables</a></p>
<p class="toc level1 tocsp"><a href="chp-prog.html">4.&nbsp;&nbsp;D Program Structure</a></p>
<p class="toc level1 tocsp"><a href="chp-pointers.html">5.&nbsp;&nbsp;Pointers and Arrays</a></p>
<p class="toc level1 tocsp"><a href="chp-strings.html">6.&nbsp;&nbsp;Strings</a></p>
<p class="toc level1 tocsp"><a href="chp-structs.html">7.&nbsp;&nbsp;Structs and Unions</a></p>
<p class="toc level1 tocsp"><a href="chp-types.html">8.&nbsp;&nbsp;Type and Constant Definitions</a></p>
<p class="toc level1 tocsp"><a href="chp-aggs.html">9.&nbsp;&nbsp;Aggregations</a></p>
<p class="toc level1 tocsp"><a href="chp-actsub.html">10.&nbsp;&nbsp;Actions and Subroutines</a></p>
<p class="toc level1 tocsp"><a href="chp-buf.html">11.&nbsp;&nbsp;Buffers and Buffering</a></p>
<p class="toc level1 tocsp"><a href="chp-fmt.html">12.&nbsp;&nbsp;Output Formatting</a></p>
<p class="toc level1 tocsp"><a href="chp-spec.html">13.&nbsp;&nbsp;Speculative Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace1m.html">14.&nbsp;&nbsp;<tt>dtrace</tt>(1M) Utility</a></p>
<p class="toc level1 tocsp"><a href="chp-script.html">15.&nbsp;&nbsp;Scripting</a></p>
<p class="toc level1 tocsp"><a href="chp-opt.html">16.&nbsp;&nbsp;Options and Tunables</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace.html">17.&nbsp;&nbsp;<tt>dtrace</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-lockstat.html">18.&nbsp;&nbsp;<tt>lockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-profile.html">19.&nbsp;&nbsp;<tt>profile</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fbt.html">20.&nbsp;&nbsp;<tt>fbt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-syscall.html">21.&nbsp;&nbsp;<tt>syscall</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sdt.html">22.&nbsp;&nbsp;<tt>sdt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sysinfo.html">23.&nbsp;&nbsp;<tt>sysinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-vminfo.html">24.&nbsp;&nbsp;<tt>vminfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-proc.html">25.&nbsp;&nbsp;<tt>proc</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sched.html">26.&nbsp;&nbsp;<tt>sched</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-io.html">27.&nbsp;&nbsp;<tt>io</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-mib.html">28.&nbsp;&nbsp;<tt>mib</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fpuinfo.html">29.&nbsp;&nbsp;<tt>fpuinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-pid.html">30.&nbsp;&nbsp;<tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-plockstat.html">31.&nbsp;&nbsp;<tt>plockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fasttrap.html">32.&nbsp;&nbsp;<tt>fasttrap</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-user.html">33.&nbsp;&nbsp;User Process Tracing</a></p>
<div class="onpage">
<p class="toc level2"><a href=""><tt>copyin()</tt> and <tt>copyinstr()</tt> Subroutines</a></p>
</div>
<p class="toc level2"><a href="chp-user-2.html">Eliminating <tt>dtrace</tt>(1M) Interference</a></p>
<p class="toc level2"><a href="chp-user-3.html"><tt>syscall</tt> Provider</a></p>
<p class="toc level2"><a href="chp-user-4.html"><tt>ustack()</tt> Action</a></p>
<p class="toc level2"><a href="chp-user-uregs.html"><tt>uregs[]</tt> Array</a></p>
<p class="toc level2"><a href="chp-user-5.html"><tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-usdt.html">34.&nbsp;&nbsp;Statically Defined Tracing for User Applications</a></p>
<p class="toc level1 tocsp"><a href="chp-sec.html">35.&nbsp;&nbsp;Security</a></p>
<p class="toc level1 tocsp"><a href="chp-anon.html">36.&nbsp;&nbsp;Anonymous Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-post.html">37.&nbsp;&nbsp;Postmortem Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-perf.html">38.&nbsp;&nbsp;Performance Considerations</a></p>
<p class="toc level1 tocsp"><a href="chp-stab.html">39.&nbsp;&nbsp;Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-xlate.html">40.&nbsp;&nbsp;Translators</a></p>
<p class="toc level1 tocsp"><a href="chp-vers.html">41.&nbsp;&nbsp;Versioning</a></p>
<p class="toc level1 tocsp"><a href="gloss01.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="chp-user-1"></a><h3><tt>copyin()</tt> and <tt>copyinstr()</tt> Subroutines</h3>
<p><a name="indexterm-456"></a><a name="indexterm-457"></a><a name="indexterm-458"></a><a name="indexterm-459"></a><a name="indexterm-460"></a>DTrace's interaction with processes is a little different than most traditional debuggers or observability
tools. Many such tools appear to execute within the scope of the process,
letting users dereference pointers to program variables directly. Rather than appearing to execute
within or as part of the process itself, DTrace probes execute in the
Solaris kernel. To access process data, a probe needs to use the <tt>copyin()</tt>
or <tt>copyinstr()</tt> subroutines to copy user process data into the address space of
the kernel.</p><p>For example, consider the following <a href="http://docs.sun.com/doc/819-2241/write-2?a=view"><tt>write</tt>(2)</a> system call:</p><pre>ssize_t write(int fd, const void *buf, size_t nbytes);</pre><p>The following D program illustrates an incorrect attempt to print the contents of
a string passed to the <a href="http://docs.sun.com/doc/819-2241/write-2?a=view"><tt>write</tt>(2)</a> system call:</p><pre>syscall::write:entry
{
    printf("%s", stringof(arg1)); /* incorrect use of arg1 */
}</pre><p>If you try to run this script, DTrace will produce error messages
similar to the following example:</p><pre>dtrace: error on enabled probe ID 1 (ID 37: syscall::write:entry): \
    invalid address (0x10038a000) in action #1</pre><p>The <tt>arg1</tt> variable, containing the value of the <i>buf</i> parameter, is an
address that refers to memory in the process executing the system call. To
read the string at that address, use the <tt>copyinstr()</tt> subroutine and record
its result with the <tt>printf()</tt> action:</p><pre>syscall::write:entry
{
    printf("%s", copyinstr(arg1)); /* correct use of arg1 */</pre><p>The output of this script shows all of the strings being passed
to the <a href="http://docs.sun.com/doc/819-2241/write-2?a=view"><tt>write</tt>(2)</a> system call. Occasionally, however, you might see irregular output similar
to the following example:</p><pre>  0     37                      write:entry mada&iuml;&iquest;&frac12;&iuml;&iquest;&frac12;&iuml;&iquest;&frac12;</pre><p>The <tt>copyinstr()</tt> subroutine acts on an input argument that is the user address
of a null-terminated ASCII string. However, buffers passed to the <a href="http://docs.sun.com/doc/819-2241/write-2?a=view"><tt>write</tt>(2)</a> system call might
refer to binary data rather than ASCII strings. To print only as much
of the string as the caller intended, use the <tt>copyin()</tt> subroutine, which takes
a size as its second argument:</p><pre>syscall::write:entry
{
    printf("%s", stringof(copyin(arg1, arg2)));
}</pre><p>Notice that the <tt>stringof</tt> operator is necessary so that DTrace properly converts the
user data retrieved using <tt>copyin()</tt> to a string. The use of <tt>stringof</tt> is
not necessary when using&nbsp;<tt>copyinstr()</tt> because this function always returns type <tt>string</tt>.</p>

<a name="chp-user-1.1"></a><h4>Avoiding Errors</h4>
<p>The <tt>copyin()</tt> and <tt>copyinstr()</tt> subroutines cannot read from user addresses which have not
yet been touched so even a valid address may cause an error if
the page containing that address has not yet been faulted in by being
accessed. Consider the following example:</p><pre><tt><b># dtrace -n syscall::open:entry'{ trace(copyinstr(arg0)); }'</b></tt>
dtrace: description 'syscall::open:entry' matched 1 probe
CPU     ID                    FUNCTION:NAME
dtrace: error on enabled probe ID 2 (ID 50: syscall::open:entry): invalid address
(0x9af1b) in action #1 at DIF offset 52</pre><p>In the above example output, the application was functioning properly, and the address
in <tt>arg0</tt> was valid, but it referred to a page that had not
yet been accessed by the corresponding process. To resolve this issue, wait for
kernel or application to use the data before tracing it. For example, you
might wait until the system call returns to apply <tt>copyinstr()</tt>, as shown
in the following example:</p><pre><tt><b># dtrace -n syscall::open:entry'{ self-&gt;file = arg0; }' \</b></tt>
<tt><b>-n syscall::open:return'{ trace(copyinstr(self-&gt;file)); self-&gt;file = 0; }'</b></tt>
dtrace: description 'syscall::open:entry' matched 1 probe
CPU     ID                    FUNCTION:NAME
  2     51                      open:return   /dev/null                        </pre>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-user.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-user-2.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

