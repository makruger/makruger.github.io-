<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Tail-call Optimization - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-11-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Solaris Dynamic Tracing Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-fbt-10.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-fbt-12.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="chp-intro.html">1.&nbsp;&nbsp;Introduction</a></p>
<p class="toc level1 tocsp"><a href="chp-typeopexpr.html">2.&nbsp;&nbsp;Types, Operators, and Expressions</a></p>
<p class="toc level1 tocsp"><a href="chp-variables.html">3.&nbsp;&nbsp;Variables</a></p>
<p class="toc level1 tocsp"><a href="chp-prog.html">4.&nbsp;&nbsp;D Program Structure</a></p>
<p class="toc level1 tocsp"><a href="chp-pointers.html">5.&nbsp;&nbsp;Pointers and Arrays</a></p>
<p class="toc level1 tocsp"><a href="chp-strings.html">6.&nbsp;&nbsp;Strings</a></p>
<p class="toc level1 tocsp"><a href="chp-structs.html">7.&nbsp;&nbsp;Structs and Unions</a></p>
<p class="toc level1 tocsp"><a href="chp-types.html">8.&nbsp;&nbsp;Type and Constant Definitions</a></p>
<p class="toc level1 tocsp"><a href="chp-aggs.html">9.&nbsp;&nbsp;Aggregations</a></p>
<p class="toc level1 tocsp"><a href="chp-actsub.html">10.&nbsp;&nbsp;Actions and Subroutines</a></p>
<p class="toc level1 tocsp"><a href="chp-buf.html">11.&nbsp;&nbsp;Buffers and Buffering</a></p>
<p class="toc level1 tocsp"><a href="chp-fmt.html">12.&nbsp;&nbsp;Output Formatting</a></p>
<p class="toc level1 tocsp"><a href="chp-spec.html">13.&nbsp;&nbsp;Speculative Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace1m.html">14.&nbsp;&nbsp;<tt>dtrace</tt>(1M) Utility</a></p>
<p class="toc level1 tocsp"><a href="chp-script.html">15.&nbsp;&nbsp;Scripting</a></p>
<p class="toc level1 tocsp"><a href="chp-opt.html">16.&nbsp;&nbsp;Options and Tunables</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace.html">17.&nbsp;&nbsp;<tt>dtrace</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-lockstat.html">18.&nbsp;&nbsp;<tt>lockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-profile.html">19.&nbsp;&nbsp;<tt>profile</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fbt.html">20.&nbsp;&nbsp;<tt>fbt</tt> Provider</a></p>
<p class="toc level2"><a href="chp-fbt-6.html">Probes</a></p>
<p class="toc level2"><a href="chp-fbt-7.html">Probe arguments</a></p>
<p class="toc level2"><a href="chp-fbt-10.html">Examples</a></p>
<div class="onpage">
<p class="toc level2"><a href="">Tail-call Optimization</a></p>
</div>
<p class="toc level2"><a href="chp-fbt-12.html">Assembly Functions</a></p>
<p class="toc level2"><a href="chp-fbt-13.html">Instruction Set Limitations</a></p>
<p class="toc level2"><a href="chp-fbt-16.html">Breakpoint Interaction</a></p>
<p class="toc level2"><a href="chp-fbt-17.html">Module Loading</a></p>
<p class="toc level2"><a href="chp-fbt-18.html">Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-syscall.html">21.&nbsp;&nbsp;<tt>syscall</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sdt.html">22.&nbsp;&nbsp;<tt>sdt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sysinfo.html">23.&nbsp;&nbsp;<tt>sysinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-vminfo.html">24.&nbsp;&nbsp;<tt>vminfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-proc.html">25.&nbsp;&nbsp;<tt>proc</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sched.html">26.&nbsp;&nbsp;<tt>sched</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-io.html">27.&nbsp;&nbsp;<tt>io</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-mib.html">28.&nbsp;&nbsp;<tt>mib</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fpuinfo.html">29.&nbsp;&nbsp;<tt>fpuinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-pid.html">30.&nbsp;&nbsp;<tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-plockstat.html">31.&nbsp;&nbsp;<tt>plockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fasttrap.html">32.&nbsp;&nbsp;<tt>fasttrap</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-user.html">33.&nbsp;&nbsp;User Process Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-usdt.html">34.&nbsp;&nbsp;Statically Defined Tracing for User Applications</a></p>
<p class="toc level1 tocsp"><a href="chp-sec.html">35.&nbsp;&nbsp;Security</a></p>
<p class="toc level1 tocsp"><a href="chp-anon.html">36.&nbsp;&nbsp;Anonymous Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-post.html">37.&nbsp;&nbsp;Postmortem Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-perf.html">38.&nbsp;&nbsp;Performance Considerations</a></p>
<p class="toc level1 tocsp"><a href="chp-stab.html">39.&nbsp;&nbsp;Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-xlate.html">40.&nbsp;&nbsp;Translators</a></p>
<p class="toc level1 tocsp"><a href="chp-vers.html">41.&nbsp;&nbsp;Versioning</a></p>
<p class="toc level1 tocsp"><a href="gloss01.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="chp-fbt-11"></a><h3>Tail-call Optimization</h3>
<p><a name="indexterm-330"></a><a name="indexterm-331"></a>When one function ends by calling another function, the compiler can engage in
<b>tail-call optimization</b>, in which the function being called reuses the caller's stack frame. This
procedure is most commonly used in the SPARC architecture, where the compiler reuses the
caller's register window in the function being called in order to minimize register
window pressure.</p><p>The presence of this optimization causes the <tt>return</tt> probe of the calling function
to fire <b>before</b> the <tt>entry</tt> probe of the called function. This ordering can
lead to quite a bit of confusion. For example, if you wanted to
record all functions called from a particular function and any functions that this
function calls, you might use the following script:</p><pre>fbt::foo:entry
{
    self-&gt;traceme = 1;
}

fbt:::entry
/self-&gt;traceme/
{
    printf("called %s", probefunc);
}

fbt::foo:return
/self-&gt;traceme/
{
    self-&gt;traceme = 0;
}</pre><p>However, if <tt>foo()</tt> ends in an optimized tail-call, the tail-called function, and therefore
any functions that it calls, will not be captured. The kernel cannot be
dynamically deoptimized on the fly, and DTrace does not wish to engage in
a lie about how code is structured. Therefore, you should be aware of
when tail-call optimization might be used.</p><p>Tail-call optimization is likely to be used in source code similar to the
following example:</p><pre>    return (bar());</pre><p>Or in source code similar to the following example:</p><pre>    (void) bar();
    return;</pre><p>Conversely, function source code that ends like the following example <b>cannot</b> have
its call to <tt>bar()</tt> optimized, because the call to <tt>bar()</tt> is not a
tail-call:</p><pre>    bar();
    return (rval);</pre><p>You can determine whether a call has been tail-call optimized using the following
technique:</p>
<ul><li><p>While running DTrace, trace <tt>arg0</tt> of the <tt>return</tt> probe in question. <tt>arg0</tt> contains the offset of the returning instruction in the function.</p></li>
<li><p>After DTrace has stopped, use <a href="http://docs.sun.com/doc/819-2239/mdb-1?a=view"><tt>mdb</tt>(1)</a> to look at the function. If the traced offset contains a call to another function instead of an instruction to return from the function, the call has been tail-call optimized.</p></li></ul>
<p>Due to the instruction set architecture, tail-call optimization is far more common on
SPARC systems than on x86 systems. The following example uses <tt>mdb</tt> to
discover tail-call optimization in the kernel's <tt>dup()</tt> function:</p><pre><tt><b># dtrace -q -n fbt::dup:return'{printf("%s+0x%x", probefunc, arg0);}'</b></tt></pre><p>While this command is running, run a program that performs a <a href="http://docs.sun.com/doc/819-2241/dup-2?a=view"><tt>dup</tt>(2)</a>,
such as a <tt>bash</tt> process. The above command should provide output similar to
the following example:</p><pre>dup+0x10
<tt><b>^C</b></tt></pre><p>Now examine the function with <tt>mdb</tt>:</p><pre><tt><b># echo "dup::dis" | mdb -k</b></tt>
dup:                            sra       %o0, 0, %o0
dup+4:                          mov       %o7, %g1
dup+8:                          clr       %o2
dup+0xc:                        clr       %o1
dup+0x10:                       call      -0x1278       &lt;fcntl&gt;
dup+0x14:                       mov       %g1, %o7</pre><p>The output shows that <tt>dup+0x10</tt> is a call to the <tt>fcntl()</tt> function
and not a <tt>ret</tt> instruction. Therefore, the call to <tt>fcntl()</tt> is an example
of tail-call optimization.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-fbt-10.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-fbt-12.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

