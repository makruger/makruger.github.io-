<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Principal Buffer Policies - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-11-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Solaris Dynamic Tracing Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-buf-1.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-buf-3.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="chp-intro.html">1.&nbsp;&nbsp;Introduction</a></p>
<p class="toc level1 tocsp"><a href="chp-typeopexpr.html">2.&nbsp;&nbsp;Types, Operators, and Expressions</a></p>
<p class="toc level1 tocsp"><a href="chp-variables.html">3.&nbsp;&nbsp;Variables</a></p>
<p class="toc level1 tocsp"><a href="chp-prog.html">4.&nbsp;&nbsp;D Program Structure</a></p>
<p class="toc level1 tocsp"><a href="chp-pointers.html">5.&nbsp;&nbsp;Pointers and Arrays</a></p>
<p class="toc level1 tocsp"><a href="chp-strings.html">6.&nbsp;&nbsp;Strings</a></p>
<p class="toc level1 tocsp"><a href="chp-structs.html">7.&nbsp;&nbsp;Structs and Unions</a></p>
<p class="toc level1 tocsp"><a href="chp-types.html">8.&nbsp;&nbsp;Type and Constant Definitions</a></p>
<p class="toc level1 tocsp"><a href="chp-aggs.html">9.&nbsp;&nbsp;Aggregations</a></p>
<p class="toc level1 tocsp"><a href="chp-actsub.html">10.&nbsp;&nbsp;Actions and Subroutines</a></p>
<p class="toc level1 tocsp"><a href="chp-buf.html">11.&nbsp;&nbsp;Buffers and Buffering</a></p>
<p class="toc level2"><a href="chp-buf-1.html">Principal Buffers</a></p>
<div class="onpage">
<p class="toc level2"><a href="">Principal Buffer Policies</a></p>
</div>
<p class="toc level2"><a href="chp-buf-3.html">Other Buffers</a></p>
<p class="toc level2"><a href="chp-buf-4.html">Buffer Sizes</a></p>
<p class="toc level2"><a href="chp-buf-5.html">Buffer Resizing Policy</a></p>
<p class="toc level1 tocsp"><a href="chp-fmt.html">12.&nbsp;&nbsp;Output Formatting</a></p>
<p class="toc level1 tocsp"><a href="chp-spec.html">13.&nbsp;&nbsp;Speculative Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace1m.html">14.&nbsp;&nbsp;<tt>dtrace</tt>(1M) Utility</a></p>
<p class="toc level1 tocsp"><a href="chp-script.html">15.&nbsp;&nbsp;Scripting</a></p>
<p class="toc level1 tocsp"><a href="chp-opt.html">16.&nbsp;&nbsp;Options and Tunables</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace.html">17.&nbsp;&nbsp;<tt>dtrace</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-lockstat.html">18.&nbsp;&nbsp;<tt>lockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-profile.html">19.&nbsp;&nbsp;<tt>profile</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fbt.html">20.&nbsp;&nbsp;<tt>fbt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-syscall.html">21.&nbsp;&nbsp;<tt>syscall</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sdt.html">22.&nbsp;&nbsp;<tt>sdt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sysinfo.html">23.&nbsp;&nbsp;<tt>sysinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-vminfo.html">24.&nbsp;&nbsp;<tt>vminfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-proc.html">25.&nbsp;&nbsp;<tt>proc</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sched.html">26.&nbsp;&nbsp;<tt>sched</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-io.html">27.&nbsp;&nbsp;<tt>io</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-mib.html">28.&nbsp;&nbsp;<tt>mib</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fpuinfo.html">29.&nbsp;&nbsp;<tt>fpuinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-pid.html">30.&nbsp;&nbsp;<tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-plockstat.html">31.&nbsp;&nbsp;<tt>plockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fasttrap.html">32.&nbsp;&nbsp;<tt>fasttrap</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-user.html">33.&nbsp;&nbsp;User Process Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-usdt.html">34.&nbsp;&nbsp;Statically Defined Tracing for User Applications</a></p>
<p class="toc level1 tocsp"><a href="chp-sec.html">35.&nbsp;&nbsp;Security</a></p>
<p class="toc level1 tocsp"><a href="chp-anon.html">36.&nbsp;&nbsp;Anonymous Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-post.html">37.&nbsp;&nbsp;Postmortem Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-perf.html">38.&nbsp;&nbsp;Performance Considerations</a></p>
<p class="toc level1 tocsp"><a href="chp-stab.html">39.&nbsp;&nbsp;Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-xlate.html">40.&nbsp;&nbsp;Translators</a></p>
<p class="toc level1 tocsp"><a href="chp-vers.html">41.&nbsp;&nbsp;Versioning</a></p>
<p class="toc level1 tocsp"><a href="gloss01.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="chp-buf-2"></a><h3>Principal Buffer Policies</h3>
<p><a name="indexterm-209"></a>DTrace permits tracing in highly constrained contexts in the kernel. In particular, DTrace
permits tracing in contexts in which kernel software may not reliably allocate memory.
The consequence of this flexibility of context is that there <b>always</b> exists a
possibility that DTrace will attempt to trace data when there isn't space available.
DTrace must have a policy to deal with such situations when they arise,
but you might wish to tune the policy based on the needs of
a given experiment. Sometimes the appropriate policy might be to discard the new
data. Other times it might be desirable to reuse the space containing the
oldest recorded data to trace new data. Most often, the desired policy is
to minimize the likelihood of running out of available space in the first
place. To accommodate these varying demands, DTrace supports several different buffer policies. This
support is implemented with the <tt>bufpolicy</tt> option, and can be set on a per-consumer
basis. See <a href="chp-opt.html">Chapter&nbsp;16, Options and Tunables</a> for more details on setting options.</p>

<a name="chp-buf-2.1"></a><h4><tt>switch</tt> Policy</h4>
<p><a name="indexterm-210"></a><a name="indexterm-211"></a>By default, the principal buffer has a <tt>switch</tt> buffer policy. Under this policy, per-CPU
buffers are allocated in pairs: one buffer is active and the other buffer
is inactive. When a DTrace consumer attempts to read a buffer, the kernel
firsts <b>switches</b> the inactive and active buffers. Buffer switching is done in such
a manner that there is no window in which tracing data may be
lost. Once the buffers are switched, the newly inactive buffer is copied out
to the DTrace consumer. This policy assures that the consumer always sees a
self-consistent buffer: a buffer is never simultaneously traced to and copied out. This
technique also avoids introducing a window in which tracing is paused or otherwise
prevented. The rate at which the buffer is switched and read out is
controlled by the consumer with the <tt>switchrate</tt> option. As with any rate
option, <tt>switchrate</tt> may be specified with any time suffix, but defaults to rate-per-second.
For more details on <tt>switchrate</tt> and other options, see <a href="chp-opt.html">Chapter&nbsp;16, Options and Tunables</a>.</p>
<hr><p><b>Note - </b>To process the principal buffer at user-level at a rate faster than the
default of once per second, tune the value of <tt>switchrate</tt>. The system processes
actions that induce user-level activity (such as <tt>printa()</tt> and <tt>system()</tt>) when the
corresponding record in the principal buffer is processed. The value of <tt>switchrate</tt> dictates the
rate at which the system processes such actions.</p>
<hr>
<p>Under the <tt>switch</tt> policy, if a given enabled probe would trace more data
than there is space available in the active principal buffer, the data is
<b>dropped</b> and a per-CPU drop count is incremented. In the event of one
or more drops, <a href="http://docs.sun.com/doc/819-2240/dtrace-1m?a=view"><tt>dtrace</tt>(1M)</a> displays a message similar to the following example:</p><pre>dtrace: 11 drops on CPU 0</pre><p>If a given record is larger than the total buffer size, the
record will be dropped regardless of buffer policy. You can reduce or eliminate
drops by either increasing the size of the principal buffer with the <tt>bufsize</tt>
option or by increasing the switching rate with the <tt>switchrate</tt> option.</p><p>Under the <tt>switch</tt> policy, scratch space for <tt>copyin()</tt>, <tt>copyinstr()</tt>, and <tt>alloca()</tt> is allocated
out of the active buffer.</p>

<a name="chp-buf-2.2"></a><h4><tt>fill</tt> Policy</h4>
<p><a name="indexterm-212"></a><a name="indexterm-213"></a>For some problems, you might wish to use a single in-kernel buffer. While
this approach can be implemented with the <tt>switch</tt> policy and appropriate D constructs by
incrementing a variable in D and predicating an <tt>exit()</tt> action appropriately, such an
implementation does not eliminate the possibility of drops. To request a single, large
in-kernel buffer, and continue tracing until one or more of the per-CPU buffers
has filled, use the <tt>fill</tt> buffer policy. Under this policy, tracing continues until
an enabled probe attempts to trace more data than can fit in the
remaining principal buffer space. When insufficient space remains, the buffer is marked as
filled and the consumer is notified that at least one of its per-CPU
buffers has filled. Once <a href="http://docs.sun.com/doc/819-2240/dtrace-1m?a=view"><tt>dtrace</tt>(1M)</a> detects a single filled buffer, tracing is stopped,
all buffers are processed and <tt>dtrace</tt> exits. No further data will be traced
to a filled buffer even if the data would fit in the buffer.</p><p>To use the <tt>fill</tt> policy, set the <tt>bufpolicy</tt> option to <tt>fill</tt>. For example,
the following command traces every system call entry into a per-CPU 2K buffer
with the buffer policy set to <tt>fill</tt>:</p><pre><tt><b># dtrace -n syscall:::entry -b 2k -x bufpolicy=fill</b></tt></pre>

<a name="chp-buf-fillandend"></a><h5><tt>fill</tt> Policy and <tt>END</tt> Probes</h5>
<p><a name="indexterm-214"></a><tt>END</tt> probes normally do not fire until tracing has been explicitly stopped by
the DTrace consumer. <tt>END</tt> probes are guaranteed to only fire on one CPU, but
the CPU on which the probe fires is undefined. With <tt>fill</tt> buffers, tracing
is explicitly stopped when at least one of the per-CPU principal buffers has
been marked as filled. If the <tt>fill</tt> policy is selected, the <tt>END</tt> probe
may fire on a CPU that has a filled buffer. To accommodate <tt>END</tt>
tracing in <tt>fill</tt> buffers, DTrace calculates the amount of space potentially consumed by
<tt>END</tt> probes and <b>subtracts</b> this space from the size of the principal buffer. If
the net size is negative, DTrace will refuse to start, and <a href="http://docs.sun.com/doc/819-2240/dtrace-1m?a=view"><tt>dtrace</tt>(1M)</a>
will output a corresponding error message:</p><pre>dtrace: END enablings exceed size of principal buffer</pre><p>The reservation mechanism ensures that a full buffer always has sufficient space for
any <tt>END</tt> probes.</p>

<a name="chp-buf-2.3"></a><h4><tt>ring</tt> Policy</h4>
<p><a name="indexterm-215"></a><a name="indexterm-216"></a>The DTrace <tt>ring</tt> buffer policy helps you trace the events leading up to
a failure. If reproducing the failure takes hours or days, you might wish
to keep only the most recent data. Once a principal buffer has filled,
tracing wraps around to the first entry, thereby overwriting older tracing data. You
establish the ring buffer by setting the <tt>bufpolicy</tt> option to the string <tt>ring</tt>:</p><pre><tt><b># dtrace -s foo.d -x bufpolicy=ring</b></tt></pre><p>When used to create a ring buffer, <a href="http://docs.sun.com/doc/819-2240/dtrace-1m?a=view"><tt>dtrace</tt>(1M)</a> will not display any
output until the process is terminated. At that time, the ring buffer is
consumed and processed. <tt>dtrace</tt> processes each ring buffer in CPU order. Within a CPU's
buffer, trace records will be displayed in order from oldest to youngest. Just
as with the <tt>switch</tt> buffering policy, no ordering exists between records from different
CPUs are made. If such an ordering is required, you should trace the
<tt>timestamp</tt> variable as part of your tracing request.</p><p>The following example demonstrates the use of a <tt>#pragma option</tt> directive to enable ring
buffering:</p><pre>#pragma D option bufpolicy=ring
#pragma D option bufsize=16k

syscall:::entry
/execname == $1/
{
    trace(timestamp);
}

syscall::rexit:entry
{
    exit(0);
}</pre>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-buf-1.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-buf-3.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

