<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Predicates - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-11-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Solaris Dynamic Tracing Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-intro-4.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-intro-6.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="chp-intro.html">1.&nbsp;&nbsp;Introduction</a></p>
<p class="toc level2"><a href="chp-intro-1.html">Getting Started</a></p>
<p class="toc level2"><a href="chp-intro-2.html">Providers and Probes</a></p>
<p class="toc level2"><a href="chp-intro-3.html">Compilation and Instrumentation</a></p>
<p class="toc level2"><a href="chp-intro-4.html">Variables and Arithmetic Expressions</a></p>
<div class="onpage">
<p class="toc level2"><a href="">Predicates</a></p>
</div>
<p class="toc level2"><a href="chp-intro-6.html">Output Formatting</a></p>
<p class="toc level2"><a href="chp-intro-7.html">Arrays</a></p>
<p class="toc level2"><a href="chp-intro-8.html">External Symbols and Types</a></p>
<p class="toc level1 tocsp"><a href="chp-typeopexpr.html">2.&nbsp;&nbsp;Types, Operators, and Expressions</a></p>
<p class="toc level1 tocsp"><a href="chp-variables.html">3.&nbsp;&nbsp;Variables</a></p>
<p class="toc level1 tocsp"><a href="chp-prog.html">4.&nbsp;&nbsp;D Program Structure</a></p>
<p class="toc level1 tocsp"><a href="chp-pointers.html">5.&nbsp;&nbsp;Pointers and Arrays</a></p>
<p class="toc level1 tocsp"><a href="chp-strings.html">6.&nbsp;&nbsp;Strings</a></p>
<p class="toc level1 tocsp"><a href="chp-structs.html">7.&nbsp;&nbsp;Structs and Unions</a></p>
<p class="toc level1 tocsp"><a href="chp-types.html">8.&nbsp;&nbsp;Type and Constant Definitions</a></p>
<p class="toc level1 tocsp"><a href="chp-aggs.html">9.&nbsp;&nbsp;Aggregations</a></p>
<p class="toc level1 tocsp"><a href="chp-actsub.html">10.&nbsp;&nbsp;Actions and Subroutines</a></p>
<p class="toc level1 tocsp"><a href="chp-buf.html">11.&nbsp;&nbsp;Buffers and Buffering</a></p>
<p class="toc level1 tocsp"><a href="chp-fmt.html">12.&nbsp;&nbsp;Output Formatting</a></p>
<p class="toc level1 tocsp"><a href="chp-spec.html">13.&nbsp;&nbsp;Speculative Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace1m.html">14.&nbsp;&nbsp;<tt>dtrace</tt>(1M) Utility</a></p>
<p class="toc level1 tocsp"><a href="chp-script.html">15.&nbsp;&nbsp;Scripting</a></p>
<p class="toc level1 tocsp"><a href="chp-opt.html">16.&nbsp;&nbsp;Options and Tunables</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace.html">17.&nbsp;&nbsp;<tt>dtrace</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-lockstat.html">18.&nbsp;&nbsp;<tt>lockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-profile.html">19.&nbsp;&nbsp;<tt>profile</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fbt.html">20.&nbsp;&nbsp;<tt>fbt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-syscall.html">21.&nbsp;&nbsp;<tt>syscall</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sdt.html">22.&nbsp;&nbsp;<tt>sdt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sysinfo.html">23.&nbsp;&nbsp;<tt>sysinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-vminfo.html">24.&nbsp;&nbsp;<tt>vminfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-proc.html">25.&nbsp;&nbsp;<tt>proc</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sched.html">26.&nbsp;&nbsp;<tt>sched</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-io.html">27.&nbsp;&nbsp;<tt>io</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-mib.html">28.&nbsp;&nbsp;<tt>mib</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fpuinfo.html">29.&nbsp;&nbsp;<tt>fpuinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-pid.html">30.&nbsp;&nbsp;<tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-plockstat.html">31.&nbsp;&nbsp;<tt>plockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fasttrap.html">32.&nbsp;&nbsp;<tt>fasttrap</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-user.html">33.&nbsp;&nbsp;User Process Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-usdt.html">34.&nbsp;&nbsp;Statically Defined Tracing for User Applications</a></p>
<p class="toc level1 tocsp"><a href="chp-sec.html">35.&nbsp;&nbsp;Security</a></p>
<p class="toc level1 tocsp"><a href="chp-anon.html">36.&nbsp;&nbsp;Anonymous Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-post.html">37.&nbsp;&nbsp;Postmortem Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-perf.html">38.&nbsp;&nbsp;Performance Considerations</a></p>
<p class="toc level1 tocsp"><a href="chp-stab.html">39.&nbsp;&nbsp;Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-xlate.html">40.&nbsp;&nbsp;Translators</a></p>
<p class="toc level1 tocsp"><a href="chp-vers.html">41.&nbsp;&nbsp;Versioning</a></p>
<p class="toc level1 tocsp"><a href="gloss01.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="chp-intro-5"></a><h3>Predicates</h3>
<p>One major difference between D and other programming languages such as C, C++,
and the Java programming language is the absence of control-flow constructs such as
if-statements and loops. D program clauses are written as single straight-line statement lists
that trace an optional, fixed amount of data. D does provide the ability
to conditionally trace data and modify control flow using logical expressions called <b>predicates</b>
that can be used to prefix program clauses. A predicate expression is evaluated at
probe firing time prior to executing any of the statements associated with the
corresponding clause. If the predicate evaluates to true, represented by any non-zero value,
the statement list is executed. If the predicate is false, represented by a
zero value, none of the statements are executed and the probe firing is
ignored.</p><p>Type the following source code for the next example and save it
in a file named <tt>countdown.d</tt>:</p><pre>dtrace:::BEGIN
{
    i = 10;
}

profile:::tick-1sec
/i &gt; 0/
{
    trace(i--);
}

profile:::tick-1sec
/i == 0/
{
    trace("blastoff!");
    exit(0);
}</pre><p>This D program implements a 10-second countdown timer using predicates. When executed, <tt>countdown.d</tt>
counts down from 10 and then prints a message and exits:</p><pre># dtrace -s countdown.d
dtrace: script 'countdown.d' matched 3 probes
CPU     ID                    FUNCTION:NAME
    0  25499                       :tick-1sec        10
    0  25499                       :tick-1sec         9
    0  25499                       :tick-1sec         8
    0  25499                       :tick-1sec         7
    0  25499                       :tick-1sec         6
    0  25499                       :tick-1sec         5
    0  25499                       :tick-1sec         4
    0  25499                       :tick-1sec         3
    0  25499                       :tick-1sec         2
    0  25499                       :tick-1sec         1
    0  25499                       :tick-1sec   blastoff!
# </pre><p>This example uses the <tt>BEGIN</tt> probe to initialize an integer <tt>i</tt> to 10
to begin the countdown. Next, as in the previous example, the program uses
the <tt>tick-1sec</tt> probe to implement a timer that fires once per second. Notice
that in <tt>countdown.d</tt>, the <tt>tick-1sec</tt> probe description is used in two different clauses,
each with a different predicate and action list. The predicate is a logical
expression surrounded by enclosing slashes <tt>/ /</tt> that appears after the probe name
and before the braces <tt>{ }</tt> that surround the clause statement list.</p><p>The first predicate tests whether <tt>i</tt> is greater than zero, indicating that the
timer is still running:</p><pre>profile:::tick-1sec
/i &gt; 0/
{
    trace(i--);
}</pre><p>The relational operator <tt>&gt;</tt> means <b>greater than</b> and returns the integer value zero
for false and one for true. All of the C relational operators are
supported in D; the complete list is found in <a href="chp-typeopexpr.html">Chapter&nbsp;2, Types, Operators, and Expressions</a>. If <tt>i</tt> is
not yet zero, the script traces <tt>i</tt> and then decrements it by one
using the <tt>--</tt> operator.</p><p>The second predicate uses the <tt>==</tt> operator to return true when <tt>i</tt> is
exactly equal to zero, indicating that the countdown is complete:</p><pre>profile:::tick-1sec
/i == 0/
{
    trace("blastoff!");
    exit(0);
}</pre><p>Similar to the first example, <tt>hello.d</tt>, <tt>countdown.d</tt> uses a sequence of characters
enclosed in double quotes, called a <b>string constant</b>, to print a final message when
the countdown is complete. The <tt>exit()</tt> function is then used to exit <tt>dtrace</tt> and
return to the shell prompt.</p><p>If you look back at the structure of <tt>countdown.d</tt>, you will see that
by creating two clauses with the same probe description but different predicates and
actions, we effectively created the logical flow:</p>i = 10 once per second,     if i is greater than zero         trace(i--);     otherwise if i is equal to zero         trace("blastoff!");         exit(0);<p>When you wish to write complex programs using predicates, try to first visualize
your algorithm in this manner, and then transform each path of your conditional
constructs into a separate clause and predicate.</p><p>Now let's combine predicates with a new provider, the <tt>syscall</tt> provider, and create
our first real D tracing program. The <tt>syscall</tt> provider permits you to enable
probes on entry to or return from any Solaris system call. The next
example uses DTrace to observe every time your shell performs a <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> or
<a href="http://docs.sun.com/doc/819-2241/write-2?a=view"><tt>write</tt>(2)</a> system call. First, open two terminal windows, one to use for DTrace
and the other containing the shell process you're going to watch. In the
second window, type the following command to obtain the process ID of this
shell:</p><pre><tt><b># echo $$</b></tt>
12345</pre><p>Now go back to your first terminal window and type the following
D program and save it in a file named <tt>rw.d</tt>. As you type
in the program, replace <i>12345</i> with the process ID of the shell that was
printed in response to your <tt>echo</tt> command.</p><pre>syscall::read:entry,
syscall::write:entry
/pid == 12345/
{

}</pre><p>Notice that the body of <tt>rw.d</tt>'s probe clause is left empty because the
program is only intended to trace notification of probe firings and not to
trace any additional data. Once you're done typing in <tt>rw.d</tt>, use <tt>dtrace</tt>
to start your experiment and then go to your second shell window and
type a few commands, pressing return after each command. As you type, you
should see <tt>dtrace</tt> report probe firings in your first window, similar to the
following example:</p><pre><tt><b># dtrace -s rw.d</b></tt>
dtrace: script 'rw.d' matched 2 probes
CPU     ID                    FUNCTION:NAME
    0     34                      write:entry 
    0     32                       read:entry 
    0     34                      write:entry 
    0     32                       read:entry 
    0     34                      write:entry 
    0     32                       read:entry 
    0     34                      write:entry 
    0     32                       read:entry 
...</pre><p>You are now watching your shell perform <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> and <a href="http://docs.sun.com/doc/819-2241/write-2?a=view"><tt>write</tt>(2)</a> system calls to
read a character from your terminal window and echo back the result! This
example includes many of the concepts described so far and a few
new ones as well. First, to instrument <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> and <a href="http://docs.sun.com/doc/819-2241/write-2?a=view"><tt>write</tt>(2)</a> in the same
manner, the script uses a single probe clause with multiple probe descriptions by
separating the descriptions with commas like this:</p><pre>syscall::read:entry,
syscall::write:entry</pre><p>For readability, each probe description appears on its own line. This arrangement is
not strictly required, but it makes for a more readable script. Next the
script defines a predicate that matches only those system calls that are executed
by your shell process:</p><pre>/pid == 12345/</pre><p>The predicate uses the predefined DTrace variable <tt>pid</tt>, which always evaluates to the
process ID associated with the thread that fired the corresponding probe. DTrace provides
many built-in variable definitions for useful things like the process ID. Here is
a list of a few DTrace variables you can use to write your
first D programs:</p><table><col width="27%"><col width="21%"><col width="51%"><tr><th align="left" valign="top" scope="column"><p>Variable Name</p></th>
<th align="left" valign="top" scope="column"><p>Data Type</p></th>
<th align="left" valign="top" scope="column"><p>Meaning</p></th>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>errno</tt></p></td>
<td align="left" valign="top" scope="row"><p><tt>int</tt></p></td>
<td align="left" valign="top" scope="row"><p>Current <tt>errno</tt> value for system calls</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>execname</tt></p></td>
<td align="left" valign="top" scope="row"><p><tt>string</tt></p></td>
<td align="left" valign="top" scope="row"><p>Name of the
current process's executable file</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>pid</tt></p></td>
<td align="left" valign="top" scope="row"><p><tt>pid_t</tt></p></td>
<td align="left" valign="top" scope="row"><p>Process ID of the current process</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>tid</tt></p></td>
<td align="left" valign="top" scope="row"><p><tt>id_t</tt></p></td>
<td align="left" valign="top" scope="row"><p>Thread ID of the
current thread</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>probeprov</tt></p></td>
<td align="left" valign="top" scope="row"><p><tt>string</tt></p></td>
<td align="left" valign="top" scope="row"><p>Current probe description's provider field</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>probemod</tt></p></td>
<td align="left" valign="top" scope="row"><p><tt>string</tt></p></td>
<td align="left" valign="top" scope="row"><p>Current probe description's module field</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>probefunc</tt></p></td>
<td align="left" valign="top" scope="row"><p><tt>string</tt></p></td>
<td align="left" valign="top" scope="row"><p>Current probe description's
function field</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>probename</tt></p></td>
<td align="left" valign="top" scope="row"><p><tt>string</tt></p></td>
<td align="left" valign="top" scope="row"><p>Current probe description's name field</p></td>
</tr>
</table><p>Now that you've written a real instrumentation program, try experimenting with it on
different processes running on your system by changing the process ID and the
system call probes that are instrumented. Then, you can make one more simple
change and turn <tt>rw.d</tt> into a very simple version of a system call
tracing tool like <a href="http://docs.sun.com/doc/819-2239/truss-1?a=view"><tt>truss</tt>(1)</a>. An empty probe description field acts as a wildcard,
matching any probe, so change your program to the following new source code
to trace <b>any</b> system call executed by your shell:</p><pre>syscall:::entry
/pid == 12345/
{

}</pre><p>Try typing a few commands in the shell such as <tt>cd</tt>, <tt>ls</tt>,
and <tt>date</tt> and see what your DTrace program reports.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-intro-4.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-intro-6.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

