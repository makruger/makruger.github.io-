<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>pid Provider - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-11-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Solaris Dynamic Tracing Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-user-uregs.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-usdt.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="chp-intro.html">1.&nbsp;&nbsp;Introduction</a></p>
<p class="toc level1 tocsp"><a href="chp-typeopexpr.html">2.&nbsp;&nbsp;Types, Operators, and Expressions</a></p>
<p class="toc level1 tocsp"><a href="chp-variables.html">3.&nbsp;&nbsp;Variables</a></p>
<p class="toc level1 tocsp"><a href="chp-prog.html">4.&nbsp;&nbsp;D Program Structure</a></p>
<p class="toc level1 tocsp"><a href="chp-pointers.html">5.&nbsp;&nbsp;Pointers and Arrays</a></p>
<p class="toc level1 tocsp"><a href="chp-strings.html">6.&nbsp;&nbsp;Strings</a></p>
<p class="toc level1 tocsp"><a href="chp-structs.html">7.&nbsp;&nbsp;Structs and Unions</a></p>
<p class="toc level1 tocsp"><a href="chp-types.html">8.&nbsp;&nbsp;Type and Constant Definitions</a></p>
<p class="toc level1 tocsp"><a href="chp-aggs.html">9.&nbsp;&nbsp;Aggregations</a></p>
<p class="toc level1 tocsp"><a href="chp-actsub.html">10.&nbsp;&nbsp;Actions and Subroutines</a></p>
<p class="toc level1 tocsp"><a href="chp-buf.html">11.&nbsp;&nbsp;Buffers and Buffering</a></p>
<p class="toc level1 tocsp"><a href="chp-fmt.html">12.&nbsp;&nbsp;Output Formatting</a></p>
<p class="toc level1 tocsp"><a href="chp-spec.html">13.&nbsp;&nbsp;Speculative Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace1m.html">14.&nbsp;&nbsp;<tt>dtrace</tt>(1M) Utility</a></p>
<p class="toc level1 tocsp"><a href="chp-script.html">15.&nbsp;&nbsp;Scripting</a></p>
<p class="toc level1 tocsp"><a href="chp-opt.html">16.&nbsp;&nbsp;Options and Tunables</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace.html">17.&nbsp;&nbsp;<tt>dtrace</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-lockstat.html">18.&nbsp;&nbsp;<tt>lockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-profile.html">19.&nbsp;&nbsp;<tt>profile</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fbt.html">20.&nbsp;&nbsp;<tt>fbt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-syscall.html">21.&nbsp;&nbsp;<tt>syscall</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sdt.html">22.&nbsp;&nbsp;<tt>sdt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sysinfo.html">23.&nbsp;&nbsp;<tt>sysinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-vminfo.html">24.&nbsp;&nbsp;<tt>vminfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-proc.html">25.&nbsp;&nbsp;<tt>proc</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sched.html">26.&nbsp;&nbsp;<tt>sched</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-io.html">27.&nbsp;&nbsp;<tt>io</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-mib.html">28.&nbsp;&nbsp;<tt>mib</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fpuinfo.html">29.&nbsp;&nbsp;<tt>fpuinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-pid.html">30.&nbsp;&nbsp;<tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-plockstat.html">31.&nbsp;&nbsp;<tt>plockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fasttrap.html">32.&nbsp;&nbsp;<tt>fasttrap</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-user.html">33.&nbsp;&nbsp;User Process Tracing</a></p>
<p class="toc level2"><a href="chp-user-1.html"><tt>copyin()</tt> and <tt>copyinstr()</tt> Subroutines</a></p>
<p class="toc level2"><a href="chp-user-2.html">Eliminating <tt>dtrace</tt>(1M) Interference</a></p>
<p class="toc level2"><a href="chp-user-3.html"><tt>syscall</tt> Provider</a></p>
<p class="toc level2"><a href="chp-user-4.html"><tt>ustack()</tt> Action</a></p>
<p class="toc level2"><a href="chp-user-uregs.html"><tt>uregs[]</tt> Array</a></p>
<div class="onpage">
<p class="toc level2"><a href=""><tt>pid</tt> Provider</a></p>
</div>
<p class="toc level1 tocsp"><a href="chp-usdt.html">34.&nbsp;&nbsp;Statically Defined Tracing for User Applications</a></p>
<p class="toc level1 tocsp"><a href="chp-sec.html">35.&nbsp;&nbsp;Security</a></p>
<p class="toc level1 tocsp"><a href="chp-anon.html">36.&nbsp;&nbsp;Anonymous Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-post.html">37.&nbsp;&nbsp;Postmortem Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-perf.html">38.&nbsp;&nbsp;Performance Considerations</a></p>
<p class="toc level1 tocsp"><a href="chp-stab.html">39.&nbsp;&nbsp;Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-xlate.html">40.&nbsp;&nbsp;Translators</a></p>
<p class="toc level1 tocsp"><a href="chp-vers.html">41.&nbsp;&nbsp;Versioning</a></p>
<p class="toc level1 tocsp"><a href="gloss01.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="chp-user-5"></a><h3><tt>pid</tt> Provider</h3>
<p><a name="indexterm-465"></a>The <tt>pid</tt> provider enables you to trace any instruction in a process. Unlike
most other providers, <tt>pid</tt> probes are created on demand based on the probe
descriptions found in your D programs. As a result, no <tt>pid</tt> probes are
listed in the output of <tt>dtrace -l</tt> until you have enabled them yourself.</p>

<a name="chp-user-5.1"></a><h4>User Function Boundary Tracing</h4>
<p><a name="indexterm-466"></a>The simplest mode of operation for the <tt>pid</tt> provider is as the user space
analogue to the <tt>fbt</tt> provider. The following example program traces all function entries
and returns that are made from a single function. The <tt>$1</tt> macro variable
(the first operand on the command line) is the process ID for the
process to trace. The <tt>$2</tt> macro variable (the second operand on the command
line) is the name of the function from which to trace all function
calls.</p><a name="ex-userfunc.d"></a><h6>Example&nbsp;33-1 <tt>userfunc.d</tt>: Trace User Function Entry and Return</h6><pre>pid$1::$2:entry
{
    self-&gt;trace = 1;
}

pid$1::$2:return
/self-&gt;trace/
{
    self-&gt;trace = 0;
}

pid$1:::entry,
pid$1:::return
/self-&gt;trace/
{
}</pre><p>Type in the above example script and save it in a file
named <tt>userfunc.d</tt>, and then <tt>chmod</tt> it to be executable. This script produces output
similar to the following example:</p><pre><tt><b># ./userfunc.d 15032 execute</b></tt>
dtrace: script './userfunc.d' matched 11594 probes
  0  -&gt; execute                               
  0    -&gt; execute                             
  0      -&gt; Dfix                              
  0      &lt;- Dfix                              
  0      -&gt; s_strsave                         
  0        -&gt; malloc                          
  0        &lt;- malloc                          
  0      &lt;- s_strsave                         
  0      -&gt; set                               
  0        -&gt; malloc                          
  0        &lt;- malloc                          
  0      &lt;- set                               
  0      -&gt; set1                              
  0        -&gt; tglob                           
  0        &lt;- tglob                           
  0      &lt;- set1                              
  0      -&gt; setq                              
  0        -&gt; s_strcmp                        
  0        &lt;- s_strcmp                        
...</pre><p>The <tt>pid</tt> provider can only be used on processes that are already running.
You can use the <tt>$target</tt> macro variable (see <a href="chp-script.html">Chapter&nbsp;15, Scripting</a>) and the <tt>dtrace</tt> <tt>-c</tt> and
<tt>-p</tt> options to create and grab processes of interest and instrument them using
DTrace. For example, the following D script can be used to determine the
distribution of function calls made to <tt>libc</tt> by a particular subject process:</p><pre>pid$target:libc.so::entry
{
    @[probefunc] = count();
}</pre><p>To determine the distribution of such calls made by the <a href="http://docs.sun.com/doc/819-2239/date-1?a=view"><tt>date</tt>(1)</a> command,
save the script in a file named <tt>libc.d</tt> and execute the following command:</p><pre><tt><b># dtrace -s libc.d -c date</b></tt>
dtrace: script 'libc.d' matched 2476 probes
Fri Jul 30 14:08:54 PDT 2004
dtrace: pid 109196 has exited

  pthread_rwlock_unlock                                             1
  _fflush_u                                                         1
  rwlock_lock                                                       1
  rw_write_held                                                     1
  strftime                                                          1
  _close                                                            1
  _read                                                             1
  __open                                                            1
  _open                                                             1
  strstr                                                            1
  load_zoneinfo                                                     1

...
  _ti_bind_guard                                                   47
  _ti_bind_clear                                                   94</pre>

<a name="chp-user-5.2"></a><h4>Tracing Arbitrary Instructions</h4>
<p><a name="indexterm-467"></a><a name="indexterm-468"></a>You can use the <tt>pid</tt> provider to trace any instruction in any user
function. Upon demand, the <tt>pid</tt> provider will create a probe for every instruction
in a function. The name of each probe is the offset of its
corresponding instruction in the function expressed as a hexadecimal integer. For example, to
enable a probe associated with the instruction at offset 0x1c in function <tt>foo</tt>
of module <tt>bar.so</tt> in the process with PID 123, you can use
the following command:</p><pre><tt><b># dtrace -n pid123:bar.so:foo:1c</b></tt></pre><p>To enable all of the probes in the function <tt>foo</tt>, including the probe
for each instruction, you can use the command:</p><pre><tt><b># dtrace -n pid123:bar.so:foo:</b></tt></pre><p>This command demonstrates an extremely powerful technique for debugging and analyzing user applications.
Infrequent errors can be difficult to debug because they can be difficult to
reproduce. Often, you can identify a problem after the failure has occurred, too
late to reconstruct the code path. The following example demonstrates how to combine
the <tt>pid</tt> provider with speculative tracing (see <a href="chp-spec.html">Chapter&nbsp;13, Speculative Tracing</a>) to solve this problem by
tracing every instruction in a function.</p><a name="ex-errorpath.d"></a><h6>Example&nbsp;33-2 <tt>errorpath.d</tt>: Trace User Function Call Error Path</h6><pre>pid$1::$2:entry
{
    self-&gt;spec = speculation();
    speculate(self-&gt;spec);
    printf("%x %x %x %x %x", arg0, arg1, arg2, arg3, arg4);
}

pid$1::$2:
/self-&gt;spec/
{
    speculate(self-&gt;spec);
}

pid$1::$2:return
/self-&gt;spec &amp;&amp; arg1 == 0/
{
    discard(self-&gt;spec);
    self-&gt;spec = 0;
}

pid$1::$2:return
/self-&gt;spec &amp;&amp; arg1 != 0/
{
    commit(self-&gt;spec);
    self-&gt;spec = 0;
}</pre><p>Executing <tt>errorpath.d</tt> results in output similar to the following example:</p><pre><tt><b># ./errorpath.d 100461 _chdir</b></tt>
dtrace: script './errorpath.d' matched 19 probes
CPU     ID                    FUNCTION:NAME
  0  25253                     _chdir:entry 81e08 6d140 ffbfcb20 656c73 0
  0  25253                     _chdir:entry
  0  25269                         _chdir:0
  0  25270                         _chdir:4
  0  25271                         _chdir:8
  0  25272                         _chdir:c
  0  25273                        _chdir:10
  0  25274                        _chdir:14
  0  25275                        _chdir:18
  0  25276                        _chdir:1c
  0  25277                        _chdir:20
  0  25278                        _chdir:24
  0  25279                        _chdir:28
  0  25280                        _chdir:2c
  0  25268                    _chdir:return</pre>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-user-uregs.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-usdt.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

