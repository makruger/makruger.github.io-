<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Unions - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-11-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Solaris Dynamic Tracing Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-structs-2.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-structs-4.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="chp-intro.html">1.&nbsp;&nbsp;Introduction</a></p>
<p class="toc level1 tocsp"><a href="chp-typeopexpr.html">2.&nbsp;&nbsp;Types, Operators, and Expressions</a></p>
<p class="toc level1 tocsp"><a href="chp-variables.html">3.&nbsp;&nbsp;Variables</a></p>
<p class="toc level1 tocsp"><a href="chp-prog.html">4.&nbsp;&nbsp;D Program Structure</a></p>
<p class="toc level1 tocsp"><a href="chp-pointers.html">5.&nbsp;&nbsp;Pointers and Arrays</a></p>
<p class="toc level1 tocsp"><a href="chp-strings.html">6.&nbsp;&nbsp;Strings</a></p>
<p class="toc level1 tocsp"><a href="chp-structs.html">7.&nbsp;&nbsp;Structs and Unions</a></p>
<p class="toc level2"><a href="chp-structs-1.html">Structs</a></p>
<p class="toc level2"><a href="chp-structs-2.html">Pointers to Structs</a></p>
<div class="onpage">
<p class="toc level2"><a href="">Unions</a></p>
</div>
<p class="toc level2"><a href="chp-structs-4.html">Member Sizes and Offsets</a></p>
<p class="toc level2"><a href="chp-structs-5.html">Bit-Fields</a></p>
<p class="toc level1 tocsp"><a href="chp-types.html">8.&nbsp;&nbsp;Type and Constant Definitions</a></p>
<p class="toc level1 tocsp"><a href="chp-aggs.html">9.&nbsp;&nbsp;Aggregations</a></p>
<p class="toc level1 tocsp"><a href="chp-actsub.html">10.&nbsp;&nbsp;Actions and Subroutines</a></p>
<p class="toc level1 tocsp"><a href="chp-buf.html">11.&nbsp;&nbsp;Buffers and Buffering</a></p>
<p class="toc level1 tocsp"><a href="chp-fmt.html">12.&nbsp;&nbsp;Output Formatting</a></p>
<p class="toc level1 tocsp"><a href="chp-spec.html">13.&nbsp;&nbsp;Speculative Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace1m.html">14.&nbsp;&nbsp;<tt>dtrace</tt>(1M) Utility</a></p>
<p class="toc level1 tocsp"><a href="chp-script.html">15.&nbsp;&nbsp;Scripting</a></p>
<p class="toc level1 tocsp"><a href="chp-opt.html">16.&nbsp;&nbsp;Options and Tunables</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace.html">17.&nbsp;&nbsp;<tt>dtrace</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-lockstat.html">18.&nbsp;&nbsp;<tt>lockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-profile.html">19.&nbsp;&nbsp;<tt>profile</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fbt.html">20.&nbsp;&nbsp;<tt>fbt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-syscall.html">21.&nbsp;&nbsp;<tt>syscall</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sdt.html">22.&nbsp;&nbsp;<tt>sdt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sysinfo.html">23.&nbsp;&nbsp;<tt>sysinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-vminfo.html">24.&nbsp;&nbsp;<tt>vminfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-proc.html">25.&nbsp;&nbsp;<tt>proc</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sched.html">26.&nbsp;&nbsp;<tt>sched</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-io.html">27.&nbsp;&nbsp;<tt>io</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-mib.html">28.&nbsp;&nbsp;<tt>mib</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fpuinfo.html">29.&nbsp;&nbsp;<tt>fpuinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-pid.html">30.&nbsp;&nbsp;<tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-plockstat.html">31.&nbsp;&nbsp;<tt>plockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fasttrap.html">32.&nbsp;&nbsp;<tt>fasttrap</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-user.html">33.&nbsp;&nbsp;User Process Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-usdt.html">34.&nbsp;&nbsp;Statically Defined Tracing for User Applications</a></p>
<p class="toc level1 tocsp"><a href="chp-sec.html">35.&nbsp;&nbsp;Security</a></p>
<p class="toc level1 tocsp"><a href="chp-anon.html">36.&nbsp;&nbsp;Anonymous Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-post.html">37.&nbsp;&nbsp;Postmortem Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-perf.html">38.&nbsp;&nbsp;Performance Considerations</a></p>
<p class="toc level1 tocsp"><a href="chp-stab.html">39.&nbsp;&nbsp;Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-xlate.html">40.&nbsp;&nbsp;Translators</a></p>
<p class="toc level1 tocsp"><a href="chp-vers.html">41.&nbsp;&nbsp;Versioning</a></p>
<p class="toc level1 tocsp"><a href="gloss01.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="chp-structs-3"></a><h3>Unions</h3>
<p><a name="indexterm-124"></a>Unions are another kind of composite type supported by ANSI-C and D, and
are closely related to structs. A union is a composite type where a
set of members of different types are defined and the member objects all
occupy the same region of storage. A union is therefore an object of
variant type, where only one member is valid at any given time, depending
on how the union has been assigned. Typically, some other variable or piece
of state is used to indicate which union member is currently valid. The
size of a union is the size of its largest member, and the
memory alignment used for the union is the maximum alignment required by the
union members.</p><p><a name="indexterm-125"></a><a name="indexterm-126"></a>The Solaris <tt>kstat</tt> framework defines a struct containing a union that is used in
the following example to illustrate and observe C and D unions. The <tt>kstat</tt>
framework is used to export a set of named counters representing kernel statistics
such as memory usage and I/O throughput. The framework is used to implement
utilities such as <a href="http://docs.sun.com/doc/819-2240/mpstat-1m?a=view"><tt>mpstat</tt>(1M)</a> and <a href="http://docs.sun.com/doc/819-2240/iostat-1m?a=view"><tt>iostat</tt>(1M)</a>. This framework uses <tt>struct kstat_named</tt> to represent
a named counter and its value and is defined as follows:</p><pre>struct kstat_named {
    char name[KSTAT_STRLEN]; /* name of counter */
    uchar_t data_type;    /* data type */
    union {
        char c[16];
        int32_t i32;
        uint32_t ui32;
        long l;
        ulong_t ul;
        ...
    } value;    /* value of counter */
};    </pre><p>The examined declaration is shortened for illustrative purposes. The complete structure definition can
be found in the <tt>&lt;sys/kstat.h&gt;</tt> header file and is described in <tt>kstat_named</tt>(9S). The
declaration above is valid in both ANSI-C and D, and defines a struct
containing as one of its members a union value with members of various
types, depending on the type of the counter. Notice that since the union
itself is declared inside of another type, <tt>struct kstat_named</tt>, a formal name for
the union type is omitted. This declaration style is known as an <b>anonymous union</b>.
The member named <tt>value</tt> is of a union type described by the
preceding declaration, but this union type itself has no name because it does
not need to be used anywhere else. The struct member <tt>data_type</tt> is assigned a
value that indicates which union member is valid for each object of
type <tt>struct kstat_named</tt>. A set of C preprocessor tokens are defined for the values
of <tt>data_type</tt>. For example, the token <tt>KSTAT_DATA_CHAR</tt> is equal to zero and
indicates that the member <tt>value.c</tt> is where the value is currently stored.</p><p><a name="indexterm-127"></a><a name="indexterm-128"></a><a href="#ex-kstat.d">Example&nbsp;7-3</a> demonstrates accessing the <tt>kstat_named.value</tt> union by tracing a user process. The <tt>kstat</tt> counters
can be sampled from a user process using the <a href="http://docs.sun.com/doc/819-2246/kstat-data-lookup-3kstat?a=view"><tt>kstat_data_lookup</tt>(3KSTAT)</a> function, which returns a
pointer to a <tt>struct kstat_named</tt>. The <a href="http://docs.sun.com/doc/819-2240/mpstat-1m?a=view"><tt>mpstat</tt>(1M)</a> utility calls this function repeatedly as it
executes in order to sample the latest counter values. Go to your shell
and try running <tt>mpstat 1</tt> and observe the output. Press Control-C in your shell
to abort <tt>mpstat</tt> after a few seconds. To observe counter sampling, we would
like to enable a probe that fires each time the <tt>mpstat</tt> command calls
the <a href="http://docs.sun.com/doc/819-2246/kstat-data-lookup-3kstat?a=view"><tt>kstat_data_lookup</tt>(3KSTAT)</a> function in <tt>libkstat</tt>. To do so, we're going to make use
of a new DTrace provider: <tt>pid</tt>. The <tt>pid</tt> provider permits you to dynamically
create probes in user processes at C symbol locations such as function entry
points. You can ask the <tt>pid</tt> provider to create a probe at a
user function entry and return sites by writing probe descriptions of the form:</p><tt>pid</tt><i>process-ID</i><tt>:</tt><i>object-name</i><tt>:</tt><i>function-name</i><tt>:entry</tt> <tt>pid</tt><i>process-ID</i><tt>:</tt><i>object-name</i><tt>:</tt><i>function-name</i><tt>:return</tt><p>For example, if you wanted to create a probe in process ID
12345 that fires on entry to <a href="http://docs.sun.com/doc/819-2246/kstat-data-lookup-3kstat?a=view"><tt>kstat_data_lookup</tt>(3KSTAT)</a>, you would write the following probe description:</p><pre>pid12345:libkstat:kstat_data_lookup:entry</pre><p>The <tt>pid</tt> provider inserts dynamic instrumentation into the specified user process at the
program location corresponding to the probe description. The probe implementation forces each user
thread that reaches the instrumented program location to trap into the operating system
kernel and enter DTrace, firing the corresponding probe. So although the instrumentation location is
associated with a user process, the DTrace predicates and actions you specify still
execute in the context of the operating system kernel. The <tt>pid</tt> provider
is described in further detail in <a href="chp-pid.html">Chapter&nbsp;30, <tt>pid</tt> Provider</a>.</p><p><a name="indexterm-129"></a><a name="indexterm-130"></a><a name="indexterm-131"></a>Instead of having to edit your D program source each time you wish
to apply your program to a different process, you can insert identifiers called
<b>macro variables</b> into your program that are evaluated at the time your program is
compiled and replaced with the additional <tt>dtrace</tt> command-line arguments. Macro variables are specified
using a dollar sign <tt>$</tt> followed by an identifier or digit. If you
execute the command <tt>dtrace -s <i>script</i> foo bar baz</tt>, the D compiler will automatically define the macro variables
<tt>$1</tt>, <tt>$2</tt>, and <tt>$3</tt> to be the tokens <tt>foo</tt>, <tt>bar</tt>, and <tt>baz</tt> respectively.
You can use macro variables in D program expressions or in probe descriptions.
For example, the following probe descriptions instrument whatever process ID is specified as
an additional argument to <tt>dtrace</tt>:</p><pre>pid$1:libkstat:kstat_data_lookup:entry
{
    self-&gt;ksname = arg1;
}

pid$1:libkstat:kstat_data_lookup:return
/self-&gt;ksname != NULL &amp;&amp; arg1 != NULL/
{
    this-&gt;ksp = (kstat_named_t *)copyin(arg1, sizeof (kstat_named_t));
    printf("%s has ui64 value %u\n", copyinstr(self-&gt;ksname),
        this-&gt;ksp-&gt;value.ui64);
}

pid$1:libkstat:kstat_data_lookup:return
/self-&gt;ksname != NULL &amp;&amp; arg1 == NULL/
{
    self-&gt;ksname = NULL;
}</pre><p>Macro variables and reusable scripts are described in further detail in <a href="chp-script.html">Chapter&nbsp;15, Scripting</a>. Now
that we know how to instrument user processes using their process ID, let's
return to sampling unions. Go to your editor and type in the source
code for our complete example and save it in a file named <tt>kstat.d</tt>:</p><a name="ex-kstat.d"></a><h6>Example&nbsp;7-3 <tt>kstat.d</tt>: Trace Calls to <tt>kstat_data_lookup</tt>(3KSTAT)</h6><pre>pid$1:libkstat:kstat_data_lookup:entry
{
    self-&gt;ksname = arg1;
}

pid$1:libkstat:kstat_data_lookup:return
/self-&gt;ksname != NULL &amp;&amp; arg1 != NULL/
{
    this-&gt;ksp = (kstat_named_t *) copyin(arg1, sizeof (kstat_named_t));
    printf("%s has ui64 value %u\n",
        copyinstr(self-&gt;ksname), this-&gt;ksp-&gt;value.ui64);
}

pid$1:libkstat:kstat_data_lookup:return
/self-&gt;ksname != NULL &amp;&amp; arg1 == NULL/
{
    self-&gt;ksname = NULL;
}</pre><p>Now go to one of your shells and execute the command <tt>mpstat 1</tt>
to start <a href="http://docs.sun.com/doc/819-2240/mpstat-1m?a=view"><tt>mpstat</tt>(1M)</a> running in a mode where it samples statistics and reports
them once per second. Once <tt>mpstat</tt> is running, execute the command <tt>dtrace -q -s kstat.d `pgrep mpstat`</tt>
in your other shell. You will see output corresponding to the statistics that
are being accessed. Press Control-C to abort <tt>dtrace</tt> and return to the
shell prompt.</p><pre><tt><b># dtrace -q -s kstat.d `pgrep mpstat`</b></tt>
cpu_ticks_idle has ui64 value 41154176
cpu_ticks_user has ui64 value 1137
cpu_ticks_kernel has ui64 value 12310
cpu_ticks_wait has ui64 value 903
hat_fault has ui64 value 0
as_fault has ui64 value 48053
maj_fault has ui64 value 1144
xcalls has ui64 value 123832170
intr has ui64 value 165264090
intrthread has ui64 value 124094974
pswitch has ui64 value 840625
inv_swtch has ui64 value 1484
cpumigrate has ui64 value 36284
mutex_adenters has ui64 value 35574
rw_rdfails has ui64 value 2
rw_wrfails has ui64 value 2
...
<tt><b>^C</b></tt>
<tt><b>#</b></tt></pre><p>If you capture the output in each terminal window and subtract each value
from the value reported by the previous iteration through the statistics, you should
be able to correlate the <tt>dtrace</tt> output with the <tt>mpstat</tt> output. The example
program records the counter name pointer on entry to the lookup function, and
then performs most of the tracing work on return from <a href="http://docs.sun.com/doc/819-2246/kstat-data-lookup-3kstat?a=view"><tt>kstat_data_lookup</tt>(3KSTAT)</a>. The D built-in
functions <tt>copyinstr()</tt> and <tt>copyin()</tt> copy the function results from the user process back
into DTrace when <tt>arg1</tt> (the return value) is not <tt>NULL</tt>. Once the <tt>kstat</tt>
data has been copied, the example reports the <tt>ui64</tt> counter value from the union.
This simplified example assumes that <tt>mpstat</tt> samples counters that use the <tt>value.ui64</tt> member.
As an exercise, try recoding <tt>kstat.d</tt> to use multiple predicates and print out the
union member corresponding to the <tt>data_type</tt> member. You can also try to create
a version of <tt>kstat.d</tt> that computes the difference between successive data values and
actually produces output similar to <tt>mpstat</tt>.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-structs-2.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-structs-4.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

