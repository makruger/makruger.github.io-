<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Arrays - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-11-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Solaris Dynamic Tracing Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-intro-6.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-intro-8.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="chp-intro.html">1.&nbsp;&nbsp;Introduction</a></p>
<p class="toc level2"><a href="chp-intro-1.html">Getting Started</a></p>
<p class="toc level2"><a href="chp-intro-2.html">Providers and Probes</a></p>
<p class="toc level2"><a href="chp-intro-3.html">Compilation and Instrumentation</a></p>
<p class="toc level2"><a href="chp-intro-4.html">Variables and Arithmetic Expressions</a></p>
<p class="toc level2"><a href="chp-intro-5.html">Predicates</a></p>
<p class="toc level2"><a href="chp-intro-6.html">Output Formatting</a></p>
<div class="onpage">
<p class="toc level2"><a href="">Arrays</a></p>
</div>
<p class="toc level2"><a href="chp-intro-8.html">External Symbols and Types</a></p>
<p class="toc level1 tocsp"><a href="chp-typeopexpr.html">2.&nbsp;&nbsp;Types, Operators, and Expressions</a></p>
<p class="toc level1 tocsp"><a href="chp-variables.html">3.&nbsp;&nbsp;Variables</a></p>
<p class="toc level1 tocsp"><a href="chp-prog.html">4.&nbsp;&nbsp;D Program Structure</a></p>
<p class="toc level1 tocsp"><a href="chp-pointers.html">5.&nbsp;&nbsp;Pointers and Arrays</a></p>
<p class="toc level1 tocsp"><a href="chp-strings.html">6.&nbsp;&nbsp;Strings</a></p>
<p class="toc level1 tocsp"><a href="chp-structs.html">7.&nbsp;&nbsp;Structs and Unions</a></p>
<p class="toc level1 tocsp"><a href="chp-types.html">8.&nbsp;&nbsp;Type and Constant Definitions</a></p>
<p class="toc level1 tocsp"><a href="chp-aggs.html">9.&nbsp;&nbsp;Aggregations</a></p>
<p class="toc level1 tocsp"><a href="chp-actsub.html">10.&nbsp;&nbsp;Actions and Subroutines</a></p>
<p class="toc level1 tocsp"><a href="chp-buf.html">11.&nbsp;&nbsp;Buffers and Buffering</a></p>
<p class="toc level1 tocsp"><a href="chp-fmt.html">12.&nbsp;&nbsp;Output Formatting</a></p>
<p class="toc level1 tocsp"><a href="chp-spec.html">13.&nbsp;&nbsp;Speculative Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace1m.html">14.&nbsp;&nbsp;<tt>dtrace</tt>(1M) Utility</a></p>
<p class="toc level1 tocsp"><a href="chp-script.html">15.&nbsp;&nbsp;Scripting</a></p>
<p class="toc level1 tocsp"><a href="chp-opt.html">16.&nbsp;&nbsp;Options and Tunables</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace.html">17.&nbsp;&nbsp;<tt>dtrace</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-lockstat.html">18.&nbsp;&nbsp;<tt>lockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-profile.html">19.&nbsp;&nbsp;<tt>profile</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fbt.html">20.&nbsp;&nbsp;<tt>fbt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-syscall.html">21.&nbsp;&nbsp;<tt>syscall</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sdt.html">22.&nbsp;&nbsp;<tt>sdt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sysinfo.html">23.&nbsp;&nbsp;<tt>sysinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-vminfo.html">24.&nbsp;&nbsp;<tt>vminfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-proc.html">25.&nbsp;&nbsp;<tt>proc</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sched.html">26.&nbsp;&nbsp;<tt>sched</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-io.html">27.&nbsp;&nbsp;<tt>io</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-mib.html">28.&nbsp;&nbsp;<tt>mib</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fpuinfo.html">29.&nbsp;&nbsp;<tt>fpuinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-pid.html">30.&nbsp;&nbsp;<tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-plockstat.html">31.&nbsp;&nbsp;<tt>plockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fasttrap.html">32.&nbsp;&nbsp;<tt>fasttrap</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-user.html">33.&nbsp;&nbsp;User Process Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-usdt.html">34.&nbsp;&nbsp;Statically Defined Tracing for User Applications</a></p>
<p class="toc level1 tocsp"><a href="chp-sec.html">35.&nbsp;&nbsp;Security</a></p>
<p class="toc level1 tocsp"><a href="chp-anon.html">36.&nbsp;&nbsp;Anonymous Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-post.html">37.&nbsp;&nbsp;Postmortem Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-perf.html">38.&nbsp;&nbsp;Performance Considerations</a></p>
<p class="toc level1 tocsp"><a href="chp-stab.html">39.&nbsp;&nbsp;Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-xlate.html">40.&nbsp;&nbsp;Translators</a></p>
<p class="toc level1 tocsp"><a href="chp-vers.html">41.&nbsp;&nbsp;Versioning</a></p>
<p class="toc level1 tocsp"><a href="gloss01.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="chp-intro-7"></a><h3>Arrays</h3>
<p>D permits you to define variables that are integers, as well as
other types to represent strings and composite types called <b>structs</b> and <b>unions</b>. If
you are familiar with C programming, you'll be happy to know you can
use any type in D that you can in C. If you're
not a C expert, don't worry: the different kinds of data types are
all described in <a href="chp-typeopexpr.html">Chapter&nbsp;2, Types, Operators, and Expressions</a>. D also supports a special kind of variable called
an <b>associative array</b>. An associative array is similar to a normal array in
that it associates a set of keys with a set of values, but
in an associative array the keys are not limited to integers of a
fixed range.</p><p>D associative arrays can be indexed by a list of one or
more values of any type. Together the individual key values form a <b>tuple</b>
that is used to index into the array and access or modify the
value corresponding to that key. Every tuple used with a given associative array
must conform to the same type signature; that is, each tuple key must
be of the same length and have the same key types in the
same order. The value associated with each element of a given associative array
is also of a single fixed type for the entire array. For example,
the following D statement defines a new associative array <tt>a</tt> of value type
<tt>int</tt> with the tuple signature <tt>[ string, int ]</tt> and stores the integer value 456 in the
array:</p><pre>a["hello", 123] = 456;</pre><p>Once an array is defined, its elements can be accessed like any
other D variable. For example, the following D statement modifies the array element previously
stored in <tt>a</tt> by incrementing the value from 456 to 457:</p><pre>a["hello", 123]++;</pre><p>The values of any array elements you have not yet assigned are
set to zero. Now let's use an associative array in a D program.
Type the following program and save it in a file named <tt>rwtime.d</tt>:</p><a name="ex-rwtime.d"></a><h6>Example&nbsp;1-3 <tt>rwtime.d</tt>: Time <tt>read</tt>(2) and <tt>write</tt>(2) Calls</h6><pre>syscall::read:entry,
syscall::write:entry
/pid == $1/
{
    ts[probefunc] = timestamp;
}

syscall::read:return,
syscall::write:return
/pid == $1 &amp;&amp; ts[probefunc] != 0/
{
    printf("%d nsecs", timestamp - ts[probefunc]);
}</pre><p>As with <tt>trussrw.d</tt>, specify the ID of shell process when you execute <tt>rwtime.d</tt>.
If you type a few shell commands, you'll see the amount time elapsed
during each system call. Type in the following command and then press return
a few times in your other shell:</p><pre><tt><b># dtrace -s rwtime.d `pgrep -n ksh`</b></tt>
dtrace: script 'rwtime.d' matched 4 probes
CPU     ID                    FUNCTION:NAME
  0     33                      read:return 22644 nsecs
  0     33                      read:return 3382 nsecs
  0     35                     write:return 25952 nsecs
  0     33                      read:return 916875239 nsecs
  0     35                     write:return 27320 nsecs
  0     33                      read:return 9022 nsecs
  0     33                      read:return 3776 nsecs
  0     35                     write:return 17164 nsecs
...
<tt><b>^C</b></tt>
#</pre><p>To trace the elapsed time for each system call, you must instrument both
the entry to and return from <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> and <a href="http://docs.sun.com/doc/819-2241/write-2?a=view"><tt>write</tt>(2)</a> and sample the
time at each point. Then, on return from a given system call, you
must compute the difference between our first and second timestamp. You could use
separate variables for each system call, but this would make the program annoying
to extend to additional system calls. Instead, it's easier to use an associative
array indexed by the probe function name. Here is the first probe clause:</p><pre>syscall::read:entry,
syscall::write:entry
/pid == $1/
{
    ts[probefunc] = timestamp;
}</pre><p>This clause defines an array named <tt>ts</tt> and assigns the appropriate member the
value of the DTrace variable <tt>timestamp</tt>. This variable returns the value of an
always-incrementing nanosecond counter, similar to the Solaris library routine <a href="http://docs.sun.com/doc/819-2243/gethrtime-3c?a=view"><tt>gethrtime</tt>(3C)</a>. Once the entry
timestamp is saved, the corresponding return probe samples <tt>timestamp</tt> again and reports the difference
between the current time and the saved value:</p><pre>syscall::read:return,
syscall::write:return
/pid == $1 &amp;&amp; ts[probefunc] != 0/
{
    printf("%d nsecs", timestamp - ts[probefunc]);
}</pre><p>The predicate on the return probe requires that DTrace is tracing the appropriate
process and that the corresponding <tt>entry</tt> probe has already fired and assigned <tt>ts[probefunc]</tt>
a non-zero value. This trick eliminates invalid output when DTrace first starts. If
your shell is already waiting in a <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> system call for input when you
execute <tt>dtrace</tt>, the <tt>read:return</tt> probe will fire without a preceding <tt>read:entry</tt> for this
first <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> and <tt>ts[probefunc]</tt> will evaluate to zero because it has not
yet been assigned.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-intro-6.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-intro-8.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

