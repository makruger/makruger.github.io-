<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Aggregations - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-11-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Solaris Dynamic Tracing Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-aggs-1.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-aggs-7.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="chp-intro.html">1.&nbsp;&nbsp;Introduction</a></p>
<p class="toc level1 tocsp"><a href="chp-typeopexpr.html">2.&nbsp;&nbsp;Types, Operators, and Expressions</a></p>
<p class="toc level1 tocsp"><a href="chp-variables.html">3.&nbsp;&nbsp;Variables</a></p>
<p class="toc level1 tocsp"><a href="chp-prog.html">4.&nbsp;&nbsp;D Program Structure</a></p>
<p class="toc level1 tocsp"><a href="chp-pointers.html">5.&nbsp;&nbsp;Pointers and Arrays</a></p>
<p class="toc level1 tocsp"><a href="chp-strings.html">6.&nbsp;&nbsp;Strings</a></p>
<p class="toc level1 tocsp"><a href="chp-structs.html">7.&nbsp;&nbsp;Structs and Unions</a></p>
<p class="toc level1 tocsp"><a href="chp-types.html">8.&nbsp;&nbsp;Type and Constant Definitions</a></p>
<p class="toc level1 tocsp"><a href="chp-aggs.html">9.&nbsp;&nbsp;Aggregations</a></p>
<p class="toc level2"><a href="chp-aggs-1.html">Aggregating Functions</a></p>
<div class="onpage">
<p class="toc level2"><a href="">Aggregations</a></p>
</div>
<p class="toc level2"><a href="chp-aggs-7.html">Printing Aggregations</a></p>
<p class="toc level2"><a href="chp-aggs-normalization.html">Data Normalization</a></p>
<p class="toc level2"><a href="chp-aggs-clear.html">Clearing Aggregations</a></p>
<p class="toc level2"><a href="chp-aggs-trunc.html">Truncating aggregations</a></p>
<p class="toc level2"><a href="chp-aggs-4.html">Minimizing Drops</a></p>
<p class="toc level1 tocsp"><a href="chp-actsub.html">10.&nbsp;&nbsp;Actions and Subroutines</a></p>
<p class="toc level1 tocsp"><a href="chp-buf.html">11.&nbsp;&nbsp;Buffers and Buffering</a></p>
<p class="toc level1 tocsp"><a href="chp-fmt.html">12.&nbsp;&nbsp;Output Formatting</a></p>
<p class="toc level1 tocsp"><a href="chp-spec.html">13.&nbsp;&nbsp;Speculative Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace1m.html">14.&nbsp;&nbsp;<tt>dtrace</tt>(1M) Utility</a></p>
<p class="toc level1 tocsp"><a href="chp-script.html">15.&nbsp;&nbsp;Scripting</a></p>
<p class="toc level1 tocsp"><a href="chp-opt.html">16.&nbsp;&nbsp;Options and Tunables</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace.html">17.&nbsp;&nbsp;<tt>dtrace</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-lockstat.html">18.&nbsp;&nbsp;<tt>lockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-profile.html">19.&nbsp;&nbsp;<tt>profile</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fbt.html">20.&nbsp;&nbsp;<tt>fbt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-syscall.html">21.&nbsp;&nbsp;<tt>syscall</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sdt.html">22.&nbsp;&nbsp;<tt>sdt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sysinfo.html">23.&nbsp;&nbsp;<tt>sysinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-vminfo.html">24.&nbsp;&nbsp;<tt>vminfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-proc.html">25.&nbsp;&nbsp;<tt>proc</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sched.html">26.&nbsp;&nbsp;<tt>sched</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-io.html">27.&nbsp;&nbsp;<tt>io</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-mib.html">28.&nbsp;&nbsp;<tt>mib</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fpuinfo.html">29.&nbsp;&nbsp;<tt>fpuinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-pid.html">30.&nbsp;&nbsp;<tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-plockstat.html">31.&nbsp;&nbsp;<tt>plockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fasttrap.html">32.&nbsp;&nbsp;<tt>fasttrap</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-user.html">33.&nbsp;&nbsp;User Process Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-usdt.html">34.&nbsp;&nbsp;Statically Defined Tracing for User Applications</a></p>
<p class="toc level1 tocsp"><a href="chp-sec.html">35.&nbsp;&nbsp;Security</a></p>
<p class="toc level1 tocsp"><a href="chp-anon.html">36.&nbsp;&nbsp;Anonymous Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-post.html">37.&nbsp;&nbsp;Postmortem Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-perf.html">38.&nbsp;&nbsp;Performance Considerations</a></p>
<p class="toc level1 tocsp"><a href="chp-stab.html">39.&nbsp;&nbsp;Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-xlate.html">40.&nbsp;&nbsp;Translators</a></p>
<p class="toc level1 tocsp"><a href="chp-vers.html">41.&nbsp;&nbsp;Versioning</a></p>
<p class="toc level1 tocsp"><a href="gloss01.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="chp-aggs-2"></a><h3>Aggregations</h3>
<p><a name="indexterm-149"></a>DTrace stores the results of aggregating functions in objects called <b>aggregations</b>. The aggregation results
are indexed using a tuple of expressions similar to those used for associative
arrays. In D, the syntax for an aggregation is:</p><pre>@<i>name</i>[ <i>keys</i> ] = <i>aggfunc</i> ( <i>args</i> );</pre><p>where <i>name</i> is the name of the aggregation, <i>keys</i> is a comma-separated
list of D expressions, <i>aggfunc</i> is one of the DTrace aggregating functions,
and <i>args</i> is a comma-separated list of arguments appropriate for the aggregating function. The
aggregation <i>name</i> is a D identifier that is prefixed with the special character
<tt>@</tt>. All aggregations named in your D programs are global variables; there are
no thread- or clause-local aggregations. The aggregation names are kept in a separate
identifier namespace from other D global variables. Remember that <tt>a</tt> and <tt>@a</tt> are
not the same variable if you reuse names. The special aggregation name <tt>@</tt>
can be used to name an anonymous aggregation in simple D programs. The
D compiler treats this name as an alias for the aggregation name <tt>@_</tt>.</p><p><a name="indexterm-150"></a><a name="indexterm-151"></a><a name="indexterm-152"></a><a name="indexterm-153"></a><a name="indexterm-154"></a><a name="indexterm-155"></a><a name="indexterm-156"></a>The DTrace aggregating functions are shown in the following table. Most aggregating functions
take just a single argument that represents the new datum.</p><a name="chp-aggs-tbl-4"></a><h6>Table&nbsp;9-1 DTrace Aggregating Functions</h6><table><col width="20%"><col width="20%"><col width="59%"><tr><th align="left" valign="top" scope="column"><p>Function Name</p></th>
<th align="left" valign="top" scope="column"><p>Arguments</p></th>
<th align="left" valign="top" scope="column"><p>Result</p></th>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>count</tt></p></td>
<td align="left" valign="top" scope="row"><p>none</p></td>
<td align="left" valign="top" scope="row"><p>The number of
times called.</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>sum</tt></p></td>
<td align="left" valign="top" scope="row"><p>scalar expression</p></td>
<td align="left" valign="top" scope="row"><p>The total value of the specified expressions.</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>avg</tt></p></td>
<td align="left" valign="top" scope="row"><p>scalar expression</p></td>
<td align="left" valign="top" scope="row"><p>The arithmetic average
of the specified expressions.</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>min</tt></p></td>
<td align="left" valign="top" scope="row"><p>scalar expression</p></td>
<td align="left" valign="top" scope="row"><p>The smallest value among the specified expressions.</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>max</tt></p></td>
<td align="left" valign="top" scope="row"><p>scalar expression</p></td>
<td align="left" valign="top" scope="row"><p>The
largest value among the specified expressions.</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>lquantize</tt></p></td>
<td align="left" valign="top" scope="row"><p>scalar expression, lower bound, upper bound, step
value</p></td>
<td align="left" valign="top" scope="row"><p>A linear frequency distribution, sized by the specified range, of the values of
the specified expressions. Increments the value in the <b>highest</b> bucket that is
<b>less</b> than the specified expression.</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>quantize</tt></p></td>
<td align="left" valign="top" scope="row"><p>scalar expression</p></td>
<td align="left" valign="top" scope="row"><p>A power-of-two frequency distribution of the values
of the specified expressions. Increments the value in the <b>highest</b> power-of-two bucket that is
<b>less</b> than the specified expression.</p></td>
</tr>
</table><p>For example, to count the number of <a href="http://docs.sun.com/doc/819-2241/write-2?a=view"><tt>write</tt>(2)</a> system calls in the
system, you could use an informative string as a key and the <tt>count()</tt>
aggregating function:</p><pre>syscall::write:entry
{
    @counts["write system calls"] = count();
}</pre><p><a name="indexterm-157"></a>The <tt>dtrace</tt> command prints aggregation results by default when the process terminates, either
as the result of an explicit <tt>END</tt> action or when the user presses
Control-C. The following example output shows the result of running this command, waiting
for a few seconds, and pressing Control-C:</p><pre><tt><b># dtrace -s writes.d</b></tt>
dtrace: script './writes.d' matched 1 probe
<tt><b>^C</b></tt>

  write system calls                                              179
#</pre><p><a name="indexterm-158"></a>You can count system calls per process name using the <tt>execname</tt> variable as the
key to an aggregation:</p><pre>syscall::write:entry
{
    @counts[execname] = count();
}</pre><p>The following example output shows the result of running this command, waiting for
a few seconds, and pressing Control-C:</p><pre><tt><b># dtrace -s writesbycmd.d</b></tt>
dtrace: script './writesbycmd.d' matched 1 probe
<tt><b>^C</b></tt>

  dtrace                                                            1
  cat                                                               4
  sed                                                               9
  head                                                              9
  grep                                                             14
  find                                                             15
  tail                                                             25
  mountd                                                           28
  expr                                                             72
  sh                                                              291
  tee                                                             814
  def.dir.flp                                                    1996
  make.bin                                                       2010
#</pre><p>Alternatively, you might want to further examine writes organized by both executable name
and file descriptor. The file descriptor is the first argument to <a href="http://docs.sun.com/doc/819-2241/write-2?a=view"><tt>write</tt>(2)</a>, so the
following example uses a key consisting of both <tt>execname</tt> and <tt>arg0</tt>:</p><pre>syscall::write:entry
{
    @counts[execname, arg0] = count();
}</pre><p>Running this command results in a table with both executable name and file
descriptor, as shown in the following example:</p><pre><tt><b># dtrace -s writesbycmdfd.d</b></tt>
dtrace: script './writesbycmdfd.d' matched 1 probe
<tt><b>^C</b></tt>

  cat                                                               1      58
  sed                                                               1      60
  grep                                                              1      89
  tee                                                               1     156
  tee                                                               3     156
  make.bin                                                          5     164
  acomp                                                             1     263
  macrogen                                                          4     286
  cg                                                                1     397
  acomp                                                             3     736
  make.bin                                                          1     880
  iropt                                                             4    1731
#</pre><p>The following example displays the average time spent in the write system call,
organized by process name. This example uses the <tt>avg()</tt> aggregating function, specifying the
expression to average as the argument. The example averages the wall clock time
spent in the system call:</p><pre>syscall::write:entry
{
    self-&gt;ts = timestamp;
}

syscall::write:return
/self-&gt;ts/
{
    @time[execname] = avg(timestamp - self-&gt;ts);
    self-&gt;ts = 0;
}</pre><p>The following example output shows the result of running this command, waiting for
a few seconds, and pressing Control-C:</p><pre><tt><b># dtrace -s writetime.d</b></tt>
dtrace: script './writetime.d' matched 2 probes
<tt><b>^C</b></tt>

  iropt                                                         31315
  acomp                                                         37037
  make.bin                                                      63736
  tee                                                           68702
  date                                                          84020
  sh                                                            91632
  dtrace                                                       159200
  ctfmerge                                                     321560
  install                                                      343300
  mcs                                                          394400
  get                                                          413695
  ctfconvert                                                   594400
  bringover                                                   1332465
  tail                                                        1335260
#</pre><p>The average can be useful, but often does not provide sufficient detail to
understand the distribution of data points. To understand the distribution in further detail,
use the <tt>quantize()</tt> aggregating function as shown in the following example:</p><pre>syscall::write:entry
{
    self-&gt;ts = timestamp;
}

syscall::write:return
/self-&gt;ts/
{
    @time[execname] = quantize(timestamp - self-&gt;ts);
    self-&gt;ts = 0;
}</pre><p>Because each line of output becomes a frequency distribution diagram, the output of
this script is substantially longer than previous ones. The following example shows a
selection of sample output:</p><pre>  lint                                              
           value  ------------- Distribution ------------- count    
            8192 |                                         0        
           16384 |                                         2        
           32768 |                                         0        
           65536 |@@@@@@@@@@@@@@@@@@@                      74       
          131072 |@@@@@@@@@@@@@@@                          59       
          262144 |@@@                                      14       
          524288 |                                         0        

  acomp                                             
           value  ------------- Distribution ------------- count    
            4096 |                                         0        
            8192 |@@@@@@@@@@@@                             840      
           16384 |@@@@@@@@@@@                              750      
           32768 |@@                                       165      
           65536 |@@@@@@                                   460      
          131072 |@@@@@@                                   446      
          262144 |                                         16       
          524288 |                                         0        
         1048576 |                                         1        
         2097152 |                                         0        

  iropt                                             
           value  ------------- Distribution ------------- count    
            4096 |                                         0        
            8192 |@@@@@@@@@@@@@@@@@@@@@@@                  4149     
           16384 |@@@@@@@@@@                               1798     
           32768 |@                                        332      
           65536 |@                                        325      
          131072 |@@                                       431      
          262144 |                                         3        
          524288 |                                         2        
         1048576 |                                         1        
         2097152 |                                         0        </pre><p>Notice that the rows for the frequency distribution are <b>always</b> power-of-two values. Each
rows indicates the count of the number of elements <b>greater than or equal to</b> the corresponding
value, but <b>less than</b> the next larger row value. For example, the above output
shows that <tt>iropt</tt> had 4,149 writes taking between 8,192 nanoseconds and 16,383 nanoseconds,
inclusive.</p><p>While <tt>quantize()</tt> is useful for getting quick insight into the data, you might
want to examine a distribution across linear values instead. To display a linear
value distribution, use the <tt>lquantize()</tt> aggregating function. The <tt>lquantize()</tt> function takes three arguments in
addition to a D expression: a lower bound, an upper bound, and
a step. For example, if you wanted to look at the distribution of
writes by file descriptor, a power-of-two quantization would not be effective. Instead, use
a linear quantization with a small range, as shown in the following example:</p><pre>syscall::write:entry
{
    @fds[execname] = lquantize(arg0, 0, 100, 1);
}</pre><p>Running this script for several seconds yields a large amount of information. The
following example shows a selection of typical output:</p><pre>  mountd                                            
           value  ------------- Distribution ------------- count    
              11 |                                         0        
              12 |@                                        4        
              13 |                                         0        
              14 |@@@@@@@@@@@@@@@@@@@@@@@@@                70       
              15 |                                         0        
              16 |@@@@@@@@@@@@                             34       
              17 |                                         0        

  xemacs-20.4                                       
           value  ------------- Distribution ------------- count    
               6 |                                         0        
               7 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  521      
               8 |                                         0        
               9 |                                         1        
              10 |                                         0        

  make.bin                                          
           value  ------------- Distribution ------------- count    
               0 |                                         0        
               1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  3596     
               2 |                                         0        
               3 |                                         0        
               4 |                                         42       
               5 |                                         50       
               6 |                                         0        

  acomp                                             
           value  ------------- Distribution ------------- count    
               0 |                                         0        
               1 |@@@@@                                    1156     
               2 |                                         0        
               3 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@         6635     
               4 |@                                        297      
               5 |                                         0        

  iropt                                             
           value  ------------- Distribution ------------- count    
               2 |                                         0        
               3 |                                         299      
               4 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  20144    
               5 |                                         0        </pre><p>You can also use the <tt>lquantize()</tt> aggregating function to aggregate on time since
some point in the past. This technique allows you to observe a change
in behavior over time. The following example displays the change in system call
behavior over the lifetime of a process executing the <a href="http://docs.sun.com/doc/819-2239/date-1?a=view"><tt>date</tt>(1)</a> command:</p><pre>syscall::exec:return,
syscall::exece:return
/execname == "date"/
{
    self-&gt;start = vtimestamp;
}

syscall:::entry
/self-&gt;start/
{
    /*
     * We linearly quantize on the current virtual time minus our
     * process's start time.  We divide by 1000 to yield microseconds
     * rather than nanoseconds.  The range runs from 0 to 10 milliseconds
     * in steps of 100 microseconds; we expect that no date(1) process
     * will take longer than 10 milliseconds to complete.
     */
    @a["system calls over time"] =
        lquantize((vtimestamp - self-&gt;start) / 1000, 0, 10000, 100);
}

syscall::rexit:entry
/self-&gt;start/
{
    self-&gt;start = 0;
}</pre><p>The preceding script provides greater insight into system call behavior when many <a href="http://docs.sun.com/doc/819-2239/date-1?a=view"><tt>date</tt>(1)</a>
processes are executed. To see this result, run <tt>sh -c 'while true; do date &gt;/dev/null; done'</tt> in one window, while
executing the D script in another. The script produces a profile of the
system call behavior of the <a href="http://docs.sun.com/doc/819-2239/date-1?a=view"><tt>date</tt>(1)</a> command:</p><pre><tt><b># dtrace -s dateprof.d</b></tt>
dtrace: script './dateprof.d' matched 218 probes
<tt><b>^C</b></tt>

  system calls over time
           value  ------------- Distribution ------------- count    
             &lt; 0 |                                         0        
               0 |@@                                       20530    
             100 |@@@@@@                                   48814    
             200 |@@@                                      28119    
             300 |@                                        14646    
             400 |@@@@@                                    41237    
             500 |                                         1259     
             600 |                                         218      
             700 |                                         116      
             800 |@                                        12783    
             900 |@@@                                      28133    
            1000 |                                         7897     
            1100 |@                                        14065    
            1200 |@@@                                      27549    
            1300 |@@@                                      25715    
            1400 |@@@@                                     35011    
            1500 |@@                                       16734    
            1600 |                                         498      
            1700 |                                         256      
            1800 |                                         369      
            1900 |                                         404      
            2000 |                                         320      
            2100 |                                         555      
            2200 |                                         54       
            2300 |                                         17       
            2400 |                                         5        
            2500 |                                         1        
            2600 |                                         7        
            2700 |                                         0        </pre><p>This output provides a rough idea of the different phases of the
<a href="http://docs.sun.com/doc/819-2239/date-1?a=view"><tt>date</tt>(1)</a> command with respect to the services required of the kernel. To better
understand these phases, you might want to understand which system calls are being
called when. If so, you could change the D script to aggregate on
the variable <tt>probefunc</tt> instead of a constant string.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-aggs-1.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-aggs-7.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

