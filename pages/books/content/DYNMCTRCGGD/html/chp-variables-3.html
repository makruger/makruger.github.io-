<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Thread-Local Variables - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-11-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Solaris Dynamic Tracing Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-variables-2.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-variables-4.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="chp-intro.html">1.&nbsp;&nbsp;Introduction</a></p>
<p class="toc level1 tocsp"><a href="chp-typeopexpr.html">2.&nbsp;&nbsp;Types, Operators, and Expressions</a></p>
<p class="toc level1 tocsp"><a href="chp-variables.html">3.&nbsp;&nbsp;Variables</a></p>
<p class="toc level2"><a href="chp-variables-1.html">Scalar Variables</a></p>
<p class="toc level2"><a href="chp-variables-2.html">Associative Arrays</a></p>
<div class="onpage">
<p class="toc level2"><a href="">Thread-Local Variables</a></p>
</div>
<p class="toc level2"><a href="chp-variables-4.html">Clause-Local Variables</a></p>
<p class="toc level2"><a href="chp-variables-5.html">Built-in Variables</a></p>
<p class="toc level2"><a href="chp-variables-6.html">External Variables</a></p>
<p class="toc level1 tocsp"><a href="chp-prog.html">4.&nbsp;&nbsp;D Program Structure</a></p>
<p class="toc level1 tocsp"><a href="chp-pointers.html">5.&nbsp;&nbsp;Pointers and Arrays</a></p>
<p class="toc level1 tocsp"><a href="chp-strings.html">6.&nbsp;&nbsp;Strings</a></p>
<p class="toc level1 tocsp"><a href="chp-structs.html">7.&nbsp;&nbsp;Structs and Unions</a></p>
<p class="toc level1 tocsp"><a href="chp-types.html">8.&nbsp;&nbsp;Type and Constant Definitions</a></p>
<p class="toc level1 tocsp"><a href="chp-aggs.html">9.&nbsp;&nbsp;Aggregations</a></p>
<p class="toc level1 tocsp"><a href="chp-actsub.html">10.&nbsp;&nbsp;Actions and Subroutines</a></p>
<p class="toc level1 tocsp"><a href="chp-buf.html">11.&nbsp;&nbsp;Buffers and Buffering</a></p>
<p class="toc level1 tocsp"><a href="chp-fmt.html">12.&nbsp;&nbsp;Output Formatting</a></p>
<p class="toc level1 tocsp"><a href="chp-spec.html">13.&nbsp;&nbsp;Speculative Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace1m.html">14.&nbsp;&nbsp;<tt>dtrace</tt>(1M) Utility</a></p>
<p class="toc level1 tocsp"><a href="chp-script.html">15.&nbsp;&nbsp;Scripting</a></p>
<p class="toc level1 tocsp"><a href="chp-opt.html">16.&nbsp;&nbsp;Options and Tunables</a></p>
<p class="toc level1 tocsp"><a href="chp-dtrace.html">17.&nbsp;&nbsp;<tt>dtrace</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-lockstat.html">18.&nbsp;&nbsp;<tt>lockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-profile.html">19.&nbsp;&nbsp;<tt>profile</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fbt.html">20.&nbsp;&nbsp;<tt>fbt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-syscall.html">21.&nbsp;&nbsp;<tt>syscall</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sdt.html">22.&nbsp;&nbsp;<tt>sdt</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sysinfo.html">23.&nbsp;&nbsp;<tt>sysinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-vminfo.html">24.&nbsp;&nbsp;<tt>vminfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-proc.html">25.&nbsp;&nbsp;<tt>proc</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-sched.html">26.&nbsp;&nbsp;<tt>sched</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-io.html">27.&nbsp;&nbsp;<tt>io</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-mib.html">28.&nbsp;&nbsp;<tt>mib</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fpuinfo.html">29.&nbsp;&nbsp;<tt>fpuinfo</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-pid.html">30.&nbsp;&nbsp;<tt>pid</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-plockstat.html">31.&nbsp;&nbsp;<tt>plockstat</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-fasttrap.html">32.&nbsp;&nbsp;<tt>fasttrap</tt> Provider</a></p>
<p class="toc level1 tocsp"><a href="chp-user.html">33.&nbsp;&nbsp;User Process Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-usdt.html">34.&nbsp;&nbsp;Statically Defined Tracing for User Applications</a></p>
<p class="toc level1 tocsp"><a href="chp-sec.html">35.&nbsp;&nbsp;Security</a></p>
<p class="toc level1 tocsp"><a href="chp-anon.html">36.&nbsp;&nbsp;Anonymous Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-post.html">37.&nbsp;&nbsp;Postmortem Tracing</a></p>
<p class="toc level1 tocsp"><a href="chp-perf.html">38.&nbsp;&nbsp;Performance Considerations</a></p>
<p class="toc level1 tocsp"><a href="chp-stab.html">39.&nbsp;&nbsp;Stability</a></p>
<p class="toc level1 tocsp"><a href="chp-xlate.html">40.&nbsp;&nbsp;Translators</a></p>
<p class="toc level1 tocsp"><a href="chp-vers.html">41.&nbsp;&nbsp;Versioning</a></p>
<p class="toc level1 tocsp"><a href="gloss01.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="chp-variables-3"></a><h3>Thread-Local Variables</h3>
<p><a name="indexterm-20"></a><a name="indexterm-21"></a>DTrace provides the ability to declare variable storage that is local to each
operating system thread, as opposed to the global variables demonstrated earlier in this
chapter. Thread-local variables are useful in situations where you want to enable a
probe and mark every thread that fires the probe with some tag or
other data. Creating a program to solve this problem is easy in D
because thread-local variables share a common name in your D code but refer
to separate data storage associated with each thread. Thread-local variables are referenced by
applying the <tt>-&gt;</tt> operator to the special identifier <tt>self</tt>:</p><pre>syscall::read:entry
{
    self-&gt;read = 1;
}</pre><p><a name="indexterm-22"></a>This D fragment example enables the probe on the <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> system call
and associates a thread-local variable named <tt>read</tt> with each thread that fires the probe.
Similar to global variables, thread-local variables are created automatically on their first assignment
and assume the type used on the right-hand side of the first assignment
statement (in this example, <tt>int</tt>).</p><p><a name="indexterm-23"></a>Each time the variable <tt>self-&gt;read</tt> is referenced in your D program, the data
object referenced is the one associated with the operating system thread that was
executing when the corresponding DTrace probe fired. You can think of a thread-local
variable as an associative array that is implicitly indexed by a tuple that
describes the thread's identity in the system. A thread's identity is unique over
the lifetime of the system: if the thread exits and the same operating
system data structure is used to create a new thread, this thread does
<b>not</b> reuse the same DTrace thread-local storage identity.</p><p><a name="indexterm-24"></a><a name="indexterm-25"></a><a name="indexterm-26"></a><a name="indexterm-27"></a>Once you have defined a thread-local variable, you can reference it for any
thread in the system even if the variable in question has not
been previously assigned for that particular thread. If a thread's copy of the thread-local
variable has not yet been assigned, the data storage for the copy is
defined to be filled with zeroes. As with associative array elements, underlying storage
is not allocated for a thread-local variable until a non-zero value is assigned
to it. Also as with associative array elements, assigning zero to a thread-local
variable causes DTrace to deallocate the underlying storage. Always assign zero to thread-local
variables that are no longer in use. See <a href="chp-opt.html">Chapter&nbsp;16, Options and Tunables</a> for other techniques to fine-tune
the dynamic variable space from which thread-local variables are allocated.</p><p>Thread-local variables of any type can be defined in your D program, including
associative arrays. Some example thread-local variable definitions are:</p><pre>self-&gt;x = 123;              /* integer value */
self-&gt;s = "hello";              /* string value */
self-&gt;a[123, 'a'] = 456;    /* associative array */</pre><p><a name="indexterm-28"></a><a name="indexterm-29"></a>Like any D variable, you don't need to explicitly declare thread-local variables before
using them. If you want to create a declaration anyway, you can place
one outside of your program clauses by prepending the keyword <tt>self</tt>:</p><pre>self int x;    /* declare int x as a thread-local variable */

syscall::read:entry
{
    self-&gt;x = 123;
}</pre><p><a name="indexterm-30"></a><a name="indexterm-31"></a>Thread-local variables are kept in a separate namespace from global variables so you
can reuse names. Remember that <tt>x</tt> and <tt>self-&gt;x</tt> are not the same variable if
you overload names in your program! The following example shows how to use
thread-local variables. In a text editor, type in the following program and save
it in a file named <tt>rtime.d</tt>:</p><a name="ex-rtime.d"></a><h6>Example&nbsp;3-1 <tt>rtime.d</tt>: Compute Time Spent in <tt>read</tt>(2)</h6><pre>syscall::read:entry
{
    self-&gt;t = timestamp;
}

syscall::read:return
/self-&gt;t != 0/
{
    printf("%d/%d spent %d nsecs in read(2)\n",
        pid, tid, timestamp - self-&gt;t);
    
    /*
     * We're done with this thread-local variable; assign zero to it to
     * allow the DTrace runtime to reclaim the underlying storage.
     */
    self-&gt;t = 0;
}</pre><p>Now go to your shell and start the program running. Wait a
few seconds and you should start to see some output. If no output
appears, try running a few commands.</p><pre><tt><b># dtrace -q -s rtime.d</b></tt>
100480/1 spent 11898 nsecs in read(2)
100441/1 spent 6742 nsecs in read(2)
100480/1 spent 4619 nsecs in read(2)
100452/1 spent 19560 nsecs in read(2)
100452/1 spent 3648 nsecs in read(2)
100441/1 spent 6645 nsecs in read(2)
100452/1 spent 5168 nsecs in read(2)
100452/1 spent 20329 nsecs in read(2)
100452/1 spent 3596 nsecs in read(2)
...
<tt><b>^C</b></tt>
#</pre><p><tt>rtime.d</tt> uses a thread-local variable named <tt>t</tt> to capture a timestamp on entry
to <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> by any thread. Then, in the return clause, the program prints
out the amount of time spent in <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> by subtracting <tt>self-&gt;t</tt> from the current
timestamp. The built-in D variables <tt>pid</tt> and <tt>tid</tt> report the process ID and thread
ID of the thread performing the <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a>. Because <tt>self-&gt;t</tt> is no longer
needed once this information is reported, it is then assigned 0 to allow
DTrace to reuse the underlying storage associated with <tt>t</tt> for the current thread.</p><p>Typically you will see many lines of output without even doing anything because,
behind the scenes, server processes and daemons are executing <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> all the
time even when you aren't doing anything. Try changing the second clause of
<tt>rtime.d</tt> to use the <tt>execname</tt> variable to print out the name of the process
performing a <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> to learn more:</p><pre>printf("%s/%d spent %d nsecs in read(2)\n",
    execname, tid, timestamp - self-&gt;t);</pre><p>If you find a process that's of particular interest, add a predicate to
learn more about its <a href="http://docs.sun.com/doc/819-2241/read-2?a=view"><tt>read</tt>(2)</a> behavior:</p><pre>syscall::read:entry
/execname == "Xsun"/
{
    self-&gt;t = timestamp;
}</pre>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="chp-variables-2.html">Previous</a>
             </td>
             <td align="right">
                 <a href="chp-variables-4.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

