<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Utility Functions - Writing Device Drivers</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-08-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Writing Device Drivers</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="usb-43.html">Previous</a>
             </td>
             <td align="right">
                 <a href="ewavr.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="eqbvu.html">Part&nbsp;I&nbsp;Designing Device Drivers for the Solaris Platform</a></p>
<p class="toc level2"><a href="eqbqn.html">1.&nbsp;&nbsp;Overview of Solaris Device Drivers</a></p>
<p class="toc level2"><a href="kernelovr-77198.html">2.&nbsp;&nbsp;Solaris Kernel and Device Tree</a></p>
<p class="toc level2"><a href="mt-17026.html">3.&nbsp;&nbsp;Multithreading</a></p>
<p class="toc level2"><a href="properties-1.html">4.&nbsp;&nbsp;Properties</a></p>
<p class="toc level2"><a href="events-1.html">5.&nbsp;&nbsp;Managing Events and Queueing Tasks</a></p>
<p class="toc level2"><a href="autoconf-17.html">6.&nbsp;&nbsp;Driver Autoconfiguration</a></p>
<p class="toc level2"><a href="devaccess-3.html">7.&nbsp;&nbsp;Device Access: Programmed I/O</a></p>
<p class="toc level2"><a href="interrupt-15678.html">8.&nbsp;&nbsp;Interrupt Handlers</a></p>
<p class="toc level2"><a href="dma-29901.html">9.&nbsp;&nbsp;Direct Memory Access (DMA)</a></p>
<p class="toc level2"><a href="devmap-24338.html">10.&nbsp;&nbsp;Mapping Device and Kernel Memory</a></p>
<p class="toc level2"><a href="devcnmgt-19679.html">11.&nbsp;&nbsp;Device Context Management</a></p>
<p class="toc level2"><a href="powermgt-37437.html">12.&nbsp;&nbsp;Power Management</a></p>
<p class="toc level2"><a href="gevsi.html">13.&nbsp;&nbsp;Hardening Solaris Drivers</a></p>
<p class="toc level2"><a href="ldi-1.html">14.&nbsp;&nbsp;Layered Driver Interface (LDI)</a></p>
<p class="toc level1 tocsp"><a href="eqbvb.html">Part&nbsp;II&nbsp;Designing Specific Kinds of Device Drivers</a></p>
<p class="toc level2"><a href="character-21002.html">15.&nbsp;&nbsp;Drivers for Character Devices</a></p>
<p class="toc level2"><a href="block-34861.html">16.&nbsp;&nbsp;Drivers for Block Devices</a></p>
<p class="toc level2"><a href="scsi-36812.html">17.&nbsp;&nbsp;SCSI Target Drivers</a></p>
<p class="toc level2"><a href="scsihba-32898.html">18.&nbsp;&nbsp;SCSI Host Bus Adapter Drivers</a></p>
<p class="toc level2"><a href="gld-1.html">19.&nbsp;&nbsp;Drivers for Network Devices</a></p>
<p class="toc level2"><a href="usb-1.html">20.&nbsp;&nbsp;USB Drivers</a></p>
<p class="toc level3"><a href="usb-2.html">USB in the Solaris Environment</a></p>
<p class="toc level3"><a href="usb-7.html">Binding Client Drivers</a></p>
<p class="toc level3"><a href="usb-8.html">Basic Device Access</a></p>
<p class="toc level3"><a href="usb-16.html">Device Communication</a></p>
<p class="toc level3"><a href="usb-43.html">Device State Management</a></p>
<div class="onpage">
<p class="toc level3"><a href="">Utility Functions</a></p>
</div>
<p class="toc level3"><a href="ewavr.html">Sample USB Device Driver</a></p>
<p class="toc level1 tocsp"><a href="eqbvo.html">Part&nbsp;III&nbsp;Building a Device Driver</a></p>
<p class="toc level2"><a href="loading-15035.html">21.&nbsp;&nbsp;Compiling, Loading, Packaging, and Testing Drivers</a></p>
<p class="toc level2"><a href="debug-60.html">22.&nbsp;&nbsp;Debugging, Testing, and Tuning Device Drivers</a></p>
<p class="toc level2"><a href="coding-practices.html">23.&nbsp;&nbsp;Recommended Coding Practices</a></p>
<p class="toc level1 tocsp"><a href="eqbva.html">Part&nbsp;IV&nbsp;Appendixes</a></p>
<p class="toc level2"><a href="hwovr-18191.html">A.&nbsp;&nbsp;Hardware Overview</a></p>
<p class="toc level2"><a href="ddidkisvc-29227.html">B.&nbsp;&nbsp;Summary of Solaris DDI/DKI Services</a></p>
<p class="toc level2"><a href="lp64-35004.html">C.&nbsp;&nbsp;Making a Device Driver 64-Bit Ready</a></p>
<p class="toc level2"><a href="euazz.html">D.&nbsp;&nbsp;Console Frame Buffer Drivers</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="usb-17"></a><h3>Utility Functions</h3>
<p>This section describes several functions that are of general use.</p>

<a name="usb-42"></a><h4>Device Configuration Facilities</h4>
<p>This section describes functions related to device configuration.</p>

<a name="erfbk"></a><h5>Getting Interface Numbers</h5>
<a name="indexterm-1047"></a><a name="indexterm-1048"></a><a name="indexterm-1049"></a><a name="indexterm-1050"></a><a name="indexterm-1051"></a><a name="indexterm-1052"></a><p>If you are using a multiple-interface device where the <a href="http://docs.sun.com/doc/819-2254/usb-mid-7d?a=view"><tt>usb_mid</tt>(7D)</a> driver is
making only one of its interfaces available to the calling driver, you might
need to know the number of the interface to which the calling driver
is bound. Use the <a href="http://docs.sun.com/doc/819-2256/usb-get-if-number-9f?a=view"><tt>usb_get_if_number</tt>(9F)</a> function to do any of the following
tasks:</p>
<ul><li><p>Return the number of the interface to which the calling driver is bound. The <tt>usb_get_if_number</tt>(9F) function returns an interface number greater than zero in this case.</p></li>
<li><p>Discover that the calling driver manages an entire multi-interface device. The driver is bound at the device level so that <tt>usb_mid</tt> has not split it. The <tt>usb_get_if_number</tt>(9F) function returns <tt>USB_DEVICE_NODE</tt> in this case.</p></li>
<li><p>Discover that the calling driver manages an entire device by managing the only interface that device offers in its current configuration. The <tt>usb_get_if_number</tt>(9F) function returns <tt>USB_COMBINED_NODE</tt> in this case.</p></li></ul>


<a name="erfbn"></a><h5>Managing Entire Devices</h5>
<a name="indexterm-1053"></a><p><a name="indexterm-1054"></a><a name="indexterm-1055"></a>If a driver manages an entire composite device, that driver can bind to
the entire device by using a compatible name that contains vendor ID, product
ID, and revision ID. A driver that is bound to an entire
composite device must manage all the interfaces of that device as a nexus
driver would. In general, you should not bind your driver to an entire
composite device. Instead, you should use the generic multiple-interface driver <a href="http://docs.sun.com/doc/819-2254/usb-mid-7d?a=view"><tt>usb_mid</tt>(7D)</a>.</p><p>Use the <a href="http://docs.sun.com/doc/819-2256/usb-owns-device-9f?a=view"><tt>usb_owns_device</tt>(9F)</a> function to determine whether a driver owns an entire device.
The device might be a composite device. The <tt>usb_owns_device</tt>(9F) function returns <tt>TRUE</tt>
if the driver owns the entire device.</p>

<a name="usb-36"></a><h5>Multiple-Configuration Devices</h5>
<a name="indexterm-1056"></a><a name="indexterm-1057"></a><a name="indexterm-1058"></a><a name="indexterm-1059"></a><a name="indexterm-1060"></a><p>USB devices make only a single configuration available to the host at any
particular time. Most devices support only a single configuration. However, a few USB
devices support multiple configurations.</p><p><a name="indexterm-1061"></a><a name="indexterm-1062"></a>Any device that has multiple configurations is placed into the first configuration for
which a driver is available. When seeking a match, device configurations are considered
in numeric order. If no matching driver is found, the device is set
to the first configuration. In this case, the <tt>usb_mid</tt> driver takes over the
device and splits the device into interface nodes. Use the <a href="http://docs.sun.com/doc/819-2256/usb-get-cfg-9f?a=view"><tt>usb_get_cfg</tt>(9F)</a> function to
return the current configuration of a device.</p><p>You can use either of the following two methods to request a
different configuration. Using either of these two methods to modify the device configuration ensures
that the USBA module remains in sync with the device.</p>
<ul><li><p>Use the <a href="http://docs.sun.com/doc/819-2240/cfgadm-usb-1m?a=view"><tt>cfgadm_usb</tt>(1M)</a> command.</p></li>
<li><p>Call the <a href="http://docs.sun.com/doc/819-2256/usb-set-cfg-9f?a=view"><tt>usb_set_cfg</tt>(9F)</a> function from the driver.</p><p>Because changing device configuration affects an entire device, the client driver must meet all of the following criteria to call the <tt>usb_set_cfg</tt>(9F) function successfully:</p>
<ul><li><p>The client driver must own the entire device.</p></li>
<li><p>The device must have no child nodes, because other drivers could drive the device through them.</p></li>
<li><p>All pipes except the default pipe must be closed.</p></li>
<li><p>The device must have multiple configurations.</p></li></ul>
</li></ul>

<hr><p><b>Caution - </b>Do not change the device configuration by doing a <tt>SET_CONFIGURATION</tt> USB request
manually. Using a <tt>SET_CONFIGURATION</tt> request to change the configuration is not supported.</p>
<hr>


<a name="erfay"></a><h5>Modifying or Getting the Alternate Setting</h5>
<a name="indexterm-1063"></a><a name="indexterm-1064"></a><a name="indexterm-1065"></a><a name="indexterm-1066"></a><p>A client driver can call the <a href="http://docs.sun.com/doc/819-2256/usb-set-alt-if-9f?a=view"><tt>usb_set_alt_if</tt>(9F)</a> function to change the selected alternate
setting of the currently selected interface. Be sure to close all pipes that
were opened explicitly. When switching alternate settings, the <tt>usb_set_alt_if</tt>(9F) function verifies that
only the default pipe is open. Be sure the device is settled before
you call <tt>usb_set_alt_if</tt>(9F).</p><p>Changing the alternate setting can affect which endpoints and which class-specific and vendor-specific
descriptors are available to the driver. See <a href="usb-8.html#usb-10">The Descriptor Tree</a> for more information about endpoints and
descriptors.</p><p>Call the <a href="http://docs.sun.com/doc/819-2256/usb-get-alt-if-9f?a=view"><tt>usb_get_alt_if</tt>(9F)</a> function to retrieve the number of the current alternate setting.</p>
<hr><p><b>Note - </b>When you request a new alternate setting, a new configuration, or a new
interface, all pipes except the default pipe to the device must be closed.
This is because changing an alternate setting, a configuration, or an interface changes
the mode of operation of the device. Also, changing an alternate setting, a
configuration, or an interface changes the device's presentation to the system.</p>
<hr>


<a name="usb-45"></a><h4>Other Utility Functions</h4>
<p>This section describes other functions that are useful in USB device drivers.</p>

<a name="usb-35"></a><h5>Retrieving a String Descriptor</h5>
<a name="indexterm-1067"></a><p>Call the <a href="http://docs.sun.com/doc/819-2256/usb-get-string-descr-9f?a=view"><tt>usb_get_string_descr</tt>(9F)</a> function to retrieve a string descriptor given its index. Some
configuration, interface, or device descriptors have string IDs associated with them. Such descriptors contain
string index fields with nonzero values. Pass a string index field value to
the <tt>usb_get_string_descr</tt>(9F) to retrieve the corresponding string.</p>

<a name="usb-38"></a><h5>Pipe Private Data Facility</h5>
<a name="indexterm-1068"></a><a name="indexterm-1069"></a><p>Each pipe has one pointer of space set aside for the client
driver's private use. Use the <a href="http://docs.sun.com/doc/819-2256/usb-pipe-set-private-9f?a=view"><tt>usb_pipe_set_private</tt>(9F)</a> function to install a value. Use the <a href="http://docs.sun.com/doc/819-2256/usb-pipe-get-private-9f?a=view"><tt>usb_pipe_get_private</tt>(9F)</a>
function to retrieve the value. This facility is useful in callbacks, when pipes
might need to bring their own client-defined state to the callback for specific processing.</p>

<a name="usb-39"></a><h5>Clearing a USB Condition</h5>
<a name="indexterm-1070"></a><p>Use the <a href="http://docs.sun.com/doc/819-2256/usb-clr-feature-9f?a=view"><tt>usb_clr_feature</tt>(9F)</a> function to do the following tasks:</p>
<ul><li><p>Issue a USB <tt>CLEAR_FEATURE</tt> request to clear a halt condition on an endpoint.</p></li>
<li><p>Clear a remote wakeup condition on a device.</p></li>
<li><p>Clear a device-specific condition at a device, interface, or endpoint level.</p></li></ul>


<a name="usb-40"></a><h5>Getting Device, Interface, or Endpoint Status</h5>
<a name="indexterm-1071"></a><p>Use the <a href="http://docs.sun.com/doc/819-2256/usb-get-status-9f?a=view"><tt>usb_get_status</tt>(9F)</a> function to issue a USB <tt>GET_STATUS</tt> request to retrieve the
status of a device, interface, or endpoint.</p>
<ul><li><p><b>Device status</b>. Self-powered and remote-wakeup-enabled.</p></li>
<li><p><b>Interface status</b>. Returns zero, per USB&nbsp;2.0 specification.</p></li>
<li><p><b>Endpoint status</b>. Endpoint halted. This status indicates a functional stall. A halt must be cleared before the device can operate again.</p><p>A protocol stall indicates that an unsupported control pipe request has been made. A protocol stall is cleared automatically at the beginning of the next control transfer.</p></li></ul>


<a name="usb-41"></a><h5>Getting the Bus Address of a Device</h5>
<a name="indexterm-1072"></a><p>Use the <a href="http://docs.sun.com/doc/819-2256/usb-get-addr-9f?a=view"><tt>usb_get_addr</tt>(9F)</a> function to get the USB bus address of a
device for debugging purposes. This address maps to a particular USB port.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="usb-43.html">Previous</a>
             </td>
             <td align="right">
                 <a href="ewavr.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

