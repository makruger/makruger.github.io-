<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Data Structures Required for Drivers - Writing Device Drivers</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-08-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Writing Device Drivers</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="autoconf-3.html">Previous</a>
             </td>
             <td align="right">
                 <a href="autoconf-95548.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="eqbvu.html">Part&nbsp;I&nbsp;Designing Device Drivers for the Solaris Platform</a></p>
<p class="toc level2"><a href="eqbqn.html">1.&nbsp;&nbsp;Overview of Solaris Device Drivers</a></p>
<p class="toc level2"><a href="kernelovr-77198.html">2.&nbsp;&nbsp;Solaris Kernel and Device Tree</a></p>
<p class="toc level2"><a href="mt-17026.html">3.&nbsp;&nbsp;Multithreading</a></p>
<p class="toc level2"><a href="properties-1.html">4.&nbsp;&nbsp;Properties</a></p>
<p class="toc level2"><a href="events-1.html">5.&nbsp;&nbsp;Managing Events and Queueing Tasks</a></p>
<p class="toc level2"><a href="autoconf-17.html">6.&nbsp;&nbsp;Driver Autoconfiguration</a></p>
<p class="toc level3"><a href="autoconf-3.html">Driver Loading and Unloading</a></p>
<div class="onpage">
<p class="toc level3"><a href="">Data Structures Required for Drivers</a></p>
</div>
<p class="toc level3"><a href="autoconf-95548.html">Loadable Driver Interfaces</a></p>
<p class="toc level3"><a href="autoconf-60641.html">Device Configuration Concepts</a></p>
<p class="toc level3"><a href="autoconf-24.html">Using Device IDs</a></p>
<p class="toc level2 tocsp"><a href="devaccess-3.html">7.&nbsp;&nbsp;Device Access: Programmed I/O</a></p>
<p class="toc level2"><a href="interrupt-15678.html">8.&nbsp;&nbsp;Interrupt Handlers</a></p>
<p class="toc level2"><a href="dma-29901.html">9.&nbsp;&nbsp;Direct Memory Access (DMA)</a></p>
<p class="toc level2"><a href="devmap-24338.html">10.&nbsp;&nbsp;Mapping Device and Kernel Memory</a></p>
<p class="toc level2"><a href="devcnmgt-19679.html">11.&nbsp;&nbsp;Device Context Management</a></p>
<p class="toc level2"><a href="powermgt-37437.html">12.&nbsp;&nbsp;Power Management</a></p>
<p class="toc level2"><a href="gevsi.html">13.&nbsp;&nbsp;Hardening Solaris Drivers</a></p>
<p class="toc level2"><a href="ldi-1.html">14.&nbsp;&nbsp;Layered Driver Interface (LDI)</a></p>
<p class="toc level1 tocsp"><a href="eqbvb.html">Part&nbsp;II&nbsp;Designing Specific Kinds of Device Drivers</a></p>
<p class="toc level2"><a href="character-21002.html">15.&nbsp;&nbsp;Drivers for Character Devices</a></p>
<p class="toc level2"><a href="block-34861.html">16.&nbsp;&nbsp;Drivers for Block Devices</a></p>
<p class="toc level2"><a href="scsi-36812.html">17.&nbsp;&nbsp;SCSI Target Drivers</a></p>
<p class="toc level2"><a href="scsihba-32898.html">18.&nbsp;&nbsp;SCSI Host Bus Adapter Drivers</a></p>
<p class="toc level2"><a href="gld-1.html">19.&nbsp;&nbsp;Drivers for Network Devices</a></p>
<p class="toc level2"><a href="usb-1.html">20.&nbsp;&nbsp;USB Drivers</a></p>
<p class="toc level1 tocsp"><a href="eqbvo.html">Part&nbsp;III&nbsp;Building a Device Driver</a></p>
<p class="toc level2"><a href="loading-15035.html">21.&nbsp;&nbsp;Compiling, Loading, Packaging, and Testing Drivers</a></p>
<p class="toc level2"><a href="debug-60.html">22.&nbsp;&nbsp;Debugging, Testing, and Tuning Device Drivers</a></p>
<p class="toc level2"><a href="coding-practices.html">23.&nbsp;&nbsp;Recommended Coding Practices</a></p>
<p class="toc level1 tocsp"><a href="eqbva.html">Part&nbsp;IV&nbsp;Appendixes</a></p>
<p class="toc level2"><a href="hwovr-18191.html">A.&nbsp;&nbsp;Hardware Overview</a></p>
<p class="toc level2"><a href="ddidkisvc-29227.html">B.&nbsp;&nbsp;Summary of Solaris DDI/DKI Services</a></p>
<p class="toc level2"><a href="lp64-35004.html">C.&nbsp;&nbsp;Making a Device Driver 64-Bit Ready</a></p>
<p class="toc level2"><a href="euazz.html">D.&nbsp;&nbsp;Console Frame Buffer Drivers</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="autoconf-22386"></a><h3>Data Structures Required for Drivers</h3>
<p>To support autoconfiguration, drivers are required to statically initialize the following data structures:</p>
<ul><li><p><a href="http://docs.sun.com/doc/819-2257/modlinkage-9s?a=view"><tt>modlinkage</tt>(9S)</a></p></li>
<li><p><a href="http://docs.sun.com/doc/819-2257/modldrv-9s?a=view"><tt>modldrv</tt>(9S)</a></p></li>
<li><p><a href="http://docs.sun.com/doc/819-2257/dev-ops-9s?a=view"><tt>dev_ops</tt>(9S)</a></p></li>
<li><p><a href="http://docs.sun.com/doc/819-2257/cb-ops-9s?a=view"><tt>cb_ops</tt>(9S)</a></p></li></ul>
<p>The data structures in Figure 5-1  are relied on by the
driver. These structures must be provided and be initialized correctly. Without these data structures,
the driver might not load properly. As a result, the necessary routines might
not be loaded.  If an operation is not supported by the
driver, the address of the <a href="http://docs.sun.com/doc/819-2256/nodev-9f?a=view"><tt>nodev</tt>(9F)</a> routine can be used as a placeholder. In
some instances, the driver supports the entry point and only needs to return
success or failure. In such cases, the address of the routine <a href="http://docs.sun.com/doc/819-2256/nulldev-9f?a=view"><tt>nulldev</tt>(9F)</a> can be
used.</p>
<hr><p><b>Note - </b>These structures should be initialized at compile-time. The driver should not access or
change the structures at any other time.</p>
<hr>


<a name="autoconf-5"></a><h4><tt>modlinkage</tt> Structure</h4>
<a name="autoconf-ix209"></a><pre>static struct modlinkage xxmodlinkage = {
    MODREV_1,       /* ml_rev */
    &amp;xxmodldrv,     /* ml_linkage[] */
    NULL            /* NULL termination */
};</pre><p>The first field is the version number of the module that loads
the subsystem. This field should be <tt>MODREV_1</tt>. The second field points to driver's <tt>modldrv</tt>
structure defined next. The last element of the structure should always be <tt>NULL</tt>.</p>

<a name="autoconf-6"></a><h4><tt>modldrv</tt> Structure</h4>
<a name="autoconf-ix210"></a><a name="indexterm-74"></a><pre>static struct modldrv xxmodldrv = {
    &amp;mod_driverops,           /* drv_modops */
    "generic driver v1.1",    /* drv_linkinfo */
    &amp;xx_dev_ops               /* drv_dev_ops */
};</pre><p>This structure describes the module in more detail. The first field provides information
regarding installation of the module. This field should be set to <tt>&amp;mod_driverops</tt> for
driver modules. The second field is a string to be displayed by <a href="http://docs.sun.com/doc/819-2240/modinfo-1m?a=view"><tt>modinfo</tt>(1M)</a>.
The second field should contain sufficient information for identifying the version of source
code that generated the driver binary. The last field points to the driver's
<tt>dev_ops</tt> structure defined in the following section.</p>

<a name="autoconf-7"></a><h4><tt>dev_ops</tt> Structure</h4>
<a name="autoconf-ix211"></a><a name="autoconf-ix212"></a><pre>static struct dev_ops xx_dev_ops = {
    DEVO_REV,       /* devo_rev, */
    0,              /* devo_refcnt  */
    xxgetinfo,      /* getinfo(9E) */
    nulldev,        /* identify(9E) */
    xxprobe,        /* probe(9E) */
    xxattach,       /* attach(9E) */
    xxdetach,       /* detach(9E) */
    nodev,          /* devo_reset */
    &amp;xx_cb_ops,     /* devo_cb_ops */
    NULL,           /* devo_bus_ops */
    &amp;xxpower        /* power(9E) */
};</pre><p>The <a href="http://docs.sun.com/doc/819-2257/dev-ops-9s?a=view"><tt>dev_ops</tt>(9S)</a> structure enables the kernel to find the autoconfiguration entry points of
the device driver. The <tt>devo_rev</tt> field identifies the revision number of the structure. This
field must be set to <tt>DEVO_REV</tt>. The <tt>devo_refcnt</tt> field must be initialized to
zero. The function address fields should be filled in with the address of
the appropriate driver entry point, except in the following cases:</p>
<ul><li><p>Set the <tt>devo_probe</tt> field to <a href="http://docs.sun.com/doc/819-2256/nulldev-9f?a=view"><tt>nulldev</tt>(9F)</a> if a <a href="http://docs.sun.com/doc/819-2255/probe-9e?a=view"><tt>probe</tt>(9E)</a> routine is not needed.</p></li>
<li><p>Set the <tt>identify()</tt> field to <a href="http://docs.sun.com/doc/819-2256/nulldev-9f?a=view"><tt>nulldev</tt>(9F)</a>. The <tt>identify()</tt> entry point is obsolete.</p></li>
<li><p>Set the <tt>devo_reset</tt> field to <a href="http://docs.sun.com/doc/819-2256/nodev-9f?a=view"><tt>nodev</tt>(9F)</a>.</p></li>
<li><p>Set the <a href="http://docs.sun.com/doc/819-2255/power-9e?a=view"><tt>power</tt>(9E)</a> field to <tt>NULL</tt> if a <tt>power()</tt> routine is not needed. Drivers for devices that provide Power Management functionality must have a <tt>power()</tt> entry point.</p></li></ul>
<p>The <tt>devo_cb_ops</tt> member should include the address of the <a href="http://docs.sun.com/doc/819-2257/cb-ops-9s?a=view"><tt>cb_ops</tt>(9S)</a> structure. The <tt>devo_bus_ops</tt> field
must be set to <tt>NULL</tt>.</p>

<a name="autoconf-8"></a><h4><tt>cb_ops</tt> Structure</h4>
<pre>static struct cb_ops xx_cb_ops = {
    xxopen,         /* open(9E) */
    xxclose,        /* close(9E) */
    xxstrategy,     /* strategy(9E) */
    xxprint,        /* print(9E) */
    xxdump,         /* dump(9E) */
    xxread,         /* read(9E) */
    xxwrite,        /* write(9E) */
    xxioctl,        /* ioctl(9E) */
    xxdevmap,       /* devmap(9E) */
    nodev,          /* mmap(9E) */
    xxsegmap,       /* segmap(9E) */
    xxchpoll,       /* chpoll(9E) */
    xxprop_op,      /* prop_op(9E) */
    NULL,           /* streamtab(9S) */
    D_MP | D_64BIT, /* cb_flag */
    CB_REV,         /* cb_rev */
    xxaread,        /* aread(9E) */
    xxawrite        /* awrite(9E) */
};</pre><p><a name="indexterm-75"></a><a name="fbdyx"></a><a name="fbdzk"></a>The <a href="http://docs.sun.com/doc/819-2257/cb-ops-9s?a=view"><tt>cb_ops</tt>(9S)</a> structure contains the entry points for the character operations and block
operations of the device driver. Any entry points that the driver does not
support should be initialized to <a href="http://docs.sun.com/doc/819-2256/nodev-9f?a=view"><tt>nodev</tt>(9F)</a>. For example, character device drivers should set
all the block-only fields, such as <tt>cb_stategy</tt>, to  <a href="http://docs.sun.com/doc/819-2256/nodev-9f?a=view"><tt>nodev</tt>(9F)</a>. Note that the 
<a href="http://docs.sun.com/doc/819-2255/mmap-9e?a=view"><tt>mmap</tt>(9E)</a> entry point is maintained for compatibility with previous releases. Drivers should use the
 <a href="http://docs.sun.com/doc/819-2255/devmap-9e?a=view"><tt>devmap</tt>(9E)</a> entry point for device memory mapping. If  <a href="http://docs.sun.com/doc/819-2255/devmap-9e?a=view"><tt>devmap</tt>(9E)</a> is supported,
set  <a href="http://docs.sun.com/doc/819-2255/mmap-9e?a=view"><tt>mmap</tt>(9E)</a> to  <a href="http://docs.sun.com/doc/819-2256/nodev-9f?a=view"><tt>nodev</tt>(9F)</a>.</p><p><a name="autoconf-ix215"></a>The <tt>streamtab</tt> field indicates whether the driver is STREAMS-based. Only the network device
drivers that are discussed in <a href="gld-1.html">Chapter&nbsp;19, Drivers for Network Devices</a>  are STREAMS-based. All non-STREAMS-based drivers <b>must</b>
set the <tt>streamtab</tt> field to <tt>NULL</tt>.</p><p>The <tt>cb_flag</tt> member contains the following flags:</p>
<ul><li><p><a name="autoconf-ix216"></a>The <tt>D_MP</tt> flag indicates that the driver is safe for multithreading. The Solaris OS supports only thread-safe drivers so <tt>D_MP</tt> must be set.</p></li>
<li><p>The <tt>D_64BIT</tt> flag causes the driver to use the <tt>uio_loffset</tt> field of the <a href="http://docs.sun.com/doc/819-2257/uio-9s?a=view"><tt>uio</tt>(9S)</a> structure. The driver should set the <tt>D_64BIT</tt> flag in the <tt>cb_flag</tt> field to handle 64-bit offsets properly.</p></li>
<li><p><a name="autoconf-ix217"></a>The <tt>D_DEVMAP</tt> flag supports the <a href="http://docs.sun.com/doc/819-2255/devmap-9e?a=view"><tt>devmap</tt>(9E)</a> entry point. For information on <a href="http://docs.sun.com/doc/819-2255/devmap-9e?a=view"><tt>devmap</tt>(9E)</a>, see <a href="devmap-24338.html">Chapter&nbsp;10, Mapping Device and Kernel Memory</a>.</p></li></ul>
<p><tt>cb_rev</tt> is the <tt>cb_ops</tt> structure revision number. This field must be set to
<tt>CB_REV</tt>.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="autoconf-3.html">Previous</a>
             </td>
             <td align="right">
                 <a href="autoconf-95548.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

