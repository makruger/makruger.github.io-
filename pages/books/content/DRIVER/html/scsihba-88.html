<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>SCSI HBA Driver Specific Issues - Writing Device Drivers</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-08-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Writing Device Drivers</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="scsihba-50.html">Previous</a>
             </td>
             <td align="right">
                 <a href="scsihba-100.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="eqbvu.html">Part&nbsp;I&nbsp;Designing Device Drivers for the Solaris Platform</a></p>
<p class="toc level2"><a href="eqbqn.html">1.&nbsp;&nbsp;Overview of Solaris Device Drivers</a></p>
<p class="toc level2"><a href="kernelovr-77198.html">2.&nbsp;&nbsp;Solaris Kernel and Device Tree</a></p>
<p class="toc level2"><a href="mt-17026.html">3.&nbsp;&nbsp;Multithreading</a></p>
<p class="toc level2"><a href="properties-1.html">4.&nbsp;&nbsp;Properties</a></p>
<p class="toc level2"><a href="events-1.html">5.&nbsp;&nbsp;Managing Events and Queueing Tasks</a></p>
<p class="toc level2"><a href="autoconf-17.html">6.&nbsp;&nbsp;Driver Autoconfiguration</a></p>
<p class="toc level2"><a href="devaccess-3.html">7.&nbsp;&nbsp;Device Access: Programmed I/O</a></p>
<p class="toc level2"><a href="interrupt-15678.html">8.&nbsp;&nbsp;Interrupt Handlers</a></p>
<p class="toc level2"><a href="dma-29901.html">9.&nbsp;&nbsp;Direct Memory Access (DMA)</a></p>
<p class="toc level2"><a href="devmap-24338.html">10.&nbsp;&nbsp;Mapping Device and Kernel Memory</a></p>
<p class="toc level2"><a href="devcnmgt-19679.html">11.&nbsp;&nbsp;Device Context Management</a></p>
<p class="toc level2"><a href="powermgt-37437.html">12.&nbsp;&nbsp;Power Management</a></p>
<p class="toc level2"><a href="gevsi.html">13.&nbsp;&nbsp;Hardening Solaris Drivers</a></p>
<p class="toc level2"><a href="ldi-1.html">14.&nbsp;&nbsp;Layered Driver Interface (LDI)</a></p>
<p class="toc level1 tocsp"><a href="eqbvb.html">Part&nbsp;II&nbsp;Designing Specific Kinds of Device Drivers</a></p>
<p class="toc level2"><a href="character-21002.html">15.&nbsp;&nbsp;Drivers for Character Devices</a></p>
<p class="toc level2"><a href="block-34861.html">16.&nbsp;&nbsp;Drivers for Block Devices</a></p>
<p class="toc level2"><a href="scsi-36812.html">17.&nbsp;&nbsp;SCSI Target Drivers</a></p>
<p class="toc level2"><a href="scsihba-32898.html">18.&nbsp;&nbsp;SCSI Host Bus Adapter Drivers</a></p>
<p class="toc level3"><a href="scsihba-105.html">Introduction to Host Bus Adapter Drivers</a></p>
<p class="toc level3"><a href="scsihba-10.html">SCSI Interface</a></p>
<p class="toc level3"><a href="scsihba-16.html">SCSA HBA Interfaces</a></p>
<p class="toc level3"><a href="scsihba-32.html">HBA Driver Dependency and Configuration Issues</a></p>
<p class="toc level3"><a href="scsihba-50.html">Entry Points for SCSA HBA Drivers</a></p>
<div class="onpage">
<p class="toc level3"><a href="">SCSI HBA Driver Specific Issues</a></p>
</div>
<p class="toc level3"><a href="scsihba-100.html">Support for Queuing</a></p>
<p class="toc level2 tocsp"><a href="gld-1.html">19.&nbsp;&nbsp;Drivers for Network Devices</a></p>
<p class="toc level2"><a href="usb-1.html">20.&nbsp;&nbsp;USB Drivers</a></p>
<p class="toc level1 tocsp"><a href="eqbvo.html">Part&nbsp;III&nbsp;Building a Device Driver</a></p>
<p class="toc level2"><a href="loading-15035.html">21.&nbsp;&nbsp;Compiling, Loading, Packaging, and Testing Drivers</a></p>
<p class="toc level2"><a href="debug-60.html">22.&nbsp;&nbsp;Debugging, Testing, and Tuning Device Drivers</a></p>
<p class="toc level2"><a href="coding-practices.html">23.&nbsp;&nbsp;Recommended Coding Practices</a></p>
<p class="toc level1 tocsp"><a href="eqbva.html">Part&nbsp;IV&nbsp;Appendixes</a></p>
<p class="toc level2"><a href="hwovr-18191.html">A.&nbsp;&nbsp;Hardware Overview</a></p>
<p class="toc level2"><a href="ddidkisvc-29227.html">B.&nbsp;&nbsp;Summary of Solaris DDI/DKI Services</a></p>
<p class="toc level2"><a href="lp64-35004.html">C.&nbsp;&nbsp;Making a Device Driver 64-Bit Ready</a></p>
<p class="toc level2"><a href="euazz.html">D.&nbsp;&nbsp;Console Frame Buffer Drivers</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="scsihba-88"></a><h3>SCSI HBA Driver Specific Issues</h3>
<p><a name="indexterm-660"></a>The section covers issues specific to SCSI HBA drivers.</p>

<a name="scsihba-89"></a><h4>Installing HBA Drivers</h4>
<p>A SCSI HBA driver is installed in similar fashion to a leaf
driver. See <a href="loading-15035.html">Chapter&nbsp;21, Compiling, Loading, Packaging, and Testing Drivers</a>. The difference is that the <a href="http://docs.sun.com/doc/819-2240/add-drv-1m?a=view"><tt>add_drv</tt>(1M)</a> command must specify the driver
class as SCSI, such as:</p><pre># add_drv -m" * 0666 root root" -i'"pci1077,1020"' -c scsi isp</pre>

<a name="scsihba-90"></a><h4>HBA Configuration Properties</h4>
<p><a name="indexterm-661"></a><a name="indexterm-662"></a>When attaching an instance of an HBA device,  <a href="http://docs.sun.com/doc/819-2256/scsi-hba-attach-setup-9f?a=view"><tt>scsi_hba_attach_setup</tt>(9F)</a> creates a
number of SCSI configuration properties for that HBA instance. A particular property is
created only if no existing property of the same name is already attached
to the HBA instance. This restriction avoids overriding any default property values in
an HBA configuration file.</p><p><a name="indexterm-663"></a><a name="indexterm-664"></a>An HBA driver must use  <a href="http://docs.sun.com/doc/819-2256/ddi-prop-get-int-9f?a=view"><tt>ddi_prop_get_int</tt>(9F)</a> to retrieve each property. The HBA
driver then modifies or accepts the default value of the properties to configure
its specific operation.</p>

<a name="scsihba-91"></a><h5><tt>scsi-reset-delay</tt> Property</h5>
<p>The <tt>scsi-reset-delay</tt> property is an integer specifying the recovery time in milliseconds for
a reset delay by either a SCSI bus or SCSI device.</p>

<a name="scsihba-92"></a><h5><tt>scsi-options</tt> Property</h5>
<p>The <tt>scsi-options</tt> property is an integer specifying a number of options through individually
defined bits:</p>
<ul><li><p><tt>SCSI_OPTIONS_DR (0x008)</tt> &ndash; If not set, the HBA should not grant disconnect privileges to a target device.</p></li>
<li><p><tt>SCSI_OPTIONS_LINK (0x010)</tt> &ndash; If not set, the HBA should not enable linked commands.</p></li>
<li><p><tt>SCSI_OPTIONS_SYNC (0x020)</tt> &ndash; If not set, the HBA driver must not negotiate synchronous data transfer. The driver should reject any attempt to negotiate synchronous data transfer initiated by a target.</p></li>
<li><p><tt>SCSI_OPTIONS_PARITY (0x040)</tt> &ndash; If not set, the HBA should run the SCSI bus without parity.</p></li>
<li><p><tt>SCSI_OPTIONS_TAG (0x080)</tt> &ndash; If not set, the HBA should not operate in Command Tagged Queuing mode.</p></li>
<li><p><tt>SCSI_OPTIONS_FAST (0x100)</tt> &ndash; If not set, the HBA should not operate the bus in FAST SCSI mode.</p></li>
<li><p><tt>SCSI_OPTIONS_WIDE (0x200)</tt> &ndash; If not set, the HBA should not operate the bus in WIDE SCSI mode.</p></li></ul>


<a name="scsihba-93"></a><h5>Per-Target <tt>scsi-options</tt></h5>
<p>An HBA driver might support a per-target <tt>scsi</tt>-<tt>options</tt> feature in the following
format:</p><pre>target&lt;n&gt;-scsi-options=&lt;hex value&gt;</pre><p>In this example, &lt; <b>n</b>&gt; is the target ID. If the per-target <tt>scsi-options</tt>
property is defined, the HBA driver uses that value  rather than the
per-HBA driver instance <tt>scsi-options</tt> property. This approach can provide more precise control if,
for example, synchronous data transfer needs to be disabled for just one particular
target device. The per-target <tt>scsi-options</tt> property can be defined in the <a href="http://docs.sun.com/doc/819-2251/driver.conf-4?a=view"><tt>driver.conf</tt>(4)</a> file.</p><p>The following example shows a per-target <tt>scsi-options</tt> property definition to disable synchronous data
transfer for target device 3:</p><pre>target3-scsi-options=0x2d8</pre>

<a name="scsihba-94"></a><h4>x86 Target Driver Configuration Properties</h4>
<p><a name="indexterm-665"></a><a name="indexterm-666"></a>Some x86 SCSI target drivers, such as the driver for <tt>cmdk</tt> disk, use
the following configuration properties:</p>
<ul><li><p><tt>disk</tt></p></li>
<li><p><tt>queue</tt></p></li>
<li><p><tt>flow_control</tt></p></li></ul>
<p><a name="indexterm-667"></a>If you use the <tt>cmdk</tt> sample driver to write an HBA driver for
an x86 platform, any appropriate properties must be defined in the <a href="http://docs.sun.com/doc/819-2251/driver.conf-4?a=view"><tt>driver.conf</tt>(4)</a> file.</p>
<hr><p><b>Note - </b>These property definitions should appear only in an HBA driver's <a href="http://docs.sun.com/doc/819-2251/driver.conf-4?a=view"><tt>driver.conf</tt>(4)</a> file.
The HBA driver itself should not inspect or attempt to interpret these properties in
any way. These properties are advisory only and serve as an adjunct
to the <tt>cmdk</tt> driver. The properties should not be relied upon in any way.
The property definitions might not be used in future releases.</p>
<hr>
<p>The <tt>disk</tt> property can be used to define the type of disk supported
by <tt>cmdk</tt>. For a SCSI HBA, the only possible value for the <tt>disk</tt>
property is:</p>
<ul><li><p><tt>disk="scdk"</tt> &ndash; Disk type is a SCSI disk</p></li></ul>
<p>The <tt>queue</tt> property defines how the disk driver sorts the queue of incoming
requests during  <a href="http://docs.sun.com/doc/819-2255/strategy-9e?a=view"><tt>strategy</tt>(9E)</a>. Two values are possible:</p>
<ul><li><p><tt>queue="qsort"</tt> &ndash; One-way elevator queuing model, provided by <a href="http://docs.sun.com/doc/819-2256/disksort-9f?a=view"><tt>disksort</tt>(9F)</a></p></li>
<li><p><tt>queue="qfifo"</tt> &ndash; FIFO, that is, first in, first out queuing model</p></li></ul>
<p>The <tt>flow_control</tt> property defines how commands are transported to the HBA driver. Three
values are possible:</p>
<ul><li><p><tt>flow_control="dsngl"</tt> &ndash; Single command per HBA driver</p></li>
<li><p><tt>flow_control="dmult"</tt> &ndash; Multiple commands per HBA driver. When the HBA queue is full, the driver returns <tt>TRAN_BUSY</tt>.</p></li>
<li><p><tt>flow_control="duplx"</tt> &ndash; The HBA can support separate read and write queues, with multiple commands per queue. FIFO ordering is used for the write queue. The queuing model that is used for the read queue is described by the <b>queue</b> property. When an HBA queue is full, the driver returns <tt>TRAN_BUSY</tt></p></li></ul>
<p>The following example is a <a href="http://docs.sun.com/doc/819-2251/driver.conf-4?a=view"><tt>driver.conf</tt>(4)</a> file for use with an x86
HBA PCI device that has been designed for use with the <tt>cmdk</tt> sample driver:</p><pre>#
# config file for ISP 1020 SCSI HBA driver     
#
       flow_control="dsngl" queue="qsort" disk="scdk"
       scsi-initiator-id=7;</pre>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="scsihba-50.html">Previous</a>
             </td>
             <td align="right">
                 <a href="scsihba-100.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

