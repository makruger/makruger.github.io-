<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>SCSA HBA Interfaces - Writing Device Drivers</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-08-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Writing Device Drivers</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="scsihba-10.html">Previous</a>
             </td>
             <td align="right">
                 <a href="scsihba-32.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="eqbvu.html">Part&nbsp;I&nbsp;Designing Device Drivers for the Solaris Platform</a></p>
<p class="toc level2"><a href="eqbqn.html">1.&nbsp;&nbsp;Overview of Solaris Device Drivers</a></p>
<p class="toc level2"><a href="kernelovr-77198.html">2.&nbsp;&nbsp;Solaris Kernel and Device Tree</a></p>
<p class="toc level2"><a href="mt-17026.html">3.&nbsp;&nbsp;Multithreading</a></p>
<p class="toc level2"><a href="properties-1.html">4.&nbsp;&nbsp;Properties</a></p>
<p class="toc level2"><a href="events-1.html">5.&nbsp;&nbsp;Managing Events and Queueing Tasks</a></p>
<p class="toc level2"><a href="autoconf-17.html">6.&nbsp;&nbsp;Driver Autoconfiguration</a></p>
<p class="toc level2"><a href="devaccess-3.html">7.&nbsp;&nbsp;Device Access: Programmed I/O</a></p>
<p class="toc level2"><a href="interrupt-15678.html">8.&nbsp;&nbsp;Interrupt Handlers</a></p>
<p class="toc level2"><a href="dma-29901.html">9.&nbsp;&nbsp;Direct Memory Access (DMA)</a></p>
<p class="toc level2"><a href="devmap-24338.html">10.&nbsp;&nbsp;Mapping Device and Kernel Memory</a></p>
<p class="toc level2"><a href="devcnmgt-19679.html">11.&nbsp;&nbsp;Device Context Management</a></p>
<p class="toc level2"><a href="powermgt-37437.html">12.&nbsp;&nbsp;Power Management</a></p>
<p class="toc level2"><a href="gevsi.html">13.&nbsp;&nbsp;Hardening Solaris Drivers</a></p>
<p class="toc level2"><a href="ldi-1.html">14.&nbsp;&nbsp;Layered Driver Interface (LDI)</a></p>
<p class="toc level1 tocsp"><a href="eqbvb.html">Part&nbsp;II&nbsp;Designing Specific Kinds of Device Drivers</a></p>
<p class="toc level2"><a href="character-21002.html">15.&nbsp;&nbsp;Drivers for Character Devices</a></p>
<p class="toc level2"><a href="block-34861.html">16.&nbsp;&nbsp;Drivers for Block Devices</a></p>
<p class="toc level2"><a href="scsi-36812.html">17.&nbsp;&nbsp;SCSI Target Drivers</a></p>
<p class="toc level2"><a href="scsihba-32898.html">18.&nbsp;&nbsp;SCSI Host Bus Adapter Drivers</a></p>
<p class="toc level3"><a href="scsihba-105.html">Introduction to Host Bus Adapter Drivers</a></p>
<p class="toc level3"><a href="scsihba-10.html">SCSI Interface</a></p>
<div class="onpage">
<p class="toc level3"><a href="">SCSA HBA Interfaces</a></p>
</div>
<p class="toc level3"><a href="scsihba-32.html">HBA Driver Dependency and Configuration Issues</a></p>
<p class="toc level3"><a href="scsihba-50.html">Entry Points for SCSA HBA Drivers</a></p>
<p class="toc level3"><a href="scsihba-88.html">SCSI HBA Driver Specific Issues</a></p>
<p class="toc level3"><a href="scsihba-100.html">Support for Queuing</a></p>
<p class="toc level2 tocsp"><a href="gld-1.html">19.&nbsp;&nbsp;Drivers for Network Devices</a></p>
<p class="toc level2"><a href="usb-1.html">20.&nbsp;&nbsp;USB Drivers</a></p>
<p class="toc level1 tocsp"><a href="eqbvo.html">Part&nbsp;III&nbsp;Building a Device Driver</a></p>
<p class="toc level2"><a href="loading-15035.html">21.&nbsp;&nbsp;Compiling, Loading, Packaging, and Testing Drivers</a></p>
<p class="toc level2"><a href="debug-60.html">22.&nbsp;&nbsp;Debugging, Testing, and Tuning Device Drivers</a></p>
<p class="toc level2"><a href="coding-practices.html">23.&nbsp;&nbsp;Recommended Coding Practices</a></p>
<p class="toc level1 tocsp"><a href="eqbva.html">Part&nbsp;IV&nbsp;Appendixes</a></p>
<p class="toc level2"><a href="hwovr-18191.html">A.&nbsp;&nbsp;Hardware Overview</a></p>
<p class="toc level2"><a href="ddidkisvc-29227.html">B.&nbsp;&nbsp;Summary of Solaris DDI/DKI Services</a></p>
<p class="toc level2"><a href="lp64-35004.html">C.&nbsp;&nbsp;Making a Device Driver 64-Bit Ready</a></p>
<p class="toc level2"><a href="euazz.html">D.&nbsp;&nbsp;Console Frame Buffer Drivers</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="scsihba-16"></a><h3>SCSA HBA Interfaces</h3>
<p>SCSA HBA interfaces include HBA entry points, HBA data structures, and an HBA
framework.</p>

<a name="scsihba-17"></a><h4>SCSA HBA Entry Point Summary</h4>
<p><a name="indexterm-604"></a><a name="indexterm-605"></a><a name="indexterm-606"></a>SCSA defines a number of HBA driver entry points. These entry points are
listed in the following table. The entry points are called by the system
when a target driver instance connected to the HBA driver is configured. The
entry points are also called when the target driver makes a SCSA request.
See <a href="scsihba-50.html">Entry Points for SCSA HBA Drivers</a> for more information.</p><a name="scsihba-tbl-18"></a><h6>Table&nbsp;18-1 SCSA HBA Entry Point Summary</h6><table><col width="44%"><col width="55%"><tr><th align="left" valign="top" scope="column"><p>Function Name</p></th>
<th align="left" valign="top" scope="column"><p>Called as a Result of</p></th>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-abort-9e?a=view"><tt>tran_abort</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>Target driver calling
 <a href="http://docs.sun.com/doc/819-2256/scsi-abort-9f?a=view"><tt>scsi_abort</tt>(9F)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-bus-reset-9e?a=view"><tt>tran_bus_reset</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>System resetting bus</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-destroy-pkt-9e?a=view"><tt>tran_destroy_pkt</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>Target driver calling <a href="http://docs.sun.com/doc/819-2256/scsi-destroy-pkt-9f?a=view"><tt>scsi_destroy_pkt</tt>(9F)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-dmafree-9e?a=view"><tt>tran_dmafree</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>Target driver calling <a href="http://docs.sun.com/doc/819-2256/scsi-dmafree-9f?a=view"><tt>scsi_dmafree</tt>(9F)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-getcap-9e?a=view"><tt>tran_getcap</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>Target driver calling
 <a href="http://docs.sun.com/doc/819-2256/scsi-ifgetcap-9f?a=view"><tt>scsi_ifgetcap</tt>(9F)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-init-pkt-9e?a=view"><tt>tran_init_pkt</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>Target driver calling <a href="http://docs.sun.com/doc/819-2256/scsi-init-pkt-9f?a=view"><tt>scsi_init_pkt</tt>(9F)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-quiesce-9e?a=view"><tt>tran_quiesce</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>System quiescing bus</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-reset-9e?a=view"><tt>tran_reset</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>Target driver calling <tt>scsi_reset</tt>(9F)</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-reset-notify-9e?a=view"><tt>tran_reset_notify</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>Target driver calling
<a href="http://docs.sun.com/doc/819-2256/scsi-reset-notify-9f?a=view"><tt>scsi_reset_notify</tt>(9F)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-setcap-9e?a=view"><tt>tran_setcap</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>Target driver calling <a href="http://docs.sun.com/doc/819-2256/scsi-ifsetcap-9f?a=view"><tt>scsi_ifsetcap</tt>(9F)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-start-9e?a=view"><tt>tran_start</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>Target driver calling <a href="http://docs.sun.com/doc/819-2256/scsi-transport-9f?a=view"><tt>scsi_transport</tt>(9F)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-sync-pkt-9e?a=view"><tt>tran_sync_pkt</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>Target driver calling <a href="http://docs.sun.com/doc/819-2256/scsi-sync-pkt-9f?a=view"><tt>scsi_sync_pkt</tt>(9F)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>tran_tgt_free</tt>(9E)</p></td>
<td align="left" valign="top" scope="row"><p>System detaching target
device instance</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>tran_tgt_init</tt>(9E)</p></td>
<td align="left" valign="top" scope="row"><p>System attaching target device instance</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>tran_tgt_probe</tt>(9E)</p></td>
<td align="left" valign="top" scope="row"><p>Target driver calling  <a href="http://docs.sun.com/doc/819-2256/scsi-probe-9f?a=view"><tt>scsi_probe</tt>(9F)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-unquiesce-9e?a=view"><tt>tran_unquiesce</tt>(9E)</a></p></td>
<td align="left" valign="top" scope="row"><p>System resuming activity
on bus</p></td>
</tr>
</table>

<a name="scsihba-19"></a><h4>SCSA HBA Data Structures</h4>
<p><a name="indexterm-607"></a>SCSA defines data structures to enable the exchange of information between the target
and HBA drivers. The following data structures are included:</p>
<ul><li><p><a href="http://docs.sun.com/doc/819-2257/scsi-hba-tran-9s?a=view"><tt>scsi_hba_tran</tt>(9S)</a></p></li>
<li><p><a href="http://docs.sun.com/doc/819-2257/scsi-address-9s?a=view"><tt>scsi_address</tt>(9S)</a></p></li>
<li><p><a href="http://docs.sun.com/doc/819-2257/scsi-device-9s?a=view"><tt>scsi_device</tt>(9S)</a></p></li>
<li><p><a href="http://docs.sun.com/doc/819-2257/scsi-pkt-9s?a=view"><tt>scsi_pkt</tt>(9S)</a></p></li></ul>


<a name="scsihba-20"></a><h5><tt>scsi_hba_tran()</tt> Structure</h5>
<p><a name="indexterm-608"></a>Each instance of an HBA driver must allocate a <a href="http://docs.sun.com/doc/819-2257/scsi-hba-tran-9s?a=view"><tt>scsi_hba_tran</tt>(9S)</a> structure by using
the <a href="http://docs.sun.com/doc/819-2256/scsi-hba-tran-alloc-9f?a=view"><tt>scsi_hba_tran_alloc</tt>(9F)</a> function in the  <a href="http://docs.sun.com/doc/819-2255/attach-9e?a=view"><tt>attach</tt>(9E)</a> entry point. The <tt>scsi_hba_tran_alloc()</tt> function
initializes the <tt>scsi_hba_tran</tt> structure. The HBA driver must initialize specific vectors in the
transport structure to point to entry points within the HBA driver. After the
<tt>scsi_hba_tran</tt> structure is initialized, the HBA driver exports the transport structure to SCSA
by calling the <a href="http://docs.sun.com/doc/819-2256/scsi-hba-attach-setup-9f?a=view"><tt>scsi_hba_attach_setup</tt>(9F)</a> function.</p>
<hr><p><b>Caution - </b>Because SCSA keeps a pointer to the transport structure in the driver-private field
on the <tt>devinfo</tt> node, HBA drivers must not use  <a href="http://docs.sun.com/doc/819-2256/ddi-set-driver-private-9f?a=view"><tt>ddi_set_driver_private</tt>(9F)</a>. HBA drivers
can, however, use  <a href="http://docs.sun.com/doc/819-2256/ddi-get-driver-private-9f?a=view"><tt>ddi_get_driver_private</tt>(9F)</a> to retrieve the pointer to the transport
structure.</p>
<hr>
<p>The SCSA interfaces require the HBA driver to supply a number of
entry points that are callable through the <tt>scsi_hba_tran</tt> structure. See <a href="scsihba-50.html">Entry Points for SCSA HBA Drivers</a> for more information.</p><p>The <tt>scsi_hba_tran</tt> structure contains the following fields:</p><pre>struct scsi_hba_tran {
    dev_info_t          *tran_hba_dip;          /* HBAs dev_info pointer */
    void                *tran_hba_private;      /* HBA softstate */
    void                *tran_tgt_private;      /* HBA target private pointer */
    struct scsi_device  *tran_sd;               /* scsi_device */
    int                 (*tran_tgt_init)();     /* Transport target */
                                                /* Initialization */
    int                 (*tran_tgt_probe)();    /* Transport target probe */
    void                (*tran_tgt_free)();     /* Transport target free */
    int                 (*tran_start)();        /* Transport start */
    int                 (*tran_reset)();        /* Transport reset */
    int                 (*tran_abort)();        /* Transport abort */
    int                 (*tran_getcap)();       /* Capability retrieval */
    int                 (*tran_setcap)();       /* Capability establishment */
    struct scsi_pkt     *(*tran_init_pkt)();    /* Packet and DMA allocation */
    void                (*tran_destroy_pkt)();  /* Packet and DMA */
                                                /* Deallocation */
    void                (*tran_dmafree)();      /* DMA deallocation */
    void                (*tran_sync_pkt)();     /* Sync DMA */
    void                (*tran_reset_notify)(); /* Bus reset notification */
    int                 (*tran_bus_reset)();    /* Reset bus only */
    int                 (*tran_quiesce)();      /* Quiesce a bus */
    int                 (*tran_unquiesce)();    /* Unquiesce a bus */
    int                 tran_interconnect_type; /* transport interconnect */
};</pre><p>The following descriptions give more information about these <tt>scsi_hba_tran</tt> structure fields:</p><dl><dt><tt>tran_hba_dip</tt></dt>
<dd><p>Pointer to the HBA device instance <tt>dev_info</tt> structure. The function <a href="http://docs.sun.com/doc/819-2256/scsi-hba-attach-setup-9f?a=view"><tt>scsi_hba_attach_setup</tt>(9F)</a> sets this field.</p></dd>
<dt><tt>tran_hba_private</tt></dt>
<dd><p>Pointer to private data maintained by the HBA driver. Usually, <tt>tran_hba_private</tt> contains a pointer to the state structure of the HBA driver.</p></dd>
<dt><tt>tran_tgt_private</tt></dt>
<dd><p>Pointer to private data maintained by the HBA driver when using cloning. By specifying <tt>SCSI_HBA_TRAN_CLONE</tt> when calling  <a href="http://docs.sun.com/doc/819-2256/scsi-hba-attach-setup-9f?a=view"><tt>scsi_hba_attach_setup</tt>(9F)</a>, the <a href="http://docs.sun.com/doc/819-2257/scsi-hba-tran-9s?a=view"><tt>scsi_hba_tran</tt>(9S)</a> structure is cloned once per target. This approach enables the HBA to initialize this field to point to a per-target instance data structure in the <a href="http://docs.sun.com/doc/819-2255/tran-tgt-init-9e?a=view"><tt>tran_tgt_init</tt>(9E)</a> entry point. If <tt>SCSI_HBA_TRAN_CLONE</tt> is not specified, <tt>tran_tgt_private</tt> is <tt>NULL</tt>, and <tt>tran_tgt_private</tt> must not be referenced. See <a href="#scsihba-27">Transport Structure Cloning</a> for more information.</p></dd>
<dt><tt>tran_sd</tt></dt>
<dd><p>Pointer to a per-target instance <a href="http://docs.sun.com/doc/819-2257/scsi-device-9s?a=view"><tt>scsi_device</tt>(9S)</a> structure used when cloning. If <tt>SCSI_HBA_TRAN_CLONE</tt> is passed to <a href="http://docs.sun.com/doc/819-2256/scsi-hba-attach-setup-9f?a=view"><tt>scsi_hba_attach_setup</tt>(9F)</a>, <tt>tran_sd</tt> is initialized to point to the per-target <tt>scsi_device</tt> structure. This initialization takes place before any HBA functions are called on behalf of that target. If <tt>SCSI_HBA_TRAN_CLONE</tt> is not specified, <tt>tran_sd</tt> is <tt>NULL</tt>, and <tt>tran_sd</tt> must not be referenced. See <a href="#scsihba-27">Transport Structure Cloning</a> for more information.</p></dd>
<dt><tt>tran_tgt_init</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when initializing a target device instance. If no per-target initialization is required, the HBA can leave <tt>tran_tgt_init</tt> set to <tt>NULL</tt>.</p></dd>
<dt><tt>tran_tgt_probe</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target driver instance calls <a href="http://docs.sun.com/doc/819-2256/scsi-probe-9f?a=view"><tt>scsi_probe</tt>(9F)</a>. This routine is called to probe for the existence of a target device. If no target probing customization is required for this HBA, the HBA should set <tt>tran_tgt_probe</tt> to  <a href="http://docs.sun.com/doc/819-2256/scsi-hba-probe-9f?a=view"><tt>scsi_hba_probe</tt>(9F)</a>.</p></dd>
<dt><tt>tran_tgt_free</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target device instance is destroyed. If no per-target deallocation is necessary, the HBA can leave <tt>tran_tgt_free</tt> set to <tt>NULL</tt>.</p></dd>
<dt><tt>tran_start</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target driver calls <a href="http://docs.sun.com/doc/819-2256/scsi-transport-9f?a=view"><tt>scsi_transport</tt>(9F)</a>.</p></dd>
<dt><tt>tran_reset</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target driver calls <a href="http://docs.sun.com/doc/819-2256/scsi-reset-9f?a=view"><tt>scsi_reset</tt>(9F)</a>.</p></dd>
<dt><tt>tran_abort</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target driver calls <a href="http://docs.sun.com/doc/819-2256/scsi-abort-9f?a=view"><tt>scsi_abort</tt>(9F)</a>.</p></dd>
<dt><tt>tran_getcap</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target driver calls <a href="http://docs.sun.com/doc/819-2256/scsi-ifgetcap-9f?a=view"><tt>scsi_ifgetcap</tt>(9F)</a>.</p></dd>
<dt><tt>tran_setcap</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target driver calls <a href="http://docs.sun.com/doc/819-2256/scsi-ifsetcap-9f?a=view"><tt>scsi_ifsetcap</tt>(9F)</a>.</p></dd>
<dt><tt>tran_init_pkt</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target driver calls <a href="http://docs.sun.com/doc/819-2256/scsi-init-pkt-9f?a=view"><tt>scsi_init_pkt</tt>(9F)</a>.</p></dd>
<dt><tt>tran_destroy_pkt</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target driver calls <a href="http://docs.sun.com/doc/819-2256/scsi-destroy-pkt-9f?a=view"><tt>scsi_destroy_pkt</tt>(9F)</a>.</p></dd>
<dt><tt>tran_dmafree</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target driver calls <a href="http://docs.sun.com/doc/819-2256/scsi-dmafree-9f?a=view"><tt>scsi_dmafree</tt>(9F)</a>.</p></dd>
<dt><tt>tran_sync_pkt</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target driver calls <a href="http://docs.sun.com/doc/819-2256/scsi-sync-pkt-9f?a=view"><tt>scsi_sync_pkt</tt>(9F)</a>.</p></dd>
<dt><tt>tran_reset_notify</tt></dt>
<dd><p>Pointer to the HBA driver entry point that is called when a target driver calls <a href="http://docs.sun.com/doc/819-2255/tran-reset-notify-9e?a=view"><tt>tran_reset_notify</tt>(9E)</a>.</p></dd>
<dt><tt>tran_bus_reset</tt></dt>
<dd><p>The function entry that resets the SCSI bus without resetting targets.</p></dd>
<dt><tt>tran_quiesce</tt></dt>
<dd><p>The function entry that waits for all outstanding commands to complete and blocks (or queues) any I/O requests issued.</p></dd>
<dt><tt>tran_unquiesce</tt></dt>
<dd><p>The function entry that allows I/O activities to resume on the SCSI bus.</p></dd>
<dt><tt>tran_interconnect_type</tt></dt>
<dd><p>Integer value denoting interconnect type of the transport as defined in the <tt>services.h</tt> header file.</p></dd>
</dl>


<a name="scsihba-21"></a><h5><tt>scsi_address</tt> Structure</h5>
<p><a name="indexterm-609"></a>The <a href="http://docs.sun.com/doc/819-2257/scsi-address-9s?a=view"><tt>scsi_address</tt>(9S)</a> structure provides transport and addressing information for each SCSI command that
is allocated and transported by a target driver instance.</p><p>The <tt>scsi_address</tt> structure contains the following fields:</p><pre>struct scsi_address {
    struct scsi_hba_tran    *a_hba_tran;    /* Transport vectors */
    ushort_t                a_target;       /* Target identifier */
    uchar_t                 a_lun;          /* LUN on that target */
    uchar_t                 a_sublun;       /* Sub LUN on that LUN */
                                            /* Not used */
};</pre><dl><dt><tt>a_hba_tran</tt></dt>
<dd><p>Pointer to the <a href="http://docs.sun.com/doc/819-2257/scsi-hba-tran-9s?a=view"><tt>scsi_hba_tran</tt>(9S)</a> structure, as allocated and initialized by the HBA driver. If <tt>SCSI_HBA_TRAN_CLONE</tt> was specified as the flag to <a href="http://docs.sun.com/doc/819-2256/scsi-hba-attach-setup-9f?a=view"><tt>scsi_hba_attach_setup</tt>(9F)</a>, <tt>a_hba_tran</tt> points to a copy of that structure.</p></dd>
<dt><tt>a_target</tt></dt>
<dd><p>Identifies the SCSI target on the SCSI bus.</p></dd>
<dt><tt>a_lun</tt></dt>
<dd><p>Identifies the SCSI logical unit on the SCSI target.</p></dd>
</dl>


<a name="scsihba-22"></a><h5><tt>scsi_device</tt> Structure</h5>
<p><a name="indexterm-610"></a>The HBA framework allocates and initializes a <a href="http://docs.sun.com/doc/819-2257/scsi-device-9s?a=view"><tt>scsi_device</tt>(9S)</a> structure for each instance of
a target device. The allocation and initialization occur before the framework calls the
HBA driver's <a href="http://docs.sun.com/doc/819-2255/tran-tgt-init-9e?a=view"><tt>tran_tgt_init</tt>(9E)</a> entry point. This structure stores information about each SCSI logical
unit, including pointers to information areas that contain both generic and device-specific information.
One <a href="http://docs.sun.com/doc/819-2257/scsi-device-9s?a=view"><tt>scsi_device</tt>(9S)</a> structure exists for each target device instance that is attached to
the system.</p><p>If the per-target initialization is successful, the HBA framework sets the target driver's
per-instance private data to point to the <a href="http://docs.sun.com/doc/819-2257/scsi-device-9s?a=view"><tt>scsi_device</tt>(9S)</a> structure, using  <a href="http://docs.sun.com/doc/819-2256/ddi-set-driver-private-9f?a=view"><tt>ddi_set_driver_private</tt>(9F)</a>. Note
that an initialization is successful if <tt>tran_tgt_init()</tt> returns success or if the
vector is null.</p><p>The <a href="http://docs.sun.com/doc/819-2257/scsi-device-9s?a=view"><tt>scsi_device</tt>(9S)</a> structure contains the following fields:</p><pre>struct scsi_device {
    struct scsi_address           sd_address;    /* routing information */
    dev_info_t                    *sd_dev;       /* device dev_info node */
    kmutex_t                      sd_mutex;      /* mutex used by device */
    void                          *sd_reserved;
    struct scsi_inquiry           *sd_inq;
    struct scsi_extended_sense    *sd_sense;
    caddr_t                       sd_private;    /* for driver's use */
};</pre><p>where:</p><dl><dt><tt>sd_address</tt></dt>
<dd><p>Data structure that is passed to the routines for SCSI resource allocation.</p></dd>
<dt><tt>sd_dev</tt></dt>
<dd><p>Pointer to the target's <tt>dev_info</tt> structure.</p></dd>
<dt><tt>sd_mutex</tt></dt>
<dd><p>Mutex for use by the target driver. This mutex is initialized by the HBA framework. The mutex can be used by the target driver as a per-device mutex. This mutex should not be held across a call to <a href="http://docs.sun.com/doc/819-2256/scsi-transport-9f?a=view"><tt>scsi_transport</tt>(9F)</a> or <a href="http://docs.sun.com/doc/819-2256/scsi-poll-9f?a=view"><tt>scsi_poll</tt>(9F)</a>. See <a href="mt-17026.html">Chapter&nbsp;3, Multithreading</a> for more information on mutexes.</p></dd>
<dt><tt>sd_inq</tt></dt>
<dd><p>Pointer for the target device's SCSI inquiry data. The <a href="http://docs.sun.com/doc/819-2256/scsi-probe-9f?a=view"><tt>scsi_probe</tt>(9F)</a> routine allocates a buffer, fills the buffer in, and attaches the buffer to this field.</p></dd>
<dt><tt>sd_sense</tt></dt>
<dd><p>Pointer to a buffer to contain request sense data from the device. The target driver must allocate and manage this buffer itself. See the target driver's <a href="http://docs.sun.com/doc/819-2255/attach-9e?a=view"><tt>attach</tt>(9E)</a> routine in <a href="autoconf-60641.html#autoconf-41111"><tt>attach()</tt> Entry Point</a> for more information.</p></dd>
<dt><tt>sd_private</tt></dt>
<dd><p>Pointer field for use by the target driver. This field is commonly used to store a pointer to a private target driver state structure.</p></dd>
</dl>


<a name="scsihba-23"></a><h5><tt>scsi_pkt</tt> Structure (HBA)</h5>
<p><a name="indexterm-611"></a>To execute SCSI commands, a target driver must first allocate a <a href="http://docs.sun.com/doc/819-2257/scsi-pkt-9s?a=view"><tt>scsi_pkt</tt>(9S)</a> structure for
the command. The target driver must then specify its own private data area
length, the command status, and the command length. The HBA driver is responsible
for implementing the packet allocation in the  <a href="http://docs.sun.com/doc/819-2255/tran-init-pkt-9e?a=view"><tt>tran_init_pkt</tt>(9E)</a> entry point. The HBA
driver is also responsible for freeing the packet in its  <a href="http://docs.sun.com/doc/819-2255/tran-destroy-pkt-9e?a=view"><tt>tran_destroy_pkt</tt>(9E)</a>
entry point. See <a href="scsi-9.html#scsi-39157"><tt>scsi_pkt</tt> Structure (Target Drivers)</a> for more information.</p><p>The <a href="http://docs.sun.com/doc/819-2257/scsi-pkt-9s?a=view"><tt>scsi_pkt</tt>(9S)</a> structure contains these fields:</p><pre>struct scsi_pkt {
    opaque_t pkt_ha_private;             /* private data for host adapter */
    struct scsi_address pkt_address;     /* destination address */
    opaque_t pkt_private;                /* private data for target driver */
    void (*pkt_comp)(struct scsi_pkt *); /* completion routine */
    uint_t  pkt_flags;                   /* flags */
    int     pkt_time;                    /* time allotted to complete command */
    uchar_t *pkt_scbp;                   /* pointer to status block */
    uchar_t *pkt_cdbp;                   /* pointer to command block */
    ssize_t pkt_resid;                   /* data bytes not transferred */
    uint_t  pkt_state;                   /* state of command */
    uint_t  pkt_statistics;              /* statistics */
    uchar_t pkt_reason;                  /* reason completion called */
};</pre><p>where:</p><dl><dt><tt>pkt_ha_private</tt></dt>
<dd><p>Pointer to per-command HBA-driver private data.</p></dd>
<dt><tt>pkt_address</tt></dt>
<dd><p>Pointer to the <a href="http://docs.sun.com/doc/819-2257/scsi-address-9s?a=view"><tt>scsi_address</tt>(9S)</a> structure providing address information for this command.</p></dd>
<dt><tt>pkt_private</tt></dt>
<dd><p>Pointer to per-packet target-driver private data.</p></dd>
<dt><tt>pkt_comp</tt></dt>
<dd><p>Pointer to the target-driver completion routine called by the HBA driver when the transport layer has completed this command.</p></dd>
<dt><tt>pkt_flags</tt></dt>
<dd><p>Flags for the command.</p></dd>
<dt><tt>pkt_time</tt></dt>
<dd><p>Specifies the completion timeout in seconds for the command.</p></dd>
<dt><tt>pkt_scbp</tt></dt>
<dd><p>Pointer to the status completion block for the command.</p></dd>
<dt><tt>pkt_cdbp</tt></dt>
<dd><p>Pointer to the command descriptor block (CDB) for the command.</p></dd>
<dt><tt>pkt_resid</tt></dt>
<dd><p>Count of the data bytes that were <b>not</b> transferred when the command completed. This field can also be used to specify the amount of data for which resources have not been allocated. The HBA must modify this field during transport.</p></dd>
<dt><tt>pkt_state</tt></dt>
<dd><p>State of the command. The HBA must modify this field during transport.</p></dd>
<dt><tt>pkt_statistics</tt></dt>
<dd><p>Provides a history of the events that the command experienced while in the transport layer. The HBA must modify this field during transport.</p></dd>
<dt><tt>pkt_reason</tt></dt>
<dd><p>Reason for command completion. The HBA must modify this field during transport.</p></dd>
</dl>


<a name="scsihba-24"></a><h4>Per-Target Instance Data</h4>
<p><a name="indexterm-612"></a>An HBA driver must allocate a <a href="http://docs.sun.com/doc/819-2257/scsi-hba-tran-9s?a=view"><tt>scsi_hba_tran</tt>(9S)</a> structure during  <a href="http://docs.sun.com/doc/819-2255/attach-9e?a=view"><tt>attach</tt>(9E)</a>. The HBA
driver must then initialize the vectors in this transport structure to point to
the required entry points for the HBA driver. This <tt>scsi_hba_tran</tt> structure is then passed
into  <a href="http://docs.sun.com/doc/819-2256/scsi-hba-attach-setup-9f?a=view"><tt>scsi_hba_attach_setup</tt>(9F)</a>.</p><p>The <tt>scsi_hba_tran</tt> structure contains a <tt>tran_hba_private</tt> field, which can be used to
refer to the HBA driver's per-instance state.</p><p>Each <a href="http://docs.sun.com/doc/819-2257/scsi-address-9s?a=view"><tt>scsi_address</tt>(9S)</a> structure contains a pointer to the <tt>scsi_hba_tran</tt> structure. In addition,
the <tt>scsi_address</tt> structure provides the target, that is, <tt>a_target</tt>, and logical unit (<tt>a_lun</tt>) addresses
for the particular target device. Each entry point for the HBA driver is
passed a pointer to the <tt>scsi_address</tt> structure, either directly or indirectly through
the <a href="http://docs.sun.com/doc/819-2257/scsi-device-9s?a=view"><tt>scsi_device</tt>(9S)</a> structure. As a result, the HBA driver can reference its own
state. The HBA driver can also identify the target device that is addressed.</p><p>The following figure illustrates the HBA data structures for transport operations.</p><a name="scsihba-fig-25"></a><h6>Figure&nbsp;18-3 HBA Transport Structures</h6><img src="figures/scsihba.transportstructs.gif" alt="Diagram shows the relationships of structures involved in the HBA transport layer."></img>

<a name="scsihba-27"></a><h4>Transport Structure Cloning</h4>
<p><a name="indexterm-613"></a><a name="indexterm-614"></a>Cloning can be useful if an HBA driver needs to maintain per-target private
data in the <a href="http://docs.sun.com/doc/819-2257/scsi-hba-tran-9s?a=view"><tt>scsi_hba_tran</tt>(9S)</a> structure. Cloning can also be used to maintain a more
complex address than is provided in the <a href="http://docs.sun.com/doc/819-2257/scsi-address-9s?a=view"><tt>scsi_address</tt>(9S)</a> structure.</p><p>In the cloning process, the HBA driver must still allocate a <tt>scsi_hba_tran</tt>
structure at  <a href="http://docs.sun.com/doc/819-2255/attach-9e?a=view"><tt>attach</tt>(9E)</a> time. The HBA driver must also initialize the <tt>tran_hba_private</tt>
soft state pointer and the entry point vectors for the HBA driver. The
difference occurs when the framework begins to connect an instance of a target
driver to the HBA driver. Before calling the HBA driver's  <a href="http://docs.sun.com/doc/819-2255/tran-tgt-init-9e?a=view"><tt>tran_tgt_init</tt>(9E)</a> entry
point, the framework clones the <tt>scsi_hba_tran</tt> structure that is associated with that instance of
the HBA. Accordingly, each <tt>scsi_address</tt> structure that is allocated and initialized for a
particular target device instance points to a per-target instance <b>copy</b> of the <tt>scsi_hba_tran</tt>
structure. The <tt>scsi_address</tt> structures do not point to the <tt>scsi_hba_tran</tt> structure that is allocated
by the HBA driver at  <tt>attach()</tt> time. </p><p>An HBA driver can use two important pointers when cloning is 
specified. These pointers are contained in the <tt>scsi_hba_tran</tt> structure. The first pointer is the
<tt>tran_tgt_private</tt> field, which the driver can use to point to per-target HBA private
data. The <tt>tran_tgt_private</tt> pointer is useful, for example, if an HBA driver needs
to maintain a more complex address than <tt>a_target</tt> and <tt>a_lun</tt> provide. The
second pointer is the <tt>tran_sd</tt> field, which is a pointer to the <a href="http://docs.sun.com/doc/819-2257/scsi-device-9s?a=view"><tt>scsi_device</tt>(9S)</a>
structure referring to the particular target device.</p><p>When specifying cloning, the HBA driver must allocate and initialize the per-target data.
The HBA driver must then initialize the <tt>tran_tgt_private</tt> field to point to
this data during its  <a href="http://docs.sun.com/doc/819-2255/tran-tgt-init-9e?a=view"><tt>tran_tgt_init</tt>(9E)</a> entry point. The HBA driver must free
this per-target data during its  <a href="http://docs.sun.com/doc/819-2255/tran-tgt-free-9e?a=view"><tt>tran_tgt_free</tt>(9E)</a> entry point.</p><p>When cloning, the framework initializes the <tt>tran_sd</tt> field to point to the <tt>scsi_device</tt>
structure before the HBA driver  <tt>tran_tgt_init()</tt> entry point is called. The driver requests
cloning by passing the <tt>SCSI_HBA_TRAN_CLONE</tt> flag to  <a href="http://docs.sun.com/doc/819-2256/scsi-hba-attach-setup-9f?a=view"><tt>scsi_hba_attach_setup</tt>(9F)</a>. The following figure illustrates
the HBA data structures for cloning transport operations.</p><a name="scsihba-fig-28"></a><h6>Figure&nbsp;18-4 Cloning Transport Operation</h6><img src="figures/scsihba.cloningtransportop.gif" alt="Diagram shows an example of cloned HBA structures."></img>

<a name="scsihba-30"></a><h4>SCSA HBA Functions</h4>
<p><a name="indexterm-615"></a>SCSA also provides a number of functions. The functions are listed in the
following table, for use by HBA drivers.</p><a name="scsihba-tbl-31"></a><h6>Table&nbsp;18-2 SCSA HBA Functions</h6><table><col width="44%"><col width="55%"><tr><th align="left" valign="top" scope="column"><p>Function Name</p></th>
<th align="left" valign="top" scope="column"><p>Called by Driver Entry Point</p></th>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-hba-init-9f?a=view"><tt>scsi_hba_init</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/u-init-9e?a=view"><tt>_init</tt>(9E)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-hba-fini-9f?a=view"><tt>scsi_hba_fini</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/u-fini-9e?a=view"><tt>_fini</tt>(9E)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-hba-attach-setup-9f?a=view"><tt>scsi_hba_attach_setup</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/attach-9e?a=view"><tt>attach</tt>(9E)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-hba-detach-9f?a=view"><tt>scsi_hba_detach</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/detach-9e?a=view"><tt>detach</tt>(9E)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-hba-tran-alloc-9f?a=view"><tt>scsi_hba_tran_alloc</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/attach-9e?a=view"><tt>attach</tt>(9E)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-hba-tran-free-9f?a=view"><tt>scsi_hba_tran_free</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/detach-9e?a=view"><tt>detach</tt>(9E)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-hba-probe-9f?a=view"><tt>scsi_hba_probe</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-tgt-probe-9e?a=view"><tt>tran_tgt_probe</tt>(9E)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-hba-pkt-alloc-9f?a=view"><tt>scsi_hba_pkt_alloc</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-init-pkt-9e?a=view"><tt>tran_init_pkt</tt>(9E)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-hba-pkt-free-9f?a=view"><tt>scsi_hba_pkt_free</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-destroy-pkt-9e?a=view"><tt>tran_destroy_pkt</tt>(9E)</a></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-hba-lookup-capstr-9f?a=view"><tt>scsi_hba_lookup_capstr</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2255/tran-getcap-9e?a=view"><tt>tran_getcap</tt>(9E)</a> and
<a href="http://docs.sun.com/doc/819-2255/tran-setcap-9e?a=view"><tt>tran_setcap</tt>(9E)</a></p></td>
</tr>
</table>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="scsihba-10.html">Previous</a>
             </td>
             <td align="right">
                 <a href="scsihba-32.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

