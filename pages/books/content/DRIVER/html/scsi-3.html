<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Sun Common SCSI Architecture Overview - Writing Device Drivers</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-08-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Writing Device Drivers</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="scsi-6a.html">Previous</a>
             </td>
             <td align="right">
                 <a href="scsi-37210.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="eqbvu.html">Part&nbsp;I&nbsp;Designing Device Drivers for the Solaris Platform</a></p>
<p class="toc level2"><a href="eqbqn.html">1.&nbsp;&nbsp;Overview of Solaris Device Drivers</a></p>
<p class="toc level2"><a href="kernelovr-77198.html">2.&nbsp;&nbsp;Solaris Kernel and Device Tree</a></p>
<p class="toc level2"><a href="mt-17026.html">3.&nbsp;&nbsp;Multithreading</a></p>
<p class="toc level2"><a href="properties-1.html">4.&nbsp;&nbsp;Properties</a></p>
<p class="toc level2"><a href="events-1.html">5.&nbsp;&nbsp;Managing Events and Queueing Tasks</a></p>
<p class="toc level2"><a href="autoconf-17.html">6.&nbsp;&nbsp;Driver Autoconfiguration</a></p>
<p class="toc level2"><a href="devaccess-3.html">7.&nbsp;&nbsp;Device Access: Programmed I/O</a></p>
<p class="toc level2"><a href="interrupt-15678.html">8.&nbsp;&nbsp;Interrupt Handlers</a></p>
<p class="toc level2"><a href="dma-29901.html">9.&nbsp;&nbsp;Direct Memory Access (DMA)</a></p>
<p class="toc level2"><a href="devmap-24338.html">10.&nbsp;&nbsp;Mapping Device and Kernel Memory</a></p>
<p class="toc level2"><a href="devcnmgt-19679.html">11.&nbsp;&nbsp;Device Context Management</a></p>
<p class="toc level2"><a href="powermgt-37437.html">12.&nbsp;&nbsp;Power Management</a></p>
<p class="toc level2"><a href="gevsi.html">13.&nbsp;&nbsp;Hardening Solaris Drivers</a></p>
<p class="toc level2"><a href="ldi-1.html">14.&nbsp;&nbsp;Layered Driver Interface (LDI)</a></p>
<p class="toc level1 tocsp"><a href="eqbvb.html">Part&nbsp;II&nbsp;Designing Specific Kinds of Device Drivers</a></p>
<p class="toc level2"><a href="character-21002.html">15.&nbsp;&nbsp;Drivers for Character Devices</a></p>
<p class="toc level2"><a href="block-34861.html">16.&nbsp;&nbsp;Drivers for Block Devices</a></p>
<p class="toc level2"><a href="scsi-36812.html">17.&nbsp;&nbsp;SCSI Target Drivers</a></p>
<p class="toc level3"><a href="scsi-6a.html">Introduction to Target Drivers</a></p>
<div class="onpage">
<p class="toc level3"><a href="">Sun Common SCSI Architecture Overview</a></p>
</div>
<p class="toc level3"><a href="scsi-37210.html">Hardware Configuration File</a></p>
<p class="toc level3"><a href="scsi-9.html">Declarations and Data Structures</a></p>
<p class="toc level3"><a href="scsi-11.html">Autoconfiguration for SCSI Target Drivers</a></p>
<p class="toc level3"><a href="scsi-12.html">Resource Allocation</a></p>
<p class="toc level3"><a href="scsi-15.html">Building and Transporting a Command</a></p>
<p class="toc level3"><a href="scsi-100.html">SCSI Options</a></p>
<p class="toc level2 tocsp"><a href="scsihba-32898.html">18.&nbsp;&nbsp;SCSI Host Bus Adapter Drivers</a></p>
<p class="toc level2"><a href="gld-1.html">19.&nbsp;&nbsp;Drivers for Network Devices</a></p>
<p class="toc level2"><a href="usb-1.html">20.&nbsp;&nbsp;USB Drivers</a></p>
<p class="toc level1 tocsp"><a href="eqbvo.html">Part&nbsp;III&nbsp;Building a Device Driver</a></p>
<p class="toc level2"><a href="loading-15035.html">21.&nbsp;&nbsp;Compiling, Loading, Packaging, and Testing Drivers</a></p>
<p class="toc level2"><a href="debug-60.html">22.&nbsp;&nbsp;Debugging, Testing, and Tuning Device Drivers</a></p>
<p class="toc level2"><a href="coding-practices.html">23.&nbsp;&nbsp;Recommended Coding Practices</a></p>
<p class="toc level1 tocsp"><a href="eqbva.html">Part&nbsp;IV&nbsp;Appendixes</a></p>
<p class="toc level2"><a href="hwovr-18191.html">A.&nbsp;&nbsp;Hardware Overview</a></p>
<p class="toc level2"><a href="ddidkisvc-29227.html">B.&nbsp;&nbsp;Summary of Solaris DDI/DKI Services</a></p>
<p class="toc level2"><a href="lp64-35004.html">C.&nbsp;&nbsp;Making a Device Driver 64-Bit Ready</a></p>
<p class="toc level2"><a href="euazz.html">D.&nbsp;&nbsp;Console Frame Buffer Drivers</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="scsi-3"></a><h3>Sun Common SCSI Architecture Overview</h3>
<p><a name="scsi-ix472"></a>The Sun Common SCSI Architecture (SCSA) is the Solaris DDI/DKI programming interface for
the transmission of SCSI commands from a target driver to a host bus
adapter driver. This interface is independent of the type of host bus adapter
hardware, the platform, the processor architecture, and the SCSI command being transported across
the interface.</p><p>Conforming to the SCSA enables the target driver to pass SCSI commands to
target devices without knowledge of the hardware implementation of the host bus adapter.</p><p>The SCSA conceptually separates building the SCSI command from transporting the  command
with data across the SCSI bus. The architecture defines the software interface between
high-level and low-level software components. The higher level software component consists of one
or more SCSI target drivers, which translate I/O requests into SCSI commands appropriate
for the peripheral device. The following example illustrates the SCSI architecture.</p><a name="scsi-fig-4"></a><h6>Figure&nbsp;17-1 <a name="scsi-33151"></a>SCSA Block Diagram</h6><img src="figures/scsi.scsadiagram.gif" alt="Diagram shows the role of the Sun Common SCSI Architecture in relation to SCSI drivers in the operating system."></img><p>The lower-level software component consists of a SCSA interface layer and one or
more host bus adapter drivers. The target driver is responsible for the generation
of the proper SCSI commands required to execute the desired function and for
processing the results.</p>

<a name="scsi-5"></a><h4>General Flow of Control</h4>
<p>Assuming no transport errors occur, the following steps describe the general flow of
control for a read or write request.</p>
<ol><li><p>The target driver's <a href="http://docs.sun.com/doc/819-2255/read-9e?a=view"><tt>read</tt>(9E)</a> or <a href="http://docs.sun.com/doc/819-2255/write-9e?a=view"><tt>write</tt>(9E)</a> entry point is invoked. <a href="http://docs.sun.com/doc/819-2256/physio-9f?a=view"><tt>physio</tt>(9F)</a> is used to lock down memory, prepare a <tt>buf</tt> structure, and call the strategy routine.</p></li>
<li><p>The target driver's <a href="http://docs.sun.com/doc/819-2255/strategy-9e?a=view"><tt>strategy</tt>(9E)</a> routine checks the request. <tt>strategy()</tt> then allocates a <a href="http://docs.sun.com/doc/819-2257/scsi-pkt-9s?a=view"><tt>scsi_pkt</tt>(9S)</a> by using <a href="http://docs.sun.com/doc/819-2256/scsi-init-pkt-9f?a=view"><tt>scsi_init_pkt</tt>(9F)</a>. The target driver initializes the packet and sets the SCSI command descriptor block (CDB) using the <a href="http://docs.sun.com/doc/819-2256/scsi-setup-cdb-9f?a=view"><tt>scsi_setup_cdb</tt>(9F)</a> function. The target driver also specifies a timeout. Then, the driver provides a pointer to a callback function. The callback function is called by the host bus adapter driver on completion of the command. The <a href="http://docs.sun.com/doc/819-2257/buf-9s?a=view"><tt>buf</tt>(9S)</a> pointer should be saved in the SCSI packet's target-private space.</p></li>
<li><p>The target driver submits the packet to the host bus adapter driver by using <a href="http://docs.sun.com/doc/819-2256/scsi-transport-9f?a=view"><tt>scsi_transport</tt>(9F)</a>. The target driver is then free to accept other requests. The target driver should not access the packet while the packet is in transport. If either the host bus adapter driver or the target supports queueing, new requests can be submitted while the packet is in transport.</p></li>
<li><p>As soon as the SCSI bus is free and the target not busy, the host bus adapter driver selects the target and passes the CDB. The target driver executes the command. The target then performs the requested data transfers.</p></li>
<li><p>After the target sends completion status and the command completes, the host bus adapter driver notifies the target driver. To perform the notification, the host calls the completion function that was specified in the SCSI packet. At this time the host bus adapter driver is no longer responsible for the packet, and the target driver has regained ownership of the packet.</p></li>
<li><p>The SCSI packet's completion routine analyzes the returned information. The completion routine then determines whether the SCSI operation was successful. If a failure has occurred, the target driver retries the command by calling <a href="http://docs.sun.com/doc/819-2256/scsi-transport-9f?a=view"><tt>scsi_transport</tt>(9F)</a> again. If the host bus adapter driver does not support auto request sense, the target driver must submit a request sense packet to retrieve the sense data in the event of a check condition.</p></li>
<li><p>After successful completion or if the command cannot be retried, the target driver calls <a href="http://docs.sun.com/doc/819-2256/scsi-destroy-pkt-9f?a=view"><tt>scsi_destroy_pkt</tt>(9F)</a>. <tt>scsi_destroy_pkt()</tt> synchronizes the data. <tt>scsi_destroy_pkt()</tt> then frees the packet. If the target driver needs to access the data before freeing the packet, <a href="http://docs.sun.com/doc/819-2256/scsi-sync-pkt-9f?a=view"><tt>scsi_sync_pkt</tt>(9F)</a> is called.</p></li>
<li><p>Finally, the target driver notifies the requesting application that the read or write transaction is complete. This notification is made by returning from the <a href="http://docs.sun.com/doc/819-2255/read-9e?a=view"><tt>read</tt>(9E)</a> entry point in the driver for character devices. Otherwise, notification is made indirectly through <a href="http://docs.sun.com/doc/819-2256/biodone-9f?a=view"><tt>biodone</tt>(9F)</a>.</p></li></ol>
<p>SCSA allows the execution of many of such operations, both overlapped and queued,
at various points in the process. The model places the management of system
resources on the host bus adapter driver. The software interface enables the execution
of target driver functions on host bus adapter drivers by  using SCSI
bus adapters of varying degrees of sophistication.</p>

<a name="scsi-6"></a><h4>SCSA Functions</h4>
<p><a name="fblha"></a><a name="fblgh"></a>SCSA defines functions to manage the allocation and freeing of resources, the sensing and
setting of control states, and the transport of SCSI commands. These functions are
listed in the following table.</p><a name="scsi-71616"></a><h6>Table&nbsp;17-1 Standard SCSA Functions</h6><table><col width="55%"><col width="44%"><tr><th align="left" valign="top" scope="column"><p>Function Name</p></th>
<th align="left" valign="top" scope="column"><p>Category</p></th>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-abort-9f?a=view"><tt>scsi_abort</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p>Error handling</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-alloc-consistent-buf-9f?a=view"><tt>scsi_alloc_consistent_buf</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-destroy-pkt-9f?a=view"><tt>scsi_destroy_pkt</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-dmafree-9f?a=view"><tt>scsi_dmafree</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-free-consistent-buf-9f?a=view"><tt>scsi_free_consistent_buf</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-ifgetcap-9f?a=view"><tt>scsi_ifgetcap</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p>Transport information and control</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-ifsetcap-9f?a=view"><tt>scsi_ifsetcap</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-init-pkt-9f?a=view"><tt>scsi_init_pkt</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p>Resource management</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-poll-9f?a=view"><tt>scsi_poll</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p>Polled I/O</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-probe-9f?a=view"><tt>scsi_probe</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p>Probe
functions</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-reset-9f?a=view"><tt>scsi_reset</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-setup-cdb-9f?a=view"><tt>scsi_setup_cdb</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p>CDB initialization function</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-sync-pkt-9f?a=view"><tt>scsi_sync_pkt</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p></p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-transport-9f?a=view"><tt>scsi_transport</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p>Command transport</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><a href="http://docs.sun.com/doc/819-2256/scsi-unprobe-9f?a=view"><tt>scsi_unprobe</tt>(9F)</a></p></td>
<td align="left" valign="top" scope="row"><p></p></td>
</tr>
</table>
<hr><p><b>Note - </b>If your driver needs to work with a SCSI-1 device, use the
<a href="http://docs.sun.com/doc/819-2256/makecom-9f?a=view"><tt>makecom</tt>(9F)</a>.</p>
<hr>

         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="scsi-6a.html">Previous</a>
             </td>
             <td align="right">
                 <a href="scsi-37210.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

