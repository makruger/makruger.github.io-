<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>PROM on SPARC Machines - Writing Device Drivers</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-08-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Writing Device Drivers</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="hwovr-100.html">Previous</a>
             </td>
             <td align="right">
                 <a href="ddidkisvc-29227.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="eqbvu.html">Part&nbsp;I&nbsp;Designing Device Drivers for the Solaris Platform</a></p>
<p class="toc level2"><a href="eqbqn.html">1.&nbsp;&nbsp;Overview of Solaris Device Drivers</a></p>
<p class="toc level2"><a href="kernelovr-77198.html">2.&nbsp;&nbsp;Solaris Kernel and Device Tree</a></p>
<p class="toc level2"><a href="mt-17026.html">3.&nbsp;&nbsp;Multithreading</a></p>
<p class="toc level2"><a href="properties-1.html">4.&nbsp;&nbsp;Properties</a></p>
<p class="toc level2"><a href="events-1.html">5.&nbsp;&nbsp;Managing Events and Queueing Tasks</a></p>
<p class="toc level2"><a href="autoconf-17.html">6.&nbsp;&nbsp;Driver Autoconfiguration</a></p>
<p class="toc level2"><a href="devaccess-3.html">7.&nbsp;&nbsp;Device Access: Programmed I/O</a></p>
<p class="toc level2"><a href="interrupt-15678.html">8.&nbsp;&nbsp;Interrupt Handlers</a></p>
<p class="toc level2"><a href="dma-29901.html">9.&nbsp;&nbsp;Direct Memory Access (DMA)</a></p>
<p class="toc level2"><a href="devmap-24338.html">10.&nbsp;&nbsp;Mapping Device and Kernel Memory</a></p>
<p class="toc level2"><a href="devcnmgt-19679.html">11.&nbsp;&nbsp;Device Context Management</a></p>
<p class="toc level2"><a href="powermgt-37437.html">12.&nbsp;&nbsp;Power Management</a></p>
<p class="toc level2"><a href="gevsi.html">13.&nbsp;&nbsp;Hardening Solaris Drivers</a></p>
<p class="toc level2"><a href="ldi-1.html">14.&nbsp;&nbsp;Layered Driver Interface (LDI)</a></p>
<p class="toc level1 tocsp"><a href="eqbvb.html">Part&nbsp;II&nbsp;Designing Specific Kinds of Device Drivers</a></p>
<p class="toc level2"><a href="character-21002.html">15.&nbsp;&nbsp;Drivers for Character Devices</a></p>
<p class="toc level2"><a href="block-34861.html">16.&nbsp;&nbsp;Drivers for Block Devices</a></p>
<p class="toc level2"><a href="scsi-36812.html">17.&nbsp;&nbsp;SCSI Target Drivers</a></p>
<p class="toc level2"><a href="scsihba-32898.html">18.&nbsp;&nbsp;SCSI Host Bus Adapter Drivers</a></p>
<p class="toc level2"><a href="gld-1.html">19.&nbsp;&nbsp;Drivers for Network Devices</a></p>
<p class="toc level2"><a href="usb-1.html">20.&nbsp;&nbsp;USB Drivers</a></p>
<p class="toc level1 tocsp"><a href="eqbvo.html">Part&nbsp;III&nbsp;Building a Device Driver</a></p>
<p class="toc level2"><a href="loading-15035.html">21.&nbsp;&nbsp;Compiling, Loading, Packaging, and Testing Drivers</a></p>
<p class="toc level2"><a href="debug-60.html">22.&nbsp;&nbsp;Debugging, Testing, and Tuning Device Drivers</a></p>
<p class="toc level2"><a href="coding-practices.html">23.&nbsp;&nbsp;Recommended Coding Practices</a></p>
<p class="toc level1 tocsp"><a href="eqbva.html">Part&nbsp;IV&nbsp;Appendixes</a></p>
<p class="toc level2"><a href="hwovr-18191.html">A.&nbsp;&nbsp;Hardware Overview</a></p>
<p class="toc level3"><a href="hwovr-1.html">SPARC Processor Issues</a></p>
<p class="toc level3"><a href="hwovr-35423.html">x86 Processor Issues</a></p>
<p class="toc level3"><a href="hwovr-66.html">Endianness</a></p>
<p class="toc level3"><a href="hwovr-14.html">Store Buffers</a></p>
<p class="toc level3"><a href="hwovr-15.html">System Memory Model</a></p>
<p class="toc level3"><a href="hwovr-18.html">Bus Architectures</a></p>
<p class="toc level3"><a href="hwovr-25520.html">Bus Specifics</a></p>
<p class="toc level3"><a href="hwovr-100.html">Device Issues</a></p>
<div class="onpage">
<p class="toc level3"><a href="">PROM on SPARC Machines</a></p>
</div>
<p class="toc level2 tocsp"><a href="ddidkisvc-29227.html">B.&nbsp;&nbsp;Summary of Solaris DDI/DKI Services</a></p>
<p class="toc level2"><a href="lp64-35004.html">C.&nbsp;&nbsp;Making a Device Driver 64-Bit Ready</a></p>
<p class="toc level2"><a href="euazz.html">D.&nbsp;&nbsp;Console Frame Buffer Drivers</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="hwovr-101"></a><h3>PROM on SPARC Machines</h3>
<p><a name="indexterm-1242"></a><a name="indexterm-1243"></a>Some platforms have a PROM monitor that provides support for debugging a device without
an operating system. This section describes how to use the PROM on SPARC
machines to map device registers so that they can be accessed. Usually, the
device can be exercised enough with PROM commands to determine whether the device
is working correctly.</p><p>See the <a href="http://docs.sun.com/doc/819-2240/boot-1m?a=view"><tt>boot</tt>(1M)</a> man page for a description of the x86 boot subsystem.</p><p>The PROM has several purposes, including:</p>
<ul><li><p>Bringing the machine up from power on, or from a hard reset PROM <tt>reset</tt> command</p></li>
<li><p>Providing an interactive tool for examining and setting memory, device registers, and memory mappings</p></li>
<li><p>Booting the Solaris system.</p><p>Simply powering up the computer and attempting to use its PROM to examine device registers can fail. While the device might be correctly installed, those mappings are specific to the Solaris OS and do not become active until the Solaris kernel is booted. Upon power up, the PROM maps only essential system devices, such as the keyboard.</p></li>
<li><p>Taking a system crash dump using the <tt>sync</tt> command</p></li></ul>


<a name="hwovr-82"></a><h4>Open Boot PROM 3</h4>
<p><a name="indexterm-1244"></a>For complete documentation on the Open Boot PROM, see the <i>Open Boot PROM Toolkit User's Guide</i> and the
<a href="http://docs.sun.com/doc/819-2240/monitor-1m?a=view"><tt>monitor</tt>(1M)</a> man page. The examples in this section refer to a Sun4U<sup>TM</sup> architecture.
Other architectures might require different commands to perform actions.</p>
<hr><p><b>Note - </b>The Open Boot PROM is currently used on Sun machines with an
SBus or UPA/PCI. The Open Boot PROM uses an &ldquo;<tt>ok</tt>&rdquo; prompt. On older machines,
you might have to type `<tt>n</tt>' to get the &ldquo;<tt>ok</tt>&rdquo; prompt.</p>
<hr>
<p>If the PROM is in <b>secure mode</b> (the <tt>security-mode</tt> parameter is not set
to <b>none</b>), the PROM password might be required (set in the <tt>security-password</tt> parameter).</p><p>The <tt>printenv</tt> command displays all parameters and their values.</p><p>Help is available with the <tt>help</tt> command.</p><p>EMACS-style command-line history is available. Use Control-N (next) and Control-P (previous) to traverse
the history list.</p>

<a name="hwovr-83"></a><h5>Forth Commands</h5>
<p>The Open Boot PROM uses the Forth programming language. Forth is a
stack-based language. Arguments must be pushed on the stack before running the correct command
(called a <b>word</b>), and the result is left on the stack.</p><p>To place a number on the stack, type its value.</p><pre>ok <tt><b>57</b></tt>
ok <tt><b>68</b></tt></pre><p>To add the two top values on the stack, use the <tt>+</tt>
operator.</p><pre>ok <tt><b>+</b></tt></pre><p>The result remains on the stack. The stack is shown with the
<tt>.s</tt> <b>word</b>.</p><pre>ok <tt><b>.s</b></tt>
bf</pre><p>The default base is hexadecimal. The <tt>hex</tt> and <tt>decimal</tt> <b>words</b> can be
used to switch bases.</p><pre>ok <tt><b>decimal</b></tt>
ok <tt><b>.s</b></tt>
191</pre><p>See the <i>Forth User's Guide</i> for more information.</p>

<a name="hwovr-84"></a><h5>Walking the PROMs Device Tree</h5>
<p>The commands <tt>pwd</tt>, <tt>cd</tt>, and <tt>ls</tt> walk the PROM device tree to
get to the device. The <tt>cd</tt> command must be used to establish a
position in the tree before <tt>pwd</tt> will work. This example is from an
Ultra 1 workstation with a <tt>cgsix</tt> frame buffer on an SBus.</p><pre>ok <tt><b>cd /</b></tt></pre><p>To see the devices attached to the current node in the tree,
use <tt>ls</tt>.</p><pre>ok <tt><b>ls</b></tt>
f006a064 SUNW,UltraSPARC@0,0
f00598b0 sbus@1f,0
f00592dc counter-timer@1f,3c00
f004eec8 virtual-memory
f004e8e8 memory@0,0
f002ca28 aliases
f002c9b8 options
f002c880 openprom
f002c814 chosen
f002c7a4 packages</pre><p>The full node name can be used:</p><pre>ok <tt><b>cd sbus@1f,0</b></tt>
ok <tt><b>ls</b></tt>
f006a4e4 cgsix@2,0
f0068194 SUNW,bpp@e,c800000
f0065370 ledma@e,8400010
f006120c espdma@e,8400000
f005a448 SUNW,pll@f,1304000
f005a394 sc@f,1300000
f005a24c zs@f,1000000
f005a174 zs@f,1100000
f005a0c0 eeprom@f,1200000
f0059f8c SUNW,fdtwo@f,1400000
f0059ec4 flashprom@f,0
f0059e34 auxio@f,1900000
f0059d28 SUNW,CS4231@d,c000000</pre><p>Rather than using the full node name in the previous example, you
could also use an abbreviation. The abbreviated command-line entry looks like the following example:</p><pre>ok <tt><b>cd sbus</b></tt></pre><p>The name is actually <tt>device@slot,offset</tt> (for SBus devices). The <tt>cgsix</tt> device is in
slot 2 and starts at offset 0. If an SBus device is displayed
in this tree, the device has been recognized by the PROM.</p><p>The <tt>.properties</tt> command displays the PROM properties of a device. These properties can
be examined to determine which properties the device exports. This information is useful
later to ensure that the driver is looking for the correct hardware properties.
These properties are the same properties that can be retrieved with <a href="http://docs.sun.com/doc/819-2256/ddi-getprop-9f?a=view"><tt>ddi_getprop</tt>(9F)</a>.</p><pre>ok <tt><b>cd cgsix</b></tt>
ok <tt><b>.properties</b></tt>
character-set            ISO8859-1
intr                     00000005 00000000
interrupts               00000005
reg                      00000002 00000000 01000000
dblbuf                   00 00 00 00
vmsize                   00 00 00 01
...</pre><p>The <tt>reg</tt> property defines an array of register description structures containing the following
fields:</p><pre>uint_t        bustype;       /* cookie for related bus type*/
uint_t        addr;          /* address of reg relative to bus */
uint_t        size;          /* size of this register set */</pre><p>For the <tt>cgsix</tt> example, the address is 0.</p>

<a name="hwovr-85"></a><h5>Mapping the Device</h5>
<p>A device must be mapped into memory to be tested. The PROM
can then be used to verify proper operation of the device by using
data-transfer commands to transfer bytes, words, and long words. If the device can
be operated from the PROM, even in a limited way, the driver should
also be able to operate the device.</p><p>To set up the device for initial testing, perform the following steps:</p>
<ol><li><p>Determine the SBus slot number the device is in.</p><p>In this example, the <tt>cgsix</tt> device is located in slot 2.</p></li>
<li><p>Determine the offset within the physical address space used by the device.</p><p>The offset used is specific to the device. In the <tt>cgsix</tt> example, the video memory happens to start at an offset of 0x800000.</p></li>
<li><p>Use the <tt>select-dev</tt> <b>word</b> to select the Sbus device and the <tt>map-in</tt> <b>word</b> to map the device in.</p><p>The <tt>select-dev</tt> <b>word</b> takes a string of the device path as its argument. The <tt>map-in</tt> <b>word</b> takes an <b>offset</b>, a <b>slot number</b>, and a <b>size</b> as arguments to map. Like the offset, the size of the byte transfer is specific to the device. In the <tt>cgsix</tt> example, the size is set to 0x100000 bytes.</p><p>In the following code example, the Sbus path is displayed as an argument to the <tt>select-dev</tt> word, and the offset, slot number, and size values for the frame buffer are displayed as arguments to the <tt>map-in</tt> word. Notice the space between the opening quote and / in the <tt>select-dev</tt> argument. The virtual address to use remains on top of the stack. The stack is shown using the <tt>.s</tt> word. The stack can be assigned a name with the <tt>constant</tt> operation.</p><pre>ok <tt><b>" sbus@1f,0" select-dev</b></tt>
ok <tt><b>800000 2 100000 map-in</b></tt>
ok <tt><b>.s</b></tt>
ffe98000
ok <tt><b>constant fb</b></tt></pre></li></ol>


<a name="hwovr-86"></a><h4>Reading and Writing</h4>
<p>The PROM provides a variety of 8-bit, 16-bit, and 32-bit operations. In general,
a <tt>c</tt> (character) prefix indicates an 8-bit (one-byte) operation; a <tt>w</tt> (word) prefix
indicates a 16-bit (two-byte) operation; and an <tt>L</tt> (longword) prefix indicates a 32-bit (four-byte)
operation.</p><p>A suffix of <tt>!</tt> indicates a write operation. The write operation takes the
first two items off the stack. The first item is the address, and
the second item is the value.</p><pre>ok <tt><b>55 ffe98000 c!</b></tt></pre><p>A suffix of <tt>@</tt> indicates a read operation. The read operation takes the
address off the stack.</p><pre>ok <tt><b>ffe98000 c@</b></tt>
ok <tt><b>.s</b></tt>
55</pre><p>A suffix of <tt>?</tt> is used to display the value without affecting the
stack.</p><pre>ok <tt><b>ffe98000 c?</b></tt>
55</pre><p>Be careful when trying to query the device. If the mappings are
not set up correctly, trying to read or write could cause errors. Special
words are provided to handle these cases. <tt>cprobe</tt>, <tt>wprobe</tt>, and <tt>lprobe</tt>, for example, read
from the given address but return zero if the location does not respond,
or nonzero if it does.</p><pre>ok <tt><b>fffa4000 c@</b></tt>
Data Access Error

ok <tt><b>fffa4000 cprobe</b></tt>
ok <tt><b>.s</b></tt>0

ok <tt><b>ffe98000 cprobe</b></tt>
ok <tt><b>.s</b></tt>
0 ffffffffffffffff</pre><p>A region of memory can be shown with the <tt>dump</tt> word. This takes
an <i>address</i> and a <i>length</i>, and displays the contents of the memory region
in bytes.</p><p>In the following example, the <tt>fill</tt> word is used to fill video memory
with a pattern. <tt>fill</tt> takes the address, the number of bytes to fill,
and the byte to use. Use <tt>wfill</tt> and an <tt>Lfill</tt> for words and
longwords. This fill example causes the <tt>cgsix</tt> to display simple patterns based on
the byte passed.</p><pre>ok <tt><b>" /sbus" select-dev</b></tt>
ok <tt><b>800000 2 100000 map-in</b></tt>
ok <tt><b>constant fb</b></tt>
ok <tt><b>fb 10000 ff fill</b></tt>
ok <tt><b>fb 20000 0 fill</b></tt>
ok <tt><b>fb 18000 55 fill</b></tt>
ok <tt><b>fb 15000 3 fill</b></tt>
ok <tt><b>fb 10000 5 fill</b></tt>ok <tt><b>fb 5000 f9 fill</b></tt></pre>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="hwovr-100.html">Previous</a>
             </td>
             <td align="right">
                 <a href="ddidkisvc-29227.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

