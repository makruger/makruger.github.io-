<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Device Access (Character Drivers) - Writing Device Drivers</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-08-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Writing Device Drivers</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="character-51.html">Previous</a>
             </td>
             <td align="right">
                 <a href="character-25379.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="eqbvu.html">Part&nbsp;I&nbsp;Designing Device Drivers for the Solaris Platform</a></p>
<p class="toc level2"><a href="eqbqn.html">1.&nbsp;&nbsp;Overview of Solaris Device Drivers</a></p>
<p class="toc level2"><a href="kernelovr-77198.html">2.&nbsp;&nbsp;Solaris Kernel and Device Tree</a></p>
<p class="toc level2"><a href="mt-17026.html">3.&nbsp;&nbsp;Multithreading</a></p>
<p class="toc level2"><a href="properties-1.html">4.&nbsp;&nbsp;Properties</a></p>
<p class="toc level2"><a href="events-1.html">5.&nbsp;&nbsp;Managing Events and Queueing Tasks</a></p>
<p class="toc level2"><a href="autoconf-17.html">6.&nbsp;&nbsp;Driver Autoconfiguration</a></p>
<p class="toc level2"><a href="devaccess-3.html">7.&nbsp;&nbsp;Device Access: Programmed I/O</a></p>
<p class="toc level2"><a href="interrupt-15678.html">8.&nbsp;&nbsp;Interrupt Handlers</a></p>
<p class="toc level2"><a href="dma-29901.html">9.&nbsp;&nbsp;Direct Memory Access (DMA)</a></p>
<p class="toc level2"><a href="devmap-24338.html">10.&nbsp;&nbsp;Mapping Device and Kernel Memory</a></p>
<p class="toc level2"><a href="devcnmgt-19679.html">11.&nbsp;&nbsp;Device Context Management</a></p>
<p class="toc level2"><a href="powermgt-37437.html">12.&nbsp;&nbsp;Power Management</a></p>
<p class="toc level2"><a href="gevsi.html">13.&nbsp;&nbsp;Hardening Solaris Drivers</a></p>
<p class="toc level2"><a href="ldi-1.html">14.&nbsp;&nbsp;Layered Driver Interface (LDI)</a></p>
<p class="toc level1 tocsp"><a href="eqbvb.html">Part&nbsp;II&nbsp;Designing Specific Kinds of Device Drivers</a></p>
<p class="toc level2"><a href="character-21002.html">15.&nbsp;&nbsp;Drivers for Character Devices</a></p>
<p class="toc level3"><a href="character-1.html">Overview of the Character Driver Structure</a></p>
<p class="toc level3"><a href="character-51.html">Character Device Autoconfiguration</a></p>
<div class="onpage">
<p class="toc level3"><a href="">Device Access (Character Drivers)</a></p>
</div>
<p class="toc level3"><a href="character-25379.html">I/O Request Handling</a></p>
<p class="toc level3"><a href="character-16543.html">Mapping Device Memory</a></p>
<p class="toc level3"><a href="character-11313.html">Multiplexing I/O on File Descriptors</a></p>
<p class="toc level3"><a href="character-23939.html">Miscellaneous I/O Control</a></p>
<p class="toc level3"><a href="character-17.html">32-bit and 64-bit Data Structure Macros</a></p>
<p class="toc level2 tocsp"><a href="block-34861.html">16.&nbsp;&nbsp;Drivers for Block Devices</a></p>
<p class="toc level2"><a href="scsi-36812.html">17.&nbsp;&nbsp;SCSI Target Drivers</a></p>
<p class="toc level2"><a href="scsihba-32898.html">18.&nbsp;&nbsp;SCSI Host Bus Adapter Drivers</a></p>
<p class="toc level2"><a href="gld-1.html">19.&nbsp;&nbsp;Drivers for Network Devices</a></p>
<p class="toc level2"><a href="usb-1.html">20.&nbsp;&nbsp;USB Drivers</a></p>
<p class="toc level1 tocsp"><a href="eqbvo.html">Part&nbsp;III&nbsp;Building a Device Driver</a></p>
<p class="toc level2"><a href="loading-15035.html">21.&nbsp;&nbsp;Compiling, Loading, Packaging, and Testing Drivers</a></p>
<p class="toc level2"><a href="debug-60.html">22.&nbsp;&nbsp;Debugging, Testing, and Tuning Device Drivers</a></p>
<p class="toc level2"><a href="coding-practices.html">23.&nbsp;&nbsp;Recommended Coding Practices</a></p>
<p class="toc level1 tocsp"><a href="eqbva.html">Part&nbsp;IV&nbsp;Appendixes</a></p>
<p class="toc level2"><a href="hwovr-18191.html">A.&nbsp;&nbsp;Hardware Overview</a></p>
<p class="toc level2"><a href="ddidkisvc-29227.html">B.&nbsp;&nbsp;Summary of Solaris DDI/DKI Services</a></p>
<p class="toc level2"><a href="lp64-35004.html">C.&nbsp;&nbsp;Making a Device Driver 64-Bit Ready</a></p>
<p class="toc level2"><a href="euazz.html">D.&nbsp;&nbsp;Console Frame Buffer Drivers</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="character-6"></a><h3>Device Access (Character Drivers)</h3>
<p><a name="character-ix370"></a>Access to a device by one or more application programs is controlled through
the <a href="http://docs.sun.com/doc/819-2255/open-9e?a=view"><tt>open</tt>(9E)</a> and <a href="http://docs.sun.com/doc/819-2255/close-9e?a=view"><tt>close</tt>(9E)</a> entry points. An <a href="http://docs.sun.com/doc/819-2241/open-2?a=view"><tt>open</tt>(2)</a> system call to a
special file representing a character device always causes a call to the <a href="http://docs.sun.com/doc/819-2255/open-9e?a=view"><tt>open</tt>(9E)</a>
routine for the driver. For a particular minor device, <a href="http://docs.sun.com/doc/819-2255/open-9e?a=view"><tt>open</tt>(9E)</a> can be called many
times. The <a href="http://docs.sun.com/doc/819-2255/close-9e?a=view"><tt>close</tt>(9E)</a> routine is called only when the final reference to a
device is removed. If the device is accessed through file descriptors, the final
call to <a href="http://docs.sun.com/doc/819-2255/close-9e?a=view"><tt>close</tt>(9E)</a> can occur as a result of a <a href="http://docs.sun.com/doc/819-2241/close-2?a=view"><tt>close</tt>(2)</a> or <a href="http://docs.sun.com/doc/819-2241/exit-2?a=view"><tt>exit</tt>(2)</a>
system call. If the device is accessed through memory mapping, the final call
to <a href="http://docs.sun.com/doc/819-2255/close-9e?a=view"><tt>close</tt>(9E)</a> can occur as a result of a <a href="http://docs.sun.com/doc/819-2241/munmap-2?a=view"><tt>munmap</tt>(2)</a> system call.</p>

<a name="character-7"></a><h4><tt>open()</tt> Entry Point (Character Drivers)</h4>
<a name="character-ix371"></a><a name="character-ix372"></a><p>The primary function of <tt>open()</tt> is to verify that the open request is
allowed. The syntax for <a href="http://docs.sun.com/doc/819-2255/open-9e?a=view"><tt>open</tt>(9E)</a> is as follows:</p><pre>int xxopen(dev_t *<i>devp</i>, int <i>flag</i>, int <i>otyp</i>, cred_t *<i>credp</i>);</pre><p>where:</p><dl><dt><i>devp</i></dt>
<dd><p>Pointer to a device number. The <tt>open()</tt> routine is passed a pointer so that the driver can change the minor number. With this pointer, drivers can dynamically create minor instances of the device. An example would be a pseudo terminal driver that creates a new pseudo-terminal whenever the driver is opened. A driver that dynamically chooses the minor number normally creates only one minor device node in <a href="http://docs.sun.com/doc/819-2255/attach-9e?a=view"><tt>attach</tt>(9E)</a> with <a href="http://docs.sun.com/doc/819-2256/ddi-create-minor-node-9f?a=view"><tt>ddi_create_minor_node</tt>(9F)</a>, then changes the minor number component of <tt>*devp</tt> using <a href="http://docs.sun.com/doc/819-2256/makedevice-9f?a=view"><tt>makedevice</tt>(9F)</a> and <a href="http://docs.sun.com/doc/819-2256/getmajor-9f?a=view"><tt>getmajor</tt>(9F)</a>:</p><pre>*devp = makedevice(getmajor(*<i>devp</i>), <i>new_minor</i>);</pre><p>You do not have to call <a href="http://docs.sun.com/doc/819-2256/ddi-create-minor-node-9f?a=view"><tt>ddi_create_minor_node</tt>(9F)</a> for the new minor. A driver must not change the major number of <tt>*devp</tt>. The driver must keep track of available minor numbers internally.</p></dd>
<dt><i>flag</i></dt>
<dd><p>Flag with bits to indicate whether the device is opened for reading (<tt>FREAD</tt>), writing (<tt>FWRITE</tt>), or both. User threads issuing the <a href="http://docs.sun.com/doc/819-2241/open-2?a=view"><tt>open</tt>(2)</a> system call can also request exclusive access to the device (<tt>FEXCL</tt>) or specify that the open should not block for any reason (<tt>FNDELAY</tt>), but the driver must enforce both cases. A driver for a write-only device such as a printer might consider an <a href="http://docs.sun.com/doc/819-2255/open-9e?a=view"><tt>open</tt>(9E)</a> for reading invalid.</p></dd>
<dt><i>otyp</i></dt>
<dd><p>Integer that indicates how <tt>open()</tt> was called. The driver must check that the value of <i>otyp</i> is appropriate for the device. For character drivers, <i>otyp</i> should be <tt>OTYP_CHR</tt> (see the <a href="http://docs.sun.com/doc/819-2255/open-9e?a=view"><tt>open</tt>(9E)</a> man page).</p></dd>
<dt><i>credp</i></dt>
<dd><p>Pointer to a credential structure containing information about the caller, such as the user ID and group IDs. Drivers should not examine the structure directly, but should instead use <a href="http://docs.sun.com/doc/819-2256/drv-priv-9f?a=view"><tt>drv_priv</tt>(9F)</a> to check for the common case of root privileges. In this example, only <tt>root</tt> or a user with the PRIV_SYS_DEVICES privilege is allowed to open the device for writing.</p></dd>
</dl>
<p>The following example shows a character driver  <a href="http://docs.sun.com/doc/819-2255/open-9e?a=view"><tt>open</tt>(9E)</a> routine.</p><a name="character-27851"></a><h6>Example&nbsp;15-2 Character Driver <tt>open</tt>(9E) Routine</h6><pre>static int
xxopen(dev_t *devp, int flag, int otyp, cred_t *credp)
{
    minor_t        instance;

    if (getminor(*devp)         /* if device pointer is invalid */
        return (EINVAL);
    instance = getminor(*devp); /* one-to-one example mapping */
    /* Is the instance attached? */
    if (ddi_get_soft_state(statep, instance) == NULL)
        return (ENXIO);
    /* verify that otyp is appropriate */
    if (otyp != OTYP_CHR)
        return (EINVAL);
    if ((flag &amp; FWRITE) &amp;&amp; drv_priv(credp) == EPERM)
        return (EPERM);
    return (0);
}</pre>

<a name="character-8"></a><h4><tt>close()</tt> Entry Point (Character Drivers)</h4>
<p>The syntax for <a href="http://docs.sun.com/doc/819-2255/close-9e?a=view"><tt>close</tt>(9E)</a> is as follows:</p><pre>int xxclose(dev_t <i>dev</i>, int <i>flag</i>, int <i>otyp</i>, cred_t *<i>credp</i>);</pre><p><a name="character-ix373"></a><a name="character-ix374"></a><tt>close()</tt> should perform any cleanup necessary to finish using the minor device, and
prepare the device (and driver) to be opened again. For example, the open
routine might have been invoked with the exclusive access (<tt>FEXCL</tt>) flag. A call to
<a href="http://docs.sun.com/doc/819-2255/close-9e?a=view"><tt>close</tt>(9E)</a> would allow additional open routines to continue. Other functions that <a href="http://docs.sun.com/doc/819-2255/close-9e?a=view"><tt>close</tt>(9E)</a> might
perform are:</p>
<ul><li><p>Waiting for I/O to drain from output buffers before returning</p></li>
<li><p>Rewinding a tape (tape device)</p></li>
<li><p>Hanging up the phone line (modem device)</p></li></ul>
<p>A driver that waits for I/O to drain could wait forever if
draining stalls due to external conditions such as flow control.  See <a href="mt-35265.html#mt-23">Threads Unable to Receive Signals</a>
for information about how to avoid this problem.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="character-51.html">Previous</a>
             </td>
             <td align="right">
                 <a href="character-25379.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

