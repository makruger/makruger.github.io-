<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Disk Device Drivers - Writing Device Drivers</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-08-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">Writing Device Drivers</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="block-25.html">Previous</a>
             </td>
             <td align="right">
                 <a href="scsi-36812.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="eqbvu.html">Part&nbsp;I&nbsp;Designing Device Drivers for the Solaris Platform</a></p>
<p class="toc level2"><a href="eqbqn.html">1.&nbsp;&nbsp;Overview of Solaris Device Drivers</a></p>
<p class="toc level2"><a href="kernelovr-77198.html">2.&nbsp;&nbsp;Solaris Kernel and Device Tree</a></p>
<p class="toc level2"><a href="mt-17026.html">3.&nbsp;&nbsp;Multithreading</a></p>
<p class="toc level2"><a href="properties-1.html">4.&nbsp;&nbsp;Properties</a></p>
<p class="toc level2"><a href="events-1.html">5.&nbsp;&nbsp;Managing Events and Queueing Tasks</a></p>
<p class="toc level2"><a href="autoconf-17.html">6.&nbsp;&nbsp;Driver Autoconfiguration</a></p>
<p class="toc level2"><a href="devaccess-3.html">7.&nbsp;&nbsp;Device Access: Programmed I/O</a></p>
<p class="toc level2"><a href="interrupt-15678.html">8.&nbsp;&nbsp;Interrupt Handlers</a></p>
<p class="toc level2"><a href="dma-29901.html">9.&nbsp;&nbsp;Direct Memory Access (DMA)</a></p>
<p class="toc level2"><a href="devmap-24338.html">10.&nbsp;&nbsp;Mapping Device and Kernel Memory</a></p>
<p class="toc level2"><a href="devcnmgt-19679.html">11.&nbsp;&nbsp;Device Context Management</a></p>
<p class="toc level2"><a href="powermgt-37437.html">12.&nbsp;&nbsp;Power Management</a></p>
<p class="toc level2"><a href="gevsi.html">13.&nbsp;&nbsp;Hardening Solaris Drivers</a></p>
<p class="toc level2"><a href="ldi-1.html">14.&nbsp;&nbsp;Layered Driver Interface (LDI)</a></p>
<p class="toc level1 tocsp"><a href="eqbvb.html">Part&nbsp;II&nbsp;Designing Specific Kinds of Device Drivers</a></p>
<p class="toc level2"><a href="character-21002.html">15.&nbsp;&nbsp;Drivers for Character Devices</a></p>
<p class="toc level2"><a href="block-34861.html">16.&nbsp;&nbsp;Drivers for Block Devices</a></p>
<p class="toc level3"><a href="block-1.html">Block Driver Structure Overview</a></p>
<p class="toc level3"><a href="block-82249.html">File I/O</a></p>
<p class="toc level3"><a href="block-5.html">Block Device Autoconfiguration</a></p>
<p class="toc level3"><a href="block-6.html">Controlling Device Access</a></p>
<p class="toc level3"><a href="block-78892.html">Synchronous Data Transfers (Block Drivers)</a></p>
<p class="toc level3"><a href="block-54698.html">Asynchronous Data Transfers (Block Drivers)</a></p>
<p class="toc level3"><a href="block-25.html"><tt>dump()</tt> and <tt>print()</tt> Entry Points</a></p>
<div class="onpage">
<p class="toc level3"><a href="">Disk Device Drivers</a></p>
</div>
<p class="toc level2 tocsp"><a href="scsi-36812.html">17.&nbsp;&nbsp;SCSI Target Drivers</a></p>
<p class="toc level2"><a href="scsihba-32898.html">18.&nbsp;&nbsp;SCSI Host Bus Adapter Drivers</a></p>
<p class="toc level2"><a href="gld-1.html">19.&nbsp;&nbsp;Drivers for Network Devices</a></p>
<p class="toc level2"><a href="usb-1.html">20.&nbsp;&nbsp;USB Drivers</a></p>
<p class="toc level1 tocsp"><a href="eqbvo.html">Part&nbsp;III&nbsp;Building a Device Driver</a></p>
<p class="toc level2"><a href="loading-15035.html">21.&nbsp;&nbsp;Compiling, Loading, Packaging, and Testing Drivers</a></p>
<p class="toc level2"><a href="debug-60.html">22.&nbsp;&nbsp;Debugging, Testing, and Tuning Device Drivers</a></p>
<p class="toc level2"><a href="coding-practices.html">23.&nbsp;&nbsp;Recommended Coding Practices</a></p>
<p class="toc level1 tocsp"><a href="eqbva.html">Part&nbsp;IV&nbsp;Appendixes</a></p>
<p class="toc level2"><a href="hwovr-18191.html">A.&nbsp;&nbsp;Hardware Overview</a></p>
<p class="toc level2"><a href="ddidkisvc-29227.html">B.&nbsp;&nbsp;Summary of Solaris DDI/DKI Services</a></p>
<p class="toc level2"><a href="lp64-35004.html">C.&nbsp;&nbsp;Making a Device Driver 64-Bit Ready</a></p>
<p class="toc level2"><a href="euazz.html">D.&nbsp;&nbsp;Console Frame Buffer Drivers</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="advanced-7"></a><h3>Disk Device Drivers</h3>
<p>Disk devices represent an important class of block device drivers.</p>

<a name="advanced-8"></a><h4>Disk <tt>ioctl</tt>s</h4>
<p><a name="fblgy"></a><a name="fblgi"></a>Solaris disk drivers need to support a minimum set of <tt>ioctl</tt> commands specific
to Solaris disk drivers. These I/O controls are specified in the <a href="http://docs.sun.com/doc/819-2254/dkio-7i?a=view"><tt>dkio</tt>(7I)</a>
manual page. Disk I/O controls transfer disk information to or from the device
driver. A Solaris disk device is supported by disk utility commands such as
<a href="http://docs.sun.com/doc/819-2240/format-1m?a=view"><tt>format</tt>(1M)</a> and <a href="http://docs.sun.com/doc/819-2240/newfs-1m?a=view"><tt>newfs</tt>(1M)</a>. The mandatory Sun disk I/O controls are as follows:</p><dl><dt><tt>DKIOCINFO</tt></dt>
<dd><p>Returns information that describes the disk controller</p></dd>
<dt><tt>DKIOCGAPART</tt></dt>
<dd><p>Returns a disk's partition map</p></dd>
<dt><tt>DKIOCSAPART</tt></dt>
<dd><p>Sets a disk's partition map</p></dd>
<dt><tt>DKIOCGGEOM</tt></dt>
<dd><p>Returns a disk's geometry</p></dd>
<dt><tt>DKIOCSGEOM</tt></dt>
<dd><p>Sets a disk's geometry</p></dd>
<dt><tt>DKIOCGVTOC</tt></dt>
<dd><p>Returns a disk's Volume Table of Contents</p></dd>
<dt><tt>DKIOCSVTOC</tt></dt>
<dd><p>Sets a disk's Volume Table of Contents</p></dd>
</dl>


<a name="advanced-9"></a><h4>Disk Performance</h4>
<p><a name="advanced-ix685"></a><a name="advanced-ix686"></a>The Solaris DDI/DKI provides facilities to optimize I/O transfers for improved file system
performance. A mechanism manages the list of I/O requests so as to optimize
disk access for a file system. See <a href="block-54698.html">Asynchronous Data Transfers (Block Drivers)</a> for a description of enqueuing
an I/O request.</p><p>The <tt>diskhd</tt> structure is used to manage a linked list of I/O requests.</p><pre>struct diskhd {
    long     b_flags;         /* not used, needed for consistency*/
    struct   buf *b_forw,     *b_back;     /* queue of unit queues */
    struct   buf *av_forw,    *av_back;    /* queue of bufs for this unit */
    long     b_bcount;        /* active flag */
};</pre><p>The <tt>diskhd</tt> data structure has two <tt>buf</tt> pointers that the driver can
manipulate. The <tt>av_forw</tt> pointer points to the first active I/O request. The second
pointer, <tt>av_back</tt>, points to the last active request on the list.</p><p>A pointer to this structure is passed as an argument to <a href="http://docs.sun.com/doc/819-2256/disksort-9f?a=view"><tt>disksort</tt>(9F)</a>,
along with a pointer to the current <tt>buf</tt> structure being processed. The <tt>disksort()</tt> routine
sorts the <tt>buf</tt> requests to optimize disk seek. The routine then inserts the
<tt>buf</tt> pointer into the <tt>diskhd</tt> list. The <tt>disksort()</tt> program uses the value that is
in <tt>b_resid</tt> of the <tt>buf</tt> structure as a sort key. The driver
is responsible for setting this value. Most Sun disk drivers use the cylinder
group as the sort key. This approach optimizes the file system read-ahead accesses.</p><p>When data has been added to the <tt>diskhd</tt> list, the device needs to
transfer the data. If the device is not busy processing a request, the
<tt>xxstart()</tt> routine pulls the first <tt>buf</tt> structure off the <tt>diskhd</tt> list and
starts a transfer.</p><p>If the device is busy, the driver should return from the <tt>xxstrategy()</tt>
entry point. When the hardware is done with the data transfer, an interrupt
is generated. The driver's interrupt routine is then called to service the device.
After servicing the interrupt, the driver can then call the <tt>start()</tt> routine to
process the next <tt>buf</tt> structure in the <tt>diskhd</tt> list.</p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="block-25.html">Previous</a>
             </td>
             <td align="right">
                 <a href="scsi-36812.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

