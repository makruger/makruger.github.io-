<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Recovering From State Database Replica Failures - Solaris Volume Manager Administration Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2006-06-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo"></div>
   <div class="Title">Solaris Volume Manager Administration Guide</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="troubleshoottasks-29.html">Previous</a>
             </td>
             <td align="right">
                 <a href="tasks-softpart-26.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="roadmap-10.html">1.&nbsp;&nbsp;Getting Started With Solaris Volume Manager</a></p>
<p class="toc level1 tocsp"><a href="storage-overview-1.html">2.&nbsp;&nbsp;Storage Management Concepts</a></p>
<p class="toc level1 tocsp"><a href="basics-23185.html">3.&nbsp;&nbsp;Solaris Volume Manager Overview</a></p>
<p class="toc level1 tocsp"><a href="eoqra.html">4.&nbsp;&nbsp;Solaris Volume Manager for Sun Cluster (Overview)</a></p>
<p class="toc level1 tocsp"><a href="svm-scenario-1.html">5.&nbsp;&nbsp;Configuring and Using Solaris Volume Manager (Scenario)</a></p>
<p class="toc level1 tocsp"><a href="about-state-db-replicas-1.html">6.&nbsp;&nbsp;State Database (Overview)</a></p>
<p class="toc level1 tocsp"><a href="tasks-state-db-replicas-1.html">7.&nbsp;&nbsp;State Database (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="about-metadevices-22802.html">8.&nbsp;&nbsp;RAID-0 (Stripe and Concatenation) Volumes (Overview)</a></p>
<p class="toc level1 tocsp"><a href="tasks-metadevices-1.html">9.&nbsp;&nbsp;RAID-0 (Stripe and Concatenation) Volumes (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="about-mirrors-2.html">10.&nbsp;&nbsp;RAID-1 (Mirror) Volumes (Overview)</a></p>
<p class="toc level1 tocsp"><a href="tasks-mirrors-1.html">11.&nbsp;&nbsp;RAID-1 (Mirror) Volumes (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="about-softpart-1.html">12.&nbsp;&nbsp;Soft Partitions (Overview)</a></p>
<p class="toc level1 tocsp"><a href="tasks-softpart-1.html">13.&nbsp;&nbsp;Soft Partitions (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="about-raid5-1.html">14.&nbsp;&nbsp;RAID-5 Volumes (Overview)</a></p>
<p class="toc level1 tocsp"><a href="tasks-raid5-1.html">15.&nbsp;&nbsp;RAID-5 Volumes (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="about-hotspares-40444.html">16.&nbsp;&nbsp;Hot Spare Pools (Overview)</a></p>
<p class="toc level1 tocsp"><a href="tasks-hotspares-1.html">17.&nbsp;&nbsp;Hot Spare Pools (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="about-disksets-31856.html">18.&nbsp;&nbsp;Disk Sets (Overview)</a></p>
<p class="toc level1 tocsp"><a href="tasks-disksets-1.html">19.&nbsp;&nbsp;Disk Sets (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="tasks-basics-2.html">20.&nbsp;&nbsp;Maintaining Solaris Volume Manager (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="best-practices-1.html">21.&nbsp;&nbsp;Best Practices for Solaris Volume Manager</a></p>
<p class="toc level1 tocsp"><a href="topdown-overview.html">22.&nbsp;&nbsp;Top-Down Volume Creation (Overview)</a></p>
<p class="toc level1 tocsp"><a href="topdown-tasks-chap.html">23.&nbsp;&nbsp;Top-Down Volume Creation (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="tasks-snmp-1.html">24.&nbsp;&nbsp;Monitoring and Error Reporting (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="troubleshoottasks-33506.html">25.&nbsp;&nbsp;Troubleshooting Solaris Volume Manager (Tasks)</a></p>
<p class="toc level2"><a href="troubleshoottasks-83.html">Troubleshooting Solaris Volume Manager (Task Map)</a></p>
<p class="toc level2"><a href="troubleshoottasks-1.html">Overview of Troubleshooting the System</a></p>
<p class="toc level2"><a href="troubleshoottasks-95.html">Replacing Disks</a></p>
<p class="toc level3"><a href="troubleshoottasks-95.html#troubleshoottasks-96">How to Replace a Failed Disk</a></p>
<p class="toc level2 tocsp"><a href="tasks-basics-7.html">Recovering From Disk Movement Problems</a></p>
<p class="toc level2"><a href="extkh.html">Device ID Discrepancies After Upgrading to the Solaris 10 Release</a></p>
<p class="toc level2"><a href="troubleshoottasks-29.html">Recovering From Boot Problems</a></p>
<p class="toc level3"><a href="troubleshoottasks-29.html#troubleshoottasks-82">Recovering the root (<tt>/</tt>) RAID-1 (Mirror) Volume</a></p>
<p class="toc level3"><a href="troubleshoottasks-29.html#troubleshoottasks-21051">How to Recover From a Boot Device Failure</a></p>
<div class="onpage">
<p class="toc level2 tocsp"><a href="">Recovering From State Database Replica Failures</a></p>
<p class="toc level3"><a href="#troubleshoottasks-31036">How to Recover From Insufficient State Database Replicas</a></p>
</div>
<p class="toc level2 tocsp"><a href="tasks-softpart-26.html">Recovering From Soft Partition Problems</a></p>
<p class="toc level3"><a href="tasks-softpart-26.html#tasks-softpart-27">How to Recover Configuration Data for a Soft Partition</a></p>
<p class="toc level2 tocsp"><a href="troubleshoottasks-84.html">Recovering Storage From a Different System</a></p>
<p class="toc level3"><a href="troubleshoottasks-84.html#eqqcz">How to Recover Storage From a Local Disk Set</a></p>
<p class="toc level2 tocsp"><a href="egcpz.html">Recovering From Disk Set Problems</a></p>
<p class="toc level2"><a href="exlvv.html">Performing Mounted Filesystem Backups Using the <tt>ufsdump</tt> Command</a></p>
<p class="toc level3"><a href="exlvv.html#exlvw">How to Perform a Backup of a Mounted Filesystem Located on a RAID-1 Volume</a></p>
<p class="toc level2 tocsp"><a href="fsujr.html">Performing System Recovery</a></p>
<p class="toc level3"><a href="fsujr.html#fsujq">How to Recover a System Using a Solaris Volume Manager Configuration</a></p>
<p class="toc level1 tocsp"><a href="appendfiles-1.html">A.&nbsp;&nbsp;Important Solaris Volume Manager Files</a></p>
<p class="toc level1 tocsp"><a href="quick-reference-1.html">B.&nbsp;&nbsp;Solaris Volume Manager Quick Reference</a></p>
<p class="toc level1 tocsp"><a href="append-cim-wbem-1.html">C.&nbsp;&nbsp;Solaris Volume Manager CIM/WBEM API</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="tasks-state-db-replicas-11"></a><h3>Recovering From State Database Replica Failures</h3>
<p>If the state database replica quorum is not met, for example, due
to a drive failure, the system cannot be rebooted into multiuser mode. This
situation could follow a panic when Solaris Volume Manager discovers that fewer than
half of the state database replicas are available. This situation could also occur if
the system is rebooted with exactly half or fewer functional state database replicas.
In Solaris Volume Manager terminology, the state database has gone &ldquo;stale.&rdquo; This procedure
explains how to recover from this problem.</p>

<a name="troubleshoottasks-31036"></a><h4>How to Recover From Insufficient State Database Replicas</h4><ol>
<li><a name="troubleshoottasks-step-40"></a><b>Boot the system.</b></li>
<li><a name="tasks-state-db-replicas-step-23"></a><b>Determine which state database replicas are unavailable.</b><pre># <tt><b>metadb -i</b></tt></pre></li>
<li><a name="troubleshoottasks-step-42"></a><b>If one or more disks are known to be unavailable, delete the state
database replicas on those disks. Otherwise, delete enough erred state database replicas (W,
M, D, F, or R status flags reported by <tt>metadb</tt>) to ensure that
a majority of the existing state database replicas are not erred.</b><pre># <tt><b>metadb -d </tt><i>disk-slice</i><tt></b></tt></pre>
<hr><p><b>Tip - </b>State database replicas with a capitalized status flag are in error. State database
replicas with a lowercase status flag are functioning normally.</p>
<hr>
</li>
<li><a name="troubleshoottasks-step-43"></a><b>Verify that the replicas have been deleted.</b><pre># <tt><b>metadb</b></tt></pre></li>
<li><a name="troubleshoottasks-step-44"></a><b>Reboot the system.</b><pre># <tt><b>reboot</b></tt></pre></li>
<li><a name="troubleshoottasks-step-45"></a><b>If necessary, replace the disk, format it appropriately, then add any state database
replicas that are needed to the disk.</b><p>Follow the instructions in <a href="tasks-state-db-replicas-9.html">Creating State Database Replicas</a>.</p><p><a name="troubleshoottasks-ix449"></a><a name="troubleshoottasks-ix450"></a>Once you have a replacement disk, halt the system, replace the failed disk,
and once again, reboot the system. Use the <tt>format</tt> command or the <tt>fmthard</tt>
command to partition the disk as it was configured before the failure. 
</p></li></ol><a name="egjyh"></a>Example&nbsp;25-1 Recovering From Stale State Database Replicas<p>In the following example, a disk that contains seven replicas has gone bad.
As a result, the system has only three good replicas. The system
panics, then cannot reboot into multiuser mode.</p><pre>panic[cpu0]/thread=70a41e00: md: state database problem

403238a8 md:mddb_commitrec_wrapper+6c (2, 1, 70a66ca0, 40323964, 70a66ca0, 3c)
  %l0-7: 0000000a 00000000 00000001 70bbcce0 70bbcd04 70995400 00000002 00000000
40323908 md:alloc_entry+c4 (70b00844, 1, 9, 0, 403239e4, ff00)
  %l0-7: 70b796a4 00000001 00000000 705064cc 70a66ca0 00000002 00000024 00000000
40323968 md:md_setdevname+2d4 (7003b988, 6, 0, 63, 70a71618, 10)
  %l0-7: 70a71620 00000000 705064cc 70b00844 00000010 00000000 00000000 00000000
403239f8 md:setnm_ioctl+134 (7003b968, 100003, 64, 0, 0, ffbffc00)
  %l0-7: 7003b988 00000000 70a71618 00000000 00000000 000225f0 00000000 00000000
40323a58 md:md_base_ioctl+9b4 (157ffff, 5605, ffbffa3c, 100003, 40323ba8, ff1b5470)
  %l0-7: ff3f2208 ff3f2138 ff3f26a0 00000000 00000000 00000064 ff1396e9 00000000
40323ad0 md:md_admin_ioctl+24 (157ffff, 5605, ffbffa3c, 100003, 40323ba8, 0)
  %l0-7: 00005605 ffbffa3c 00100003 0157ffff 0aa64245 00000000 7efefeff 81010100
40323b48 md:mdioctl+e4 (157ffff, 5605, ffbffa3c, 100003, 7016db60, 40323c7c)
  %l0-7: 0157ffff 00005605 ffbffa3c 00100003 0003ffff 70995598 70995570 0147c800
40323bb0 genunix:ioctl+1dc (3, 5605, ffbffa3c, fffffff8, ffffffe0, ffbffa65)
  %l0-7: 0114c57c 70937428 ff3f26a0 00000000 00000001 ff3b10d4 0aa64245 00000000

panic: 
stopped at      edd000d8:       ta      %icc,%g0 + 125
Type  'go' to resume

ok<tt><b> boot -s</b></tt>
Resetting ... 

Sun Ultra 5/10 UPA/PCI (UltraSPARC-IIi 270MHz), No Keyboard
OpenBoot 3.11, 128 MB memory installed, Serial #9841776.
Ethernet address 8:0:20:96:2c:70, Host ID: 80962c70.



Rebooting with command: boot -s                                       
Boot device: /pci@1f,0/pci@1,1/ide@3/disk@0,0:a  File and args: -s
SunOS Release 5.9 Version s81_39 64-bit

Copyright 1983-2001 Sun Microsystems, Inc.  All rights reserved.
configuring IPv4 interfaces: hme0.
Hostname: dodo

metainit: dodo: stale databases

Insufficient metadevice database replicas located.

Use metadb to delete databases which are broken.
Ignore any "Read-only file system" error messages.
Reboot the system when finished to reload the metadevice database.
After reboot, repair any broken database replicas which were deleted.

Type control-d to proceed with normal startup,
(or give root password for system maintenance): <tt><b></tt><i>root-password</i><tt></b></tt>
single-user privilege assigned to /dev/console.
Entering System Maintenance Mode

Jun  7 08:57:25 su: 'su root' succeeded for root on /dev/console
Sun Microsystems Inc.   SunOS 5.9       s81_39  May 2002
# <tt><b>metadb -i</b></tt>
        flags           first blk       block count
     a m  p  lu         16              8192            /dev/dsk/c0t0d0s7
     a    p  l          8208            8192            /dev/dsk/c0t0d0s7
     a    p  l          16400           8192            /dev/dsk/c0t0d0s7
    M     p             16              unknown         /dev/dsk/c1t1d0s0
    M     p             8208            unknown         /dev/dsk/c1t1d0s0
    M     p             16400           unknown         /dev/dsk/c1t1d0s0
    M     p             24592           unknown         /dev/dsk/c1t1d0s0
    M     p             32784           unknown         /dev/dsk/c1t1d0s0
    M     p             40976           unknown         /dev/dsk/c1t1d0s0
    M     p             49168           unknown         /dev/dsk/c1t1d0s0
# <tt><b>metadb -d c1t1d0s0</b></tt>
# <tt><b>metadb</b></tt>
        flags           first blk       block count
     a m  p  lu         16              8192            /dev/dsk/c0t0d0s7
     a    p  l          8208            8192            /dev/dsk/c0t0d0s7
     a    p  l          16400           8192            /dev/dsk/c0t0d0s7
#  </pre><p>The system panicked because it could no longer detect state database replicas on
slice <tt>/dev/dsk/c1t1d0s0</tt>. This slice is part of the failed disk or is attached
to a failed controller. The first <tt>metadb <tt>-i</tt></tt> command identifies the replicas on
this slice as having a problem with the master blocks.</p><p>When you delete the stale state database replicas, the root (<tt>/</tt>) file system
is read-only. You can ignore the <tt>mddb.cf</tt> error messages that are displayed.</p><p>At this point, the system is again functional, although it probably has fewer
state database replicas than it should. Any volumes that used part of the
failed storage are also either failed, erred, or hot-spared. Those issues should be
addressed promptly. </p>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="troubleshoottasks-29.html">Previous</a>
             </td>
             <td align="right">
                 <a href="tasks-softpart-26.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

