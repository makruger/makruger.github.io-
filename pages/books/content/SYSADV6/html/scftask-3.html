<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Protecting Files With the Solaris Cryptographic Framework - System Administration Guide: Security Services</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-08-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">System Administration Guide: Security Services</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="scftask-24.html">Previous</a>
             </td>
             <td align="right">
                 <a href="scftask-28.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="oview-1.html">Part&nbsp;I&nbsp;Security Overview</a></p>
<p class="toc level2"><a href="secov-1.html">1.&nbsp;&nbsp;Security Services (Overview)</a></p>
<p class="toc level1 tocsp"><a href="sectm-1.html">Part&nbsp;II&nbsp;System, File, and Device Security</a></p>
<p class="toc level2"><a href="concept-1.html">2.&nbsp;&nbsp;Managing Machine Security (Overview)</a></p>
<p class="toc level2"><a href="secsys-1.html">3.&nbsp;&nbsp;Controlling Access to Systems (Tasks)</a></p>
<p class="toc level2"><a href="vscan-1.html">4.&nbsp;&nbsp;Virus Scanning Service (Tasks)</a></p>
<p class="toc level2"><a href="devtask-1.html">5.&nbsp;&nbsp;Controlling Access to Devices (Tasks)</a></p>
<p class="toc level2"><a href="bart-1.html">6.&nbsp;&nbsp;Using the Basic Audit Reporting Tool (Tasks)</a></p>
<p class="toc level2"><a href="secfile-1.html">7.&nbsp;&nbsp;Controlling Access to Files (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="prbactm-1.html">Part&nbsp;III&nbsp;Roles, Rights Profiles, and Privileges</a></p>
<p class="toc level2"><a href="prbac-1.html">8.&nbsp;&nbsp;Using Roles and Privileges (Overview)</a></p>
<p class="toc level2"><a href="rbactask-1.html">9.&nbsp;&nbsp;Using Role-Based Access Control (Tasks)</a></p>
<p class="toc level2"><a href="rbacref-1.html">10.&nbsp;&nbsp;Role-Based Access Control (Reference)</a></p>
<p class="toc level2"><a href="privtask-1.html">11.&nbsp;&nbsp;Privileges (Tasks)</a></p>
<p class="toc level2"><a href="privref-1.html">12.&nbsp;&nbsp;Privileges (Reference)</a></p>
<p class="toc level1 tocsp"><a href="scftm-1.html">Part&nbsp;IV&nbsp;Solaris Cryptographic Services</a></p>
<p class="toc level2"><a href="scf-1.html">13.&nbsp;&nbsp;Solaris Cryptographic Framework (Overview)</a></p>
<p class="toc level2"><a href="scftask-1.html">14.&nbsp;&nbsp;Solaris Cryptographic Framework (Tasks)</a></p>
<p class="toc level3"><a href="scftask-2.html">Using the Cryptographic Framework (Task Map)</a></p>
<p class="toc level3"><a href="scftask-24.html">Protecting Files With the Solaris Cryptographic Framework (Task Map)</a></p>
<div class="onpage">
<p class="toc level3"><a href="">Protecting Files With the Solaris Cryptographic Framework</a></p>
</div>
<p class="toc level3"><a href="scftask-28.html">Administering the Cryptographic Framework (Task Map)</a></p>
<p class="toc level3"><a href="scftask-8.html">Administering the Cryptographic Framework</a></p>
<p class="toc level2 tocsp"><a href="kmf-1.html">15.&nbsp;&nbsp;Solaris Key Management Framework</a></p>
<p class="toc level1 tocsp"><a href="authtm-1.html">Part&nbsp;V&nbsp;Authentication Services and Secure Communication</a></p>
<p class="toc level2"><a href="auth-1.html">16.&nbsp;&nbsp;Using Authentication Services (Tasks)</a></p>
<p class="toc level2"><a href="pam-1.html">17.&nbsp;&nbsp;Using PAM</a></p>
<p class="toc level2"><a href="sasl-1.html">18.&nbsp;&nbsp;Using SASL</a></p>
<p class="toc level2"><a href="sshuser-1.html">19.&nbsp;&nbsp;Using Solaris Secure Shell (Tasks)</a></p>
<p class="toc level2"><a href="sshref-1.html">20.&nbsp;&nbsp;Solaris Secure Shell (Reference)</a></p>
<p class="toc level1 tocsp"><a href="seamtm-1.html">Part&nbsp;VI&nbsp;Kerberos Service</a></p>
<p class="toc level2"><a href="intro-1.html">21.&nbsp;&nbsp;Introduction to the Kerberos Service</a></p>
<p class="toc level2"><a href="seamplan-1.html">22.&nbsp;&nbsp;Planning for the Kerberos Service</a></p>
<p class="toc level2"><a href="setup-8.html">23.&nbsp;&nbsp;Configuring the Kerberos Service (Tasks)</a></p>
<p class="toc level2"><a href="trouble-1.html">24.&nbsp;&nbsp;Kerberos Error Messages and Troubleshooting</a></p>
<p class="toc level2"><a href="aadmin-1.html">25.&nbsp;&nbsp;Administering Kerberos Principals and Policies (Tasks)</a></p>
<p class="toc level2"><a href="user-7.html">26.&nbsp;&nbsp;Using Kerberos Applications (Tasks)</a></p>
<p class="toc level2"><a href="refer-1.html">27.&nbsp;&nbsp;The Kerberos Service (Reference)</a></p>
<p class="toc level1 tocsp"><a href="audittm-1.html">Part&nbsp;VII&nbsp;Solaris Auditing</a></p>
<p class="toc level2"><a href="auditov-1.html">28.&nbsp;&nbsp;Solaris Auditing (Overview)</a></p>
<p class="toc level2"><a href="auditplan-1.html">29.&nbsp;&nbsp;Planning for Solaris Auditing</a></p>
<p class="toc level2"><a href="audittask-1.html">30.&nbsp;&nbsp;Managing Solaris Auditing (Tasks)</a></p>
<p class="toc level2"><a href="auditref-1.html">31.&nbsp;&nbsp;Solaris Auditing (Reference)</a></p>
<p class="toc level1 tocsp"><a href="glossary-2.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="scftask-3"></a><h3>Protecting Files With the Solaris Cryptographic Framework</h3>
<p>This section describes how to generate symmetric keys, how to create checksums for
file integrity, and how to protect files from eavesdropping. The commands in this
section can be run by regular users. Developers can write scripts that use
these commands.</p>

<a name="scftask-10"></a><h4>How to Generate a Symmetric Key by Using the <tt>dd</tt> Command</h4><a name="indexterm-1575"></a><a name="indexterm-1576"></a><a name="indexterm-1577"></a><a name="indexterm-1578"></a><a name="indexterm-1579"></a><a name="indexterm-1580"></a><a name="indexterm-1581"></a><a name="indexterm-1582"></a><a name="indexterm-1583"></a><a name="indexterm-1584"></a><a name="indexterm-1585"></a><a name="indexterm-1586"></a><a name="indexterm-1587"></a><a name="indexterm-1588"></a><p>A key is needed to encrypt files and to generate the MAC
of a file. The key should be derived from a random pool of
numbers. To create the key, you have three options:</p>
<ul><li><p>If your site has a random number generator, use the generator.</p></li>
<li><p>If you want to generate the key and store it, see <a href="#kmf-20">How to Generate a Symmetric Key by Using the <tt>pktool</tt> Command</a>.</p></li>
<li><p>Otherwise, use this procedure. This procedure requires that you provide the key size in bites. In contrast, the <tt>pktool</tt> command determines the correct key size according to the algorithm that you specify.</p></li></ul>
<ol>
<li><b>Determine the key length that your algorithm requires.</b><ol style="list-style-type: lower-alpha">
				 
<li><b><a name="indexterm-1589"></a><a name="indexterm-1590"></a>List the available algorithms.</b><pre>% encrypt -l
Algorithm       Keysize:  Min   Max (bits)
------------------------------------------
aes                       128   128
arcfour                     8   128
des                        64    64
3des                      192   192

% mac -l
Algorithm       Keysize:  Min   Max (bits)
------------------------------------------
des_mac                    64    64
sha1_hmac                   8   512
md5_hmac                    8   512</pre></li>
<li><b>Determine the key length in bytes to pass to the <tt>dd</tt> command.</b><p>Divide the minimum and maximum key sizes by 8. When the minimum and
maximum key sizes are different, intermediate key sizes are possible. For example, the
value 8, 16, or 64 can be passed to the <tt>dd</tt> command for
the <tt>sha1_hmac</tt> and <tt>md5_hmac</tt> functions.</p></li></ol></li>
<li><b>Generate the symmetric key.</b><pre>% dd if=/dev/urandom of=<i>keyfile</i> bs=<i>n</i> count=<i>n</i></pre><dl><dt><tt>if=</tt><i>file</i></dt>
<dd><p>Is the input file. For a random key, use the <tt>/dev/urandom</tt> file.</p></dd>
<dt><tt>of=</tt><i>keyfile</i></dt>
<dd><p>Is the output file that holds the generated key.</p></dd>
<dt><tt>bs=</tt><i>n</i></dt>
<dd><p>Is the key size in bytes. For the length in bytes, divide the key length in bits by 8.</p></dd>
<dt><tt>count=</tt><i>n</i></dt>
<dd><p>Is the count of the input blocks. The number for <i>n</i> should be <tt>1</tt>.</p></dd>
</dl>
</li>
<li><b>Store your key in a protected directory.</b><p>The key file should not be readable by anyone but the user.</p><pre>% chmod 400 <i>keyfile</i></pre></li></ol><a name="scftask-18"></a><h6>Example&nbsp;14-1 Creating a Key for the AES Algorithm</h6><p>In the following example, a secret key for the AES algorithm is
created. The key is also stored for later decryption. AES mechanisms use a
128-bit key. The key is expressed as 16 bytes in the <tt>dd</tt> command.</p><pre>% <tt><b>ls -al ~/keyf</b></tt>
drwx------   2 jdoe  staff        512 May 3 11:32 ./
% <tt><b>dd if=/dev/urandom of=$HOME/keyf/05.07.aes16 bs=16 count=1</b></tt>
% <tt><b>chmod 400 ~/keyf/05.07.aes16</b></tt></pre><a name="scftask-32"></a><h6>Example&nbsp;14-2 Creating a Key for the DES Algorithm</h6><p>In the following example, a secret key for the DES algorithm is
created. The key is also stored for later decryption. DES mechanisms use a
64-bit key. The key is expressed as 8 bytes in the <tt>dd</tt> command.</p><pre>% <tt><b>dd if=/dev/urandom of=$HOME/keyf/05.07.des8 bs=8 count=1</b></tt>
% <tt><b>chmod 400 ~/keyf/05.07.des8</b></tt></pre><a name="scftask-33"></a><h6>Example&nbsp;14-3 Creating a Key for the 3DES Algorithm</h6><p>In the following example, a secret key for the 3DES algorithm is
created. The key is also stored for later decryption. 3DES mechanisms use a
192-bit key. The key is expressed as 24 bytes in the <tt>dd</tt> command.</p><pre>% <tt><b>dd if=/dev/urandom of=$HOME/keyf/05.07.3des.24 bs=24 count=1</b></tt>
% <tt><b>chmod 400 ~/keyf/05.07.3des.24</b></tt></pre><a name="scftask-14"></a><h6>Example&nbsp;14-4 Creating a Key for the MD5 Algorithm</h6><p>In the following example, a secret key for the MD5 algorithm is
created. The key is also stored for later decryption.  The key is
expressed as 64 bytes in the <tt>dd</tt> command.</p><pre>% <tt><b>dd if=/dev/urandom of=$HOME/keyf/05.07.mack64 bs=64 count=1</b></tt>
% <tt><b>chmod 400 ~/keyf/05.07.mack64</b></tt></pre>

<a name="kmf-20"></a><h4>How to Generate a Symmetric Key by Using the <tt>pktool</tt> Command</h4><a name="indexterm-1591"></a><a name="indexterm-1592"></a><a name="indexterm-1593"></a><a name="indexterm-1594"></a><a name="indexterm-1595"></a><a name="indexterm-1596"></a><a name="indexterm-1597"></a><a name="indexterm-1598"></a><a name="indexterm-1599"></a><a name="indexterm-1600"></a><a name="indexterm-1601"></a><a name="indexterm-1602"></a><a name="indexterm-1603"></a><p>Some applications require a symmetric key for encryption and decryption of communications. In
this procedure, you create a symmetric key and store it.</p>
<ul><li><p>If your site has a random number generator, you can use the generator to create a random number for the key. This procedure does not use your site's random number generator.</p></li>
<li><p>You can instead use the <tt>dd</tt> command with the Solaris <tt>/dev/urandom</tt> device as input. The <tt>dd</tt> command does not store the key. For the procedure, see <a href="#scftask-10">How to Generate a Symmetric Key by Using the <tt>dd</tt> Command</a>.</p></li></ul>
<ol>
<li><a name="scftask-keystore-1"></a>(Optional) <b>If you plan to use a keystore, create it.</b><ul>
<li><b>To create and initialize a PKCS #11 keystore, see <a href="kmf-6.html#kmf-9">How to Generate a Passphrase by Using the <tt>pktool&nbsp;setpin</tt> Command</a>.</b></li>
<li><b>To create and initialize an NSS database, see <a href="kmf-6.html#kmf-11">Example&nbsp;15-5</a>.</b></li></ul></li>
<li><b>Generate a random number for use as a symmetric key.</b><p>Use one of the following methods.</p><ul>
<li><b>Generate a key and store it in a file.</b><p>The advantage of a file-stored key is that you can extract the key
from this file for use in an application's key file, such as the
<tt>/etc/inet/secret/ipseckeys</tt> file or IPsec.</p><pre>% pktool genkey keystore=file outkey=<i>key-fn</i> \ 
[keytype=generic|<i>specific-symmetric-algorithm</i>] [keylen=<i>size-in-bits</i>] \
[dir=<i>directory</i>] [print=n]</pre><dl><dt><tt>keystore</tt></dt>
<dd><p>The value <tt>file</tt> specifies the file type of storage location for the key.</p></dd>
<dt><tt>outkey=</tt><i>key-fn</i></dt>
<dd><p>Is the filename when <tt>keystore=file</tt>.</p></dd>
<dt><tt>keytype=</tt><i>specific-symmetric-algorithm</i></dt>
<dd><p>For a symmetric key of any length, the value is <tt>generic</tt>. For a particular algorithm, specify <tt>aes</tt>, <tt>arcfour</tt>, <tt>des</tt>, or <tt>3des</tt>.</p></dd>
<dt><tt>keylen=</tt><i>size-in-bits</i></dt>
<dd><p>Is the length of the key in bits. The number must be divisible by 8. Do <b>not</b> specify for <tt>des</tt> or <tt>3des</tt>.</p></dd>
<dt><tt>dir=</tt><i>directory</i></dt>
<dd><p>Is the directory path to <i>key-fn</i>. By default, <i>directory</i> is the current directory.</p></dd>
<dt><tt>print=n</tt></dt>
<dd><p>Prints the key to the terminal window. By default, the value of <tt>print</tt> is <tt>n</tt>.</p></dd>
</dl>
</li>
<li><b>Generate a key and store it in a PKCS #11 keystore.</b><p>The advantage of the PKCS #11 keystore is that you can retrieve the
key by its label. This method is useful for keys that encrypt and
decrypt files. You must complete <a href="#scftask-keystore-1">Step&nbsp;1</a> before using this method.</p><pre>% pktool genkey label=<i>key-label</i> \ 
[keytype=generic|<i>specific-symmetric-algorithm</i>] [keylen=<i>size-in-bits</i>] [token=<i>token</i>] \
[sensitive=n] [extractable=y] [print=n]</pre><dl><dt><tt>label=</tt><i>key-label</i></dt>
<dd><p>Is a user-specified label for the key. The key can be retrieved from the keystore by its label.</p></dd>
<dt><tt>keytype=</tt><i>specific-symmetric-algorithm</i></dt>
<dd><p>For a symmetric key of any length, the value is <tt>generic</tt>. For a particular algorithm, specify <tt>aes</tt>, <tt>arcfour</tt>, <tt>des</tt>, or <tt>3des</tt>.</p></dd>
<dt><tt>keylen=</tt><i>size-in-bits</i></dt>
<dd><p>Is the length of the key in bits. The number must be divisible by 8. Do <b>not</b> specify for <tt>des</tt> or <tt>3des</tt>.</p></dd>
<dt><tt>token=</tt><i>token</i></dt>
<dd><p>Is the token name. By default, the token is <tt>Sun Software PKCS#11 softtoken</tt>.</p></dd>
<dt><tt>sensitive=n</tt></dt>
<dd><p>Specifies the sensitivity of the key. When the value is <tt>y</tt>, the key cannot be printed by using the <tt>print=y</tt> argument. By default, the value of <tt>sensitive</tt> is <tt>n</tt>.</p></dd>
<dt><tt>extractable=y</tt></dt>
<dd><p>Specifies that the key can be extracted from the keystore. Specify <tt>n</tt> to prevent the key from being extracted.</p></dd>
<dt><tt>print=n</tt></dt>
<dd><p>Prints the key to the terminal window. By default, the value of <tt>print</tt> is <tt>n</tt>.</p></dd>
</dl>
</li>
<li><b>Generate a key and store it in an NSS keystore.</b><p>You must complete <a href="#scftask-keystore-1">Step&nbsp;1</a> before using this method.</p><pre>% pktool keystore=nss genkey label=<i>key-label</i> \ 
[keytype=generic|<i>specific-symmetric-algorithm</i>] [keylen=<i>size-in-bits</i>] [token=<i>token</i>] \
[dir=<i>directory-path</i>] [prefix=<i>database-prefix</i>]</pre><dl><dt><tt>keystore</tt></dt>
<dd><p>The value <tt>nss</tt> specifies the NSS type of storage location for the key.</p></dd>
<dt><tt>label=</tt><i>key-label</i></dt>
<dd><p>Is a user-specified label for the key. The key can be retrieved from the keystore by its label.</p></dd>
<dt><tt>keytype=</tt><i>specific-symmetric-algorithm</i></dt>
<dd><p>For a symmetric key of any length, the value is <tt>generic</tt>. For a particular algorithm, specify <tt>aes</tt>, <tt>arcfour</tt>, <tt>des</tt>, or <tt>3des</tt>.</p></dd>
<dt><tt>keylen=</tt><i>size-in-bits</i></dt>
<dd><p>Is the length of the key in bits. The number must be divisible by 8. Do <b>not</b> specify for <tt>des</tt> or <tt>3des</tt>.</p></dd>
<dt><tt>token=</tt><i>token</i></dt>
<dd><p>Is the token name. By default, the token is the NSS internal token.</p></dd>
<dt><tt>dir=</tt><i>directory</i></dt>
<dd><p>Is the directory path to the NSS database. By default, <i>directory</i> is the current directory.</p></dd>
<dt><tt>prefix=</tt><i>directory</i></dt>
<dd><p>Is the prefix to the NSS database. The default is no prefix.</p></dd>
<dt><tt>print=n</tt></dt>
<dd><p>Prints the key to the terminal window. By default, the value of <tt>print</tt> is <tt>n</tt>.</p></dd>
</dl>
</li></ul></li>
<li>(Optional) <b>Verify that the key exists.</b><p>Use one of the following commands, depending on where you stored the key.</p><ul>
<li><b>Verify the key in the <i>key-fn</i> file.</b><pre>% pktool list keystore=file objtype=key infile=<i>key-fn</i>
Found <i>n</i> keys.
Key #1 - <i>keytype</i>:<i>location (keylen)</i></pre></li>
<li><b>Verify the key in the PKCS #11 or the NSS keystore.</b><pre>$ pktool list objtype=key
Enter PIN for <i>keystore</i>:
Found <i>n</i> keys.
Key #1 - <i>keytype</i>:<i>location (keylen)</i></pre></li></ul></li></ol><a name="kmf-21"></a><h6>Example&nbsp;14-5 Creating a Symmetric Key by Using the <tt>pktool</tt> Command</h6><p>In the following example, a user creates a PKCS #11 keystore for
the first time, and then generates a large symmetric key for an application.
Finally, the user verifies that the key is in the keystore.</p><pre># <tt><b>pktool setpin</b></tt>
Create new passphrase:easily-remembered-hard-to-detect-password
Re-enter new passphrase:Retype password
Passphrase changed.
% <tt><b>pktool genkey label=specialappkey keytype=generic keylen=1024</b></tt>
Enter PIN for Sun Software PKCS#11 softtoken  :Type password

% <tt><b>pktool list objtype=key</b></tt>
Enter PIN for Sun Software PKCS#11 softtoken  :Type password

Found 1 keys.
Key #1 - symmetric:  specialappkey (1024 bits)</pre><a name="scftask-53"></a><h6>Example&nbsp;14-6 Creating a DES Key by Using the <tt>pktool</tt> Command</h6><p>In the following example, a secret key for the DES algorithm is
created. The key is stored in a local file for later decryption. The
command protects the file with <tt>400</tt> permissions. When the key is created, the <tt>print=y</tt>
option displays the generated key in the terminal window.</p><p>DES mechanisms use a 64-bit key. The user who owns the keyfile
retrieves the key by using the <tt>od</tt> command.</p><pre>% <tt><b>pktool genkey keystore=file outkey=64bit.file1 keytype=des print=y</b></tt>
        Key Value ="a3237b2c0a8ff9b3"
% <tt><b>od -x 64bit.file1</b></tt>
0000000 a323 7b2c 0a8f f9b3</pre><a name="scftask-55"></a><h6>Example&nbsp;14-7 Creating a Symmetric Key for IPsec Security Associations</h6><p>In the following example, the administrator manually creates the keying material for IPsec
SAs and stores them in files. Then, the administrator copies the keys to
the <tt>/etc/inet/secret/ipseckeys</tt> file and destroys the original files.</p>
<ul><li><p>First, the administrator creates and displays the keys that the IPsec policy requires:</p><pre># <tt><b>pktool genkey keystore=file outkey=ipencrin1 keytype=generic keylen=192 print=y</b></tt>
        Key Value ="294979e512cb8e79370dabecadc3fcbb849e78d2d6bd2049"
# <tt><b>pktool genkey keystore=file outkey=ipencrout1 keytype=generic keylen=192 print=y</b></tt>
        Key Value ="9678f80e33406c86e3d1686e50406bd0434819c20d09d204"
# <tt><b>pktool genkey keystore=file outkey=ipspi1 keytype=generic keylen=32 print=y</b></tt>
        Key Value ="acbeaa20"
# <tt><b>pktool genkey keystore=file outkey=ipspi2 keytype=generic keylen=32 print=y</b></tt>
        Key Value ="19174215"
# <tt><b>pktool genkey keystore=file outkey=ipmd51 keytype=generic keylen=64 print=y</b></tt>
        Key Value ="438c3ad2cec9a3621e90462d11ca7d2f"
# <tt><b>pktool genkey keystore=file outkey=ipmd52 keytype=generic keylen=64 print=y</b></tt>
        Key Value ="a61319630cf2abde7609ce24de3d029f"</pre></li>
<li><p>Then, the administrator creates the following <tt>/etc/inet/secret/ipseckeys</tt> file:</p><pre>##   SPI values require a leading 0x.
##   Backslashes indicate command continuation.
##
## for outbound packets on this system
add esp spi 0xacbeaa20 \
   src 192.168.1.1 dst 192.168.2.1 \
   encr_alg 3des auth_alg md5  \
   encrkey  294979e512cb8e79370dabecadc3fcbb849e78d2d6bd2049 \
   authkey  438c3ad2cec9a3621e90462d11ca7d2f
##
## for inbound packets
add esp spi 0x19174215 \
   src 192.168.2.1 dst 192.168.1.1 \
   encr_alg 3des auth_alg md5  \
   encrkey 9678f80e33406c86e3d1686e50406bd0434819c20d09d204 \
   authkey a61319630cf2abde7609ce24de3d029f</pre></li>
<li><p>After verifying that the syntax of the <tt>ipseckeys</tt> file is valid, the administrator destroys the original key files.</p><pre># <tt><b>ipseckey -c /etc/inet/secret/ipseckeys</b></tt>
# <tt><b>rm ipencrin1 ipencrout1 ipspi1 ipspi2 ipmd51 ipmd52</b></tt></pre></li>
<li><p>The administrator copies the <tt>ipseckeys</tt> file to the communicating system by using the <tt>ssh</tt> command or another secure mechanism. On the communicating system, the protections are reversed. The first entry in the <tt>ipseckeys</tt> file protects inbound packets, and the second entry protects outbound packets. No keys are generated on the communicating system.</p></li></ul>


<a name="scftask-22"></a><h4>How to Compute a Digest of a File</h4><a name="indexterm-1604"></a><a name="indexterm-1605"></a><a name="indexterm-1606"></a><a name="indexterm-1607"></a><a name="indexterm-1608"></a><a name="indexterm-1609"></a><a name="indexterm-1610"></a><a name="indexterm-1611"></a><a name="indexterm-1612"></a><a name="indexterm-1613"></a><a name="indexterm-1614"></a><a name="indexterm-1615"></a><a name="indexterm-1616"></a><p>When you compute a digest of a file, you can check to
see that the file has not been tampered with by comparing digest outputs.
A digest does not alter the original file.</p><ol>
<li><a name="scftask-digest-1"></a><b><a name="indexterm-1617"></a><a name="indexterm-1618"></a>List the available digest algorithms.</b><pre>% <tt><b>digest -l</b></tt>
sha1
md5
sha256
sha384
sha512</pre></li>
<li><b><a name="indexterm-1619"></a><a name="indexterm-1620"></a>Compute the digest of the file and save the digest listing.</b><p>Provide an algorithm with the <tt>digest</tt> command.</p><pre>% digest -v -a <i>algorithm input-file</i> &gt; <i>digest-listing</i></pre><dl><dt><tt>-v</tt></dt>
<dd><p>Displays the output in the following format:</p><pre><i>algorithm</i> (<i>input-file</i>) = <i>digest</i></pre></dd>
<dt><tt>-a</tt> <i>algorithm</i></dt>
<dd><p>Is the algorithm to use to compute a digest of the file. Type the algorithm as the algorithm appears in the output of <a href="#scftask-digest-1">Step&nbsp;1</a>.</p></dd>
<dt><i>input-file</i></dt>
<dd><p>Is the input file for the <tt>digest</tt> command.</p></dd>
<dt><i>digest-listing</i></dt>
<dd><p>Is the output file for the <tt>digest</tt> command.</p></dd>
</dl>
</li></ol><a name="scftask-34"></a><h6>Example&nbsp;14-8 Computing a Digest With the MD5 Mechanism</h6><p><a name="indexterm-1621"></a><a name="indexterm-1622"></a><a name="indexterm-1623"></a><a name="indexterm-1624"></a>In the following example, the <tt>digest</tt> command uses the MD5 mechanism to compute
a digest for an email attachment.</p><pre>% <tt><b>digest -v -a md5 email.attach &gt;&gt; $HOME/digest.emails.05.07</b></tt>
% <tt><b>cat ~/digest.emails.05.07</b></tt>
md5 (email.attach) = 85c0a53d1a5cc71ea34d9ee7b1b28b01</pre><p>When the <tt>-v</tt> option is not used, the digest is saved with no
accompanying information:</p><pre>% <tt><b>digest -a md5 email.attach &gt;&gt; $HOME/digest.emails.05.07</b></tt>
% <tt><b>cat ~/digest.emails.05.07</b></tt>
85c0a53d1a5cc71ea34d9ee7b1b28b01</pre><a name="scftask-35"></a><h6>Example&nbsp;14-9 Computing a Digest With the SHA1 Mechanism</h6><p>In the following example, the <tt>digest</tt> command uses the SHA1 mechanism to provide
a directory listing. The results are placed in a file.</p><pre>% <tt><b>digest -v -a sha1 docs/* &gt; $HOME/digest.docs.legal.05.07</b></tt>
% <tt><b>more ~/digest.docs.legal.05.07</b></tt>
sha1 (docs/legal1) = 1df50e8ad219e34f0b911e097b7b588e31f9b435
sha1 (docs/legal2) = 68efa5a636291bde8f33e046eb33508c94842c38
sha1 (docs/legal3) = 085d991238d61bd0cfa2946c183be8e32cccf6c9
sha1 (docs/legal4) = f3085eae7e2c8d008816564fdf28027d10e1d983</pre>

<a name="scftask-20"></a><h4>How to Compute a MAC of a File</h4><a name="indexterm-1625"></a><a name="indexterm-1626"></a><a name="indexterm-1627"></a><a name="indexterm-1628"></a><a name="indexterm-1629"></a><a name="indexterm-1630"></a><a name="indexterm-1631"></a><a name="indexterm-1632"></a><p>A message authentication code, or MAC, computes a digest for the file and
uses a secret key to further protect the digest. A MAC does
not alter the original file.</p><ol>
<li><b><a name="indexterm-1633"></a><a name="indexterm-1634"></a>List the available mechanisms.</b><pre>% <tt><b>mac -l</b></tt>
Algorithm       Keysize:  Min   Max (bits)
------------------------------------------
des_mac                    64    64
sha1_hmac                   8   512
md5_hmac                    8   512
sha256_hmac                 8   512
sha384_hmac                 8  1024
sha512_hmac                 8  1024</pre></li>
<li><a name="scftask-genkey-1"></a><b>Generate a symmetric key of the appropriate length.</b><p>You have two options. You can provide a <a href="glossary-2.html#glossary-101">passphrase</a> from which a
key will be generated. Or you can provide a key.</p>
<ul><li><p><a name="indexterm-1635"></a>If you provide a passphrase, you must store or remember the passphrase. If you store the passphrase online, the passphrase file should be readable only by you.</p></li>
<li><p>If you provide a key, it must be the correct size for the mechanism. For the procedure, see <a href="#scftask-10">How to Generate a Symmetric Key by Using the <tt>dd</tt> Command</a>. You can also use the <tt>pktool</tt> command. For the procedure and some examples, see <a href="#kmf-20">How to Generate a Symmetric Key by Using the <tt>pktool</tt> Command</a>.</p></li></ul>
</li>
<li><b><a name="indexterm-1636"></a><a name="indexterm-1637"></a><a name="indexterm-1638"></a>Create a MAC for a file.</b><p>Provide a key and use a symmetric key algorithm with the <tt>mac</tt> command.</p><pre>% mac [-v] -a <i>algorithm</i> [-k <i>keyfile</i> | -K <i>key-label</i> [-T <i>token</i>]] <i>input-file</i></pre><dl><dt><tt>-v</tt></dt>
<dd><p>Displays the output in the following format:</p><pre><i>algorithm</i> (<i>input-file</i>) = <i>mac</i></pre></dd>
<dt><tt>-a</tt> <i>algorithm</i></dt>
<dd><p>Is the algorithm to use to compute the MAC. Type the algorithm as the algorithm appears in the output of the <tt>mac -l</tt> command.</p></dd>
<dt><tt>-k</tt> <i>keyfile</i></dt>
<dd><p>Is the file that contains a key of algorithm-specified length.</p></dd>
<dt><tt>-K</tt> <i>key-label</i></dt>
<dd><p><a name="indexterm-1639"></a>Is the label of a key in the PKCS #11 keystore.</p></dd>
<dt><tt>-T</tt> <i>token</i></dt>
<dd><p><a name="indexterm-1640"></a>Is the token name. By default, the token is <tt>Sun Software PKCS#11 softtoken</tt>. Is used only when the <tt>-K</tt> <i>key-label</i> option is used.</p></dd>
<dt><i>input-file</i></dt>
<dd><p>Is the input file for the MAC.</p></dd>
</dl>
</li></ol><a name="scftask-36"></a><h6>Example&nbsp;14-10 Computing a MAC With DES_MAC and a Passphrase</h6><a name="indexterm-1641"></a><p>In the following example, the email attachment is authenticated with the DES_MAC mechanism
and a key that is derived from a passphrase. The MAC listing is
saved to a file. If the passphrase is stored in a file,
the file should not be readable by anyone but the user.</p><pre>% <tt><b>mac -v -a des_mac email.attach</b></tt>
Enter key: &lt;Type passphrase&gt;
des_mac (email.attach) = dd27870a
% <tt><b>echo "des_mac (email.attach) = dd27870a" &gt;&gt; ~/desmac.daily.05.07</b></tt></pre><a name="scftask-45"></a><h6>Example&nbsp;14-11 Computing a MAC With MD5_HMAC and a Key File</h6><a name="indexterm-1642"></a><a name="indexterm-1643"></a><p>In the following example, the email attachment is authenticated with the MD5_HMAC mechanism
and a secret key. The MAC listing is saved to a file.</p><pre>% <tt><b>mac -v -a md5_hmac -k $HOME/keyf/05.07.mack64 email.attach</b></tt>
md5_hmac (email.attach) = 02df6eb6c123ff25d78877eb1d55710c
% <tt><b>echo "md5_hmac (email.attach) = 02df6eb6c123ff25d78877eb1d55710c" \</b></tt>
<tt><b>&gt;&gt; ~/mac.daily.05.07</b></tt></pre><a name="scftask-37"></a><h6>Example&nbsp;14-12 Computing a MAC With SHA1_HMAC and a Key File</h6><p>In the following example, the directory manifest is authenticated with the SHA1_HMAC mechanism
and a secret key. The results are placed in a file.</p><pre>% <tt><b>mac -v -a sha1_hmac \</b></tt>
<tt><b>-k $HOME/keyf/05.07.mack64 docs/* &gt; $HOME/mac.docs.legal.05.07</b></tt>
% <tt><b>more ~/mac.docs.legal.05.07</b></tt>
sha1_hmac (docs/legal1) = 9b31536d3b3c0c6b25d653418db8e765e17fe07a
sha1_hmac (docs/legal2) = 865af61a3002f8a457462a428cdb1a88c1b51ff5
sha1_hmac (docs/legal3) = 076c944cb2528536c9aebd3b9fbe367e07b61dc7
sha1_hmac (docs/legal4) = 7aede27602ef6e4454748cbd3821e0152e45beb4</pre><a name="scftask-52"></a><h6>Example&nbsp;14-13 Computing a MAC With SHA1_HMAC and a Key Label</h6><p>In the following example, the directory manifest is authenticated with the SHA1_HMAC mechanism
and a secret key. The results are placed in the user's PKCS #11
keystore. The user initially created the keystore and the password to the keystore
by using the <tt>pktool setpin</tt> command.</p><pre>% <tt><b>mac -a sha1_hmac -K legaldocs0507 docs/*</b></tt>
Enter pin for Sun Software PKCS#11 softtoken:Type password</pre><p>To retrieve the MAC from the keystore, the user uses the verbose
option, and provides the key label and the name of the directory that
was authenticated.</p><pre>% <tt><b>mac -v -a sha1_hmac -K legaldocs0507 docs/*</b></tt>
Enter pin for Sun Software PKCS#11 softtoken:Type password
sha1_hmac (docs/legal1) = 9b31536d3b3c0c6b25d653418db8e765e17fe07a
sha1_hmac (docs/legal2) = 865af61a3002f8a457462a428cdb1a88c1b51ff5
sha1_hmac (docs/legal3) = 076c944cb2528536c9aebd3b9fbe367e07b61dc7
sha1_hmac (docs/legal4) = 7aede27602ef6e4454748cbd3821e0152e45beb4</pre>

<a name="scftask-4"></a><h4>How to Encrypt and Decrypt a File</h4><a name="indexterm-1644"></a><a name="indexterm-1645"></a><a name="indexterm-1646"></a><a name="indexterm-1647"></a><a name="indexterm-1648"></a><a name="indexterm-1649"></a><a name="indexterm-1650"></a><a name="indexterm-1651"></a><p>When you encrypt a file, the original file is not removed or
changed. The output file is encrypted.</p><p>For solutions to common errors from the <tt>encrypt</tt> command, see the section that
follows the examples.</p><ol>
<li><a name="scftask-genkey-2"></a><b>Create a symmetric key of the appropriate length.</b><p><a name="indexterm-1652"></a>You have two options. You can provide a <a href="glossary-2.html#glossary-101">passphrase</a> from which a key will
be generated. Or you can provide a key.</p>
<ul><li><p>If you provide a passphrase, you must store or remember the passphrase. If you store the passphrase online, the passphrase file should be readable only by you.</p></li>
<li><p>If you provide a key, it must be the correct size for the mechanism. For the procedure, see <a href="#scftask-10">How to Generate a Symmetric Key by Using the <tt>dd</tt> Command</a>. You can also use the <tt>pktool</tt> command. For the procedure and some examples, see <a href="#kmf-20">How to Generate a Symmetric Key by Using the <tt>pktool</tt> Command</a>.</p></li></ul>
</li>
<li><b><a name="indexterm-1653"></a><a name="indexterm-1654"></a><a name="indexterm-1655"></a><a name="indexterm-1656"></a>Encrypt a file.</b><p>Provide a key and use a symmetric key algorithm with the <tt>encrypt</tt>
command.</p><pre>% encrypt -a <i>algorithm</i> [-v] \
[-k <i>keyfile</i> | -K <i>key-label</i> [-T <i>token</i>]] [-i <i>input-file</i>] [-o <i>output-file</i>]</pre><dl><dt><tt>-a</tt> <i>algorithm</i></dt>
<dd><p>Is the algorithm to use to encrypt the file. Type the algorithm as the algorithm appears in the output of the <tt>encrypt -l</tt> command.</p></dd>
<dt><tt>-k</tt> <i>keyfile</i></dt>
<dd><p>Is the file that contains a key of algorithm-specified length.  The key length for each algorithm is listed, in bits, in the output of the <tt>encrypt -l</tt> command.</p></dd>
<dt><tt>-K</tt> <i>key-label</i></dt>
<dd><p><a name="indexterm-1657"></a>Is the label of a key in the PKCS #11 keystore.</p></dd>
<dt><tt>-T</tt> <i>token</i></dt>
<dd><p><a name="indexterm-1658"></a>Is the token name. By default, the token is <tt>Sun Software PKCS#11 softtoken</tt>. Is used only when the <tt>-K</tt> <i>key-label</i> option is used.</p></dd>
<dt><tt>-i</tt> <i>input-file</i></dt>
<dd><p>Is the input file that you want to encrypt. This file is left unchanged by the command.</p></dd>
<dt><tt>-o</tt> <i>output-file</i></dt>
<dd><p>Is the output file that is the encrypted form of the input file.</p></dd>
</dl>
</li></ol><a name="scftask-54"></a><h6>Example&nbsp;14-14 Creating an AES Key for Encrypting Your Files</h6><p>In the following example, a user creates and stores an AES key
in an existing PKCS #11 keystore for use in encryption and decryption. The
user can verify that the key exists and can use the key, but
cannot view the key itself.</p><pre>% <tt><b>pktool genkey label=MyAESkeynumber1 keytype=aes keylen=256</b></tt>
Enter PIN for Sun Software PKCS#11 softtoken  :Type password

% <tt><b>pktool list objtype=key</b></tt>
Enter PIN for Sun Software PKCS#11 softtoken  :&lt;<i>Type password</i>&gt;
Found 1 key
Key #1 - Sun Software PKCS#11 softtoken: MyAESkeynumber1 (256)</pre><p>To use the key to encrypt a file, the user retrieves the
key by its label.</p><pre>% <tt><b>encrypt -a aes -K MyAESkeynumber1 -i encryptthisfile -o encryptedthisfile</b></tt></pre><p>To decrypt the <tt>encryptedthisfile</tt> file, the user retrieves the key by its label.</p><pre>% <tt><b>decrypt -a aes -K MyAESkeynumber1 -i encryptedthisfile -o sameasencryptthisfile</b></tt></pre><a name="scftask-47"></a><h6>Example&nbsp;14-15 Encrypting and Decrypting With AES and a Passphrase</h6><a name="indexterm-1659"></a><a name="indexterm-1660"></a><a name="indexterm-1661"></a><p><a name="indexterm-1662"></a><a name="indexterm-1663"></a>In the following example, a file is encrypted with the AES algorithm. The
key is generated from the passphrase. If the passphrase is stored in
a file, the file should not be readable by anyone but the user.</p><pre>% <tt><b>encrypt -a aes -i ticket.to.ride -o ~/enc/e.ticket.to.ride</b></tt>
Enter key: &lt;Type passphrase&gt;</pre><p>The input file, <tt>ticket.to.ride</tt>, still exists in its original form.</p><p><a name="indexterm-1664"></a>To decrypt the output file, the user uses the same passphrase and encryption
mechanism that encrypted the file.</p><pre>% <tt><b>decrypt -a aes -i ~/enc/e.ticket.to.ride -o ~/d.ticket.to.ride</b></tt>
Enter key: &lt;Type passphrase&gt;</pre><a name="scftask-38"></a><h6>Example&nbsp;14-16 Encrypting and Decrypting With AES and a Key File</h6><p>In the following example, a file is encrypted with the AES algorithm. AES
mechanisms use a key of 128 bits, or 16 bytes.</p><pre>% <tt><b>encrypt -a aes -k ~/keyf/05.07.aes16 \</b></tt>
<tt><b>-i ticket.to.ride -o ~/enc/e.ticket.to.ride</b></tt> </pre><p>The input file, <tt>ticket.to.ride</tt>, still exists in its original form.</p><p>To decrypt the output file, the user uses the same key and
encryption mechanism that encrypted the file.</p><pre>% <tt><b>decrypt -a aes -k ~/keyf/05.07.aes16 \</b></tt>
<tt><b>-i ~/enc/e.ticket.to.ride -o ~/d.ticket.to.ride</b></tt></pre><a name="scftask-39"></a><h6>Example&nbsp;14-17 Encrypting and Decrypting With ARCFOUR and a Key File</h6><p>In the following example, a file is encrypted with the ARCFOUR algorithm. The
ARCFOUR algorithm accepts a key of 8 bits (1 byte), 64 bits
(8 bytes), or 128 bits (16 bytes).</p><pre>% <tt><b>encrypt -a arcfour -i personal.txt \</b></tt>
<tt><b>-k ~/keyf/05.07.rc4.8 -o ~/enc/e.personal.txt</b></tt></pre><p>To decrypt the output file, the user uses the same key and
encryption mechanism that encrypted the file.</p><pre>% <tt><b>decrypt -a arcfour -i ~/enc/e.personal.txt \</b></tt>
<tt><b>-k ~/keyf/05.07.rc4.8 -o ~/personal.txt</b></tt></pre><a name="scftask-40"></a><h6>Example&nbsp;14-18 Encrypting and Decrypting With 3DES and a Key File</h6><p>In the following example, a file is encrypted with the 3DES algorithm. The
3DES algorithm requires a key of 192 bits, or 24 bytes.</p><pre>% <tt><b>encrypt -a 3des -k ~/keyf/05.07.des24 \</b></tt>
<tt><b>-i ~/personal2.txt -o ~/enc/e.personal2.txt</b></tt></pre><p>To decrypt the output file, the user uses the same key and
encryption mechanism that encrypted the file.</p><pre>% <tt><b>decrypt -a 3des -k ~/keyf/05.07.des24 \</b></tt>
<tt><b>-i ~/enc/e.personal2.txt -o ~/personal2.txt</b></tt></pre><h6>Troubleshooting</h6><p><a name="indexterm-1665"></a><a name="indexterm-1666"></a><a name="indexterm-1667"></a><a name="indexterm-1668"></a><a name="indexterm-1669"></a><a name="indexterm-1670"></a>The following messages indicate that the key that you provided to the <tt>encrypt</tt>
command is not permitted by the algorithm that you are using.</p>
<ul><li><p><tt>encrypt: unable to create key for crypto operation: CKR_ATTRIBUTE_VALUE_INVALID</tt></p></li>
<li><p><tt>encrypt: failed to initialize crypto operation: CKR_KEY_SIZE_RANGE</tt></p></li></ul>
<p>If you pass a key that does not meet the requirements of
the algorithm, you must supply a better key.</p>
<ul><li><p>One option is to use a passphrase. The framework then provides a key that meets the requirements.</p></li>
<li><p>The second option is to pass a key size that the algorithm accepts. For example, the DES algorithm requires a key of 64 bits. The 3DES algorithm requires a key of 192 bits.</p></li></ul>

         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="scftask-24.html">Previous</a>
             </td>
             <td align="right">
                 <a href="scftask-28.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

