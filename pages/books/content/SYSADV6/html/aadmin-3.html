<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Administering the Kerberos Database - System Administration Guide: Security Services</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-08-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.org"><img border="0" src="graphics/header.png"></img></a>
   </div>
   <div class="Title">System Administration Guide: Security Services</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="aadmin-2.html">Previous</a>
             </td>
             <td align="right">
                 <a href="ggklp.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="oview-1.html">Part&nbsp;I&nbsp;Security Overview</a></p>
<p class="toc level2"><a href="secov-1.html">1.&nbsp;&nbsp;Security Services (Overview)</a></p>
<p class="toc level1 tocsp"><a href="sectm-1.html">Part&nbsp;II&nbsp;System, File, and Device Security</a></p>
<p class="toc level2"><a href="concept-1.html">2.&nbsp;&nbsp;Managing Machine Security (Overview)</a></p>
<p class="toc level2"><a href="secsys-1.html">3.&nbsp;&nbsp;Controlling Access to Systems (Tasks)</a></p>
<p class="toc level2"><a href="vscan-1.html">4.&nbsp;&nbsp;Virus Scanning Service (Tasks)</a></p>
<p class="toc level2"><a href="devtask-1.html">5.&nbsp;&nbsp;Controlling Access to Devices (Tasks)</a></p>
<p class="toc level2"><a href="bart-1.html">6.&nbsp;&nbsp;Using the Basic Audit Reporting Tool (Tasks)</a></p>
<p class="toc level2"><a href="secfile-1.html">7.&nbsp;&nbsp;Controlling Access to Files (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="prbactm-1.html">Part&nbsp;III&nbsp;Roles, Rights Profiles, and Privileges</a></p>
<p class="toc level2"><a href="prbac-1.html">8.&nbsp;&nbsp;Using Roles and Privileges (Overview)</a></p>
<p class="toc level2"><a href="rbactask-1.html">9.&nbsp;&nbsp;Using Role-Based Access Control (Tasks)</a></p>
<p class="toc level2"><a href="rbacref-1.html">10.&nbsp;&nbsp;Role-Based Access Control (Reference)</a></p>
<p class="toc level2"><a href="privtask-1.html">11.&nbsp;&nbsp;Privileges (Tasks)</a></p>
<p class="toc level2"><a href="privref-1.html">12.&nbsp;&nbsp;Privileges (Reference)</a></p>
<p class="toc level1 tocsp"><a href="scftm-1.html">Part&nbsp;IV&nbsp;Solaris Cryptographic Services</a></p>
<p class="toc level2"><a href="scf-1.html">13.&nbsp;&nbsp;Solaris Cryptographic Framework (Overview)</a></p>
<p class="toc level2"><a href="scftask-1.html">14.&nbsp;&nbsp;Solaris Cryptographic Framework (Tasks)</a></p>
<p class="toc level2"><a href="kmf-1.html">15.&nbsp;&nbsp;Solaris Key Management Framework</a></p>
<p class="toc level1 tocsp"><a href="authtm-1.html">Part&nbsp;V&nbsp;Authentication Services and Secure Communication</a></p>
<p class="toc level2"><a href="auth-1.html">16.&nbsp;&nbsp;Using Authentication Services (Tasks)</a></p>
<p class="toc level2"><a href="pam-1.html">17.&nbsp;&nbsp;Using PAM</a></p>
<p class="toc level2"><a href="sasl-1.html">18.&nbsp;&nbsp;Using SASL</a></p>
<p class="toc level2"><a href="sshuser-1.html">19.&nbsp;&nbsp;Using Solaris Secure Shell (Tasks)</a></p>
<p class="toc level2"><a href="sshref-1.html">20.&nbsp;&nbsp;Solaris Secure Shell (Reference)</a></p>
<p class="toc level1 tocsp"><a href="seamtm-1.html">Part&nbsp;VI&nbsp;Kerberos Service</a></p>
<p class="toc level2"><a href="intro-1.html">21.&nbsp;&nbsp;Introduction to the Kerberos Service</a></p>
<p class="toc level2"><a href="seamplan-1.html">22.&nbsp;&nbsp;Planning for the Kerberos Service</a></p>
<p class="toc level2"><a href="setup-8.html">23.&nbsp;&nbsp;Configuring the Kerberos Service (Tasks)</a></p>
<p class="toc level3"><a href="setup-306.html">Configuring the Kerberos Service (Task Map)</a></p>
<p class="toc level3"><a href="ezecs.html">Configuring Additional Kerberos Services (Task Map)</a></p>
<p class="toc level3"><a href="setup-9.html">Configuring KDC Servers</a></p>
<p class="toc level3"><a href="setup-87.html">Configuring Cross-Realm Authentication</a></p>
<p class="toc level3"><a href="setup-119.html">Configuring Kerberos Network Application Servers</a></p>
<p class="toc level3"><a href="setup-97.html">Configuring Kerberos NFS Servers</a></p>
<p class="toc level3"><a href="setup-148.html">Configuring Kerberos Clients</a></p>
<p class="toc level3"><a href="setup-192.html">Synchronizing Clocks Between KDCs and Kerberos Clients</a></p>
<p class="toc level3"><a href="aadmin-2.html">Swapping a Master KDC and a Slave KDC</a></p>
<div class="onpage">
<p class="toc level3"><a href="">Administering the Kerberos Database</a></p>
</div>
<p class="toc level3"><a href="ggklp.html">Managing a KDC on an LDAP Directory Server</a></p>
<p class="toc level3"><a href="setup-280.html">Increasing Security on Kerberos Servers</a></p>
<p class="toc level2 tocsp"><a href="trouble-1.html">24.&nbsp;&nbsp;Kerberos Error Messages and Troubleshooting</a></p>
<p class="toc level2"><a href="aadmin-1.html">25.&nbsp;&nbsp;Administering Kerberos Principals and Policies (Tasks)</a></p>
<p class="toc level2"><a href="user-7.html">26.&nbsp;&nbsp;Using Kerberos Applications (Tasks)</a></p>
<p class="toc level2"><a href="refer-1.html">27.&nbsp;&nbsp;The Kerberos Service (Reference)</a></p>
<p class="toc level1 tocsp"><a href="audittm-1.html">Part&nbsp;VII&nbsp;Solaris Auditing</a></p>
<p class="toc level2"><a href="auditov-1.html">28.&nbsp;&nbsp;Solaris Auditing (Overview)</a></p>
<p class="toc level2"><a href="auditplan-1.html">29.&nbsp;&nbsp;Planning for Solaris Auditing</a></p>
<p class="toc level2"><a href="audittask-1.html">30.&nbsp;&nbsp;Managing Solaris Auditing (Tasks)</a></p>
<p class="toc level2"><a href="auditref-1.html">31.&nbsp;&nbsp;Solaris Auditing (Reference)</a></p>
<p class="toc level1 tocsp"><a href="glossary-2.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="aadmin-3"></a><h3>Administering the Kerberos Database</h3>
<p>The Kerberos database is the backbone of Kerberos and must be maintained properly.
This section provides some procedures on how to administer the Kerberos database, such
as backing up and restoring the database, setting up incremental or parallel propagation,
and administering the stash file. The steps to initially set up the database
are in <a href="setup-9.html#setup-1">How to Configure a Master KDC</a>.</p>

<a name="setup-304"></a><h4>Backing Up and Propagating the Kerberos Database</h4>
<a name="indexterm-2622"></a><a name="indexterm-2623"></a><a name="indexterm-2624"></a><a name="indexterm-2625"></a><a name="indexterm-2626"></a><p>Propagating the Kerberos database from the master KDC to the slave KDCs is
one of the most important configuration tasks. If propagation doesn't happen often enough,
the master KDC and the slave KDCs will lose synchronization. So, if the
master KDC goes down, the slave KDCs will not have the most
recent database information. Also, if a slave KDC has been configured as a
master KDC for purposes of load balancing, the clients that use that slave
KDC as a master KDC will not have the latest information. Therefore, you
must make sure that propagation occurs often enough or else configure the servers
for incremental propagation, based on how often you change the Kerberos database. Incremental propagation
is preferred over manual propagation because there is more administrative overhead when you
manually propagate the database. Also, there are inefficiencies when you do full propagation
of the database.</p><p>When you configure the master KDC, you set up the <tt>kprop_script</tt> command in
a <tt>cron</tt> job to automatically back up the Kerberos database to the <tt>/var/krb5/slave_datatrans</tt>
dump file and propagate it to the slave KDCs. But, as with any
file, the Kerberos database can become corrupted. If data corruption occurs on a
slave KDC, you might never notice, because the next automatic propagation of the
database installs a fresh copy. However, if corruption occurs on the master KDC,
the corrupted database is propagated to all of the slave KDCs during the
next propagation. And, the corrupted backup overwrites the previous uncorrupted backup file on
the master KDC.</p><p>Because there is no &ldquo;safe&rdquo; backup copy in this scenario, you should also
set up a <tt>cron</tt> job to periodically copy the <tt>slave_datatrans</tt> dump file to
another location or to create another separate backup copy by using the <tt>dump</tt>
command of <tt>kdb5_util</tt>. Then, if your database becomes corrupted, you can restore the most
recent backup on the master KDC by using the <tt>load</tt> command of
<tt>kdb5_util</tt>. </p><p>Another important note: Because the database dump file contains principal keys, you need
to protect the file from being accessed by unauthorized users. By default, the
database dump file has read and write permissions only as <tt>root</tt>. To
protect against unauthorized access, use only the <tt>kprop</tt> command to propagate the
database dump file, which encrypts the data that is being transferred. Also, <tt>kprop</tt>
propagates the data only to the slave KDCs, which minimizes the chance of
accidentally sending the database dump file to unauthorized hosts.</p>
<hr><p><b>Caution - </b>If the Kerberos database is updated after it has been propagated and if
the database subsequently is corrupted before the next propagation, the KDC slaves will
not contain the updates. The updates will be lost. For this reason, if
you add significant updates to the Kerberos database before a regularly scheduled propagation,
you should manually propagate the database to avoid data loss.</p>
<hr>


<a name="setup-314"></a><h5>The <tt>kpropd.acl</tt> File</h5>
<p>The <tt>kpropd.acl</tt> file on a slave KDC provides a list of host principal
names, one name per line, that specifies the systems from which the KDC
can receive an updated database through propagation. If the master KDC is used
to propagate all the slave KDCs, the <tt>kpropd.acl</tt> file on each slave needs
to contain only the host principal name of the master KDC. </p><p>However, the Kerberos installation and subsequent configuration steps in this book instruct you
to add the same <tt>kpropd.acl</tt> file to the master KDC and the slave
KDCs. This file contains all the KDC host principal names. This configuration enables
you to propagate from any KDC, in case the propagating KDCs become temporarily
unavailable. And, by keeping an identical copy on all KDCs, you make the
configuration easy to maintain.  </p>

<a name="setup-315"></a><h5>The <tt>kprop_script</tt> Command</h5>
<p>The <tt>kprop_script</tt> command uses the <tt>kprop</tt> command to propagate the Kerberos database to
other KDCs. If the <tt>kprop_script</tt> command is run on a slave KDC, it
propagates the slave KDC's copy of the Kerberos database to other KDCs. The
<tt>kprop_script</tt> accepts a list of host names for arguments, separated by spaces, which
denote the KDCs to propagate.  </p><p>When <tt>kprop_script</tt> is run, it creates a backup of the Kerberos database to
the <tt>/var/krb5/slave_datatrans</tt> file and copies the file to the specified KDCs. The Kerberos
database is locked until the propagation is finished.</p>

<a name="setup-155"></a><h4>How to Back Up the Kerberos Database</h4><ol>
<li><a name="seamtask-step-423"></a><b>Become superuser on the master KDC.</b></li>
<li><a name="seamtask-step-424"></a><b>Back up the Kerberos database by using the <tt>dump</tt> command of the <tt>kdb5_util</tt>
command.</b><pre># <tt><b>/usr/sbin/kdb5_util dump</b></tt> [<tt><b></b></tt><tt>-verbose</tt><tt><b></b></tt>] [<tt><b></b></tt><tt>-d</tt><tt><b></b></tt> <i>dbname</i>] [<i>filename</i> [<i>principals</i>...]]</pre><dl><dt><tt>-verbose</tt></dt>
<dd><p>Prints the name of each principal and policy that is being backed up.</p></dd>
<dt><i>dbname</i></dt>
<dd><p>Defines the name of the database to back up. Note that you can specify an absolute path for the file. If the <tt>-d</tt> option is not specified, the default database name is <tt>/var/krb5/principal</tt>.</p></dd>
<dt><i>filename</i></dt>
<dd><p>Defines the file that is used to back up the database. You can specify an absolute path for the file. If you don't specify a file, the database is dumped to standard output.</p></dd>
<dt><i>principals</i></dt>
<dd><p>Defines a list of one or more principals (separated by a space) to back up. You must use fully qualified principal names. If you don't specify any principals, the entire database is backed up.</p></dd>
</dl>
</li></ol><a name="ehgbf"></a><h6>Example&nbsp;23-14 Backing Up the Kerberos Database</h6><p>In the following example, the Kerberos database is backed up to a
file called <tt>dumpfile</tt>. Because the <tt>-verbose</tt> option is specified, each principal is printed as
it is backed up.</p><pre># <tt><b>kdb5_util dump -verbose dumpfile</b></tt> 
kadmin/kdc1.eng.example.com@ENG.EXAMPLE.COM 
krbtgt/eng.example.com@ENG.EXAMPLE.COM 
kadmin/history@ENG.EXAMPLE.COM 
pak/admin@ENG.EXAMPLE.COM 
pak@ENG.EXAMPLE.COM
changepw/kdc1.eng.example.com@ENG.EXAMPLE.COM</pre><p>In the following example, the <tt>pak</tt> and <tt>pak/admin</tt> principals from the Kerberos
database are backed up.</p><pre># <tt><b>kdb5_util dump -verbose dumpfile pak/admin@ENG.EXAMPLE.COM pak@ENG.EXAMPLE.COM</b></tt>
pak/admin@ENG.EXAMPLE.COM
pak@ENG.EXAMPLE.COM</pre>

<a name="setup-152"></a><h4>How to Restore the Kerberos Database</h4><ol>
<li><b>Become superuser on the master KDC.</b></li>
<li><b>On the master, stop the KDC daemons.</b><pre>kdc1 # <tt><b>svcadm disable network/security/krb5kdc</b></tt>
kdc1 # <tt><b>svcadm disable network/security/kadmin</b></tt></pre></li>
<li><b>Restore the Kerberos database by using the <tt>load</tt> command of the <tt>kdb_util</tt> command.</b><pre># <tt><b>/usr/sbin/kdb5_util load</b></tt> [<tt><b></b></tt><tt>-verbose</tt><tt><b></b></tt>] [<tt><b></b></tt><tt>-d</tt><tt><b></b></tt> <i>dbname</i>] [<tt><b></b></tt><tt>-update</tt><tt><b></b></tt>] [<i>filename</i>] </pre><dl><dt><tt>-verbose</tt></dt>
<dd><p>Prints the name of each principal and policy that is being restored.</p></dd>
<dt><i>dbname</i></dt>
<dd><p>Defines the name of the database to restore. Note you can specify an absolute path for the file. If the <tt>-d</tt> option is not specified, the default database name is <tt>/var/krb5/principal</tt>.</p></dd>
<dt><tt>-update</tt></dt>
<dd><p>Updates the existing database. Otherwise, a new database is created or the existing database is overwritten.</p></dd>
<dt><i>filename</i></dt>
<dd><p>Defines the file from which to restore the database. You can specify an absolute path for the file. </p></dd>
</dl>
</li>
<li><b>Start the KDC daemons.</b><pre>kdc1 # <tt><b>svcadm enable -r network/security/krb5kdc</b></tt>
kdc1 # <tt><b>svcadm enable -r network/security/kadmin</b></tt></pre></li></ol><a name="ehgbe"></a><h6>Example&nbsp;23-15 Restoring the Kerberos Database</h6><p>In the following example, the database called <tt>database1</tt> is restored into the current
directory from the <tt>dumpfile</tt> file. Because the <tt>-update</tt> option isn't specified, a new
database is created by the restore.</p><pre># <tt><b>kdb5_util load -d database1 dumpfile</b></tt></pre>

<a name="faazs"></a><h4>How to Convert a Kerberos Database After a Server Upgrade</h4><p>If your KDC database was created on a server running the Solaris
8 or Solaris 9 release, converting the database allows you to take advantage
of the improved database format.</p><h6>Before You Begin</h6><p>Make sure that the database is using an older format. </p><ol>
<li><b>On the master, stop the KDC daemons.</b><pre>kdc1 # <tt><b>svcadm disable network/security/krb5kdc</b></tt>
kdc1 # <tt><b>svcadm disable network/security/kadmin</b></tt></pre></li>
<li><b>Create a directory to store a temporary copy of the database.</b><pre>kdc1 # <tt><b>mkdir /var/krb5/tmp</b></tt>
kdc1 # <tt><b>chmod 700 /var/krb5/tmp</b></tt></pre></li>
<li><b>Dump the KDC database.</b><pre>kdc1 # <tt><b>kdb5_util dump /var/krb5/tmp/prdb.txt</b></tt></pre></li>
<li><b>Save copies of the current database files.</b><pre>kdc1 # <tt><b>cd /var/krb5</b></tt>
kdc1 # <tt><b>mv princ* tmp/</b></tt></pre></li>
<li><b>Load the database.</b><pre>kdc1 # <tt><b>kdb5_util load /var/krb5/tmp/prdb.txt</b></tt></pre></li>
<li><b>Start the KDC daemons.</b><pre>kdc1 # <tt><b>svcadm enable -r network/security/krb5kdc</b></tt>
kdc1 # <tt><b>svcadm enable -r network/security/kadmin</b></tt></pre></li></ol>

<a name="faazt"></a><h4>How to Reconfigure a Master KDC to Use Incremental Propagation</h4><p>The steps in this procedure can be used to reconfigure an existing
master KDC to use incremental propagation. In this procedure, the following configuration parameters are
used: </p>
<ul><li><p>Realm name = <tt>EXAMPLE.COM</tt></p></li>
<li><p>DNS domain name = <tt>example.com</tt></p></li>
<li><p>Master KDC = <tt>kdc1.example.com</tt></p></li>
<li><p>Slave KDC = <tt>kdc2.example.com</tt></p></li>
<li><p><tt>admin</tt> principal = <tt>kws/admin</tt></p></li></ul>
<ol>
<li><b>Add entries to <tt>kdc.conf</tt>.</b><p>You need to enable incremental propagation and select the number of updates the KDC
master keeps in the log. See the <a href="http://docs.sun.com/doc/819-2251/kdc.conf-4?a=view"><tt>kdc.conf</tt>(4)</a> man page for more
information.</p><pre>kdc1 # <tt><b>cat /etc/krb5/kdc.conf</b></tt>
[kdcdefaults]
        kdc_ports = 88,750

[realms]
        <tt><b>EXAMPLE.COM</b></tt>= {
                profile = /etc/krb5/krb5.conf
                database_name = /var/krb5/principal
                admin_keytab = /etc/krb5/kadm5.keytab
                acl_file = /etc/krb5/kadm5.acl
                kadmind_port = 749
                max_life = 8h 0m 0s
                max_renewable_life = 7d 0h 0m 0s
                <tt><b>sunw_dbprop_enable = true</b></tt>
                <tt><b>sunw_dbprop_master_ulogsize = 1000</b></tt>
        }</pre></li>
<li><b>Create the <tt>kiprop</tt> principal.</b><p>The <tt>kiprop</tt> principal is used to authenticate the master KDC server and to
authorize updates from the master KDC.</p><pre>kdc1 # <tt><b>/usr/sbin/kadmin -p kws/admin</b></tt>
Enter password: &lt;Type kws/admin password&gt;
kadmin: <tt><b>addprinc -randkey kiprop/kdc1.example.com</b></tt>
Principal "kiprop/kdc1.example.com@EXAMPLE.COM" created.
kadmin: <tt><b>addprinc -randkey kiprop/kdc2.example.com</b></tt>
Principal "kiprop/kdc2.example.com@EXAMPLE.COM" created.
kadmin:</pre></li>
<li><b>Add the <tt>kiprop</tt> principal to the <tt>kadmind</tt> keytab file</b><p>Adding the <tt>kiprop</tt> principal to the <tt>kadm5.keytab</tt> file allows the <tt>kadmind</tt> command to
authenticate itself when it is started.</p><pre>kadmin: <tt><b>ktadd -k /etc/krb5/kadm5.keytab kiprop/kdc1.example.com</b></tt>
Entry for principal kiprop/kdc1.example.com with kvno 3, encryption type AES-256 CTS mode
          with 96-bit SHA-1 HMAC added to keytab WRFILE:/etc/krb5/kadm5.keytab.
Entry for principal kiprop/kdc1.example.com with kvno 3, encryption type AES-128 CTS mode
          with 96-bit SHA-1 HMAC added to keytab WRFILE:/etc/krb5/kadm5.keytab.
Entry for principal kiprop/kdc1.example.com with kvno 3, encryption type Triple DES cbc
          mode with HMAC/sha1 added to keytab WRFILE:/etc/krb5/kadm5.keytab.
Entry for principal kiprop/kdc1.example.com with kvno 3, encryption type ArcFour
          with HMAC/md5 added to keytab WRFILE:/etc/krb5/kadm5.keytab.
Entry for principal kiprop/kdc1.example.com with kvno 3, encryption type DES cbc mode
          with RSA-MD5 added to keytab WRFILE:/etc/krb5/kadm5.keytab.
kadmin: <tt><b>quit</b></tt></pre></li>
<li><b>On the master KDC, add a kiprop entry to <tt>kadm5.acl</tt></b><p>This entry allows the master KDC to receive requests for incremental propagation from
the <tt>kdc2</tt> server.</p><pre>kdc1 # <tt><b>cat /etc/krb5/kadm5.acl</b></tt>
*/admin@EXAMPLE.COM *
<tt><b>kiprop/kdc2.example.com@EXAMPLE.COM p</b></tt></pre></li>
<li><a name="ejusu"></a><b>Comment out the <tt>kprop</tt> line in the <tt>root</tt> crontab file.</b><p>This step prevents the master KDC from propagating its copy of the KDC
database.</p><pre>kdc1 # <tt><b>crontab -e</b></tt>
#ident  "@(#)root       1.20    01/11/06 SMI"
#
# The root crontab should be used to perform accounting data collection.
#
# The rtc command is run to adjust the real time clock if and when
# daylight savings time changes.
#
10 3 * * * /usr/sbin/logadm
15 3 * * 0 /usr/lib/fs/nfs/nfsfind
1 2 * * * [ -x /usr/sbin/rtc ] &amp;&amp; /usr/sbin/rtc -c &gt; /dev/null 2&gt;&amp;1
30 3 * * * [ -x /usr/lib/gss/gsscred_clean ] &amp;&amp; /usr/lib/gss/gsscred_clean
<tt><b>#</b></tt>10 3 * * * /usr/lib/krb5kprop_script kdc2.example.sun.com #SUNWkr5ma</pre></li>
<li><a name="ejuqu"></a><b>Restart <tt>kadmind</tt>.</b><pre>kdc1 # <tt><b>svcadm restart network/security/kadmin</b></tt></pre></li>
<li><b>Reconfigure all slave KDC servers that use incremental propagation.</b><p>See <a href="#ejurx">How to Reconfigure a Slave KDC to Use Incremental Propagation</a> for complete instructions.</p></li></ol>

<a name="ejurx"></a><h4>How to Reconfigure a Slave KDC to Use Incremental Propagation</h4><ol>
<li><b>Add entries to <tt>krb5.conf</tt>.</b><p>The new entries enable incremental propagation and set the poll time to 2
minutes.</p><pre>kdc2 # <tt><b>cat /etc/krb5/krb5.conf</b></tt>
[kdcdefaults]
        kdc_ports = 88,750

[realms]
        EXAMPLE.COM= {
                profile = /etc/krb5/krb5.conf
                database_name = /var/krb5/principal
                admin_keytab = /etc/krb5/kadm5.keytab
                acl_file = /etc/krb5/kadm5.acl
                kadmind_port = 749
                max_life = 8h 0m 0s
                max_renewable_life = 7d 0h 0m 0s
                <tt><b>sunw_dbprop_enable = true</b></tt>
                <tt><b>sunw_dbprop_slave_poll = 2m</b></tt>
        }</pre></li>
<li><b>Add the <tt>kiprop</tt> principal to the <tt>krb5.keytab</tt> file.</b><pre>kdc2 # <tt><b>/usr/sbin/kadmin -p kws/admin</b></tt>
Enter password: &lt;Type kws/admin password&gt;
kadmin: <tt><b>ktadd kiprop/kdc2.example.com</b></tt>
Entry for principal kiprop/kdc2.example.com with kvno 3, encryption type AES-256 CTS mode
          with 96-bit SHA-1 HMAC added to keytab WRFILE:/etc/krb5/krb5.keytab.
Entry for principal kiprop/kdc2.example.com with kvno 3, encryption type AES-128 CTS mode
          with 96-bit SHA-1 HMAC added to keytab WRFILE:/etc/krb5/krb5.keytab.
Entry for principal kiprop/kdc2.example.com with kvno 3, encryption type Triple DES cbc
          mode with HMAC/sha1 added to keytab WRFILE:/etc/krb5/krb5.keytab.
Entry for principal kiprop/kdc2.example.com with kvno 3, encryption type ArcFour
          with HMAC/md5 added to keytab WRFILE:/etc/krb5/krb5.keytab.
Entry for principal kiprop/kdc2.example.com with kvno 3, encryption type DES cbc mode
          with RSA-MD5 added to keytab WRFILE:/etc/krb5/krb5.keytab.
kadmin: <tt><b>quit</b></tt></pre></li>
<li><b>Restart <tt>kpropd</tt>.</b><pre>kdc2 # <tt><b>svcadm restart network/security/krb5_prop</b></tt></pre></li></ol>

<a name="feotp"></a><h4>How to Configure a Slave KDC to Use Full Propagation</h4><p>This procedure shows how to reconfigure a slave KDC server running the Solaris
10 release to use full propagation. Normally, the procedure would only need to
be used if the master KDC server is running either the Solaris 9
release or an earlier release. In this case, the master KDC server
can not support incremental propagation, so the slave needs to be configured to
allow propagation to work.</p><p>In this procedure, a slave KDC named <tt>kdc3</tt> is configured. This procedure uses
the following configuration parameters:</p>
<ul><li><p>Realm name = <tt>EXAMPLE.COM</tt></p></li>
<li><p>DNS domain name = <tt>example.com</tt></p></li>
<li><p>Master KDC = <tt>kdc1.example.com</tt></p></li>
<li><p>Slave KDC = <tt>kdc2.example.com</tt> and <tt>kdc3.example.com</tt></p></li>
<li><p><tt>admin</tt> principal = <tt>kws/admin</tt></p></li>
<li><p>Online help URL = <tt>http://denver:8888/ab2/coll.384.1/SEAM/@AB2PageView/6956</tt></p>
<hr><p><b>Note - </b>Adjust the URL to point to the &ldquo;Graphical Kerberos Administration Tool&rdquo; section, as described in the <a href="seamplan-3.html">Online Help URL in the Graphical Kerberos Administration Tool</a>.</p>
<hr>
</li></ul>
<h6>Before You Begin</h6><p>The master KDC must be configured. For specific instructions if this slave is
to be swappable, see <a href="aadmin-2.html">Swapping a Master KDC and a Slave KDC</a>.</p><ol>
<li><b>On the master KDC, become superuser.</b></li>
<li><b>On the master KDC, start <tt>kadmin</tt>.</b><p>You must log in with one of the <tt>admin</tt> principal names that you created
when you configured the master KDC.</p><pre>kdc1 # <tt><b>/usr/sbin/kadmin -p kws/admin</b></tt>
Enter password: &lt;Type kws/admin password&gt;
kadmin: </pre><ol style="list-style-type: lower-alpha">
				 
<li><a name="feotl"></a><b>On the master KDC, add slave host principals to the database, if not
already done.</b><p>For the slave to function, it must have a host principal. Note that
when the principal instance is a host name, the FQDN must be specified
in lowercase letters, regardless of the case of the domain name in the
<tt>/etc/resolv.conf</tt> file.</p><pre>kadmin: <tt><b>addprinc -randkey host/kdc3.example.com</b></tt>
Principal "host/kdc3@EXAMPLE.COM" created.
kadmin: </pre></li>
<li><b>Quit <tt>kadmin</tt>.</b><pre>kadmin: <tt>quit</tt></pre></li></ol></li>
<li><a name="feovb"></a><b>On the master KDC, edit the Kerberos configuration file (<tt>krb5.conf</tt>).</b><p>You need to add an entry for each slave. See the <a href="http://docs.sun.com/doc/819-2251/krb5.conf-4?a=view"><tt>krb5.conf</tt>(4)</a> man page
for a full description of this file.</p><pre>kdc1 # <tt><b>cat /etc/krb5/krb5.conf</b></tt>
 .
 .
[realms]
                EXAMPLE.COM = {
                kdc = kdc1.example.com
                kdc = kdc2.example.com
                <tt><b>kdc = kdc3.example.com</b></tt>
                admin_server = kdc1.example.com
        }</pre></li>
<li><b>On the master KDC, add an entry for the master KDC and
each slave KDC into the <tt>kpropd.acl</tt> file.</b><p>See the <a href="http://docs.sun.com/doc/819-2240/kprop-1m?a=view"><tt>kprop</tt>(1M)</a> man page for a full description of this file.</p><pre>kdc1 # <tt><b>cat /etc/krb5/kpropd.acl</b></tt>
host/kdc1.example.com@EXAMPLE.COM
host/kdc2.example.com@EXAMPLE.COM
<tt><b>host/kdc3.example.com@EXAMPLE.COM</b></tt></pre></li>
<li><a name="feouv"></a><b><a name="indexterm-2627"></a>On all slave KDCs, copy the KDC administration files from the master KDC
server.</b><p>This step needs to be followed on all slave KDCs, because the
master KDC server has updated information that each KDC server needs. You can
use <tt>ftp</tt> or a similar transfer mechanism to grab copies of the
following files from the master KDC:</p>
<ul><li><p><tt>/etc/krb5/krb5.conf</tt></p></li>
<li><p><tt>/etc/krb5/kdc.conf</tt></p></li>
<li><p><tt>/etc/krb5/kpropd.acl</tt></p></li></ul>
</li>
<li><b>On all slave KDCs, make sure that the Kerberos access control list file,
<tt>kadm5.acl</tt>, is not populated.</b><p>An unmodified <tt>kadm5.acl</tt> file would look like:</p><pre>kdc2 # <tt><b>cat /etc/krb5/kadm5.acl</b></tt>
*/admin@___default_realm___ *</pre><p>If the file has <tt>kiprop</tt> entries, remove them.</p></li>
<li><a name="feouk"></a><b>On the new slave, start the <tt>kadmin</tt> command.</b><p>You must log in with one of the <tt>admin</tt> principal names that you
created when you configured the master KDC.</p><pre>kdc2 # <tt><b>/usr/sbin/kadmin -p kws/admin</b></tt>
Enter password: &lt;Type kws/admin password&gt;
kadmin: </pre><ol style="list-style-type: lower-alpha">
				 
<li><b>Add the slave's <tt>host</tt> principal to the slave's keytab file by using <tt>kadmin</tt>.</b><p>This entry allows <tt>kprop</tt> and other Kerberized applications to function. Note that
when the principal instance is a host name, the FQDN must be specified
in lowercase letters, regardless of the case of the domain name in the
<tt>/etc/resolv.conf</tt> file.</p><pre>kadmin: <tt><b>ktadd host/kdc3.example.com</b></tt>
Entry for principal host/kdc3.example.com with kvno 3, encryption type AES-256 CTS mode
          with 96-bit SHA-1 HMAC added to keytab WRFILE:/etc/krb5/krb5.keytab.
Entry for principal host/kdc3.example.com with kvno 3, encryption type AES-128 CTS mode
          with 96-bit SHA-1 HMAC added to keytab WRFILE:/etc/krb5/krb5.keytab.
Entry for principal host/kdc3.example.com with kvno 3, encryption type Triple DES cbc
          mode with HMAC/sha1 added to keytab WRFILE:/etc/krb5/krb5.keytab.
Entry for principal host/kdc3.example.com with kvno 3, encryption type ArcFour
          with HMAC/md5 added to keytab WRFILE:/etc/krb5/krb5.keytab.
Entry for principal host/kdc3.example.com with kvno 3, encryption type DES cbc mode
          with RSA-MD5 added to keytab WRFILE:/etc/krb5/krb5.keytab.
kadmin: </pre></li>
<li><b>Quit <tt>kadmin</tt>.</b><pre>kadmin: <tt>quit</tt></pre></li></ol></li>
<li><b>On the master KDC, add the slave KDC name to the <tt>cron</tt>
job, which automatically runs the backups, by running <tt>crontab</tt> <tt>-e</tt>.</b><p>Add the name of each slave KDC server at the end of the
<tt>kprop_script</tt> line.</p><pre>10 3 * * * /usr/lib/krb5/kprop_script kdc2.example.com <tt><b>kdc3.example.com</b></tt></pre><p>You might also want to change the time of the backups. This
entry starts the backup process every day at 3:10 AM.</p></li>
<li><b>On the new slave, start the Kerberos propagation daemon.</b><pre>kdc3 # <tt><b>svcadm enable network/security/krb5_prop</b></tt></pre></li>
<li><b>On the master KDC, back up and propagate the database by using
<tt>kprop_script</tt>.</b><p>If a backup copy of the database is already available, it is not
necessary to complete another backup. See <a href="#setup-224">How to Manually Propagate the Kerberos Database to the Slave KDCs</a> for further instructions.</p><pre>kdc1 # <tt><b>/usr/lib/krb5/kprop_script kdc3.example.com</b></tt>
Database propagation to kdc3.example.com: SUCCEEDED</pre></li>
<li><a name="feoug"></a><b><a name="indexterm-2628"></a><a name="indexterm-2629"></a><a name="indexterm-2630"></a>On the new slave, create a stash file by using <tt>kdb5_util</tt>.</b><pre>kdc3 # <tt><b>/usr/sbin/kdb5_util stash</b></tt>
kdb5_util: Cannot find/read stored master key while reading master key
kdb5_util: Warning: proceeding without master key

Enter KDC database master key: &lt;Type the key&gt;</pre></li>
<li><a name="feovd"></a>(Optional) <b><a name="indexterm-2631"></a><a name="indexterm-2632"></a><a name="indexterm-2633"></a><a name="indexterm-2634"></a>On the new slave KDC, synchronize the master KDCs clock by using NTP
or another clock synchronization mechanism.</b><p>Installing and using the Network Time Protocol (NTP) is not required. However, every
clock must be within the default time that is defined in the <tt>libdefaults</tt>
section of the <tt>krb5.conf</tt> file for authentication to succeed. See <a href="setup-192.html">Synchronizing Clocks Between KDCs and Kerberos Clients</a> for
information about NTP.</p></li>
<li><a name="feoty"></a><b><a name="indexterm-2635"></a><a name="indexterm-2636"></a><a name="indexterm-2637"></a>On the new slave, start the KDC daemon (<tt>krb5kdc</tt>).</b><pre>kdc3 # <tt><b>svcadm enable network/security/krb5kdc</b></tt></pre></li></ol>

<a name="ejuqs"></a><h4>How to Verify That the KDC Servers Are Synchronized</h4><p>If incremental propagation has been configured, this procedure ensures that the information on
the slave KDC has been updated.</p><ol>
<li><b>On the KDC master server, run the <tt>kproplog</tt> command.</b><pre>kdc1 # <tt><b>/usr/sbin/kproplog -h</b></tt></pre></li>
<li><b>On a KDC slave server, run the <tt>kproplog</tt> command.</b><pre>kdc2 # <tt><b>/usr/sbin/kproplog -h</b></tt></pre></li>
<li><b>Check that the last serial # and the last timestamp values match.</b></li></ol><a name="ejusn"></a><h6>Example&nbsp;23-16 Verifying That the KDC Servers Are Synchronized</h6><p>The following is a sample of results from running the <tt>kproplog</tt> command on
the master KDC server.</p><pre>kdc1 # <tt><b>/usr/sbin/kproplog -h</b></tt>

Kerberos update log (/var/krb5/principal.ulog)
Update log dump:
    Log version #: 1
    Log state: Stable
    Entry block size: 2048
    Number of entries: 2500
    First serial #: 137966
    Last serial #: 140465
    First time stamp: Fri Nov 28 00:59:27 2004
    Last time stamp: Fri Nov 28 01:06:13 2004</pre><p>The following is a sample of results from running the <tt>kproplog</tt> command on
a slave KDC server.</p><pre>kdc2 # <tt><b>/usr/sbin/kproplog -h</b></tt>

Kerberos update log (/var/krb5/principal.ulog)
Update log dump:
    Log version #: 1
    Log state: Stable
    Entry block size: 2048
    Number of entries: 0
    First serial #: None
    Last serial #: 140465
    First time stamp: None
    Last time stamp: Fri Nov 28 01:06:13 2004</pre><p>Notice that the values for the last serial number and the last
timestamp are identical, which indicates that the slave is synchronized with the master KDC
server.</p><p>In the slave KDC server output, notice that no update entries exist in
the slave KDC server's update log. No entries exist because the slave
KDC server does not keep a set of updates, unlike the master KDC
server. Also, the KDC slave server does not include information on the first
serial number or the first timestamp because this is not relevant information.</p>

<a name="setup-224"></a><h4>How to Manually Propagate the Kerberos Database to the Slave KDCs</h4><p>This procedure shows you how to propagate the Kerberos database by using the
<tt>kprop</tt> command. Use this procedure if you need to synchronize a slave KDC
with the master KDC outside the periodic <tt>cron</tt> job. Unlike the <tt>kprop_script</tt>, you
can use <tt>kprop</tt> to propagate just the current database backup without first making
a new backup of the Kerberos database.</p>
<hr><p><b>Note - </b>Do not use this procedure if you are using incremental propagation.</p>
<hr>
<ol>
<li><a name="seamtask-step-427"></a><b>Become superuser on the master KDC.</b></li>
<li><a name="setup-step-214"></a>(Optional) <b>Back up the database by using the <tt>kdb5_util</tt> command.</b><pre># <tt><b>/usr/sbin/kdb5_util dump /var/krb5/slave_datatrans</b></tt></pre></li>
<li><a name="seamtask-step-428"></a><b>Propagate the database to a slave KDC by using the <tt>kprop</tt> command.</b><pre># <tt><b>/usr/lib/krb5/kprop -f /var/krb5/slave_datatrans </tt><i>slave-KDC</i><tt></b></tt></pre></li></ol><a name="seamtask-ex-434"></a><h6>Example&nbsp;23-17 Manually Propagating the Kerberos Database to the Slave KDCs Using <tt>kprop_script</tt></h6><p>If you want to back up the database and propagate it to
a slave KDC outside the periodic <tt>cron</tt> job, you can also use the
<tt>kprop_script</tt> command as follows:</p><pre># <tt><b>/usr/lib/krb5/kprop_script </tt><i>slave-KDC</i><tt></b></tt></pre>

<a name="setup-313"></a><h4>Setting Up Parallel Propagation</h4>
<p>In most cases, the master KDC is used exclusively to propagate its
Kerberos database to the slave KDCs. However, if your site has many slave
KDCs, you might consider load-sharing the propagation process, known as <b>parallel propagation</b>.</p>
<hr><p><b>Note - </b>Do not use this procedure if you are using incremental propagation.</p>
<hr>
<p>Parallel propagation allows specific slave KDCs to share the propagation duties with the
master KDC. This sharing of duties enables the propagation to be done faster
and to lighten the work for the master KDC. </p><p>For example, say your site has one master KDC and six slave
KDCs (shown in <a href="#setup-fig-316">Figure&nbsp;23-2</a>), where <tt>slave-1</tt> through <tt>slave-3</tt> consist of one logical grouping and
<tt>slave-4</tt> through <tt>slave-6</tt> consist of another logical grouping. To set up parallel propagation,
you could have the master KDC propagate the database to <tt>slave-1</tt> and <tt>slave-4</tt>.
In turn, those KDC slaves could propagate the database to the KDC slaves
in their group.</p><a name="setup-fig-316"></a><h6>Figure&nbsp;23-2 Example of Parallel Propagation Configuration</h6><img src="figures/parallel-prop.gif" alt="Diagram shows a master KDC with two propagation slaves. Each propagation slave propagates to its slaves the master KDC database."></img>

<a name="setup-317"></a><h4>Configuration Steps for Setting Up Parallel Propagation</h4>
<p>The following is not a detailed step-by-step procedure, but a high-level list of
configuration steps to enable parallel propagation. These steps involve the following:</p>
<ol><li><p>On the master KDC, changing the <tt>kprop_script</tt> entry in its <tt>cron</tt> job to include arguments for only the KDC slaves that will perform the succeeding propagation (the <b>propagation slaves</b>). </p></li>
<li><p>On each propagation slave, adding a <tt>kprop_script</tt> entry to its <tt>cron</tt> job, which must include arguments for the slaves to propagate. To successfully propagate in parallel, the <tt>cron</tt> job should be set up to run after the propagation slave is itself propagated with the new Kerberos database. </p>
<hr><p><b>Note - </b>How long it will take for a propagation slave to be propagated depends on factors such as network bandwidth and the size of the Kerberos database.</p>
<hr>
</li>
<li><p>On each slave KDC, setting up the appropriate permissions to be propagated. This step is done by adding the host principal name of its propagating KDC to its <tt>kpropd.acl</tt> file.</p></li></ol>
<a name="ezlrh"></a><h6>Example&nbsp;23-18 Setting Up Parallel Propagation</h6><p>Using the example in <a href="#setup-fig-316">Figure&nbsp;23-2</a>, the master KDC's <tt>kprop_script</tt> entry would look similar
to the following:        </p><pre>0 3 * * * /usr/lib/krb5/kprop_script slave-1.example.com slave-4.example.com</pre><p>The <tt>slave-1</tt>'s <tt>kprop_script</tt> entry would look similar to the following:</p><pre>0 4 * * * /usr/lib/krb5/kprop_script slave-2.example.com slave-3.example.com</pre><p>Note that the propagation on the slave starts an hour after it
is propagated by the master.</p><p>The <tt>kpropd.acl</tt> file on the propagation slaves would contain the following entry:</p><pre>host/master.example.com@EXAMPLE.COM</pre><p>The <tt>kpropd.acl</tt> file on the KDC slaves being propagated by <tt>slave-1</tt> would contain
the following entry:</p><pre>host/slave-1.example.com@EXAMPLE.COM</pre>

<a name="setup-305"></a><h4>Administering the Stash File</h4>
<p>The <b>stash file</b> contains the master key for the Kerberos database, which is automatically
created when you create a Kerberos database. If the stash file gets corrupted,
you can use the <tt>stash</tt> command of the <tt>kdb5_util</tt> utility to replace the
corrupted file. The only time you should need to remove a stash file
is after removing the Kerberos database with the <tt>destroy</tt> command of <tt>kdb5_util</tt>. Because
the stash file is not automatically removed with the database, you have to
remove the stash file to finish the cleanup.</p>

<a name="seamtask-26"></a><h4>How to Remove a Stash File</h4><ol>
<li><a name="seamtask-step-429"></a><b>Become superuser on the KDC that contains the stash file.</b></li>
<li><a name="seamtask-step-430"></a><b>Remove the stash file.</b><pre># <tt><b>rm </tt><i>stash-file</i><tt></b></tt></pre><p>Where <i>stash-file</i> is the path to the stash file. By default, the stash
file is located at <tt>/var/krb5/.k5.</tt><i>realm</i><tt></tt>. </p>
<hr><p><b>Note - </b>If you need to re-create the stash file, you can use the
<tt>-f</tt> option of the <tt>kdb5_util</tt> command.</p>
<hr>
</li></ol>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="aadmin-2.html">Previous</a>
             </td>
             <td align="right">
                 <a href="ggklp.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

