<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Creating and Deleting UFS Snapshots - System Administration Guide: Devices and File Systems</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-01-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo"></div>
   <div class="Title">System Administration Guide: Devices and File Systems</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="bkupsnapshot-11.html">Previous</a>
             </td>
             <td align="right">
                 <a href="bkupsnapshot-9.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="vol1preface-11.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="medintro-55492.html">1.&nbsp;&nbsp;Managing Removable Media (Overview)</a></p>
<p class="toc level1 tocsp"><a href="medformat-83002.html">2.&nbsp;&nbsp;Managing Removable Media (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="medaccess-29267.html">3.&nbsp;&nbsp;Accessing Removable Media (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="medcdrw-1.html">4.&nbsp;&nbsp;Writing CDs and DVDs (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="devconfig-27900.html">5.&nbsp;&nbsp;Managing Devices (Overview/Tasks)</a></p>
<p class="toc level1 tocsp"><a href="devconfig2-1.html">6.&nbsp;&nbsp;Dynamically Configuring Devices (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="devusbover-24.html">7.&nbsp;&nbsp;Using USB Devices (Overview)</a></p>
<p class="toc level1 tocsp"><a href="devusbtasks-1.html">8.&nbsp;&nbsp;Using USB Devices (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="fncpk.html">9.&nbsp;&nbsp;Using InfiniBand Devices (Overview/Tasks)</a></p>
<p class="toc level1 tocsp"><a href="disksconcepts-29477.html">10.&nbsp;&nbsp;Managing Disks (Overview)</a></p>
<p class="toc level1 tocsp"><a href="disksprep-31030.html">11.&nbsp;&nbsp;Administering Disks (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="diskssadd-16103.html">12.&nbsp;&nbsp;SPARC: Adding a Disk (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="disksxadd-38159.html">13.&nbsp;&nbsp;x86: Adding a Disk (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="fmvcd.html">14.&nbsp;&nbsp;Configuring Solaris iSCSI Targets and Initiators (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="gfydr.html">15.&nbsp;&nbsp;Configuring and Managing the Solaris Internet Storage Name Service (iSNS)</a></p>
<p class="toc level1 tocsp"><a href="disksformat-15833.html">16.&nbsp;&nbsp;The <tt>format</tt> Utility (Reference)</a></p>
<p class="toc level1 tocsp"><a href="fsoverview-38559.html">17.&nbsp;&nbsp;Managing File Systems (Overview)</a></p>
<p class="toc level1 tocsp"><a href="fscreate-96442.html">18.&nbsp;&nbsp;Creating UFS, TMPFS, and LOFS File Systems (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="fsmount-42780.html">19.&nbsp;&nbsp;Mounting and Unmounting File Systems (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="fscachefs-70682.html">20.&nbsp;&nbsp;Using The CacheFS File System (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="fsswap-14677.html">21.&nbsp;&nbsp;Configuring Additional Swap Space (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="fstroublefsck-61446.html">22.&nbsp;&nbsp;Checking UFS File System Consistency (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="fsfilesysappx-94408.html">23.&nbsp;&nbsp;UFS File System (Reference)</a></p>
<p class="toc level1 tocsp"><a href="bkupconcepts-57422.html">24.&nbsp;&nbsp;Backing Up and Restoring File Systems (Overview)</a></p>
<p class="toc level1 tocsp"><a href="bkuptasks2-64128.html">25.&nbsp;&nbsp;Backing Up Files and File Systems (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="bkupsnapshot-2.html">26.&nbsp;&nbsp;Using UFS Snapshots (Tasks)</a></p>
<p class="toc level2"><a href="bkupsnapshot-1.html">Using UFS Snapshots (Task Map)</a></p>
<p class="toc level2"><a href="bkupsnapshot-11.html">UFS Snapshots Overview</a></p>
<div class="onpage">
<p class="toc level2"><a href="">Creating and Deleting UFS Snapshots</a></p>
<p class="toc level3"><a href="#bkupsnapshot-6">How to Create a UFS Snapshot</a></p>
<p class="toc level3"><a href="#bkupsnapshot-7">How to Display UFS Snapshot Information</a></p>
<p class="toc level3"><a href="#bkupsnapshot-8">How to Delete a UFS Snapshot</a></p>
</div>
<p class="toc level2 tocsp"><a href="bkupsnapshot-9.html">Backing Up a UFS Snapshot</a></p>
<p class="toc level3"><a href="bkupsnapshot-9.html#bkupsnapshot-10">How to Create a Full Backup of a UFS Snapshot (<tt>ufsdump</tt>)</a></p>
<p class="toc level3"><a href="bkupsnapshot-9.html#bkupsnapshot-16">How to Create an Incremental Backup of a UFS Snapshot (<tt>ufsdump</tt>)</a></p>
<p class="toc level3"><a href="bkupsnapshot-9.html#bkupsnapshot-12">How to Back Up a UFS Snapshot (<tt>tar</tt>)</a></p>
<p class="toc level1 tocsp"><a href="bkuprestoretasks-38055.html">27.&nbsp;&nbsp;Restoring Files and File Systems (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="bkupref-12756.html">28.&nbsp;&nbsp;UFS Backup and Restore Commands (Reference)</a></p>
<p class="toc level1 tocsp"><a href="bkupsavefiles-17924.html">29.&nbsp;&nbsp;Copying UFS Files and File Systems (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="bkuptapedevice-42512.html">30.&nbsp;&nbsp;Managing Tape Drives (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="bkupsnapshot-5"></a><h3>Creating and Deleting UFS Snapshots</h3>
<p>When you use the <tt>fssnap</tt> command to create a UFS snapshot, observe how
much disk space the backing-store file consumes. The backing-store file initially uses no
space, and then it grows quickly, especially on heavily used systems. Make sure
that the backing-store file has enough space to expand. Or, limit its size
with the <tt>-o maxsize=n [k,m,g]</tt> option, where <i>n</i> [<tt>k,m,g</tt>] is the maximum size of
the backing-store file.</p>
<hr><p><b>Caution - </b>If the backing-store file runs out of space, the snapshot might delete itself,
which causes the backup to fail. Check the <tt>/var/adm/messages</tt> file for possible
snapshot errors.</p>
<hr>
<p>You can also specify a directory for the backing-store path, which means a
backing store file is created in the directory specified. For example, if
<tt>/var/tmp</tt> is specified for the backing-store path, the following backing-store file is created.</p><pre>/var/tmp/snapshot0</pre><p>If you created one large root (<tt>/</tt>) file system instead of creating separate
file systems for <tt>/export/home</tt>, <tt>/usr</tt>, and so on, you will be unable
to create a snapshot of those separate file systems. For example, this system
does not have a separate file system for <tt>/usr</tt> as indicated under the
<tt>Mounted on</tt> column:</p><pre># <tt><b>df -k /usr</b></tt>
Filesystem            kbytes    used   avail capacity  Mounted on
/dev/dsk/c0t0d0s0    3618177 2190002 1391994    62%    /</pre><p>If you attempt to create a snapshot for the <tt>/usr</tt> file system, you
will see a message similar to the following:</p><pre># <tt><b>fssnap -F ufs -o bs=/snaps/usr.back.file /usr</b></tt>
snapshot error: Invalid backing file path</pre><p>This message indicates that you cannot have the backing store file on the
same file system as the file system being snapped, which is the
case for the <tt>/usr</tt> file system, in this example.</p><p>For more information, see the <a href="http://docs.sun.com/doc/819-2240/fssnap-ufs-1m?a=view"><tt>fssnap_ufs</tt>(1M)</a> man page.</p>

<a name="fapul"></a><h4>Creating a Multiterabyte UFS Snapshot</h4>
<p>Creating a multiterabyte UFS snapshot is identical to creating a snapshot for a
smaller UFS file system. The only difference is that multiple backing store files
are created for each 512 Gbytes of file system space.</p><p>Keep the following key points in mind when creating a snapshot for
a file system that is larger than 512 Gbytes:</p>
<ul><li><p>Multiple backing store files are created.</p>
<ul><li><p>If you specify a backing store file name when the snapshot is created, then the subsequent backing store file names will be interated based on the file name that you specify. The subsequent backing-store files will have the same name, but with the suffixes .2, .3, and so on.</p></li>
<li><p>If you only specify a backing store file destination (or directory) and not a backing store file name, then multiple backing store file names will be created and iterated with the suffixes .2, .3, and so on.</p></li></ul>
</li>
<li><p>The <tt>fssnap</tt> <tt>-i</tt> command only reports the first backing store file name even if multiple backing store files have been created. However, the reported backing-store length is the combined sizes of all the backing store files for the snapshot.</p>
<hr><p><b>Note - </b>Backing-store files are sparse files. The logical size of a sparse file, as reported by the <tt>ls</tt> command, is not the same as the amount of space that has been allocated to the sparse file, as reported by the <tt>du</tt> command.</p>
<hr>
</li>
<li><p>After you have backed up the snapshot or you would just like to remove the snapshot, you will have to remove the backing store files manually if you did not use the <tt>unlink</tt> option when the snapshot was created.</p></li></ul>
<p>For an example of creating a snapshot for a file system that
is larger than 512 Gbytes, see <a href="#fpypp">Example&nbsp;26-2</a>.</p><p>For more information, see <a href="http://docs.sun.com/doc/819-2240/fssnap-ufs-1m?a=view"><tt>fssnap_ufs</tt>(1M)</a>.</p>

<a name="bkupsnapshot-6"></a><h4>How to Create a UFS Snapshot</h4><ol>
<li><a name="filesystem-step-4"></a><b>Become superuser or assume an equivalent role.</b></li>
<li><a name="bkupsnapshot-step-29"></a><b>Make sure that the file system has enough disk space for the backing-store
file.</b><pre># <tt><b>df -k</b></tt> </pre></li>
<li><a name="bkupsnapshot-step-6"></a><b><a name="indexterm-453"></a><a name="indexterm-454"></a><a name="indexterm-455"></a>Make sure that a backing-store file of the same name and location does
not already exist.</b><pre># <tt><b>ls</b></tt> <i>/backing-store-file</i></pre></li>
<li><a name="bkupsnapshot-step-7"></a><b>Create the UFS snapshot.</b><pre># <tt><b>fssnap -F ufs -o bs=</b></tt><i>/backing-store-file</i> <i>/file-system</i></pre>
<hr><p><b>Note - </b>The backing-store file must reside on a different file system than the file
system that is being captured using UFS snapshots.</p>
<hr>
</li>
<li><a name="bkupsnapshot-step-10"></a><b>Verify that the snapshot has been created.</b><pre># <tt><b>/usr/lib/fs/ufs/fssnap -i</b></tt> <i>/file-system</i></pre></li></ol><a name="fncpv"></a>Example&nbsp;26-1 Creating a UFS Snapshot<p><a name="indexterm-456"></a>The following example shows how to create a snapshot of the <tt>/usr</tt>
file system. The backing-store file is <tt>/scratch/usr.back.file</tt>. The virtual device is <tt>/dev/fssnap/1</tt>.</p><pre># <tt><b>fssnap -F ufs -o bs=/scratch/usr.back.file /usr</b></tt>
/dev/fssnap/1</pre><p>The following example shows how to limit the backing-store file to 500 Mbytes.</p><pre># <tt><b>fssnap -F ufs -o maxsize=500m,bs=/scratch/usr.back.file /usr</b></tt> 
/dev/fssnap/1</pre><a name="fpypp"></a>Example&nbsp;26-2 Creating a Multiterabyte UFS Snapshot<p>The following example shows how to create a snapshot of a 1.6
Tbyte UFS file system.</p><pre># <tt><b>fssnap -F ufs -o bs=/var/tmp /data2</b></tt>
/dev/fssnap/0
# <tt><b>/usr/lib/fs/ufs/fssnap -i</b></tt>
Snapshot number               : 0
Block Device                  : /dev/fssnap/0
Raw Device                    : /dev/rfssnap/0
Mount point                   : /data2
Device state                  : idle
Backing store path            : /var/tmp/snapshot0
Backing store size            : 0 KB
Maximum backing store size    : Unlimited
Snapshot create time          : Fri Sep 10 13:13:02 2004
Copy-on-write granularity     : 32 KB
# <tt><b>ls /var/tmp</b></tt>
snapshot0    snapshot0.2  snapshot0.3  snapshot0.4</pre>

<a name="bkupsnapshot-7"></a><h4>How to Display UFS Snapshot Information</h4><p>You can display the current snapshots on the system by using the
<tt>fssnap</tt> <tt>-i</tt> option. If you specify a file system, you see detailed information
about that file system snapshot. If you don't specify a file system, you
see information about all of the current UFS snapshots and their corresponding virtual
devices.</p>
<hr><p><b>Note - </b>Use the UFS file system-specific <tt>fssnap</tt> command to view the extended snapshot information
as shown in the following examples.</p>
<hr>
<ol>
<li><a name="filesystem-step-5"></a><b>Become superuser or assume an equivalent role.</b></li>
<li><a name="bkupsnapshot-step-12"></a><b>List all current snapshots.</b><p>For example:</p><pre># <tt><b>/usr/lib/fs/ufs/fssnap -i</b></tt>
Snapshot number               : 0
Block Device                  : /dev/fssnap/0
Raw Device                    : /dev/rfssnap/0
Mount point                   : /export/home
Device state                  : idle
Backing store path            : /var/tmp/home.snap0
Backing store size            : 0 KB
Maximum backing store size    : Unlimited
Snapshot create time          : Thu Jul 01 14:50:38 2004
Copy-on-write granularity     : 32 KB</pre></li>
<li><b>Display detailed information about a specific snapshot.</b><p>For example:</p><pre># <tt><b>/usr/lib/fs/ufs/fssnap -i /export</b></tt>
Snapshot number               : 1
Block Device                  : /dev/fssnap/1
Raw Device                    : /dev/rfssnap/1
Mount point                   : /export
Device state                  : idle
Backing store path            : /var/tmp/export.snap0
Backing store size            : 0 KB
Maximum backing store size    : Unlimited
Snapshot create time          : Thu Jul 01 15:03:22 2004
Copy-on-write granularity     : 32 KB</pre></li></ol>

<a name="bkupsnapshot-4"></a><h4>Deleting a UFS Snapshot</h4>
<p>When you create a UFS snapshot, you can specify that the backing-store file
is unlinked. An unlinked backing-store file is removed after the snapshot is deleted.
If you don't specify the <tt>-o unlink</tt> option when you create a UFS snapshot,
you must manually delete the backing-store file.</p><p>The backing-store file occupies disk space until the snapshot is deleted, whether you
use the <tt>-o unlink</tt> option to remove the backing-store file or you manually delete
the file.</p>

<a name="bkupsnapshot-8"></a><h4>How to Delete a UFS Snapshot</h4><p>You can delete a snapshot either by rebooting the system or by
using the <tt>fssnap -d</tt> command. When you use this command, you must specify the path
of the file system that contains the UFS snapshot.</p><ol>
<li><a name="filesystem-step-6"></a><b>Become superuser or assume an equivalent role.</b></li>
<li><a name="bkupsnapshot-step-26"></a><b>Identify the snapshot to be deleted.</b><pre># <tt><b>/usr/lib/fs/ufs/fssnap -i</b></tt></pre></li>
<li><a name="bkupsnapshot-step-28"></a><b>Delete the snapshot.</b><pre># <tt><b>fssnap -d</b></tt> <i>/file-system</i>
Deleted snapshot 1.</pre></li>
<li><a name="bkupsnapshot-step-31"></a><b>If you did not use the <tt>-o unlink</tt> option when you created the snapshot,
manually delete the backing-store file.</b><pre># <tt><b>rm</b></tt> <i>/file-system/backing-store-file</i></pre></li></ol><a name="fncpu"></a>Example&nbsp;26-3 Deleting a UFS Snapshot<p><a name="indexterm-457"></a>The following example shows how to delete a snapshot and assumes that the
<tt>-o unlink</tt> option was not used.</p><pre># <tt><b>fssnap -i</b></tt>
    0    /export/home
    1    /export
   # <tt><b>fssnap -d /usr</b></tt>
 Deleted snapshot 1.
# <tt><b>rm /var/tmp/export.snap0</b></tt></pre>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="bkupsnapshot-11.html">Previous</a>
             </td>
             <td align="right">
                 <a href="bkupsnapshot-9.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

