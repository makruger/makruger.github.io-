<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Backing Up a Solaris System With Installed Zones - System Administration Guide:  Virtualization Using the Solaris Operating System</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-04-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/indiana.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo"></div>
   <div class="Title">System Administration Guide:  Virtualization Using the Solaris Operating System</div>
</div>

<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="z.admin.task-21.html">Previous</a>
             </td>
             <td align="right">
                 <a href="gbrmv.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="preface-1.html">Preface</a></p>
<p class="toc level1 tocsp"><a href="preface-3.html">Solaris Virtualization Product Overview</a></p>
<p class="toc level1 tocsp"><a href="resource.html">Part&nbsp;I&nbsp;Resource Management</a></p>
<p class="toc level2"><a href="rmintro-1.html">1.&nbsp;&nbsp;Introduction to Solaris Resource Management</a></p>
<p class="toc level2"><a href="rmtaskproj-1.html">2.&nbsp;&nbsp;Projects and Tasks (Overview)</a></p>
<p class="toc level2"><a href="rmtaskproj.task-37.html">3.&nbsp;&nbsp;Administering Projects and Tasks</a></p>
<p class="toc level2"><a href="rmacct-1.html">4.&nbsp;&nbsp;Extended Accounting (Overview)</a></p>
<p class="toc level2"><a href="rmacct.task.sgm.html">5.&nbsp;&nbsp;Administering Extended Accounting (Tasks)</a></p>
<p class="toc level2"><a href="rmctrls-1.html">6.&nbsp;&nbsp;Resource Controls (Overview)</a></p>
<p class="toc level2"><a href="rmctrls.task-1.html">7.&nbsp;&nbsp;Administering Resource Controls (Tasks)</a></p>
<p class="toc level2"><a href="rmfss-1.html">8.&nbsp;&nbsp;Fair Share Scheduler (Overview)</a></p>
<p class="toc level2"><a href="rmfss.task-1.html">9.&nbsp;&nbsp;Administering the Fair Share Scheduler (Tasks)</a></p>
<p class="toc level2"><a href="rm.rcapd-1.html">10.&nbsp;&nbsp;Physical Memory Control Using the Resource Capping Daemon (Overview)</a></p>
<p class="toc level2"><a href="rm.rcapd.task-1.html">11.&nbsp;&nbsp;Administering the Resource Capping Daemon (Tasks)</a></p>
<p class="toc level2"><a href="rmpool-1.html">12.&nbsp;&nbsp;Resource Pools (Overview)</a></p>
<p class="toc level2"><a href="rmpool.task-1.html">13.&nbsp;&nbsp;Creating and Administering Resource Pools (Tasks)</a></p>
<p class="toc level2"><a href="rmconfig-1.html">14.&nbsp;&nbsp;Resource Management Configuration Example</a></p>
<p class="toc level2"><a href="rmconsole-1.html">15.&nbsp;&nbsp;Resource Control Functionality in the Solaris Management Console</a></p>
<p class="toc level1 tocsp"><a href="zone.html">Part&nbsp;II&nbsp;Zones</a></p>
<p class="toc level2"><a href="zones.intro-1.html">16.&nbsp;&nbsp;Introduction to Solaris Zones</a></p>
<p class="toc level2"><a href="z.config.ov-1.html">17.&nbsp;&nbsp;Non-Global Zone Configuration (Overview)</a></p>
<p class="toc level2"><a href="z.conf.start-1.html">18.&nbsp;&nbsp;Planning and Configuring Non-Global Zones (Tasks)</a></p>
<p class="toc level2"><a href="z.inst.ov-1.html">19.&nbsp;&nbsp;About Installing, Halting, Cloning, and Uninstalling Non-Global Zones (Overview)</a></p>
<p class="toc level2"><a href="z.inst.task-1.html">20.&nbsp;&nbsp;Installing, Booting, Halting, Uninstalling,  and Cloning Non-Global Zones (Tasks)</a></p>
<p class="toc level2"><a href="z.login.ov-1.html">21.&nbsp;&nbsp;Non-Global Zone Login (Overview)</a></p>
<p class="toc level2"><a href="z.login.task-1.html">22.&nbsp;&nbsp;Logging In to Non-Global Zones (Tasks)</a></p>
<p class="toc level2"><a href="gcgnc.html">23.&nbsp;&nbsp;Moving and Migrating Non-Global Zones (Tasks)</a></p>
<p class="toc level2"><a href="z.pkginst.ov-1.html">24.&nbsp;&nbsp;About Packages and Patches on a Solaris System With Zones Installed (Overview)</a></p>
<p class="toc level2"><a href="z.pkginst.task-1.html">25.&nbsp;&nbsp;Adding and Removing Packages and Patches on a Solaris System With Zones Installed (Tasks)</a></p>
<p class="toc level2"><a href="z.admin.ov-1.html">26.&nbsp;&nbsp;Solaris Zones Administration (Overview)</a></p>
<p class="toc level2"><a href="z.admin.task-1.html">27.&nbsp;&nbsp;Administering Solaris Zones (Tasks)</a></p>
<p class="toc level3"><a href="z.admin.task-2.html">Using the <tt>ppriv</tt> Utility</a></p>
<p class="toc level4"><a href="z.admin.task-2.html#gdoof">How to List Solaris Privileges in the Global Zone</a></p>
<p class="toc level4"><a href="z.admin.task-2.html#z.admin.task-6">How to List the Non-Global Zone's Privilege Set</a></p>
<p class="toc level4"><a href="z.admin.task-2.html#z.admin.task-7">How to List a Non-Global Zone's Privilege Set With Verbose Output</a></p>
<p class="toc level3 tocsp"><a href="gelyb.html">Using DTrace in a Non-Global Zone</a></p>
<p class="toc level4"><a href="gelyb.html#gelxd">How to Use DTrace</a></p>
<p class="toc level3 tocsp"><a href="genky.html">Checking the Status of SMF Services in a Non-Global Zone</a></p>
<p class="toc level4"><a href="genky.html#genmf">How to Check the Status of SMF Services From the Command Line</a></p>
<p class="toc level4"><a href="genky.html#genmh">How to Check the Status of SMF Services From Within a Zone</a></p>
<p class="toc level3 tocsp"><a href="z.admin.task-11.html">Mounting File Systems in Running Non-Global Zones</a></p>
<p class="toc level4"><a href="z.admin.task-11.html#z.admin.task-13">How to Import Raw and Block Devices by Using <tt>zonecfg</tt></a></p>
<p class="toc level4"><a href="z.admin.task-11.html#z.admin.task-44">How to Mount the File System Manually</a></p>
<p class="toc level4"><a href="z.admin.task-11.html#z.admin.task-51">How to Place a File System in <tt>/etc/vfstab</tt> to Be Mounted When the Zone Boots</a></p>
<p class="toc level4"><a href="z.admin.task-11.html#z.admin.task-12">How to Mount a File System From the Global Zone Into a Non-Global Zone</a></p>
<p class="toc level3 tocsp"><a href="gbrkt.html">Adding Non-Global Zone Access to Specific File Systems in the Global Zone</a></p>
<p class="toc level4"><a href="gbrkt.html#gbrlv">How to Add Access to CD or DVD Media in a Non-Global Zone</a></p>
<p class="toc level4"><a href="gbrkt.html#gbrke">How to Add a Writable Directory under <tt>/usr</tt> in a Non-Global Zone</a></p>
<p class="toc level4"><a href="gbrkt.html#gbrlq">How to Export Home Directories in the Global Zone Into a Non-Global Zone</a></p>
<p class="toc level3 tocsp"><a href="z.admin.task-54.html">Using IP Network Multipathing on a Solaris System With Zones Installed</a></p>
<p class="toc level4"><a href="z.admin.task-54.html#geofy">How to Use IP Network Multipathing in Exclusive-IP Non-Global Zones</a></p>
<p class="toc level4"><a href="z.admin.task-54.html#z.admin.task-60">How to Extend IP Network Multipathing Functionality to Shared-IP Non-Global Zones</a></p>
<p class="toc level3 tocsp"><a href="geohb.html">Administering Data-Links in Exclusive-IP Non-Global Zones</a></p>
<p class="toc level4"><a href="geohb.html#geofw">How to Use <tt>dladm</tt> <tt>show-linkprop</tt></a></p>
<p class="toc level4"><a href="geohb.html#geofr">How to Use <tt>dladm</tt> <tt>set-linkprop</tt></a></p>
<p class="toc level4"><a href="geohb.html#geofj">How to Use <tt>dladm</tt> <tt>reset-linkprop</tt></a></p>
<p class="toc level3 tocsp"><a href="z.admin.task-71.html">Using the Fair Share Scheduler on a Solaris System With Zones Installed</a></p>
<p class="toc level4"><a href="z.admin.task-71.html#z.admin.task-76">How to Set FSS Shares in the Global Zone Using the <tt>prctl</tt> Command</a></p>
<p class="toc level4"><a href="z.admin.task-71.html#fiouo">How to Change the <tt>zone.cpu-shares</tt> Value in a Zone Dynamically</a></p>
<p class="toc level3 tocsp"><a href="z.admin.task-21.html">Using Rights Profiles in Zone Administration</a></p>
<p class="toc level4"><a href="z.admin.task-21.html#z.admin.task-22">How to Assign the Zone Management Profile</a></p>
<div class="onpage">
<p class="toc level3 tocsp"><a href="">Backing Up a Solaris System With Installed Zones</a></p>
<p class="toc level4"><a href="#gbrni">How to Use <tt>ufsdump</tt> to Perform Backups</a></p>
<p class="toc level4"><a href="#gbrmf">How to Create a UFS Snapshot Using <tt>fssnap</tt></a></p>
<p class="toc level4"><a href="#gbrnr">How to Use <tt>find</tt> and <tt>cpio</tt> to Perform Backups</a></p>
<p class="toc level4"><a href="#gbrnd">How to Print a Copy of a Zone Configuration</a></p>
</div>
<p class="toc level3 tocsp"><a href="gbrmv.html">Restoring a Non-Global Zone</a></p>
<p class="toc level4"><a href="gbrmv.html#gbrmi">How to Restore an Individual Non-Global Zone</a></p>
<p class="toc level2 tocsp"><a href="gclkx.html">28.&nbsp;&nbsp;Troubleshooting Miscellaneous Solaris Zones Problems</a></p>
<p class="toc level1 tocsp"><a href="gchhk.html">Part&nbsp;III&nbsp;Branded Zones</a></p>
<p class="toc level2"><a href="gchhy.html">29.&nbsp;&nbsp;About Branded Zones and the Linux Branded Zone</a></p>
<p class="toc level2"><a href="gcwwm.html">30.&nbsp;&nbsp;Planning the <tt>lx</tt> Branded Zone Configuration (Overview)</a></p>
<p class="toc level2"><a href="gdajn.html">31.&nbsp;&nbsp;Configuring the <tt>lx</tt> Branded Zone (Tasks)</a></p>
<p class="toc level2"><a href="gdbki.html">32.&nbsp;&nbsp;About Installing, Booting, Halting, Cloning, and Uninstalling <tt>lx</tt> Branded Zones (Overview)</a></p>
<p class="toc level2"><a href="gdduh.html">33.&nbsp;&nbsp;Installing, Booting, Halting, Uninstalling and Cloning <tt>lx</tt> Branded Zones (Tasks)</a></p>
<p class="toc level2"><a href="gdgck.html">34.&nbsp;&nbsp;Logging In to <tt>lx</tt> Branded Zones (Tasks)</a></p>
<p class="toc level2"><a href="gdqnv.html">35.&nbsp;&nbsp;Moving and Migrating <tt>lx</tt> Branded Zones (Tasks)</a></p>
<p class="toc level2"><a href="gdgif.html">36.&nbsp;&nbsp;Administering and Running Applications in <tt>lx</tt> Branded Zones (Tasks)</a></p>
<p class="toc level1 tocsp"><a href="gefwp.html">Part&nbsp;IV&nbsp;Sun xVM</a></p>
<p class="toc level2"><a href="gfwrc.html">37.&nbsp;&nbsp;Sun xVM Hypervisor System Requirements</a></p>
<p class="toc level2"><a href="gefwo.html">38.&nbsp;&nbsp;Booting and Running the Sun xVM Hypervisor</a></p>
<p class="toc level2"><a href="gfwcu.html">39.&nbsp;&nbsp;Xvnc</a></p>
<p class="toc level2"><a href="gfqke.html">40.&nbsp;&nbsp;Using <tt>virt-install</tt> to Install a Domain</a></p>
<p class="toc level2"><a href="gfwlm.html">41.&nbsp;&nbsp;xVM System Administration</a></p>
<p class="toc level2"><a href="gefzh.html">42.&nbsp;&nbsp;Troubleshooting Miscellaneous Sun xVM Problems</a></p>
<p class="toc level1 tocsp"><a href="glossary-1.html">Glossary</a></p>
<p class="toc level1 tocsp"><a href="idx-1.html">Index</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="gbrko"></a><h3>Backing Up a Solaris System With Installed Zones</h3>
<p>The following procedures can be used to back up files in zones.
Remember to also back up the zones' configuration files.</p>

<a name="gbrni"></a><h4>How to Use <tt>ufsdump</tt> to Perform Backups</h4><p>You can perform full or incremental backups using the <tt>ufsdump</tt> command. This procedure
backs up the zone <tt>/export/my-zone</tt> to <tt>/backup/my-zone.ufsdump</tt>, where <i>my-zone</i> is replaced with
the name of a zone on your system. You might want to have
a separate file system, for example, a file system mounted on <tt>/backup</tt>, 
to hold the backups.</p><ol>
<li><b>Become superuser, or assume the Primary Administrator role.</b><p>To create the role and assign the role to a user, see
<a href="http://docs.sun.com/doc/819-2379/smcover-95?a=view">Using the Solaris Management Tools With RBAC (Task Map) in <i>System Administration Guide: Basic Administration</i></a>.</p></li>
<li><b>(Optional) Shut down the zone to put the zone in a quiescent
state and to avoid creating backups of shared file systems.</b><pre>global# <tt><b>zlogin -S my-zone init 0</b></tt></pre></li>
<li><b>Check the zone's status.</b><pre>global# <tt><b>zoneadm list -cv</b></tt></pre><p>You will see a display similar to the following:</p><pre>ID  NAME     STATUS       PATH                           BRAND      IP
 0  global   running      /                              native     shared
 -  my-zone  installed    /export/home/my-zone           native     shared</pre></li>
<li><b>Perform the backup.</b><pre>global# <tt><b>ufsdump 0f /backup/my-zone.ufsdump /export/my-zone</b></tt></pre><p>You will see a display similar to the following:</p><pre>DUMP: Date of this level 0 dump: Wed Aug 10 16:13:52 2005
DUMP: Date of last level 0 dump: the epoch
DUMP: Dumping /dev/rdsk/c0t0d0s0 (bird:/) to /backup/my-zone.ufsdump. 
DUMP: Mapping (Pass I) [regular files]
DUMP: Mapping (Pass II) [directories]
DUMP: Writing 63 Kilobyte records
DUMP: Estimated 363468 blocks (174.47MB).
DUMP: Dumping (Pass III) [directories]
DUMP: Dumping (Pass IV) [regular files]
DUMP: 369934 blocks (180.63MB) on 1 volume at 432 KB/sec
DUMP: DUMP IS DONE</pre></li>
<li><b>Boot the zone.</b><pre>global# <tt><b>zoneadm -z my-zone boot</b></tt></pre></li></ol>

<a name="gbrmf"></a><h4>How to Create a UFS Snapshot Using <tt>fssnap</tt></h4><p>This approach uses the <tt>fssnap</tt> command, which creates a temporary image of a
file system intended for backup operations.</p><p>This method can be used to provide a clean, consistent backup of
the zone files only, and it can be executed while zones are running.
However, it is a good idea to suspend or checkpoint active applications that
are updating files when the snapshot is created. An application updating files when
the snapshot is created might leave these files in an internally inconsistent, truncated, or
otherwise unusable state. </p><p>In the example procedure below, note the following:</p>
<ul><li><p>There is a zone named <tt>my-zone</tt> under <tt>/export/home</tt>.</p></li>
<li><p><tt>/export/home</tt> is a separate file system.</p></li></ul>
<h6>Before You Begin</h6><p>The destination backup is <tt>/backup/my-zone.ufs</tt>. You must create the directory <tt>backup</tt> under <tt>/</tt>.</p><ol>
<li><b>Become superuser, or assume the Primary Administrator role.</b><p>To create the role and assign the role to a user, see
<a href="http://docs.sun.com/doc/819-2379/smcover-95?a=view">Using the Solaris Management Tools With RBAC (Task Map) in <i>System Administration Guide: Basic Administration</i></a>.</p></li>
<li><b>Create the snapshot.</b><pre>global# <tt>fssnap -o bs=/export /export/home</tt></pre><p>You will see a display similar to the following:</p><pre>dev/fssnap/0</pre></li>
<li><b>Mount the snapshot.</b><pre>global# <tt><b>mount -o ro /dev/fssnap/0 /mnt</b></tt></pre></li>
<li><b>Back up <tt>my-zone</tt> from the snapshot.</b><pre>global# <tt>ufsdump 0f /backup/my-zone.ufsdump /mnt/my-zone</tt></pre><p>You will see a display similar to the following:</p><pre>DUMP: Date of this level 0 dump: Thu Oct 06 15:13:07 2005
   DUMP: Date of last level 0 dump: the epoch
   DUMP: Dumping /dev/rfssnap/0 (pc2:/mnt) to /backup/my-zone.ufsdump.
   DUMP: Mapping (Pass I) [regular files]
   DUMP: Mapping (Pass II) [directories]
   DUMP: Writing 32 Kilobyte records
   DUMP: Estimated 176028 blocks (85.95MB).
   DUMP: Dumping (Pass III) [directories]
   DUMP: Dumping (Pass IV) [regular files]
   DUMP: 175614 blocks (85.75MB) on 1 volume at 2731 KB/sec
   DUMP: DUMP IS DONE</pre></li>
<li><b>Unmount the snapshot.</b><pre>global# <tt><b>umount /mnt</b></tt></pre></li>
<li><b>Delete the snapshot.</b><pre>global# <tt><b>fssnap -d /dev/fssnap/0</b></tt></pre><p>Note that the snapshot is also removed from the system when the
system is rebooted.</p></li></ol>

<a name="gbrnr"></a><h4>How to Use <tt>find</tt> and <tt>cpio</tt> to Perform Backups</h4><ol>
<li><b>Become superuser, or assume the Primary Administrator role.</b><p>To create the role and assign the role to a user, see
<a href="http://docs.sun.com/doc/819-2379/smcover-95?a=view">Using the Solaris Management Tools With RBAC (Task Map) in <i>System Administration Guide: Basic Administration</i></a>.</p></li>
<li><b>Change directories to the root directory.</b><pre>global# <tt><b>cd /</b></tt></pre></li>
<li><b>Back up <tt>my-zone</tt> files that are not loopback mounted to <tt>/backup/my-zone.cpio</tt>.</b><pre>global# <tt><b>find export/my-zone -fstype lofs -prune -o -local | cpio -oc -O /backup/my-zone.cpio</b></tt> type as one line</pre></li>
<li><b>Verify the results.</b><pre>global# <tt><b>ls -l backup/my-zone.cpio</b></tt></pre><p>You will see a display similar to the following:</p><pre>-rwxr-xr-x   1 root     root     99680256 Aug 10 16:13 backup/my-zone.cpio</pre></li></ol>

<a name="gbrnd"></a><h4>How to Print a Copy of a Zone Configuration</h4><p>You should create backup files of your non-global zone configurations. You can use
the backups to recreate the zones later if necessary. Create the copy of
the zone's configuration after you have logged in to the zone for the
first time and have responded to the <tt>sysidtool</tt> questions. This procedure uses a
zone named <tt>my-zone</tt> and a backup file named <tt>my-zone.config</tt> to illustrate the process.</p><ol>
<li><b>Become superuser, or assume the Primary Administrator role.</b><p>To create the role and assign the role to a user, see
<a href="http://docs.sun.com/doc/819-2379/smcover-95?a=view">Using the Solaris Management Tools With RBAC (Task Map) in <i>System Administration Guide: Basic Administration</i></a>.</p></li>
<li><b>Print the configuration for the zone <tt>my-zone</tt> to a file named <tt>my-zone.config</tt>.</b><pre>global# <tt><b>zonecfg -z my-zone export > my-zone.config</b></tt></pre></li></ol>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="z.admin.task-21.html">Previous</a>
             </td>
             <td align="right">
                 <a href="gbrmv.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

